cscope 15 $HOME/Programming/mlnx-nvme-4_extracted/mlnx-nvme-4.0/host               0000410018
	@core.c

15 
	~<lšux/blkdev.h
>

16 
	~<lšux/blk-mq.h
>

17 
	~<lšux/d–ay.h
>

18 
	~<lšux/”ºo.h
>

19 
	~<lšux/hd»g.h
>

20 
	~<lšux/k”Ãl.h
>

21 
	~<lšux/moduË.h
>

22 
	~<lšux/li¡_sÜt.h
>

23 
	~<lšux/¦ab.h
>

24 
	~<lšux/ty³s.h
>

25 #ifdeà
HAVE_PR_H


26 
	~<lšux/´.h
>

28 
	~<lšux/±¿û.h
>

29 
	~<lšux/nvme_ioùl.h
>

30 
	~<lšux/t10-pi.h
>

31 #ifdeà
HAVE_DEV_PM_INFO_SET_LATENCY_TOLERANCE


32 
	~<lšux/pm_qos.h
>

34 
	~<asm/uÇligÃd.h
>

36 
	#CREATE_TRACE_POINTS


	)

37 
	~"Œaû.h
"

39 
	~"nvme.h
"

40 
	~"çbrics.h
"

42 
	#NVME_MINORS
 (1U << 
MINORBITS
)

	)

44 
	gadmš_timeout
 = 60;

45 
moduË_·¿m
(
admš_timeout
, 
ušt
, 0644);

46 
MODULE_PARM_DESC
(
admš_timeout
, "timeout in seconds for‡dmin commands");

47 
EXPORT_SYMBOL_GPL
(
admš_timeout
);

49 
	gnvme_io_timeout
 = 30;

50 
moduË_·¿m_Çmed
(
io_timeout
, 
nvme_io_timeout
, 
ušt
, 0644);

51 
MODULE_PARM_DESC
(
io_timeout
, "timeout in seconds for I/O");

52 
EXPORT_SYMBOL_GPL
(
nvme_io_timeout
);

54 
	gshutdown_timeout
 = 5;

55 
moduË_·¿m
(
shutdown_timeout
, 
by‹
, 0644);

56 
MODULE_PARM_DESC
(
shutdown_timeout
, "timeout in seconds for controller shutdown");

58 
u8
 
	gnvme_max_»Œ›s
 = 5;

59 
moduË_·¿m_Çmed
(
max_»Œ›s
, 
nvme_max_»Œ›s
, 
by‹
, 0644);

60 
MODULE_PARM_DESC
(
max_»Œ›s
, "max‚umber of„etries‡ command may have");

62 #ifdeà
HAVE_DEV_PM_INFO_SET_LATENCY_TOLERANCE


63 
	gdeçuÉ_ps_max_Ï‹ncy_us
 = 100000;

64 
moduË_·¿m
(
deçuÉ_ps_max_Ï‹ncy_us
, 
ulÚg
, 0644);

65 
MODULE_PARM_DESC
(
deçuÉ_ps_max_Ï‹ncy_us
,

69 
boÞ
 
	gfÜû_­¡
;

70 
moduË_·¿m
(
fÜû_­¡
, 
boÞ
, 0644);

71 
MODULE_PARM_DESC
(
fÜû_­¡
, "allow APST for‚ewlyƒnumerated devicesƒven if quirked off");

73 #ifdeà
HAVE_BLK_MAX_WRITE_HINTS


74 
boÞ
 
	g¡»ams
;

75 
moduË_·¿m
(
¡»ams
, 
boÞ
, 0644);

76 
MODULE_PARM_DESC
(
¡»ams
, "turn on support for Streams write directives");

90 
wÜkqueue_¡ruù
 *
	gnvme_wq
;

91 
EXPORT_SYMBOL_GPL
(
nvme_wq
);

93 
wÜkqueue_¡ruù
 *
	gnvme_»£t_wq
;

94 
EXPORT_SYMBOL_GPL
(
nvme_»£t_wq
);

96 
wÜkqueue_¡ruù
 *
	gnvme_d–‘e_wq
;

97 
EXPORT_SYMBOL_GPL
(
nvme_d–‘e_wq
);

99 
DEFINE_IDA
(
nvme_subsy¡ems_ida
);

100 
LIST_HEAD
(
nvme_subsy¡ems
);

101 
DEFINE_MUTEX
(
nvme_subsy¡ems_lock
);

103 
DEFINE_IDA
(
nvme_š¡ªû_ida
);

104 
dev_t
 
	gnvme_chr_devt
;

105 
þass
 *
	gnvme_þass
;

106 
þass
 *
	gnvme_subsys_þass
;

108 
nvme_ns_»move
(
nvme_ns
 *
ns
);

109 
nvme_»v®id©e_disk
(
g’disk
 *
disk
);

110 
nvme_put_subsy¡em
(
nvme_subsy¡em
 *
subsys
);

112 
	$nvme_queue_sÿn
(
nvme_ù¾
 *
ù¾
)

117 ià(
ù¾
->
¡©e
 =ð
NVME_CTRL_LIVE
)

118 
	`queue_wÜk
(
nvme_wq
, &
ù¾
->
sÿn_wÜk
);

119 
	}
}

121 
	$nvme_»£t_ù¾
(
nvme_ù¾
 *
ù¾
)

123 ià(!
	`nvme_chªge_ù¾_¡©e
(
ù¾
, 
NVME_CTRL_RESETTING
))

124  -
EBUSY
;

125 ià(!
	`queue_wÜk
(
nvme_»£t_wq
, &
ù¾
->
»£t_wÜk
))

126  -
EBUSY
;

128 
	}
}

129 
EXPORT_SYMBOL_GPL
(
nvme_»£t_ù¾
);

131 
	$nvme_»£t_ù¾_sync
(
nvme_ù¾
 *
ù¾
)

133 
»t
;

135 
»t
 = 
	`nvme_»£t_ù¾
(
ù¾
);

136 ià(!
»t
) {

137 
	`æush_wÜk
(&
ù¾
->
»£t_wÜk
);

138 ià(
ù¾
->
¡©e
 !ð
NVME_CTRL_LIVE
 &&

139 
ù¾
->
¡©e
 !ð
NVME_CTRL_ADMIN_ONLY
)

140 
»t
 = -
ENETRESET
;

143  
»t
;

144 
	}
}

145 
EXPORT_SYMBOL_GPL
(
nvme_»£t_ù¾_sync
);

147 
	$nvme_d–‘e_ù¾_wÜk
(
wÜk_¡ruù
 *
wÜk
)

149 
nvme_ù¾
 *
ù¾
 =

150 
	`cÚš”_of
(
wÜk
, 
nvme_ù¾
, 
d–‘e_wÜk
);

152 
	`dev_šfo
(
ù¾
->
deviû
,

153 "Removšg cŒl: NQN \"%s\"\n", 
ù¾
->
Ýts
->
subsy¢qn
);

155 
	`æush_wÜk
(&
ù¾
->
»£t_wÜk
);

156 
	`nvme_¡Ý_ù¾
(
ù¾
);

157 
	`nvme_»move_Çme¥aûs
(
ù¾
);

158 
ù¾
->
Ýs
->
	`d–‘e_ù¾
(ctrl);

159 
	`nvme_unš™_ù¾
(
ù¾
);

160 
	`nvme_put_ù¾
(
ù¾
);

161 
	}
}

163 
	$nvme_d–‘e_ù¾
(
nvme_ù¾
 *
ù¾
)

165 ià(!
	`nvme_chªge_ù¾_¡©e
(
ù¾
, 
NVME_CTRL_DELETING
))

166  -
EBUSY
;

167 ià(!
	`queue_wÜk
(
nvme_d–‘e_wq
, &
ù¾
->
d–‘e_wÜk
))

168  -
EBUSY
;

170 
	}
}

171 
EXPORT_SYMBOL_GPL
(
nvme_d–‘e_ù¾
);

173 
	$nvme_d–‘e_ù¾_sync
(
nvme_ù¾
 *
ù¾
)

175 
»t
 = 0;

181 
	`nvme_g‘_ù¾
(
ù¾
);

182 
»t
 = 
	`nvme_d–‘e_ù¾
(
ù¾
);

183 ià(!
»t
)

184 
	`æush_wÜk
(&
ù¾
->
d–‘e_wÜk
);

185 
	`nvme_put_ù¾
(
ù¾
);

186  
»t
;

187 
	}
}

188 
EXPORT_SYMBOL_GPL
(
nvme_d–‘e_ù¾_sync
);

190 
šlše
 
boÞ
 
	$nvme_ns_has_pi
(
nvme_ns
 *
ns
)

192  
ns
->
pi_ty³
 &&‚s->
ms
 =ð(
t10_pi_tu¶e
);

193 
	}
}

195 
blk_¡©us_t
 
	$nvme_”rÜ_¡©us
(
»que¡
 *
»q
)

197 
	`nvme_»q
(
»q
)->
¡©us
 & 0x7ff) {

198 
NVME_SC_SUCCESS
:

199  
BLK_STS_OK
;

200 
NVME_SC_CAP_EXCEEDED
:

201  
BLK_STS_NOSPC
;

202 
NVME_SC_LBA_RANGE
:

203  
BLK_STS_TARGET
;

204 
NVME_SC_BAD_ATTRIBUTES
:

205 
NVME_SC_ONCS_NOT_SUPPORTED
:

206 
NVME_SC_INVALID_OPCODE
:

207 
NVME_SC_INVALID_FIELD
:

208 
NVME_SC_INVALID_NS
:

209  
BLK_STS_NOTSUPP
;

210 
NVME_SC_WRITE_FAULT
:

211 
NVME_SC_READ_ERROR
:

212 
NVME_SC_UNWRITTEN_BLOCK
:

213 
NVME_SC_ACCESS_DENIED
:

214 
NVME_SC_READ_ONLY
:

215 
NVME_SC_COMPARE_FAILED
:

216  
BLK_STS_MEDIUM
;

217 
NVME_SC_GUARD_CHECK
:

218 
NVME_SC_APPTAG_CHECK
:

219 
NVME_SC_REFTAG_CHECK
:

220 
NVME_SC_INVALID_PI
:

221  
BLK_STS_PROTECTION
;

222 
NVME_SC_RESERVATION_CONFLICT
:

223  
BLK_STS_NEXUS
;

225 #ifdeà
HAVE_BLK_MQ_END_REQUEST_TAKES_BLK_STATUS_T


226  
BLK_STS_IOERR
;

228  -
EIO
;

231 
	}
}

233 
šlše
 
boÞ
 
	$nvme_»q_Ãeds_»Œy
(
»que¡
 *
»q
)

235 ià(
	`blk_nÜ‘ry_»que¡
(
»q
))

236  
çl£
;

237 ià(
	`nvme_»q
(
»q
)->
¡©us
 & 
NVME_SC_DNR
)

238  
çl£
;

239 ià(
	`nvme_»q
(
»q
)->
»Œ›s
 >ð
nvme_max_»Œ›s
)

240  
çl£
;

241  
Œue
;

242 
	}
}

244 
	$nvme_com¶‘e_rq
(
»que¡
 *
»q
)

246 
blk_¡©us_t
 
¡©us
 = 
	`nvme_”rÜ_¡©us
(
»q
);

248 
	`Œaû_nvme_com¶‘e_rq
(
»q
);

250 ià(
	`uÆik–y
(
¡©us
 !ð
BLK_STS_OK
 && 
	`nvme_»q_Ãeds_»Œy
(
»q
))) {

251 ià(
	`nvme_»q_Ãeds_çžov”
(
»q
, 
¡©us
)) {

252 
	`nvme_çžov”_»q
(
»q
);

256 ià(!
	`blk_queue_dyšg
(
»q
->
q
)) {

257 
	`nvme_»q
(
»q
)->
»Œ›s
++;

258 #ifdeà
HAVE_BLK_MQ_REQUEUE_REQUEST_2_PARAMS


259 
	`blk_mq_»queue_»que¡
(
»q
, 
Œue
);

261 
	`blk_mq_»queue_»que¡
(
»q
);

262 
	`blk_mq_kick_»queue_li¡
(
»q
->
q
);

267 
	`blk_mq_’d_»que¡
(
»q
, 
¡©us
);

268 
	}
}

269 
EXPORT_SYMBOL_GPL
(
nvme_com¶‘e_rq
);

271 
	$nvme_ÿnûl_»que¡
(
»que¡
 *
»q
, *
d©a
, 
boÞ
 
»£rved
)

273 ià(!
	`blk_mq_»que¡_¡¬‹d
(
»q
))

276 
	`dev_dbg_¿‹lim™ed
(((
nvme_ù¾
 *è
d©a
)->
deviû
,

277 "CªûÎšg I/O %d", 
»q
->
g
);

279 
	`nvme_»q
(
»q
)->
¡©us
 = 
NVME_SC_ABORT_REQ
;

280 #ifdeà
HAVE_BLK_MQ_COMPLETE_REQUEST_HAS_2_PARAMS


281 
	`blk_mq_com¶‘e_»que¡
(
»q
, 0);

283 
	`blk_mq_com¶‘e_»que¡
(
»q
);

286 
	}
}

287 
EXPORT_SYMBOL_GPL
(
nvme_ÿnûl_»que¡
);

289 
boÞ
 
	$nvme_chªge_ù¾_¡©e
(
nvme_ù¾
 *
ù¾
,

290 
nvme_ù¾_¡©e
 
Ãw_¡©e
)

292 
nvme_ù¾_¡©e
 
Þd_¡©e
;

293 
æags
;

294 
boÞ
 
chªged
 = 
çl£
;

296 
	`¥š_lock_œq§ve
(&
ù¾
->
lock
, 
æags
);

298 
Þd_¡©e
 = 
ù¾
->
¡©e
;

299 
Ãw_¡©e
) {

300 
NVME_CTRL_ADMIN_ONLY
:

301 
Þd_¡©e
) {

302 
NVME_CTRL_CONNECTING
:

303 
chªged
 = 
Œue
;

309 
NVME_CTRL_LIVE
:

310 
Þd_¡©e
) {

311 
NVME_CTRL_NEW
:

312 
NVME_CTRL_RESETTING
:

313 
NVME_CTRL_CONNECTING
:

314 
chªged
 = 
Œue
;

320 
NVME_CTRL_RESETTING
:

321 
Þd_¡©e
) {

322 
NVME_CTRL_NEW
:

323 
NVME_CTRL_LIVE
:

324 
NVME_CTRL_ADMIN_ONLY
:

325 
chªged
 = 
Œue
;

331 
NVME_CTRL_CONNECTING
:

332 
Þd_¡©e
) {

333 
NVME_CTRL_NEW
:

334 
NVME_CTRL_RESETTING
:

335 
chªged
 = 
Œue
;

341 
NVME_CTRL_DELETING
:

342 
Þd_¡©e
) {

343 
NVME_CTRL_LIVE
:

344 
NVME_CTRL_ADMIN_ONLY
:

345 
NVME_CTRL_RESETTING
:

346 
NVME_CTRL_CONNECTING
:

347 
chªged
 = 
Œue
;

353 
NVME_CTRL_DEAD
:

354 
Þd_¡©e
) {

355 
NVME_CTRL_DELETING
:

356 
chªged
 = 
Œue
;

366 ià(
chªged
)

367 
ù¾
->
¡©e
 = 
Ãw_¡©e
;

369 
	`¥š_uÆock_œq»¡Üe
(&
ù¾
->
lock
, 
æags
);

370 ià(
chªged
 && 
ù¾
->
¡©e
 =ð
NVME_CTRL_LIVE
)

371 
	`nvme_kick_»queue_li¡s
(
ù¾
);

372  
chªged
;

373 
	}
}

374 
EXPORT_SYMBOL_GPL
(
nvme_chªge_ù¾_¡©e
);

376 #iâdeà
HAVE_CLEANUP_SRCU_STRUCT_QUIESCED


377 
	$nvme_ä“_ns_h—d_wÜk
(
wÜk_¡ruù
 *
wÜk
)

379 
nvme_ns_h—d
 *
h—d
 =

380 
	`cÚš”_of
(
wÜk
, 
nvme_ns_h—d
, 
ä“_wÜk
);

382 
	`þ—nup_¤cu_¡ruù
(&
h—d
->
¤cu
);

383 
	`nvme_put_subsy¡em
(
h—d
->
subsys
);

384 
	`kä“
(
h—d
);

385 
	}
}

388 
	$nvme_ä“_ns_h—d
(
k»f
 *
»f
)

390 
nvme_ns_h—d
 *
h—d
 =

391 
	`cÚš”_of
(
»f
, 
nvme_ns_h—d
,„ef);

393 
	`nvme_m·th_»move_disk
(
h—d
);

394 
	`ida_sim¶e_»move
(&
h—d
->
subsys
->
ns_ida
, h—d->
š¡ªû
);

395 
	`li¡_d–_š™
(&
h—d
->
’Œy
);

396 #ifdeà
HAVE_CLEANUP_SRCU_STRUCT_QUIESCED


397 
	`þ—nup_¤cu_¡ruù_qu›sûd
(&
h—d
->
¤cu
);

398 
	`nvme_put_subsy¡em
(
h—d
->
subsys
);

399 
	`kä“
(
h—d
);

401 
	`queue_wÜk
(
sy¡em_wq
, &
h—d
->
ä“_wÜk
);

403 
	}
}

405 
	$nvme_put_ns_h—d
(
nvme_ns_h—d
 *
h—d
)

407 
	`k»f_put
(&
h—d
->
»f
, 
nvme_ä“_ns_h—d
);

408 
	}
}

410 
	$nvme_ä“_ns
(
k»f
 *kref)

412 
nvme_ns
 *
ns
 = 
	`cÚš”_of
(
k»f
, nvme_ns, kref);

414 ià(
ns
->
ndev
)

415 
	`nvme_nvm_uÄegi¡”
(
ns
);

417 
	`put_disk
(
ns
->
disk
);

418 
	`nvme_put_ns_h—d
(
ns
->
h—d
);

419 
	`nvme_put_ù¾
(
ns
->
ù¾
);

420 
	`kä“
(
ns
);

421 
	}
}

423 
	$nvme_put_ns
(
nvme_ns
 *
ns
)

425 
	`k»f_put
(&
ns
->
k»f
, 
nvme_ä“_ns
);

426 
	}
}

428 
šlše
 
	$nvme_þ—r_nvme_»que¡
(
»que¡
 *
»q
)

430 #ifdeà
HAVE_REQUEST_RQ_FLAGS


431 ià(!(
»q
->
rq_æags
 & 
RQF_DONTPREP
)) {

432 
	`nvme_»q
(
»q
)->
»Œ›s
 = 0;

433 
	`nvme_»q
(
»q
)->
æags
 = 0;

434 
»q
->
rq_æags
 |ð
RQF_DONTPREP
;

437 ià(!(
»q
->
cmd_æags
 & 
REQ_DONTPREP
)) {

438 
	`nvme_»q
(
»q
)->
»Œ›s
 = 0;

439 
	`nvme_»q
(
»q
)->
æags
 = 0;

440 
»q
->
cmd_æags
 |ð
REQ_DONTPREP
;

443 
	}
}

445 #ifdeà
HAVE_BLK_MQ_ALLOC_REQUEST_HAS_3_PARAMS


446 
»que¡
 *
	$nvme_®loc_»que¡
(
»que¡_queue
 *
q
,

447 
nvme_commªd
 *
cmd
, 
blk_mq_»q_æags_t
 
æags
, 
qid
)

449 
»que¡
 *
	$nvme_®loc_»que¡
(
»que¡_queue
 *
q
,

450 
nvme_commªd
 *
cmd
, 
gå_t
 
gå
, 
boÞ
 
»£rved
, 
qid
)

453 #ifdeà
HAVE_BLK_TYPES_REQ_OP_DRV_OUT


454 
Ý
 = 
	`nvme_is_wr™e
(
cmd
è? 
REQ_OP_DRV_OUT
 : 
REQ_OP_DRV_IN
;

456 
»que¡
 *
»q
;

458 ià(
qid
 =ð
NVME_QID_ANY
) {

459 #ifdeà
HAVE_BLK_TYPES_REQ_OP_DRV_OUT


460 
»q
 = 
	`blk_mq_®loc_»que¡
(
q
, 
Ý
, 
æags
);

462 #ifdeà
HAVE_BLK_MQ_ALLOC_REQUEST_HAS_3_PARAMS


463 
»q
 = 
	`blk_mq_®loc_»que¡
(
q
, 
	`nvme_is_wr™e
(
cmd
), 
æags
);

465 
»q
 = 
	`blk_mq_®loc_»que¡
(
q
, 
	`nvme_is_wr™e
(
cmd
), 
gå
, 
»£rved
);

469 #ifdeà
HAVE_BLK_TYPES_REQ_OP_DRV_OUT


470 
»q
 = 
	`blk_mq_®loc_»que¡_hùx
(
q
, 
Ý
, 
æags
,

471 
qid
 ? qid - 1 : 0);

473 #ifdeà
HAVE_BLK_MQ_ALLOC_REQUEST_HAS_3_PARAMS


474 
»q
 = 
	`blk_mq_®loc_»que¡_hùx
(
q
, 
	`nvme_is_wr™e
(
cmd
), 
æags
,

475 
qid
 ? qid - 1 : 0);

478 
»q
 = 
	`blk_mq_®loc_»que¡
(
q
, 
	`nvme_is_wr™e
(
cmd
), 
gå
, 
»£rved
);

482 ià(
	`IS_ERR
(
»q
))

483  
»q
;

485 #iâdeà
HAVE_BLK_TYPES_REQ_OP_DRV_OUT


486 #ifdeà
HAVE_BLKDEV_REQ_TYPE_DRV_PRIV


487 
»q
->
cmd_ty³
 = 
REQ_TYPE_DRV_PRIV
;

489 
»q
->
cmd_ty³
 = 
REQ_TYPE_SPECIAL
;

493 
»q
->
cmd_æags
 |ð
REQ_FAILFAST_DRIVER
;

494 
	`nvme_þ—r_nvme_»que¡
(
»q
);

495 
	`nvme_»q
(
»q
)->
cmd
 = cmd;

497  
»q
;

498 
	}
}

499 
EXPORT_SYMBOL_GPL
(
nvme_®loc_»que¡
);

501 #ifdeà
HAVE_BLK_MAX_WRITE_HINTS


502 
	$nvme_toggË_¡»ams
(
nvme_ù¾
 *
ù¾
, 
boÞ
 
’abË
)

504 
nvme_commªd
 
c
;

506 
	`mem£t
(&
c
, 0, (c));

508 
c
.
dœeùive
.
Ýcode
 = 
nvme_admš_dœeùive_£nd
;

509 
c
.
dœeùive
.
nsid
 = 
	`ýu_to_Ë32
(
NVME_NSID_ALL
);

510 
c
.
dœeùive
.
dÝ”
 = 
NVME_DIR_SND_ID_OP_ENABLE
;

511 
c
.
dœeùive
.
dty³
 = 
NVME_DIR_IDENTIFY
;

512 
c
.
dœeùive
.
tdty³
 = 
NVME_DIR_STREAMS
;

513 
c
.
dœeùive
.
’dœ
 = 
’abË
 ? 
NVME_DIR_ENDIR
 : 0;

515  
	`nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
c
, 
NULL
, 0);

516 
	}
}

518 
	$nvme_di§bË_¡»ams
(
nvme_ù¾
 *
ù¾
)

520  
	`nvme_toggË_¡»ams
(
ù¾
, 
çl£
);

521 
	}
}

523 
	$nvme_’abË_¡»ams
(
nvme_ù¾
 *
ù¾
)

525  
	`nvme_toggË_¡»ams
(
ù¾
, 
Œue
);

526 
	}
}

528 
	$nvme_g‘_¡»am_·¿ms
(
nvme_ù¾
 *
ù¾
,

529 
¡»ams_dœeùive_·¿ms
 *
s
, 
u32
 
nsid
)

531 
nvme_commªd
 
c
;

533 
	`mem£t
(&
c
, 0, (c));

534 
	`mem£t
(
s
, 0, (*s));

536 
c
.
dœeùive
.
Ýcode
 = 
nvme_admš_dœeùive_»cv
;

537 
c
.
dœeùive
.
nsid
 = 
	`ýu_to_Ë32
(nsid);

538 
c
.
dœeùive
.
numd
 = 
	`ýu_to_Ë32
(((*
s
) >> 2) - 1);

539 
c
.
dœeùive
.
dÝ”
 = 
NVME_DIR_RCV_ST_OP_PARAM
;

540 
c
.
dœeùive
.
dty³
 = 
NVME_DIR_STREAMS
;

542  
	`nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
c
, 
s
, (*s));

543 
	}
}

545 
	$nvme_cÚfigu»_dœeùives
(
nvme_ù¾
 *
ù¾
)

547 
¡»ams_dœeùive_·¿ms
 
s
;

548 
»t
;

550 ià(!(
ù¾
->
ßcs
 & 
NVME_CTRL_OACS_DIRECTIVES
))

552 ià(!
¡»ams
)

555 
»t
 = 
	`nvme_’abË_¡»ams
(
ù¾
);

556 ià(
»t
)

557  
»t
;

559 
»t
 = 
	`nvme_g‘_¡»am_·¿ms
(
ù¾
, &
s
, 
NVME_NSID_ALL
);

560 ià(
»t
)

561  
»t
;

563 
ù¾
->
ns§
 = 
	`Ë16_to_ýu
(
s
.nssa);

564 ià(
ù¾
->
ns§
 < 
BLK_MAX_WRITE_HINTS
 - 1) {

565 
	`dev_šfo
(
ù¾
->
deviû
, "too few streams (%u)‡vailable\n",

566 
ù¾
->
ns§
);

567 
	`nvme_di§bË_¡»ams
(
ù¾
);

571 
ù¾
->
Ä_¡»ams
 = 
	`mš_t
(, cŒl->
ns§
, 
BLK_MAX_WRITE_HINTS
 - 1);

572 
	`dev_šfo
(
ù¾
->
deviû
, "Usšg %u sŒ—ms\n", cŒl->
Ä_¡»ams
);

574 
	}
}

580 
	$nvme_assign_wr™e_¡»am
(
nvme_ù¾
 *
ù¾
,

581 
»que¡
 *
»q
, 
u16
 *
cÚŒÞ
,

582 
u32
 *
dsmgmt
)

584 
rw_hšt
 
¡»amid
 = 
»q
->
wr™e_hšt
;

586 ià(
¡»amid
 =ð
WRITE_LIFE_NOT_SET
 || sŒ—mid =ð
WRITE_LIFE_NONE
)

587 
¡»amid
 = 0;

589 
¡»amid
--;

590 ià(
	`WARN_ON_ONCE
(
¡»amid
 > 
ù¾
->
Ä_¡»ams
))

593 *
cÚŒÞ
 |ð
NVME_RW_DTYPE_STREAMS
;

594 *
dsmgmt
 |ð
¡»amid
 << 16;

597 ià(
¡»amid
 < 
	`ARRAY_SIZE
(
»q
->
q
->
wr™e_hšts
))

598 
»q
->
q
->
wr™e_hšts
[
¡»amid
] +ð
	`blk_rq_by‹s
(req) >> 9;

599 
	}
}

602 
šlše
 
	$nvme_£tup_æush
(
nvme_ns
 *
ns
,

603 
nvme_commªd
 *
cmnd
)

605 
	`mem£t
(
cmnd
, 0, (*cmnd));

606 
cmnd
->
commÚ
.
Ýcode
 = 
nvme_cmd_æush
;

607 
cmnd
->
commÚ
.
nsid
 = 
	`ýu_to_Ë32
(
ns
->
h—d
->
ns_id
);

608 
	}
}

610 
blk_¡©us_t
 
	$nvme_£tup_disÿrd
(
nvme_ns
 *
ns
, 
»que¡
 *
»q
,

611 
nvme_commªd
 *
cmnd
)

613 #ifdeà
HAVE_BLK_RQ_NR_DISCARD_SEGMENTS


614 
£gm’ts
 = 
	`blk_rq_Ä_disÿrd_£gm’ts
(
»q
), 
n
 = 0;

616 
nvme_dsm_¿nge
 *
¿nge
;

617 #ifdeà
HAVE_BLK_RQ_NR_DISCARD_SEGMENTS


618 
bio
 *bio;

620 
Ä_by‹s
 = 
	`blk_rq_by‹s
(
»q
);

622 #iâdeà
HAVE_REQUEST_RQ_FLAGS


623 
·ge
 *page;

624 
off£t
;

627 #ifdeà
HAVE_BLK_RQ_NR_DISCARD_SEGMENTS


628 
¿nge
 = 
	`km®loc_¬¿y
(
£gm’ts
, (*¿nge), 
GFP_ATOMIC
);

630 
¿nge
 = 
	`km®loc
((*¿nge), 
GFP_ATOMIC
);

632 ià(!
¿nge
)

633  
BLK_STS_RESOURCE
;

635 #ifdeà
HAVE_BLK_RQ_NR_DISCARD_SEGMENTS


636 
	`__rq_fÜ_—ch_bio
(
bio
, 
»q
) {

637 
u64
 
¦ba
 = 
	`nvme_block_Ä
(
ns
, 
bio
->
bi_™”
.
bi_£ùÜ
);

638 
u32
 
Æb
 = 
bio
->
bi_™”
.
bi_size
 >> 
ns
->
lba_shiá
;

640 ià(
n
 < 
£gm’ts
) {

641 
¿nge
[
n
].
ÿ‰r
 = 
	`ýu_to_Ë32
(0);

642 
¿nge
[
n
].
Æb
 = 
	`ýu_to_Ë32
(nlb);

643 
¿nge
[
n
].
¦ba
 = 
	`ýu_to_Ë64
(slba);

645 
n
++;

648 ià(
	`WARN_ON_ONCE
(
n
 !ð
£gm’ts
)) {

649 
	`kä“
(
¿nge
);

650  
BLK_STS_IOERR
;

653 
¿nge
->
ÿ‰r
 = 
	`ýu_to_Ë32
(0);

654 
¿nge
->
Æb
 = 
	`ýu_to_Ë32
(
Ä_by‹s
 >> 
ns
->
lba_shiá
);

655 
¿nge
->
¦ba
 = 
	`ýu_to_Ë64
(
	`nvme_block_Ä
(
ns
, 
	`blk_rq_pos
(
»q
)));

658 
	`mem£t
(
cmnd
, 0, (*cmnd));

659 
cmnd
->
dsm
.
Ýcode
 = 
nvme_cmd_dsm
;

660 
cmnd
->
dsm
.
nsid
 = 
	`ýu_to_Ë32
(
ns
->
h—d
->
ns_id
);

661 #ifdeà
HAVE_BLK_RQ_NR_DISCARD_SEGMENTS


662 
cmnd
->
dsm
.
Ä
 = 
	`ýu_to_Ë32
(
£gm’ts
 - 1);

664 
cmnd
->
dsm
.
Ä
 = 0;

666 
cmnd
->
dsm
.
©Œibu‹s
 = 
	`ýu_to_Ë32
(
NVME_DSMGMT_AD
);

668 #iâdeà
HAVE_REQUEST_RQ_FLAGS


669 
»q
->
com¶‘iÚ_d©a
 = 
¿nge
;

670 
·ge
 = 
	`vœt_to_·ge
(
¿nge
);

671 
off£t
 = 
	`off£t_š_·ge
(
¿nge
);

672 #ifdeà
HAVE_BLK_ADD_REQUEST_PAYLOAD_HAS_4_PARAMS


673 
	`blk_add_»que¡_·ylßd
(
»q
, 
·ge
, 
off£t
, (*
¿nge
));

675 
	`blk_add_»que¡_·ylßd
(
»q
, 
·ge
, (*
¿nge
));

676 
»q
->
bio
->
bi_io_vec
->
bv_off£t
 = 
off£t
;

684 
»q
->
__d©a_Ën
 = 
Ä_by‹s
;

686 
»q
->
¥ecŸl_vec
.
bv_·ge
 = 
	`vœt_to_·ge
(
¿nge
);

687 
»q
->
¥ecŸl_vec
.
bv_off£t
 = 
	`off£t_š_·ge
(
¿nge
);

688 #ifdeà
HAVE_BLK_RQ_NR_DISCARD_SEGMENTS


689 
»q
->
¥ecŸl_vec
.
bv_Ën
 = (*
¿nge
è* 
£gm’ts
;

691 
»q
->
¥ecŸl_vec
.
bv_Ën
 = (*
¿nge
);

693 
»q
->
rq_æags
 |ð
RQF_SPECIAL_PAYLOAD
;

696  
BLK_STS_OK
;

697 
	}
}

699 
šlše
 
blk_¡©us_t
 
	$nvme_£tup_rw
(
nvme_ns
 *
ns
,

700 
»que¡
 *
»q
, 
nvme_commªd
 *
cmnd
)

702 #ifdeà
HAVE_BLK_MAX_WRITE_HINTS


703 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

705 
u16
 
cÚŒÞ
 = 0;

706 
u32
 
dsmgmt
 = 0;

708 ià(
»q
->
cmd_æags
 & 
REQ_FUA
)

709 
cÚŒÞ
 |ð
NVME_RW_FUA
;

710 ià(
»q
->
cmd_æags
 & (
REQ_FAILFAST_DEV
 | 
REQ_RAHEAD
))

711 
cÚŒÞ
 |ð
NVME_RW_LR
;

713 ià(
»q
->
cmd_æags
 & 
REQ_RAHEAD
)

714 
dsmgmt
 |ð
NVME_RW_DSM_FREQ_PREFETCH
;

716 
	`mem£t
(
cmnd
, 0, (*cmnd));

717 
cmnd
->
rw
.
Ýcode
 = (
	`rq_d©a_dœ
(
»q
è? 
nvme_cmd_wr™e
 : 
nvme_cmd_»ad
);

718 
cmnd
->
rw
.
nsid
 = 
	`ýu_to_Ë32
(
ns
->
h—d
->
ns_id
);

719 
cmnd
->
rw
.
¦ba
 = 
	`ýu_to_Ë64
(
	`nvme_block_Ä
(
ns
, 
	`blk_rq_pos
(
»q
)));

720 
cmnd
->
rw
.
Ëngth
 = 
	`ýu_to_Ë16
((
	`blk_rq_by‹s
(
»q
è>> 
ns
->
lba_shiá
) - 1);

722 #ifdeà
HAVE_BLK_MAX_WRITE_HINTS


723 ià(
	`»q_Ý
(
»q
è=ð
REQ_OP_WRITE
 && 
ù¾
->
Ä_¡»ams
)

724 
	`nvme_assign_wr™e_¡»am
(
ù¾
, 
»q
, &
cÚŒÞ
, &
dsmgmt
);

727 ià(
ns
->
ms
) {

734 ià(!
	`blk_š‹gr™y_rq
(
»q
)) {

735 ià(
	`WARN_ON_ONCE
(!
	`nvme_ns_has_pi
(
ns
)))

736  
BLK_STS_NOTSUPP
;

737 
cÚŒÞ
 |ð
NVME_RW_PRINFO_PRACT
;

740 
ns
->
pi_ty³
) {

741 
NVME_NS_DPS_PI_TYPE3
:

742 
cÚŒÞ
 |ð
NVME_RW_PRINFO_PRCHK_GUARD
;

744 
NVME_NS_DPS_PI_TYPE1
:

745 
NVME_NS_DPS_PI_TYPE2
:

746 
cÚŒÞ
 |ð
NVME_RW_PRINFO_PRCHK_GUARD
 |

747 
NVME_RW_PRINFO_PRCHK_REF
;

748 
cmnd
->
rw
.
»áag
 = 
	`ýu_to_Ë32
(

749 
	`nvme_block_Ä
(
ns
, 
	`blk_rq_pos
(
»q
)));

754 
cmnd
->
rw
.
cÚŒÞ
 = 
	`ýu_to_Ë16
(control);

755 
cmnd
->
rw
.
dsmgmt
 = 
	`ýu_to_Ë32
(dsmgmt);

757 
	}
}

759 
blk_¡©us_t
 
	$nvme_£tup_cmd
(
nvme_ns
 *
ns
, 
»que¡
 *
»q
,

760 
nvme_commªd
 *
cmd
)

762 
blk_¡©us_t
 
»t
 = 
BLK_STS_OK
;

764 
	`nvme_þ—r_nvme_»que¡
(
»q
);

766 #ifdeà
HAVE_BLK_TYPES_REQ_OP_DRV_OUT


767 
	`»q_Ý
(
»q
)) {

768 
REQ_OP_DRV_IN
:

769 
REQ_OP_DRV_OUT
:

770 
	`memýy
(
cmd
, 
	`nvme_»q
(
»q
)->cmd, (*cmd));

772 
REQ_OP_FLUSH
:

773 
	`nvme_£tup_æush
(
ns
, 
cmd
);

775 #ifdeà
HAVE_BLK_QUEUE_MAX_WRITE_ZEROES_SECTORS


776 
REQ_OP_WRITE_ZEROES
:

779 
REQ_OP_DISCARD
:

780 
»t
 = 
	`nvme_£tup_disÿrd
(
ns
, 
»q
, 
cmd
);

782 
REQ_OP_READ
:

783 
REQ_OP_WRITE
:

784 
»t
 = 
	`nvme_£tup_rw
(
ns
, 
»q
, 
cmd
);

787 
	`WARN_ON_ONCE
(1);

788  
BLK_STS_IOERR
;

791 #ifdeà
HAVE_BLKDEV_REQ_TYPE_DRV_PRIV


792 ià(
»q
->
cmd_ty³
 =ð
REQ_TYPE_DRV_PRIV
)

794 ià(
»q
->
cmd_ty³
 =ð
REQ_TYPE_SPECIAL
)

796 
	`memýy
(
cmd
, 
	`nvme_»q
(
»q
)->cmd, (*cmd));

797 #ifdeà
HAVE_BLK_TYPES_REQ_OP_FLUSH


798 ià(
	`»q_Ý
(
»q
è=ð
REQ_OP_FLUSH
)

800 ià(
»q
->
cmd_æags
 & 
REQ_FLUSH
)

802 
	`nvme_£tup_æush
(
ns
, 
cmd
);

803 #ifdeà
HAVE_BLK_TYPES_REQ_OP_DISCARD


804 ià(
	`»q_Ý
(
»q
è=ð
REQ_OP_DISCARD
)

806 ià(
»q
->
cmd_æags
 & 
REQ_DISCARD
)

808 
»t
 = 
	`nvme_£tup_disÿrd
(
ns
, 
»q
, 
cmd
);

810 
	`nvme_£tup_rw
(
ns
, 
»q
, 
cmd
);

813 
cmd
->
commÚ
.
commªd_id
 = 
»q
->
g
;

814 ià(
ns
)

815 
	`Œaû_nvme_£tup_nvm_cmd
(
»q
->
q
->
id
, 
cmd
);

817 
	`Œaû_nvme_£tup_admš_cmd
(
cmd
);

818  
»t
;

819 
	}
}

820 
EXPORT_SYMBOL_GPL
(
nvme_£tup_cmd
);

826 #ifdeà
HAVE_BLK_MQ_ALLOC_REQUEST_HAS_3_PARAMS


827 
	$__nvme_subm™_sync_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

828 
nvme_»suÉ
 *
»suÉ
, *
bufãr
, 
bufæ’
,

829 
timeout
, 
qid
, 
©_h—d
,

830 
blk_mq_»q_æags_t
 
æags
)

832 
	$__nvme_subm™_sync_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

833 
nvme_»suÉ
 *
»suÉ
, *
bufãr
, 
bufæ’
,

834 
timeout
, 
qid
, 
©_h—d
, 
gå_t
 
gå
, 
boÞ
 
»£rved
)

837 
»que¡
 *
»q
;

838 
»t
;

840 #ifdeà
HAVE_BLK_MQ_ALLOC_REQUEST_HAS_3_PARAMS


841 
»q
 = 
	`nvme_®loc_»que¡
(
q
, 
cmd
, 
æags
, 
qid
);

843 
»q
 = 
	`nvme_®loc_»que¡
(
q
, 
cmd
, 
gå
, 
»£rved
, 
qid
);

845 ià(
	`IS_ERR
(
»q
))

846  
	`PTR_ERR
(
»q
);

848 
»q
->
timeout
 =imeouˆ?imeouˆ: 
ADMIN_TIMEOUT
;

850 ià(
bufãr
 && 
bufæ’
) {

851 
»t
 = 
	`blk_rq_m­_k”n
(
q
, 
»q
, 
bufãr
, 
bufæ’
, 
GFP_KERNEL
);

852 ià(
»t
)

853 
out
;

856 
	`blk_execu‹_rq
(
»q
->
q
, 
NULL
,„eq, 
©_h—d
);

857 ià(
»suÉ
)

858 *
»suÉ
 = 
	`nvme_»q
(
»q
)->result;

859 ià(
	`nvme_»q
(
»q
)->
æags
 & 
NVME_REQ_CANCELLED
)

860 
»t
 = -
EINTR
;

862 
»t
 = 
	`nvme_»q
(
»q
)->
¡©us
;

863 
out
:

864 
	`blk_mq_ä“_»que¡
(
»q
);

865  
»t
;

866 
	}
}

867 
EXPORT_SYMBOL_GPL
(
__nvme_subm™_sync_cmd
);

869 
	$nvme_subm™_sync_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

870 *
bufãr
, 
bufæ’
)

872 #ifdeà
HAVE_BLK_MQ_ALLOC_REQUEST_HAS_3_PARAMS


873  
	`__nvme_subm™_sync_cmd
(
q
, 
cmd
, 
NULL
, 
bufãr
, 
bufæ’
, 0,

874 
NVME_QID_ANY
, 0, 0);

876  
	`__nvme_subm™_sync_cmd
(
q
, 
cmd
, 
NULL
, 
bufãr
, 
bufæ’
, 0,

877 
NVME_QID_ANY
, 0, 
GFP_KERNEL
, 
çl£
);

879 
	}
}

880 
EXPORT_SYMBOL_GPL
(
nvme_subm™_sync_cmd
);

882 *
	$nvme_add_u£r_m‘ad©a
(
bio
 *bio, 
__u£r
 *
ubuf
,

883 
Ën
, 
u32
 
£ed
, 
boÞ
 
wr™e
)

885 
bio_š‹gr™y_·ylßd
 *
b
;

886 
»t
 = -
ENOMEM
;

887 *
buf
;

889 
buf
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

890 ià(!
buf
)

891 
out
;

893 
»t
 = -
EFAULT
;

894 ià(
wr™e
 && 
	`cÝy_äom_u£r
(
buf
, 
ubuf
, 
Ën
))

895 
out_ä“_m‘a
;

897 
b
 = 
	`bio_š‹gr™y_®loc
(
bio
, 
GFP_KERNEL
, 1);

898 ià(
	`IS_ERR
(
b
)) {

899 
»t
 = 
	`PTR_ERR
(
b
);

900 
out_ä“_m‘a
;

903 #ifdeà
HAVE_BIO_INTEGRITY_PYLD_BIP_ITER


904 
b
->
b_™”
.
bi_size
 = 
Ën
;

905 
b
->
b_™”
.
bi_£ùÜ
 = 
£ed
;

907 
»t
 = 
	`bio_š‹gr™y_add_·ge
(
bio
, 
	`vœt_to_·ge
(
buf
), 
Ën
,

908 
	`off£t_š_·ge
(
buf
));

909 ià(
»t
 =ð
Ën
)

910  
buf
;

911 
»t
 = -
ENOMEM
;

912 
out_ä“_m‘a
:

913 
	`kä“
(
buf
);

914 
out
:

915  
	`ERR_PTR
(
»t
);

916 
	}
}

918 
	$nvme_subm™_u£r_cmd
(
»que¡_queue
 *
q
,

919 
nvme_commªd
 *
cmd
, 
__u£r
 *
ubufãr
,

920 
bufæ’
, 
__u£r
 *
m‘a_bufãr
, 
m‘a_Ën
,

921 
u32
 
m‘a_£ed
, u32 *
»suÉ
, 
timeout
)

923 
boÞ
 
wr™e
 = 
	`nvme_is_wr™e
(
cmd
);

924 
nvme_ns
 *
ns
 = 
q
->
queued©a
;

925 
g’disk
 *
disk
 = 
ns
 ?‚s->disk : 
NULL
;

926 
»que¡
 *
»q
;

927 
bio
 *biØð
NULL
;

928 *
m‘a
 = 
NULL
;

929 
»t
;

931 #ifdeà
HAVE_BLK_MQ_ALLOC_REQUEST_HAS_3_PARAMS


932 
»q
 = 
	`nvme_®loc_»que¡
(
q
, 
cmd
, 0, 
NVME_QID_ANY
);

934 
»q
 = 
	`nvme_®loc_»que¡
(
q
, 
cmd
, 
GFP_KERNEL
, 
çl£
, 
NVME_QID_ANY
);

936 ià(
	`IS_ERR
(
»q
))

937  
	`PTR_ERR
(
»q
);

939 
»q
->
timeout
 =imeouˆ?imeouˆ: 
ADMIN_TIMEOUT
;

940 
	`nvme_»q
(
»q
)->
æags
 |ð
NVME_REQ_USERCMD
;

942 ià(
ubufãr
 && 
bufæ’
) {

943 
»t
 = 
	`blk_rq_m­_u£r
(
q
, 
»q
, 
NULL
, 
ubufãr
, 
bufæ’
,

944 
GFP_KERNEL
);

945 ià(
»t
)

946 
out
;

947 
bio
 = 
»q
->bio;

948 #ifdeà
HAVE_BIO_BI_DISK


949 
bio
->
bi_disk
 = 
disk
;

951 ià(
disk
) {

952 
bio
->
bi_bdev
 = 
	`bdg‘_disk
(
disk
, 0);

953 ià(!
bio
->
bi_bdev
) {

954 
»t
 = -
ENODEV
;

955 
out_unm­
;

959 ià(
disk
 && 
m‘a_bufãr
 && 
m‘a_Ën
) {

960 
m‘a
 = 
	`nvme_add_u£r_m‘ad©a
(
bio
, 
m‘a_bufãr
, 
m‘a_Ën
,

961 
m‘a_£ed
, 
wr™e
);

962 ià(
	`IS_ERR
(
m‘a
)) {

963 
»t
 = 
	`PTR_ERR
(
m‘a
);

964 
out_unm­
;

966 #ifdeà
HAVE_BLK_TYPES_REQ_INTEGRITY


967 
»q
->
cmd_æags
 |ð
REQ_INTEGRITY
;

972 
	`blk_execu‹_rq
(
»q
->
q
, 
disk
,„eq, 0);

973 ià(
	`nvme_»q
(
»q
)->
æags
 & 
NVME_REQ_CANCELLED
)

974 
»t
 = -
EINTR
;

976 
»t
 = 
	`nvme_»q
(
»q
)->
¡©us
;

977 ià(
»suÉ
)

978 *
»suÉ
 = 
	`Ë32_to_ýu
(
	`nvme_»q
(
»q
)->»suÉ.
u32
);

979 ià(
m‘a
 && !
»t
 && !
wr™e
) {

980 ià(
	`cÝy_to_u£r
(
m‘a_bufãr
, 
m‘a
, 
m‘a_Ën
))

981 
»t
 = -
EFAULT
;

983 
	`kä“
(
m‘a
);

984 
out_unm­
:

985 #ifdeà
HAVE_BIO_BI_DISK


986 ià(
bio
)

987 
	`blk_rq_unm­_u£r
(
bio
);

989 ià(
bio
) {

990 ià(
disk
 && 
bio
->
bi_bdev
)

991 
	`bdput
(
bio
->
bi_bdev
);

992 
	`blk_rq_unm­_u£r
(
bio
);

995 
out
:

996 
	`blk_mq_ä“_»que¡
(
»q
);

997  
»t
;

998 
	}
}

1000 
	$nvme_k“p_®ive_’d_io
(
»que¡
 *
rq
, 
blk_¡©us_t
 
¡©us
)

1002 
nvme_ù¾
 *
ù¾
 = 
rq
->
’d_io_d©a
;

1004 
	`blk_mq_ä“_»que¡
(
rq
);

1006 ià(
¡©us
) {

1007 
	`dev_”r
(
ù¾
->
deviû
,

1009 
¡©us
);

1013 
	`scheduË_d–ayed_wÜk
(&
ù¾
->
ka_wÜk
, cŒl->
k©o
 * 
HZ
);

1014 
	}
}

1016 
	$nvme_k“p_®ive
(
nvme_ù¾
 *
ù¾
)

1018 
»que¡
 *
rq
;

1020 #ifdeà
HAVE_BLK_MQ_ALLOC_REQUEST_HAS_3_PARAMS


1021 
rq
 = 
	`nvme_®loc_»que¡
(
ù¾
->
admš_q
, &ù¾->
ka_cmd
, 
BLK_MQ_REQ_RESERVED
,

1022 
NVME_QID_ANY
);

1024 
rq
 = 
	`nvme_®loc_»que¡
(
ù¾
->
admš_q
, &ù¾->
ka_cmd
, 
GFP_KERNEL
, 
Œue
,

1025 
NVME_QID_ANY
);

1027 ià(
	`IS_ERR
(
rq
))

1028  
	`PTR_ERR
(
rq
);

1030 
rq
->
timeout
 = 
ù¾
->
k©o
 * 
HZ
;

1031 
rq
->
’d_io_d©a
 = 
ù¾
;

1033 
	`blk_execu‹_rq_nowa™
(
rq
->
q
, 
NULL
,„q, 0, 
nvme_k“p_®ive_’d_io
);

1036 
	}
}

1038 
	$nvme_k“p_®ive_wÜk
(
wÜk_¡ruù
 *
wÜk
)

1040 
nvme_ù¾
 *
ù¾
 = 
	`cÚš”_of
(
	`to_d–ayed_wÜk
(
wÜk
),

1041 
nvme_ù¾
, 
ka_wÜk
);

1043 ià(
	`nvme_k“p_®ive
(
ù¾
)) {

1045 
	`dev_”r
(
ù¾
->
deviû
, "keep-alive failed\n");

1046 
	`nvme_»£t_ù¾
(
ù¾
);

1049 
	}
}

1051 
	$nvme_¡¬t_k“p_®ive
(
nvme_ù¾
 *
ù¾
)

1053 ià(
	`uÆik–y
(
ù¾
->
k©o
 == 0))

1056 
	`INIT_DELAYED_WORK
(&
ù¾
->
ka_wÜk
, 
nvme_k“p_®ive_wÜk
);

1057 
	`mem£t
(&
ù¾
->
ka_cmd
, 0, (ctrl->ka_cmd));

1058 
ù¾
->
ka_cmd
.
commÚ
.
Ýcode
 = 
nvme_admš_k“p_®ive
;

1059 
	`scheduË_d–ayed_wÜk
(&
ù¾
->
ka_wÜk
, cŒl->
k©o
 * 
HZ
);

1060 
	}
}

1062 
	$nvme_¡Ý_k“p_®ive
(
nvme_ù¾
 *
ù¾
)

1064 ià(
	`uÆik–y
(
ù¾
->
k©o
 == 0))

1067 
	`ÿnûl_d–ayed_wÜk_sync
(&
ù¾
->
ka_wÜk
);

1068 
	}
}

1069 
EXPORT_SYMBOL_GPL
(
nvme_¡Ý_k“p_®ive
);

1071 
	$nvme_id’tify_ù¾
(
nvme_ù¾
 *
dev
, 
nvme_id_ù¾
 **
id
)

1073 
nvme_commªd
 
c
 = { };

1074 
”rÜ
;

1077 
c
.
id’tify
.
Ýcode
 = 
nvme_admš_id’tify
;

1078 
c
.
id’tify
.
ús
 = 
NVME_ID_CNS_CTRL
;

1080 *
id
 = 
	`km®loc
((
nvme_id_ù¾
), 
GFP_KERNEL
);

1081 ià(!*
id
)

1082  -
ENOMEM
;

1084 
”rÜ
 = 
	`nvme_subm™_sync_cmd
(
dev
->
admš_q
, &
c
, *
id
,

1085 (
nvme_id_ù¾
));

1086 ià(
”rÜ
)

1087 
	`kä“
(*
id
);

1088  
”rÜ
;

1089 
	}
}

1091 
	$nvme_id’tify_ns_descs
(
nvme_ù¾
 *
ù¾
, 
nsid
,

1092 
nvme_ns_ids
 *
ids
)

1094 
nvme_commªd
 
c
 = { };

1095 
¡©us
;

1096 *
d©a
;

1097 
pos
;

1098 
Ën
;

1100 
c
.
id’tify
.
Ýcode
 = 
nvme_admš_id’tify
;

1101 
c
.
id’tify
.
nsid
 = 
	`ýu_to_Ë32
(nsid);

1102 
c
.
id’tify
.
ús
 = 
NVME_ID_CNS_NS_DESC_LIST
;

1104 
d©a
 = 
	`kz®loc
(
NVME_IDENTIFY_DATA_SIZE
, 
GFP_KERNEL
);

1105 ià(!
d©a
)

1106  -
ENOMEM
;

1108 
¡©us
 = 
	`nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
c
, 
d©a
,

1109 
NVME_IDENTIFY_DATA_SIZE
);

1110 ià(
¡©us
)

1111 
ä“_d©a
;

1113 
pos
 = 0;…o < 
NVME_IDENTIFY_DATA_SIZE
;…o +ð
Ën
) {

1114 
nvme_ns_id_desc
 *
cur
 = 
d©a
 + 
pos
;

1116 ià(
cur
->
nidl
 == 0)

1119 
cur
->
nidt
) {

1120 
NVME_NIDT_EUI64
:

1121 ià(
cur
->
nidl
 !ð
NVME_NIDT_EUI64_LEN
) {

1122 
	`dev_w¬n
(
ù¾
->
deviû
,

1124 
cur
->
nidl
);

1125 
ä“_d©a
;

1127 
Ën
 = 
NVME_NIDT_EUI64_LEN
;

1128 
	`memýy
(
ids
->
eui64
, 
d©a
 + 
pos
 + (*
cur
), 
Ën
);

1130 
NVME_NIDT_NGUID
:

1131 ià(
cur
->
nidl
 !ð
NVME_NIDT_NGUID_LEN
) {

1132 
	`dev_w¬n
(
ù¾
->
deviû
,

1134 
cur
->
nidl
);

1135 
ä“_d©a
;

1137 
Ën
 = 
NVME_NIDT_NGUID_LEN
;

1138 
	`memýy
(
ids
->
nguid
, 
d©a
 + 
pos
 + (*
cur
), 
Ën
);

1140 
NVME_NIDT_UUID
:

1141 ià(
cur
->
nidl
 !ð
NVME_NIDT_UUID_LEN
) {

1142 
	`dev_w¬n
(
ù¾
->
deviû
,

1144 
cur
->
nidl
);

1145 
ä“_d©a
;

1147 
Ën
 = 
NVME_NIDT_UUID_LEN
;

1148 
	`uuid_cÝy
(&
ids
->
uuid
, 
d©a
 + 
pos
 + (*
cur
));

1152 
Ën
 = 
cur
->
nidl
;

1156 
Ën
 +ð(*
cur
);

1158 
ä“_d©a
:

1159 
	`kä“
(
d©a
);

1160  
¡©us
;

1161 
	}
}

1163 
	$nvme_id’tify_ns_li¡
(
nvme_ù¾
 *
dev
, 
nsid
, 
__Ë32
 *
ns_li¡
)

1165 
nvme_commªd
 
c
 = { };

1167 
c
.
id’tify
.
Ýcode
 = 
nvme_admš_id’tify
;

1168 
c
.
id’tify
.
ús
 = 
NVME_ID_CNS_NS_ACTIVE_LIST
;

1169 
c
.
id’tify
.
nsid
 = 
	`ýu_to_Ë32
(nsid);

1170  
	`nvme_subm™_sync_cmd
(
dev
->
admš_q
, &
c
, 
ns_li¡
,

1171 
NVME_IDENTIFY_DATA_SIZE
);

1172 
	}
}

1174 
nvme_id_ns
 *
	$nvme_id’tify_ns
(
nvme_ù¾
 *
ù¾
,

1175 
nsid
)

1177 
nvme_id_ns
 *
id
;

1178 
nvme_commªd
 
c
 = { };

1179 
”rÜ
;

1182 
c
.
id’tify
.
Ýcode
 = 
nvme_admš_id’tify
;

1183 
c
.
id’tify
.
nsid
 = 
	`ýu_to_Ë32
(nsid);

1184 
c
.
id’tify
.
ús
 = 
NVME_ID_CNS_NS
;

1186 
id
 = 
	`km®loc
((*id), 
GFP_KERNEL
);

1187 ià(!
id
)

1188  
NULL
;

1190 
”rÜ
 = 
	`nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
c
, 
id
, (*id));

1191 ià(
”rÜ
) {

1192 
	`dev_w¬n
(
ù¾
->
deviû
, "Identify‚amespace failed\n");

1193 
	`kä“
(
id
);

1194  
NULL
;

1197  
id
;

1198 
	}
}

1200 
	$nvme_£t_ã©u»s
(
nvme_ù¾
 *
dev
, 
fid
, 
dwÜd11
,

1201 *
bufãr
, 
size_t
 
buæ’
, 
u32
 *
»suÉ
)

1203 
nvme_commªd
 
c
;

1204 
nvme_»suÉ
 
»s
;

1205 
»t
;

1207 
	`mem£t
(&
c
, 0, (c));

1208 
c
.
ã©u»s
.
Ýcode
 = 
nvme_admš_£t_ã©u»s
;

1209 
c
.
ã©u»s
.
fid
 = 
	`ýu_to_Ë32
(fid);

1210 
c
.
ã©u»s
.
dwÜd11
 = 
	`ýu_to_Ë32
(dword11);

1212 #ifdeà
HAVE_BLK_MQ_ALLOC_REQUEST_HAS_3_PARAMS


1213 
»t
 = 
	`__nvme_subm™_sync_cmd
(
dev
->
admš_q
, &
c
, &
»s
,

1214 
bufãr
, 
buæ’
, 0, 
NVME_QID_ANY
, 0, 0);

1216 
»t
 = 
	`__nvme_subm™_sync_cmd
(
dev
->
admš_q
, &
c
, &
»s
,

1217 
bufãr
, 
buæ’
, 0, 
NVME_QID_ANY
, 0, 
GFP_KERNEL
, 
çl£
);

1219 ià(
»t
 >ð0 && 
»suÉ
)

1220 *
»suÉ
 = 
	`Ë32_to_ýu
(
»s
.
u32
);

1221  
»t
;

1222 
	}
}

1224 
	$nvme_£t_queue_couÁ
(
nvme_ù¾
 *
ù¾
, *
couÁ
)

1226 
u32
 
q_couÁ
 = (*
couÁ
 - 1) | ((*count - 1) << 16);

1227 
u32
 
»suÉ
;

1228 
¡©us
, 
Ä_io_queues
;

1230 
¡©us
 = 
	`nvme_£t_ã©u»s
(
ù¾
, 
NVME_FEAT_NUM_QUEUES
, 
q_couÁ
, 
NULL
, 0,

1231 &
»suÉ
);

1232 ià(
¡©us
 < 0)

1233  
¡©us
;

1240 ià(
¡©us
 > 0) {

1241 
	`dev_”r
(
ù¾
->
deviû
, "Could‚Ù s‘ queucouÁ (%d)\n", 
¡©us
);

1242 *
couÁ
 = 0;

1244 
Ä_io_queues
 = 
	`mš
(
»suÉ
 & 0xffff,„esult >> 16) + 1;

1245 *
couÁ
 = 
	`mš
(*couÁ, 
Ä_io_queues
);

1249 
	}
}

1250 
EXPORT_SYMBOL_GPL
(
nvme_£t_queue_couÁ
);

1252 
	#NVME_AEN_SUPPORTED
 \

1253 (
NVME_AEN_CFG_NS_ATTR
 | 
NVME_AEN_CFG_FW_ACT
)

	)

1255 
	$nvme_’abË_«n
(
nvme_ù¾
 *
ù¾
)

1257 
u32
 
»suÉ
;

1258 
¡©us
;

1260 
¡©us
 = 
	`nvme_£t_ã©u»s
(
ù¾
, 
NVME_FEAT_ASYNC_EVENT
,

1261 
ù¾
->
ßes
 & 
NVME_AEN_SUPPORTED
, 
NULL
, 0, &
»suÉ
);

1262 ià(
¡©us
)

1263 
	`dev_w¬n
(
ù¾
->
deviû
, "Failedo configure AEN (cfg %x)\n",

1264 
ù¾
->
ßes
 & 
NVME_AEN_SUPPORTED
);

1265 
	}
}

1267 
	$nvme_subm™_io
(
nvme_ns
 *
ns
, 
nvme_u£r_io
 
__u£r
 *
uio
)

1269 
nvme_u£r_io
 
io
;

1270 
nvme_commªd
 
c
;

1271 
Ëngth
, 
m‘a_Ën
;

1272 
__u£r
 *
m‘ad©a
;

1274 ià(
	`cÝy_äom_u£r
(&
io
, 
uio
, (io)))

1275  -
EFAULT
;

1276 ià(
io
.
æags
)

1277  -
EINVAL
;

1279 
io
.
Ýcode
) {

1280 
nvme_cmd_wr™e
:

1281 
nvme_cmd_»ad
:

1282 
nvme_cmd_com·»
:

1285  -
EINVAL
;

1288 
Ëngth
 = (
io
.
nblocks
 + 1è<< 
ns
->
lba_shiá
;

1289 
m‘a_Ën
 = (
io
.
nblocks
 + 1è* 
ns
->
ms
;

1290 
m‘ad©a
 = (
__u£r
 *)(
ušŒ_t
)
io
.metadata;

1292 ià(
ns
->
ext
) {

1293 
Ëngth
 +ð
m‘a_Ën
;

1294 
m‘a_Ën
 = 0;

1295 } ià(
m‘a_Ën
) {

1296 ià((
io
.
m‘ad©a
 & 3) || !io.metadata)

1297  -
EINVAL
;

1300 
	`mem£t
(&
c
, 0, (c));

1301 
c
.
rw
.
Ýcode
 = 
io
.opcode;

1302 
c
.
rw
.
æags
 = 
io
.flags;

1303 
c
.
rw
.
nsid
 = 
	`ýu_to_Ë32
(
ns
->
h—d
->
ns_id
);

1304 
c
.
rw
.
¦ba
 = 
	`ýu_to_Ë64
(
io
.slba);

1305 
c
.
rw
.
Ëngth
 = 
	`ýu_to_Ë16
(
io
.
nblocks
);

1306 
c
.
rw
.
cÚŒÞ
 = 
	`ýu_to_Ë16
(
io
.control);

1307 
c
.
rw
.
dsmgmt
 = 
	`ýu_to_Ë32
(
io
.dsmgmt);

1308 
c
.
rw
.
»áag
 = 
	`ýu_to_Ë32
(
io
.reftag);

1309 
c
.
rw
.
­±ag
 = 
	`ýu_to_Ë16
(
io
.apptag);

1310 
c
.
rw
.
­pmask
 = 
	`ýu_to_Ë16
(
io
.appmask);

1312  
	`nvme_subm™_u£r_cmd
(
ns
->
queue
, &
c
,

1313 (
__u£r
 *)(
ušŒ_t
)
io
.
addr
, 
Ëngth
,

1314 
m‘ad©a
, 
m‘a_Ën
, 
io
.
¦ba
, 
NULL
, 0);

1315 
	}
}

1317 
u32
 
	$nvme_known_admš_efãùs
(
u8
 
Ýcode
)

1319 
Ýcode
) {

1320 
nvme_admš_fÜm©_nvm
:

1321  
NVME_CMD_EFFECTS_CSUPP
 | 
NVME_CMD_EFFECTS_LBCC
 |

1322 
NVME_CMD_EFFECTS_CSE_MASK
;

1323 
nvme_admš_§n™ize_nvm
:

1324  
NVME_CMD_EFFECTS_CSE_MASK
;

1329 
	}
}

1331 
u32
 
	$nvme_·s¡hru_¡¬t
(
nvme_ù¾
 *
ù¾
, 
nvme_ns
 *
ns
,

1332 
u8
 
Ýcode
)

1334 
u32
 
efãùs
 = 0;

1336 ià(
ns
) {

1337 ià(
ù¾
->
efãùs
)

1338 
efãùs
 = 
	`Ë32_to_ýu
(
ù¾
->efãùs->
iocs
[
Ýcode
]);

1339 ià(
efãùs
 & ~
NVME_CMD_EFFECTS_CSUPP
)

1340 
	`dev_w¬n
(
ù¾
->
deviû
,

1342 
Ýcode
, 
efãùs
);

1346 ià(
ù¾
->
efãùs
)

1347 
efãùs
 = 
	`Ë32_to_ýu
(
ù¾
->efãùs->
acs
[
Ýcode
]);

1349 
efãùs
 = 
	`nvme_known_admš_efãùs
(
Ýcode
);

1355 ià(
efãùs
 & (
NVME_CMD_EFFECTS_LBCC
 | 
NVME_CMD_EFFECTS_CSE_MASK
)) {

1356 
	`nvme_¡¬t_ä“ze
(
ù¾
);

1357 
	`nvme_wa™_ä“ze
(
ù¾
);

1359  
efãùs
;

1360 
	}
}

1362 
	$nvme_upd©e_fÜm©s
(
nvme_ù¾
 *
ù¾
)

1364 
nvme_ns
 *
ns
, *
Ãxt
;

1365 
	`LIST_HEAD
(
rm_li¡
);

1367 
	`down_wr™e
(&
ù¾
->
Çme¥aûs_rw£m
);

1368 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
) {

1369 ià(
ns
->
disk
 && 
	`nvme_»v®id©e_disk
(ns->disk)) {

1370 
	`li¡_move_ž
(&
ns
->
li¡
, &
rm_li¡
);

1373 
	`up_wr™e
(&
ù¾
->
Çme¥aûs_rw£m
);

1375 
	`li¡_fÜ_—ch_’Œy_§ã
(
ns
, 
Ãxt
, &
rm_li¡
, 
li¡
)

1376 
	`nvme_ns_»move
(
ns
);

1377 
	}
}

1379 
	$nvme_·s¡hru_’d
(
nvme_ù¾
 *
ù¾
, 
u32
 
efãùs
)

1386 ià(
efãùs
 & 
NVME_CMD_EFFECTS_LBCC
)

1387 
	`nvme_upd©e_fÜm©s
(
ù¾
);

1388 ià(
efãùs
 & (
NVME_CMD_EFFECTS_LBCC
 | 
NVME_CMD_EFFECTS_CSE_MASK
))

1389 
	`nvme_unä“ze
(
ù¾
);

1390 ià(
efãùs
 & 
NVME_CMD_EFFECTS_CCC
)

1391 
	`nvme_š™_id’tify
(
ù¾
);

1392 ià(
efãùs
 & (
NVME_CMD_EFFECTS_NIC
 | 
NVME_CMD_EFFECTS_NCC
))

1393 
	`nvme_queue_sÿn
(
ù¾
);

1394 
	}
}

1396 
	$nvme_u£r_cmd
(
nvme_ù¾
 *
ù¾
, 
nvme_ns
 *
ns
,

1397 
nvme_·s¡hru_cmd
 
__u£r
 *
ucmd
)

1399 
nvme_·s¡hru_cmd
 
cmd
;

1400 
nvme_commªd
 
c
;

1401 
timeout
 = 0;

1402 
u32
 
efãùs
;

1403 
¡©us
;

1405 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

1406  -
EACCES
;

1407 ià(
	`cÝy_äom_u£r
(&
cmd
, 
ucmd
, (cmd)))

1408  -
EFAULT
;

1409 ià(
cmd
.
æags
)

1410  -
EINVAL
;

1412 
	`mem£t
(&
c
, 0, (c));

1413 
c
.
commÚ
.
Ýcode
 = 
cmd
.opcode;

1414 
c
.
commÚ
.
æags
 = 
cmd
.flags;

1415 
c
.
commÚ
.
nsid
 = 
	`ýu_to_Ë32
(
cmd
.nsid);

1416 
c
.
commÚ
.
cdw2
[0] = 
	`ýu_to_Ë32
(
cmd
.cdw2);

1417 
c
.
commÚ
.
cdw2
[1] = 
	`ýu_to_Ë32
(
cmd
.
cdw3
);

1418 
c
.
commÚ
.
cdw10
[0] = 
	`ýu_to_Ë32
(
cmd
.cdw10);

1419 
c
.
commÚ
.
cdw10
[1] = 
	`ýu_to_Ë32
(
cmd
.
cdw11
);

1420 
c
.
commÚ
.
cdw10
[2] = 
	`ýu_to_Ë32
(
cmd
.
cdw12
);

1421 
c
.
commÚ
.
cdw10
[3] = 
	`ýu_to_Ë32
(
cmd
.
cdw13
);

1422 
c
.
commÚ
.
cdw10
[4] = 
	`ýu_to_Ë32
(
cmd
.
cdw14
);

1423 
c
.
commÚ
.
cdw10
[5] = 
	`ýu_to_Ë32
(
cmd
.
cdw15
);

1425 ià(
cmd
.
timeout_ms
)

1426 
timeout
 = 
	`m£cs_to_jiff›s
(
cmd
.
timeout_ms
);

1428 
efãùs
 = 
	`nvme_·s¡hru_¡¬t
(
ù¾
, 
ns
, 
cmd
.
Ýcode
);

1429 
¡©us
 = 
	`nvme_subm™_u£r_cmd
(
ns
 ?‚s->
queue
 : 
ù¾
->
admš_q
, &
c
,

1430 (
__u£r
 *)(
ušŒ_t
)
cmd
.
addr
, cmd.
d©a_Ën
,

1431 (
__u£r
 *)(
ušŒ_t
)
cmd
.
m‘ad©a
, cmd.metadata,

1432 0, &
cmd
.
»suÉ
, 
timeout
);

1433 
	`nvme_·s¡hru_’d
(
ù¾
, 
efãùs
);

1435 ià(
¡©us
 >= 0) {

1436 ià(
	`put_u£r
(
cmd
.
»suÉ
, &
ucmd
->result))

1437  -
EFAULT
;

1440  
¡©us
;

1441 
	}
}

1447 
nvme_ns
 *
	$nvme_g‘_ns_äom_disk
(
g’disk
 *
disk
,

1448 
nvme_ns_h—d
 **
h—d
, *
¤cu_idx
)

1450 #ifdeà
CONFIG_NVME_MULTIPATH


1451 ià(
disk
->
fÝs
 =ð&
nvme_ns_h—d_Ýs
) {

1452 *
h—d
 = 
disk
->
´iv©e_d©a
;

1453 *
¤cu_idx
 = 
	`¤cu_»ad_lock
(&(*
h—d
)->
¤cu
);

1454  
	`nvme_fšd_·th
(*
h—d
);

1457 *
h—d
 = 
NULL
;

1458 *
¤cu_idx
 = -1;

1459  
disk
->
´iv©e_d©a
;

1460 
	}
}

1462 
	$nvme_put_ns_äom_disk
(
nvme_ns_h—d
 *
h—d
, 
idx
)

1464 ià(
h—d
)

1465 
	`¤cu_»ad_uÆock
(&
h—d
->
¤cu
, 
idx
);

1466 
	}
}

1468 
	$nvme_ns_ioùl
(
nvme_ns
 *
ns
, 
cmd
, 
¬g
)

1470 
cmd
) {

1471 
NVME_IOCTL_ID
:

1472 
	`fÜû_sucûssful_sysÿÎ_»tuº
();

1473  
ns
->
h—d
->
ns_id
;

1474 
NVME_IOCTL_ADMIN_CMD
:

1475  
	`nvme_u£r_cmd
(
ns
->
ù¾
, 
NULL
, (
__u£r
 *)
¬g
);

1476 
NVME_IOCTL_IO_CMD
:

1477  
	`nvme_u£r_cmd
(
ns
->
ù¾
,‚s, (
__u£r
 *)
¬g
);

1478 
NVME_IOCTL_SUBMIT_IO
:

1479  
	`nvme_subm™_io
(
ns
, (
__u£r
 *)
¬g
);

1481 #ifdeà
HAVE_NVM_USER_VIO


1482 #ifdeà
CONFIG_NVM


1483 ià(
ns
->
ndev
)

1484  
	`nvme_nvm_ioùl
(
ns
, 
cmd
, 
¬g
);

1487 #ifdeà
HAVE_LINUX_SED_OPAL_H


1488 ià(
	`is_£d_ioùl
(
cmd
))

1489  
	`£d_ioùl
(
ns
->
ù¾
->
Ý®_dev
, 
cmd
,

1490 (
__u£r
 *è
¬g
);

1492  -
ENOTTY
;

1494 
	}
}

1496 
	$nvme_ioùl
(
block_deviû
 *
bdev
, 
fmode_t
 
mode
,

1497 
cmd
, 
¬g
)

1499 
nvme_ns_h—d
 *
h—d
 = 
NULL
;

1500 
nvme_ns
 *
ns
;

1501 
¤cu_idx
, 
»t
;

1503 
ns
 = 
	`nvme_g‘_ns_äom_disk
(
bdev
->
bd_disk
, &
h—d
, &
¤cu_idx
);

1504 ià(
	`uÆik–y
(!
ns
))

1505 
»t
 = -
EWOULDBLOCK
;

1507 
»t
 = 
	`nvme_ns_ioùl
(
ns
, 
cmd
, 
¬g
);

1508 
	`nvme_put_ns_äom_disk
(
h—d
, 
¤cu_idx
);

1509  
»t
;

1510 
	}
}

1512 
	$nvme_Ý’
(
block_deviû
 *
bdev
, 
fmode_t
 
mode
)

1514 
nvme_ns
 *
ns
 = 
bdev
->
bd_disk
->
´iv©e_d©a
;

1516 #ifdeà
CONFIG_NVME_MULTIPATH


1518 ià(
	`WARN_ON_ONCE
(
ns
->
h—d
->
disk
))

1519 
çž
;

1521 ià(!
	`k»f_g‘_uÆess_z”o
(&
ns
->
k»f
))

1522 
çž
;

1523 ià(!
	`Œy_moduË_g‘
(
ns
->
ù¾
->
Ýs
->
moduË
))

1524 
çž_put_ns
;

1528 
çž_put_ns
:

1529 
	`nvme_put_ns
(
ns
);

1530 
çž
:

1531  -
ENXIO
;

1532 
	}
}

1534 
	$nvme_»Ëa£
(
g’disk
 *
disk
, 
fmode_t
 
mode
)

1536 
nvme_ns
 *
ns
 = 
disk
->
´iv©e_d©a
;

1538 
	`moduË_put
(
ns
->
ù¾
->
Ýs
->
moduË
);

1539 
	`nvme_put_ns
(
ns
);

1540 
	}
}

1542 
	$nvme_g‘geo
(
block_deviû
 *
bdev
, 
hd_geom‘ry
 *
geo
)

1545 
geo
->
h—ds
 = 1 << 6;

1546 
geo
->
£ùÜs
 = 1 << 5;

1547 
geo
->
cylšd”s
 = 
	`g‘_ÿ·c™y
(
bdev
->
bd_disk
) >> 11;

1549 
	}
}

1551 #ifdeà
CONFIG_BLK_DEV_INTEGRITY


1552 #ifdeà
HAVE_BLK_INTEGRITY_DEVICE_CAPABLE


1553 
	$nvme_š™_š‹gr™y
(
g’disk
 *
disk
, 
u16
 
ms
, 
u8
 
pi_ty³
)

1555 
blk_š‹gr™y
 
š‹gr™y
;

1557 
	`mem£t
(&
š‹gr™y
, 0, (integrity));

1558 
pi_ty³
) {

1559 
NVME_NS_DPS_PI_TYPE3
:

1560 
š‹gr™y
.
´ofže
 = &
t10_pi_ty³3_üc
;

1561 
š‹gr™y
.
g_size
 = (
u16
è+ (
u32
);

1562 
š‹gr™y
.
æags
 |ð
BLK_INTEGRITY_DEVICE_CAPABLE
;

1564 
NVME_NS_DPS_PI_TYPE1
:

1565 
NVME_NS_DPS_PI_TYPE2
:

1566 
š‹gr™y
.
´ofže
 = &
t10_pi_ty³1_üc
;

1567 
š‹gr™y
.
g_size
 = (
u16
);

1568 
š‹gr™y
.
æags
 |ð
BLK_INTEGRITY_DEVICE_CAPABLE
;

1571 
š‹gr™y
.
´ofže
 = 
NULL
;

1574 
š‹gr™y
.
tu¶e_size
 = 
ms
;

1575 
	`blk_š‹gr™y_»gi¡”
(
disk
, &
š‹gr™y
);

1576 
	`blk_queue_max_š‹gr™y_£gm’ts
(
disk
->
queue
, 1);

1577 
	}
}

1579 
	$nvme_š™_š‹gr™y
(
g’disk
 *
disk
, 
u16
 
ms
, 
u8
 
pi_ty³
)

1581 
blk_š‹gr™y
 
š‹gr™y
;

1583 
	`mem£t
(&
š‹gr™y
, 0, (integrity));

1584 
š‹gr™y
.
g_size
 = 
pi_ty³
 ? (
u16
è+ (
u32
)

1585 : (
u16
);

1586 
š‹gr™y
.
tu¶e_size
 = 
ms
;

1587 
	`blk_š‹gr™y_»gi¡”
(
disk
, &
š‹gr™y
);

1588 
	`blk_queue_max_š‹gr™y_£gm’ts
(
disk
->
queue
, 1);

1589 
	}
}

1592 
	$nvme_š™_š‹gr™y
(
g’disk
 *
disk
, 
u16
 
ms
, 
u8
 
pi_ty³
)

1594 
	}
}

1597 
	$nvme_£t_chunk_size
(
nvme_ns
 *
ns
)

1599 
u32
 
chunk_size
 = (((u32)
ns
->
noiob
è<< (ns->
lba_shiá
 - 9));

1600 
	`blk_queue_chunk_£ùÜs
(
ns
->
queue
, 
	`rounddown_pow_of_two
(
chunk_size
));

1601 
	}
}

1603 
	$nvme_cÚfig_disÿrd
(
nvme_ns
 *
ns
)

1605 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

1606 
»que¡_queue
 *
queue
 = 
ns
->queue;

1607 
u32
 
size
 = 
	`queue_logiÿl_block_size
(
queue
);

1609 ià(!(
ù¾
->
Úcs
 & 
NVME_CTRL_ONCS_DSM
)) {

1610 
	`blk_queue_æag_þ—r
(
QUEUE_FLAG_DISCARD
, 
queue
);

1614 #ifdeà
HAVE_BLK_MAX_WRITE_HINTS


1615 ià(
ù¾
->
Ä_¡»ams
 && 
ns
->
sws
 &&‚s->
sgs
)

1616 
size
 *ð
ns
->
sws
 *‚s->
sgs
;

1619 #ifdeà
HAVE_BLK_RQ_NR_DISCARD_SEGMENTS


1620 
	`BUILD_BUG_ON
(
PAGE_SIZE
 / (
nvme_dsm_¿nge
) <

1621 
NVME_DSM_MAX_RANGES
);

1624 #iâdeà
HAVE_BLK_QUEUE_MAX_WRITE_ZEROES_SECTORS


1625 ià(
ù¾
->
quœks
 & 
NVME_QUIRK_DISCARD_ZEROES
)

1626 
queue
->
lim™s
.
disÿrd_z”Ûs_d©a
 = 1;

1628 
queue
->
lim™s
.
disÿrd_z”Ûs_d©a
 = 0;

1631 
queue
->
lim™s
.
disÿrd_®ignm’t
 = 0;

1632 
queue
->
lim™s
.
disÿrd_g¿nuÏr™y
 = 
size
;

1635 ià(
	`blk_queue_æag_‹¡_ªd_£t
(
QUEUE_FLAG_DISCARD
, 
queue
))

1638 
	`blk_queue_max_disÿrd_£ùÜs
(
queue
, 
UINT_MAX
);

1639 #ifdeà
HAVE_BLK_RQ_NR_DISCARD_SEGMENTS


1640 
	`blk_queue_max_disÿrd_£gm’ts
(
queue
, 
NVME_DSM_MAX_RANGES
);

1643 #ifdeà
HAVE_BLK_QUEUE_MAX_WRITE_ZEROES_SECTORS


1644 ià(
ù¾
->
quœks
 & 
NVME_QUIRK_DEALLOCATE_ZEROES
)

1645 
	`blk_queue_max_wr™e_z”Ûs_£ùÜs
(
queue
, 
UINT_MAX
);

1647 
	}
}

1649 
	$nvme_»pÜt_ns_ids
(
nvme_ù¾
 *
ù¾
, 
nsid
,

1650 
nvme_id_ns
 *
id
, 
nvme_ns_ids
 *
ids
)

1652 
	`mem£t
(
ids
, 0, (*ids));

1654 ià(
ù¾
->
vs
 >ð
	`NVME_VS
(1, 1, 0))

1655 
	`memýy
(
ids
->
eui64
, 
id
->eui64, (id->eui64));

1656 ià(
ù¾
->
vs
 >ð
	`NVME_VS
(1, 2, 0))

1657 
	`memýy
(
ids
->
nguid
, 
id
->nguid, (id->nguid));

1658 ià(
ù¾
->
vs
 >ð
	`NVME_VS
(1, 3, 0)) {

1662 ià(
	`nvme_id’tify_ns_descs
(
ù¾
, 
nsid
, 
ids
))

1663 
	`dev_w¬n
(
ù¾
->
deviû
,

1664 "%s: Id’tify DesütÜ çžed\n", 
__func__
);

1666 
	}
}

1668 
boÞ
 
	$nvme_ns_ids_v®id
(
nvme_ns_ids
 *
ids
)

1670 #ifdeà
HAVE_UUID_IS_NULL


1671  !
	`uuid_is_nuÎ
(&
ids
->
uuid
) ||

1673  
çl£
 ||

1675 
	`memchr_šv
(
ids
->
nguid
, 0, (ids->nguid)) ||

1676 
	`memchr_šv
(
ids
->
eui64
, 0, (ids->eui64));

1677 
	}
}

1679 
boÞ
 
	$nvme_ns_ids_equ®
(
nvme_ns_ids
 *
a
, nvme_ns_id *
b
)

1681  
	`uuid_equ®
(&
a
->
uuid
, &
b
->uuid) &&

1682 
	`memcmp
(&
a
->
nguid
, &
b
->nguid, (a->nguid)) == 0 &&

1683 
	`memcmp
(&
a
->
eui64
, &
b
->eui64, (a->eui64)) == 0;

1684 
	}
}

1686 
	$nvme_upd©e_disk_šfo
(
g’disk
 *
disk
,

1687 
nvme_ns
 *
ns
, 
nvme_id_ns
 *
id
)

1689 
£ùÜ_t
 
ÿ·c™y
 = 
	`Ë64_to_ýup
(&
id
->
nsze
è<< (
ns
->
lba_shiá
 - 9);

1690 
bs
 = 1 << 
ns
->
lba_shiá
;

1692 
	`blk_mq_ä“ze_queue
(
disk
->
queue
);

1693 
	`blk_š‹gr™y_uÄegi¡”
(
disk
);

1695 
	`blk_queue_logiÿl_block_size
(
disk
->
queue
, 
bs
);

1696 
	`blk_queue_physiÿl_block_size
(
disk
->
queue
, 
bs
);

1697 
	`blk_queue_io_mš
(
disk
->
queue
, 
bs
);

1699 ià(
ns
->
ms
 && !ns->
ext
 &&

1700 (
ns
->
ù¾
->
Ýs
->
æags
 & 
NVME_F_METADATA_SUPPORTED
))

1701 
	`nvme_š™_š‹gr™y
(
disk
, 
ns
->
ms
,‚s->
pi_ty³
);

1702 ià(
ns
->
ms
 && !
	`nvme_ns_has_pi
Òsè&& !
	`blk_g‘_š‹gr™y
(
disk
))

1703 
ÿ·c™y
 = 0;

1705 
	`£t_ÿ·c™y
(
disk
, 
ÿ·c™y
);

1706 
	`nvme_cÚfig_disÿrd
(
ns
);

1707 
	`blk_mq_unä“ze_queue
(
disk
->
queue
);

1708 
	}
}

1710 
	$__nvme_»v®id©e_disk
(
g’disk
 *
disk
, 
nvme_id_ns
 *
id
)

1712 
nvme_ns
 *
ns
 = 
disk
->
´iv©e_d©a
;

1718 
ns
->
lba_shiá
 = 
id
->
lbaf
[id->
æbas
 & 
NVME_NS_FLBAS_LBA_MASK
].
ds
;

1719 ià(
ns
->
lba_shiá
 == 0)

1720 
ns
->
lba_shiá
 = 9;

1721 
ns
->
noiob
 = 
	`Ë16_to_ýu
(
id
->noiob);

1722 
ns
->
ms
 = 
	`Ë16_to_ýu
(
id
->
lbaf
[id->
æbas
 & 
NVME_NS_FLBAS_LBA_MASK
].ms);

1723 
ns
->
ext
 =‚s->
ms
 && (
id
->
æbas
 & 
NVME_NS_FLBAS_META_EXT
);

1725 ià(
ns
->
ms
 =ð(
t10_pi_tu¶e
))

1726 
ns
->
pi_ty³
 = 
id
->
dps
 & 
NVME_NS_DPS_PI_MASK
;

1728 
ns
->
pi_ty³
 = 0;

1730 ià(
ns
->
noiob
)

1731 
	`nvme_£t_chunk_size
(
ns
);

1732 
	`nvme_upd©e_disk_šfo
(
disk
, 
ns
, 
id
);

1733 ià(
ns
->
ndev
)

1734 
	`nvme_nvm_upd©e_nvm_šfo
(
ns
);

1735 #ifdeà
CONFIG_NVME_MULTIPATH


1736 ià(
ns
->
h—d
->
disk
)

1737 
	`nvme_upd©e_disk_šfo
(
ns
->
h—d
->
disk
,‚s, 
id
);

1739 
	}
}

1741 
	$nvme_»v®id©e_disk
(
g’disk
 *
disk
)

1743 
nvme_ns
 *
ns
 = 
disk
->
´iv©e_d©a
;

1744 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

1745 
nvme_id_ns
 *
id
;

1746 
nvme_ns_ids
 
ids
;

1747 
»t
 = 0;

1749 ià(
	`‹¡_b™
(
NVME_NS_DEAD
, &
ns
->
æags
)) {

1750 
	`£t_ÿ·c™y
(
disk
, 0);

1751  -
ENODEV
;

1754 
id
 = 
	`nvme_id’tify_ns
(
ù¾
, 
ns
->
h—d
->
ns_id
);

1755 ià(!
id
)

1756  -
ENODEV
;

1758 ià(
id
->
nÿp
 == 0) {

1759 
»t
 = -
ENODEV
;

1760 
out
;

1763 
	`__nvme_»v®id©e_disk
(
disk
, 
id
);

1764 
	`nvme_»pÜt_ns_ids
(
ù¾
, 
ns
->
h—d
->
ns_id
, 
id
, &
ids
);

1765 ià(!
	`nvme_ns_ids_equ®
(&
ns
->
h—d
->
ids
, &ids)) {

1766 
	`dev_”r
(
ù¾
->
deviû
,

1767 "id’tif›r chªged fÜ‚sid %d\n", 
ns
->
h—d
->
ns_id
);

1768 
»t
 = -
ENODEV
;

1771 
out
:

1772 
	`kä“
(
id
);

1773  
»t
;

1774 
	}
}

1776 #ifdeà
HAVE_PR_H


1777 
	$nvme_´_ty³
(
´_ty³
 
ty³
)

1779 
ty³
) {

1780 
PR_WRITE_EXCLUSIVE
:

1782 
PR_EXCLUSIVE_ACCESS
:

1784 
PR_WRITE_EXCLUSIVE_REG_ONLY
:

1786 
PR_EXCLUSIVE_ACCESS_REG_ONLY
:

1788 
PR_WRITE_EXCLUSIVE_ALL_REGS
:

1790 
PR_EXCLUSIVE_ACCESS_ALL_REGS
:

1795 
	}
};

1797 
	$nvme_´_commªd
(
block_deviû
 *
bdev
, 
u32
 
cdw10
,

1798 
u64
 
key
, u64 
§_key
, 
u8
 
Ý
)

1800 
nvme_ns_h—d
 *
h—d
 = 
NULL
;

1801 
nvme_ns
 *
ns
;

1802 
nvme_commªd
 
c
;

1803 
¤cu_idx
, 
»t
;

1804 
u8
 
d©a
[16] = { 0, };

1806 
ns
 = 
	`nvme_g‘_ns_äom_disk
(
bdev
->
bd_disk
, &
h—d
, &
¤cu_idx
);

1807 ià(
	`uÆik–y
(!
ns
))

1808  -
EWOULDBLOCK
;

1810 
	`put_uÇligÃd_Ë64
(
key
, &
d©a
[0]);

1811 
	`put_uÇligÃd_Ë64
(
§_key
, &
d©a
[8]);

1813 
	`mem£t
(&
c
, 0, (c));

1814 
c
.
commÚ
.
Ýcode
 = 
Ý
;

1815 
c
.
commÚ
.
nsid
 = 
	`ýu_to_Ë32
(
ns
->
h—d
->
ns_id
);

1816 
c
.
commÚ
.
cdw10
[0] = 
	`ýu_to_Ë32
(cdw10);

1818 
»t
 = 
	`nvme_subm™_sync_cmd
(
ns
->
queue
, &
c
, 
d©a
, 16);

1819 
	`nvme_put_ns_äom_disk
(
h—d
, 
¤cu_idx
);

1820  
»t
;

1821 
	}
}

1823 
	$nvme_´_»gi¡”
(
block_deviû
 *
bdev
, 
u64
 
Þd
,

1824 
u64
 
Ãw
, 
æags
)

1826 
u32
 
cdw10
;

1828 ià(
æags
 & ~
PR_FL_IGNORE_KEY
)

1829  -
EOPNOTSUPP
;

1831 
cdw10
 = 
Þd
 ? 2 : 0;

1832 
cdw10
 |ð(
æags
 & 
PR_FL_IGNORE_KEY
) ? 1 << 3 : 0;

1833 
cdw10
 |= (1 << 30) | (1 << 31);

1834  
	`nvme_´_commªd
(
bdev
, 
cdw10
, 
Þd
, 
Ãw
, 
nvme_cmd_»sv_»gi¡”
);

1835 
	}
}

1837 
	$nvme_´_»£rve
(
block_deviû
 *
bdev
, 
u64
 
key
,

1838 
´_ty³
 
ty³
, 
æags
)

1840 
u32
 
cdw10
;

1842 ià(
æags
 & ~
PR_FL_IGNORE_KEY
)

1843  -
EOPNOTSUPP
;

1845 
cdw10
 = 
	`nvme_´_ty³
(
ty³
) << 8;

1846 
cdw10
 |ð((
æags
 & 
PR_FL_IGNORE_KEY
) ? 1 << 3 : 0);

1847  
	`nvme_´_commªd
(
bdev
, 
cdw10
, 
key
, 0, 
nvme_cmd_»sv_acquœe
);

1848 
	}
}

1850 
	$nvme_´_´“m±
(
block_deviû
 *
bdev
, 
u64
 
Þd
, u64 
Ãw
,

1851 
´_ty³
 
ty³
, 
boÞ
 
abÜt
)

1853 
u32
 
cdw10
 = 
	`nvme_´_ty³
(
ty³
è<< 8 | (
abÜt
 ? 2 : 1);

1854  
	`nvme_´_commªd
(
bdev
, 
cdw10
, 
Þd
, 
Ãw
, 
nvme_cmd_»sv_acquœe
);

1855 
	}
}

1857 
	$nvme_´_þ—r
(
block_deviû
 *
bdev
, 
u64
 
key
)

1859 
u32
 
cdw10
 = 1 | (
key
 ? 1 << 3 : 0);

1860  
	`nvme_´_commªd
(
bdev
, 
cdw10
, 
key
, 0, 
nvme_cmd_»sv_»gi¡”
);

1861 
	}
}

1863 
	$nvme_´_»Ëa£
(
block_deviû
 *
bdev
, 
u64
 
key
, 
´_ty³
 
ty³
)

1865 
u32
 
cdw10
 = 
	`nvme_´_ty³
(
ty³
è<< 8 | (
key
 ? 1 << 3 : 0);

1866  
	`nvme_´_commªd
(
bdev
, 
cdw10
, 
key
, 0, 
nvme_cmd_»sv_»Ëa£
);

1867 
	}
}

1869 cÚ¡ 
´_Ýs
 
	gnvme_´_Ýs
 = {

1870 .
´_»gi¡”
 = 
nvme_´_»gi¡”
,

1871 .
	g´_»£rve
 = 
nvme_´_»£rve
,

1872 .
	g´_»Ëa£
 = 
nvme_´_»Ëa£
,

1873 .
	g´_´“m±
 = 
nvme_´_´“m±
,

1874 .
	g´_þ—r
 = 
nvme_´_þ—r
,

1878 #ifdeà
HAVE_LINUX_SED_OPAL_H


1879 #ifdeà
CONFIG_BLK_SED_OPAL


1880 
	$nvme_£c_subm™
(*
d©a
, 
u16
 
¥¥
, 
u8
 
£ý
, *
bufãr
, 
size_t
 
Ën
,

1881 
boÞ
 
£nd
)

1883 
nvme_ù¾
 *
ù¾
 = 
d©a
;

1884 
nvme_commªd
 
cmd
;

1886 
	`mem£t
(&
cmd
, 0, (cmd));

1887 ià(
£nd
)

1888 
cmd
.
commÚ
.
Ýcode
 = 
nvme_admš_£cur™y_£nd
;

1890 
cmd
.
commÚ
.
Ýcode
 = 
nvme_admš_£cur™y_»cv
;

1891 
cmd
.
commÚ
.
nsid
 = 0;

1892 
cmd
.
commÚ
.
cdw10
[0] = 
	`ýu_to_Ë32
(((
u32
)
£ý
è<< 24 | ((u32)
¥¥
) << 8);

1893 
cmd
.
commÚ
.
cdw10
[1] = 
	`ýu_to_Ë32
(
Ën
);

1895 #ifdeà
HAVE_BLK_MQ_ALLOC_REQUEST_HAS_3_PARAMS


1896  
	`__nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
cmd
, 
NULL
, 
bufãr
, 
Ën
,

1897 
ADMIN_TIMEOUT
, 
NVME_QID_ANY
, 1, 0);

1899  
	`__nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
cmd
, 
NULL
, 
bufãr
, 
Ën
,

1900 
ADMIN_TIMEOUT
, 
NVME_QID_ANY
, 1, 
GFP_KERNEL
, 
çl£
);

1902 
	}
}

1903 
EXPORT_SYMBOL_GPL
(
nvme_£c_subm™
);

1907 cÚ¡ 
block_deviû_Ý”©iÚs
 
	gnvme_fÝs
 = {

1908 .
owÃr
 = 
THIS_MODULE
,

1909 .
	gioùl
 = 
nvme_ioùl
,

1910 .
	gcom·t_ioùl
 = 
nvme_ioùl
,

1911 .
	gÝ’
 = 
nvme_Ý’
,

1912 .
	g»Ëa£
 = 
nvme_»Ëa£
,

1913 .
	gg‘geo
 = 
nvme_g‘geo
,

1914 .
	g»v®id©e_disk
ð
nvme_»v®id©e_disk
,

1915 #ifdeà
HAVE_PR_H


1916 .
	g´_Ýs
 = &
nvme_´_Ýs
,

1920 #ifdeà
CONFIG_NVME_MULTIPATH


1921 
	$nvme_ns_h—d_Ý’
(
block_deviû
 *
bdev
, 
fmode_t
 
mode
)

1923 
nvme_ns_h—d
 *
h—d
 = 
bdev
->
bd_disk
->
´iv©e_d©a
;

1925 ià(!
	`k»f_g‘_uÆess_z”o
(&
h—d
->
»f
))

1926  -
ENXIO
;

1928 
	}
}

1930 
	$nvme_ns_h—d_»Ëa£
(
g’disk
 *
disk
, 
fmode_t
 
mode
)

1932 
	`nvme_put_ns_h—d
(
disk
->
´iv©e_d©a
);

1933 
	}
}

1935 cÚ¡ 
block_deviû_Ý”©iÚs
 
	gnvme_ns_h—d_Ýs
 = {

1936 .
owÃr
 = 
THIS_MODULE
,

1937 .
	gÝ’
 = 
nvme_ns_h—d_Ý’
,

1938 .
	g»Ëa£
 = 
nvme_ns_h—d_»Ëa£
,

1939 .
	gioùl
 = 
nvme_ioùl
,

1940 .
	gcom·t_ioùl
 = 
nvme_ioùl
,

1941 .
	gg‘geo
 = 
nvme_g‘geo
,

1942 .
	g´_Ýs
 = &
nvme_´_Ýs
,

1946 
	$nvme_wa™_»ady
(
nvme_ù¾
 *
ù¾
, 
u64
 
ÿp
, 
boÞ
 
’abËd
)

1948 
timeout
 =

1949 ((
	`NVME_CAP_TIMEOUT
(
ÿp
è+ 1è* 
HZ
 / 2è+ 
jiff›s
;

1950 
u32
 
c¡s
, 
b™
 = 
’abËd
 ? 
NVME_CSTS_RDY
 : 0;

1951 
»t
;

1953 (
»t
 = 
ù¾
->
Ýs
->
	`»g_»ad32
(ù¾, 
NVME_REG_CSTS
, &
c¡s
)) == 0) {

1954 ià(
c¡s
 == ~0)

1955  -
ENODEV
;

1956 ià((
c¡s
 & 
NVME_CSTS_RDY
è=ð
b™
)

1959 
	`m¦“p
(100);

1960 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
))

1961  -
EINTR
;

1962 ià(
	`time_aá”
(
jiff›s
, 
timeout
)) {

1963 
	`dev_”r
(
ù¾
->
deviû
,

1964 "Deviû‚Ù„—dy;‡bÜtšg %s\n", 
’abËd
 ?

1966  -
ENODEV
;

1970  
»t
;

1971 
	}
}

1979 
	$nvme_di§bË_ù¾
(
nvme_ù¾
 *
ù¾
, 
u64
 
ÿp
)

1981 
»t
;

1983 
ù¾
->
ù¾_cÚfig
 &ð~
NVME_CC_SHN_MASK
;

1984 
ù¾
->
ù¾_cÚfig
 &ð~
NVME_CC_ENABLE
;

1986 
»t
 = 
ù¾
->
Ýs
->
	`»g_wr™e32
(ù¾, 
NVME_REG_CC
, cŒl->
ù¾_cÚfig
);

1987 ià(
»t
)

1988  
»t
;

1990 ià(
ù¾
->
quœks
 & 
NVME_QUIRK_DELAY_BEFORE_CHK_RDY
)

1991 
	`m¦“p
(
NVME_QUIRK_DELAY_AMOUNT
);

1993  
	`nvme_wa™_»ady
(
ù¾
, 
ÿp
, 
çl£
);

1994 
	}
}

1995 
EXPORT_SYMBOL_GPL
(
nvme_di§bË_ù¾
);

1997 
	$nvme_’abË_ù¾
(
nvme_ù¾
 *
ù¾
, 
u64
 
ÿp
)

2004 
dev_·ge_mš
 = 
	`NVME_CAP_MPSMIN
(
ÿp
è+ 12, 
·ge_shiá
 = 12;

2005 
»t
;

2007 ià(
·ge_shiá
 < 
dev_·ge_mš
) {

2008 
	`dev_”r
(
ù¾
->
deviû
,

2010 1 << 
dev_·ge_mš
, 1 << 
·ge_shiá
);

2011  -
ENODEV
;

2014 
ù¾
->
·ge_size
 = 1 << 
·ge_shiá
;

2016 
ù¾
->
ù¾_cÚfig
 = 
NVME_CC_CSS_NVM
;

2017 
ù¾
->
ù¾_cÚfig
 |ð(
·ge_shiá
 - 12è<< 
NVME_CC_MPS_SHIFT
;

2018 
ù¾
->
ù¾_cÚfig
 |ð
NVME_CC_AMS_RR
 | 
NVME_CC_SHN_NONE
;

2019 
ù¾
->
ù¾_cÚfig
 |ð
NVME_CC_IOSQES
 | 
NVME_CC_IOCQES
;

2020 
ù¾
->
ù¾_cÚfig
 |ð
NVME_CC_ENABLE
;

2022 
»t
 = 
ù¾
->
Ýs
->
	`»g_wr™e32
(ù¾, 
NVME_REG_CC
, cŒl->
ù¾_cÚfig
);

2023 ià(
»t
)

2024  
»t
;

2026 
»t
 = 
	`nvme_wa™_»ady
(
ù¾
, 
ÿp
, 
Œue
);

2027 ià(
»t
)

2028  
»t
;

2030 
	`nvme_¡¬t_k“p_®ive
(
ù¾
);

2033 
	}
}

2034 
EXPORT_SYMBOL_GPL
(
nvme_’abË_ù¾
);

2036 
	$nvme_shutdown_ù¾
(
nvme_ù¾
 *
ù¾
)

2038 
timeout
 = 
jiff›s
 + (
ù¾
->
shutdown_timeout
 * 
HZ
);

2039 
u32
 
c¡s
;

2040 
»t
;

2042 
ù¾
->
ù¾_cÚfig
 &ð~
NVME_CC_SHN_MASK
;

2043 
ù¾
->
ù¾_cÚfig
 |ð
NVME_CC_SHN_NORMAL
;

2045 
»t
 = 
ù¾
->
Ýs
->
	`»g_wr™e32
(ù¾, 
NVME_REG_CC
, cŒl->
ù¾_cÚfig
);

2046 ià(
»t
)

2047  
»t
;

2049 (
»t
 = 
ù¾
->
Ýs
->
	`»g_»ad32
(ù¾, 
NVME_REG_CSTS
, &
c¡s
)) == 0) {

2050 ià((
c¡s
 & 
NVME_CSTS_SHST_MASK
è=ð
NVME_CSTS_SHST_CMPLT
)

2053 
	`m¦“p
(100);

2054 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
))

2055  -
EINTR
;

2056 ià(
	`time_aá”
(
jiff›s
, 
timeout
)) {

2057 
	`dev_”r
(
ù¾
->
deviû
,

2059  -
ENODEV
;

2063  
»t
;

2064 
	}
}

2065 
EXPORT_SYMBOL_GPL
(
nvme_shutdown_ù¾
);

2067 
	$nvme_£t_queue_lim™s
(
nvme_ù¾
 *
ù¾
,

2068 
»que¡_queue
 *
q
)

2070 
boÞ
 
vwc
 = 
çl£
;

2072 ià(
ù¾
->
max_hw_£ùÜs
) {

2073 
u32
 
max_£gm’ts
 =

2074 (
ù¾
->
max_hw_£ùÜs
 / (ù¾->
·ge_size
 >> 9)) + 1;

2076 
	`blk_queue_max_hw_£ùÜs
(
q
, 
ù¾
->
max_hw_£ùÜs
);

2077 
	`blk_queue_max_£gm’ts
(
q
, 
	`mš_t
(
u32
, 
max_£gm’ts
, 
USHRT_MAX
));

2079 ià((
ù¾
->
quœks
 & 
NVME_QUIRK_STRIPE_SIZE
) &&

2080 
	`is_pow”_of_2
(
ù¾
->
max_hw_£ùÜs
))

2081 
	`blk_queue_chunk_£ùÜs
(
q
, 
ù¾
->
max_hw_£ùÜs
);

2082 #ifdeà
HAVE_BLK_QUEUE_VIRT_BOUNDARY


2083 
	`blk_queue_vœt_bound¬y
(
q
, 
ù¾
->
·ge_size
 - 1);

2085 ià(!
ù¾
->
sg_g­s_suµÜt
)

2086 
	`queue_æag_£t_uÆocked
(
QUEUE_FLAG_SG_GAPS
, 
q
);

2088 ià(
ù¾
->
vwc
 & 
NVME_CTRL_VWC_PRESENT
)

2089 
vwc
 = 
Œue
;

2090 
	`blk_queue_wr™e_ÿche
(
q
, 
vwc
, vwc);

2091 
	}
}

2093 
	$nvme_cÚfigu»_time¡amp
(
nvme_ù¾
 *
ù¾
)

2095 
__Ë64
 
ts
;

2096 
»t
;

2098 ià(!(
ù¾
->
Úcs
 & 
NVME_CTRL_ONCS_TIMESTAMP
))

2101 
ts
 = 
	`ýu_to_Ë64
(
	`ktime_to_ms
(
	`ktime_g‘_»®
()));

2102 
»t
 = 
	`nvme_£t_ã©u»s
(
ù¾
, 
NVME_FEAT_TIMESTAMP
, 0, &
ts
, (ts),

2103 
NULL
);

2104 ià(
»t
)

2105 
	`dev_w¬n_Úû
(
ù¾
->
deviû
,

2106 "could‚Ù s‘ime¡am°(%d)\n", 
»t
);

2107  
»t
;

2108 
	}
}

2110 #ifdeà
HAVE_DEV_PM_INFO_SET_LATENCY_TOLERANCE


2111 
	$nvme_cÚfigu»_­¡
(
nvme_ù¾
 *
ù¾
)

2129 
­¡e
;

2130 
nvme_ã©_auto_p¡
 *
bË
;

2131 
u64
 
max_Ït_us
 = 0;

2132 
max_ps
 = -1;

2133 
»t
;

2139 ià(!
ù¾
->
­¡a
)

2142 ià(
ù¾
->
Åss
 > 31) {

2143 
	`dev_w¬n
(
ù¾
->
deviû
, "NPSS is invalid;‚ot using APST\n");

2147 
bË
 = 
	`kz®loc
((*bË), 
GFP_KERNEL
);

2148 ià(!
bË
)

2151 ià(!
ù¾
->
­¡_’abËd
 || cŒl->
ps_max_Ï‹ncy_us
 == 0) {

2153 
­¡e
 = 0;

2154 
	`dev_dbg
(
ù¾
->
deviû
, "APST disabled\n");

2156 
__Ë64
 
rg‘
 = 
	`ýu_to_Ë64
(0);

2157 
¡©e
;

2165 
¡©e
 = ()
ù¾
->
Åss
; state >= 0; state--) {

2166 
u64
 
tÙ®_Ï‹ncy_us
, 
ex™_Ï‹ncy_us
, 
Œªs™iÚ_ms
;

2168 ià(
rg‘
)

2169 
bË
->
’Œ›s
[
¡©e
] = 
rg‘
;

2175 ià(
¡©e
 =ð
ù¾
->
Åss
 &&

2176 (
ù¾
->
quœks
 & 
NVME_QUIRK_NO_DEEPEST_PS
))

2183 ià(!(
ù¾
->
psd
[
¡©e
].
æags
 &

2184 
NVME_PS_FLAGS_NON_OP_STATE
))

2187 
ex™_Ï‹ncy_us
 =

2188 (
u64
)
	`Ë32_to_ýu
(
ù¾
->
psd
[
¡©e
].
ex™_Ït
);

2189 ià(
ex™_Ï‹ncy_us
 > 
ù¾
->
ps_max_Ï‹ncy_us
)

2192 
tÙ®_Ï‹ncy_us
 =

2193 
ex™_Ï‹ncy_us
 +

2194 
	`Ë32_to_ýu
(
ù¾
->
psd
[
¡©e
].
’Œy_Ït
);

2200 
Œªs™iÚ_ms
 = 
tÙ®_Ï‹ncy_us
 + 19;

2201 
	`do_div
(
Œªs™iÚ_ms
, 20);

2202 ià(
Œªs™iÚ_ms
 > (1 << 24) - 1)

2203 
Œªs™iÚ_ms
 = (1 << 24) - 1;

2205 
rg‘
 = 
	`ýu_to_Ë64
((
¡©e
 << 3) |

2206 (
Œªs™iÚ_ms
 << 8));

2208 ià(
max_ps
 == -1)

2209 
max_ps
 = 
¡©e
;

2211 ià(
tÙ®_Ï‹ncy_us
 > 
max_Ït_us
)

2212 
max_Ït_us
 = 
tÙ®_Ï‹ncy_us
;

2215 
­¡e
 = 1;

2217 ià(
max_ps
 == -1) {

2218 
	`dev_dbg
(
ù¾
->
deviû
, "APSTƒnabled but‚o‚on-operational states‡re‡vailable\n");

2220 
	`dev_dbg
(
ù¾
->
deviû
, "APSTƒnabled: max PS = %d, max„ound-trip†atency = %lluus,able = %*phN\n",

2221 
max_ps
, 
max_Ït_us
, ()(*
bË
),able);

2225 
»t
 = 
	`nvme_£t_ã©u»s
(
ù¾
, 
NVME_FEAT_AUTO_PST
, 
­¡e
,

2226 
bË
, (*bË), 
NULL
);

2227 ià(
»t
)

2228 
	`dev_”r
(
ù¾
->
deviû
, "çžedØ£ˆAPST f—tu» (%d)\n", 
»t
);

2230 
	`kä“
(
bË
);

2231  
»t
;

2232 
	}
}

2234 
	$nvme_£t_Ï‹ncy_tÞ”ªû
(
deviû
 *
dev
, 
s32
 
v®
)

2236 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

2237 
u64
 
Ï‹ncy
;

2239 
v®
) {

2240 
PM_QOS_LATENCY_TOLERANCE_NO_CONSTRAINT
:

2241 
PM_QOS_LATENCY_ANY
:

2242 
Ï‹ncy
 = 
U64_MAX
;

2246 
Ï‹ncy
 = 
v®
;

2249 ià(
ù¾
->
ps_max_Ï‹ncy_us
 !ð
Ï‹ncy
) {

2250 
ù¾
->
ps_max_Ï‹ncy_us
 = 
Ï‹ncy
;

2251 
	`nvme_cÚfigu»_­¡
(
ù¾
);

2253 
	}
}

2256 
	snvme_cÜe_quœk_’Œy
 {

2262 
u16
 
	mvid
;

2263 cÚ¡ *
	mmn
;

2264 cÚ¡ *
	mä
;

2265 
	mquœks
;

2268 cÚ¡ 
nvme_cÜe_quœk_’Œy
 
	gcÜe_quœks
[] = {

2274 .
vid
 = 0x1179,

2275 .
	gmn
 = "THNSF5256GPUK TOSHIBA",

2276 .
	gquœks
 = 
NVME_QUIRK_NO_APST
,

2281 
boÞ
 
	$¡ršg_m©ches
(cÚ¡ *
id¡r
, cÚ¡ *
m©ch
, 
size_t
 
Ën
)

2283 
size_t
 
m©chËn
;

2285 ià(!
m©ch
)

2286  
Œue
;

2288 
m©chËn
 = 
	`¡¾’
(
m©ch
);

2289 
	`WARN_ON_ONCE
(
m©chËn
 > 
Ën
);

2291 ià(
	`memcmp
(
id¡r
, 
m©ch
, 
m©chËn
))

2292  
çl£
;

2294 ; 
m©chËn
 < 
Ën
; matchlen++)

2295 ià(
id¡r
[
m©chËn
] != ' ')

2296  
çl£
;

2298  
Œue
;

2299 
	}
}

2301 
boÞ
 
	$quœk_m©ches
(cÚ¡ 
nvme_id_ù¾
 *
id
,

2302 cÚ¡ 
nvme_cÜe_quœk_’Œy
 *
q
)

2304  
q
->
vid
 =ð
	`Ë16_to_ýu
(
id
->vid) &&

2305 
	`¡ršg_m©ches
(
id
->
mn
, 
q
->mn, (id->mn)) &&

2306 
	`¡ršg_m©ches
(
id
->
ä
, 
q
->fr, (id->fr));

2307 
	}
}

2309 
	$nvme_š™_subnqn
(
nvme_subsy¡em
 *
subsys
, 
nvme_ù¾
 *
ù¾
,

2310 
nvme_id_ù¾
 *
id
)

2312 
size_t
 
nqÆ’
;

2313 
off
;

2315 
nqÆ’
 = 
	`¡ºËn
(
id
->
subnqn
, 
NVMF_NQN_SIZE
);

2316 ià(
nqÆ’
 > 0 &&‚qÆ’ < 
NVMF_NQN_SIZE
) {

2317 
	`¡ºýy
(
subsys
->
subnqn
, 
id
->subnqn, 
NVMF_NQN_SIZE
);

2321 ià(
ù¾
->
vs
 >ð
	`NVME_VS
(1, 2, 1))

2322 
	`dev_w¬n
(
ù¾
->
deviû
, "missing or invalid SUBNQN field.\n");

2325 
off
 = 
	`¢´štf
(
subsys
->
subnqn
, 
NVMF_NQN_SIZE
,

2327 
	`Ë16_to_ýu
(
id
->
vid
),†e16_to_ýu(id->
ssvid
));

2328 
	`memýy
(
subsys
->
subnqn
 + 
off
, 
id
->
¢
, (id->sn));

2329 
off
 +ð(
id
->
¢
);

2330 
	`memýy
(
subsys
->
subnqn
 + 
off
, 
id
->
mn
, (id->mn));

2331 
off
 +ð(
id
->
mn
);

2332 
	`mem£t
(
subsys
->
subnqn
 + 
off
, 0, (subsys->subnqn) - off);

2333 
	}
}

2335 
	$__nvme_»Ëa£_subsy¡em
(
nvme_subsy¡em
 *
subsys
)

2337 
	`ida_sim¶e_»move
(&
nvme_subsy¡ems_ida
, 
subsys
->
š¡ªû
);

2338 
	`kä“
(
subsys
);

2339 
	}
}

2341 
	$nvme_»Ëa£_subsy¡em
(
deviû
 *
dev
)

2343 
	`__nvme_»Ëa£_subsy¡em
(
	`cÚš”_of
(
dev
, 
nvme_subsy¡em
, dev));

2344 
	}
}

2346 
	$nvme_de¡roy_subsy¡em
(
k»f
 *
»f
)

2348 
nvme_subsy¡em
 *
subsys
 =

2349 
	`cÚš”_of
(
»f
, 
nvme_subsy¡em
,„ef);

2351 
	`mu‹x_lock
(&
nvme_subsy¡ems_lock
);

2352 
	`li¡_d–
(&
subsys
->
’Œy
);

2353 
	`mu‹x_uÆock
(&
nvme_subsy¡ems_lock
);

2355 
	`ida_de¡roy
(&
subsys
->
ns_ida
);

2356 
	`deviû_d–
(&
subsys
->
dev
);

2357 
	`put_deviû
(&
subsys
->
dev
);

2358 
	}
}

2360 
	$nvme_put_subsy¡em
(
nvme_subsy¡em
 *
subsys
)

2362 
	`k»f_put
(&
subsys
->
»f
, 
nvme_de¡roy_subsy¡em
);

2363 
	}
}

2365 
nvme_subsy¡em
 *
	$__nvme_fšd_g‘_subsy¡em
(cÚ¡ *
subsy¢qn
)

2367 
nvme_subsy¡em
 *
subsys
;

2369 
	`lockd•_as£¹_h–d
(&
nvme_subsy¡ems_lock
);

2371 
	`li¡_fÜ_—ch_’Œy
(
subsys
, &
nvme_subsy¡ems
, 
’Œy
) {

2372 ià(
	`¡rcmp
(
subsys
->
subnqn
, 
subsy¢qn
))

2374 ià(!
	`k»f_g‘_uÆess_z”o
(&
subsys
->
»f
))

2376  
subsys
;

2379  
NULL
;

2380 
	}
}

2382 
	#SUBSYS_ATTR_RO
(
_Çme
, 
_mode
, 
_show
) \

2383 
deviû_©Œibu‹
 
subsys_©Œ_
##
_Çme
 = \

2384 
	`__ATTR
(
_Çme
, 
_mode
, 
_show
, 
NULL
)

	)

2386 
ssize_t
 
	$nvme_subsys_show_nqn
(
deviû
 *
dev
,

2387 
deviû_©Œibu‹
 *
©Œ
,

2388 *
buf
)

2390 
nvme_subsy¡em
 *
subsys
 =

2391 
	`cÚš”_of
(
dev
, 
nvme_subsy¡em
, dev);

2393  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%s\n", 
subsys
->
subnqn
);

2394 
	}
}

2395 
SUBSYS_ATTR_RO
(
subsy¢qn
, 
S_IRUGO
, 
nvme_subsys_show_nqn
);

2397 
	#nvme_subsys_show_¡r_funùiÚ
(
f›ld
) \

2398 
ssize_t
 
subsys_
##
f›ld
##
	`_show
(
deviû
 *
dev
, \

2399 
deviû_©Œibu‹
 *
©Œ
, *
buf
) \

2401 
nvme_subsy¡em
 *
subsys
 = \

2402 
	`cÚš”_of
(
dev
, 
nvme_subsy¡em
, dev); \

2403  
	`¥rštf
(
buf
, "%.*s\n", \

2404 ()(
subsys
->
f›ld
), subsys->field); \

2406 
	`SUBSYS_ATTR_RO
(
f›ld
, 
S_IRUGO
, 
subsys_
##f›ld##
_show
);

	)

2408 
nvme_subsys_show_¡r_funùiÚ
(
mod–
);

2409 
nvme_subsys_show_¡r_funùiÚ
(
£rŸl
);

2410 
nvme_subsys_show_¡r_funùiÚ
(
fœmw¬e_»v
);

2412 
©Œibu‹
 *
	gnvme_subsys_©Œs
[] = {

2413 &
subsys_©Œ_mod–
.
©Œ
,

2414 &
subsys_©Œ_£rŸl
.
©Œ
,

2415 &
subsys_©Œ_fœmw¬e_»v
.
©Œ
,

2416 &
subsys_©Œ_subsy¢qn
.
©Œ
,

2417 
NULL
,

2420 
©Œibu‹_group
 
	gnvme_subsys_©Œs_group
 = {

2421 .
©Œs
 = 
nvme_subsys_©Œs
,

2424 cÚ¡ 
©Œibu‹_group
 *
	gnvme_subsys_©Œs_groups
[] = {

2425 &
nvme_subsys_©Œs_group
,

2426 
NULL
,

2429 
	$nvme_aùive_ù¾s
(
nvme_subsy¡em
 *
subsys
)

2431 
couÁ
 = 0;

2432 
nvme_ù¾
 *
ù¾
;

2434 
	`mu‹x_lock
(&
subsys
->
lock
);

2435 
	`li¡_fÜ_—ch_’Œy
(
ù¾
, &
subsys
->
ù¾s
, 
subsys_’Œy
) {

2436 ià(
ù¾
->
¡©e
 !ð
NVME_CTRL_DELETING
 &&

2437 
ù¾
->
¡©e
 !ð
NVME_CTRL_DEAD
)

2438 
couÁ
++;

2440 
	`mu‹x_uÆock
(&
subsys
->
lock
);

2442  
couÁ
;

2443 
	}
}

2445 
	$nvme_š™_subsy¡em
(
nvme_ù¾
 *
ù¾
, 
nvme_id_ù¾
 *
id
)

2447 
nvme_subsy¡em
 *
subsys
, *
found
;

2448 
»t
;

2450 
subsys
 = 
	`kz®loc
((*subsys), 
GFP_KERNEL
);

2451 ià(!
subsys
)

2452  -
ENOMEM
;

2453 
»t
 = 
	`ida_sim¶e_g‘
(&
nvme_subsy¡ems_ida
, 0, 0, 
GFP_KERNEL
);

2454 ià(
»t
 < 0) {

2455 
	`kä“
(
subsys
);

2456  
»t
;

2458 
subsys
->
š¡ªû
 = 
»t
;

2459 
	`mu‹x_š™
(&
subsys
->
lock
);

2460 
	`k»f_š™
(&
subsys
->
»f
);

2461 
	`INIT_LIST_HEAD
(&
subsys
->
ù¾s
);

2462 
	`INIT_LIST_HEAD
(&
subsys
->
nsh—ds
);

2463 
	`nvme_š™_subnqn
(
subsys
, 
ù¾
, 
id
);

2464 
	`memýy
(
subsys
->
£rŸl
, 
id
->
¢
, (subsys->serial));

2465 
	`memýy
(
subsys
->
mod–
, 
id
->
mn
, (subsys->model));

2466 
	`memýy
(
subsys
->
fœmw¬e_»v
, 
id
->
ä
, (subsys->firmware_rev));

2467 
subsys
->
v’dÜ_id
 = 
	`Ë16_to_ýu
(
id
->
vid
);

2468 
subsys
->
cmic
 = 
id
->cmic;

2470 
subsys
->
dev
.
þass
 = 
nvme_subsys_þass
;

2471 
subsys
->
dev
.
»Ëa£
 = 
nvme_»Ëa£_subsy¡em
;

2472 
subsys
->
dev
.
groups
 = 
nvme_subsys_©Œs_groups
;

2473 
	`dev_£t_Çme
(&
subsys
->
dev
, "nvme-subsys%d", subsys->
š¡ªû
);

2474 
	`deviû_š™Ÿlize
(&
subsys
->
dev
);

2476 
	`mu‹x_lock
(&
nvme_subsy¡ems_lock
);

2477 
found
 = 
	`__nvme_fšd_g‘_subsy¡em
(
subsys
->
subnqn
);

2478 ià(
found
) {

2483 ià(!(
ù¾
->
Ýts
 && cŒl->Ýts->
discov”y_nqn
) &&

2484 
	`nvme_aùive_ù¾s
(
found
è&& !(
id
->
cmic
 & (1 << 1))) {

2485 
	`dev_”r
(
ù¾
->
deviû
,

2487 
found
->
subnqn
);

2488 
	`nvme_put_subsy¡em
(
found
);

2489 
»t
 = -
EINVAL
;

2490 
out_uÆock
;

2493 
	`__nvme_»Ëa£_subsy¡em
(
subsys
);

2494 
subsys
 = 
found
;

2496 
»t
 = 
	`deviû_add
(&
subsys
->
dev
);

2497 ià(
»t
) {

2498 
	`dev_”r
(
ù¾
->
deviû
,

2500 
out_uÆock
;

2502 
	`ida_š™
(&
subsys
->
ns_ida
);

2503 
	`li¡_add_ž
(&
subsys
->
’Œy
, &
nvme_subsy¡ems
);

2506 
ù¾
->
subsys
 = subsys;

2507 
	`mu‹x_uÆock
(&
nvme_subsy¡ems_lock
);

2509 ià(
	`sysfs_ü—‹_lšk
(&
subsys
->
dev
.
kobj
, &
ù¾
->
deviû
->kobj,

2510 
	`dev_Çme
(
ù¾
->
deviû
))) {

2511 
	`dev_”r
(
ù¾
->
deviû
,

2514  -
EINVAL
;

2517 
	`mu‹x_lock
(&
subsys
->
lock
);

2518 
	`li¡_add_ž
(&
ù¾
->
subsys_’Œy
, &
subsys
->
ù¾s
);

2519 
	`mu‹x_uÆock
(&
subsys
->
lock
);

2523 
out_uÆock
:

2524 
	`mu‹x_uÆock
(&
nvme_subsy¡ems_lock
);

2525 
	`put_deviû
(&
subsys
->
dev
);

2526  
»t
;

2527 
	}
}

2529 
	$nvme_g‘_log_ext
(
nvme_ù¾
 *
ù¾
, 
nvme_ns
 *
ns
,

2530 
u8
 
log_·ge
, *
log
,

2531 
size_t
 
size
, 
u64
 
off£t
)

2533 
nvme_commªd
 
c
 = { };

2534 
dwËn
 = 
size
 / 4 - 1;

2536 
c
.
g‘_log_·ge
.
Ýcode
 = 
nvme_admš_g‘_log_·ge
;

2538 ià(
ns
)

2539 
c
.
g‘_log_·ge
.
nsid
 = 
	`ýu_to_Ë32
(
ns
->
h—d
->
ns_id
);

2541 
c
.
g‘_log_·ge
.
nsid
 = 
	`ýu_to_Ë32
(
NVME_NSID_ALL
);

2543 
c
.
g‘_log_·ge
.
lid
 = 
log_·ge
;

2544 
c
.
g‘_log_·ge
.
numdl
 = 
	`ýu_to_Ë16
(
dwËn
 & ((1 << 16) - 1));

2545 
c
.
g‘_log_·ge
.
numdu
 = 
	`ýu_to_Ë16
(
dwËn
 >> 16);

2546 
c
.
g‘_log_·ge
.
ÍÞ
 = 
	`ýu_to_Ë32
(
	`low”_32_b™s
(
off£t
));

2547 
c
.
g‘_log_·ge
.
Íou
 = 
	`ýu_to_Ë32
(
	`uµ”_32_b™s
(
off£t
));

2549  
	`nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
c
, 
log
, 
size
);

2550 
	}
}

2552 
	$nvme_g‘_log
(
nvme_ù¾
 *
ù¾
, 
u8
 
log_·ge
, *
log
,

2553 
size_t
 
size
)

2555  
	`nvme_g‘_log_ext
(
ù¾
, 
NULL
, 
log_·ge
, 
log
, 
size
, 0);

2556 
	}
}

2558 
	$nvme_g‘_efãùs_log
(
nvme_ù¾
 *
ù¾
)

2560 
»t
;

2562 ià(!
ù¾
->
efãùs
)

2563 
ù¾
->
efãùs
 = 
	`kz®loc
((*ù¾->efãùs), 
GFP_KERNEL
);

2565 ià(!
ù¾
->
efãùs
)

2568 
»t
 = 
	`nvme_g‘_log
(
ù¾
, 
NVME_LOG_CMD_EFFECTS
, cŒl->
efãùs
,

2569 (*
ù¾
->
efãùs
));

2570 ià(
»t
) {

2571 
	`kä“
(
ù¾
->
efãùs
);

2572 
ù¾
->
efãùs
 = 
NULL
;

2574  
»t
;

2575 
	}
}

2582 
	$nvme_š™_id’tify
(
nvme_ù¾
 *
ù¾
)

2584 
nvme_id_ù¾
 *
id
;

2585 
u64
 
ÿp
;

2586 
»t
, 
·ge_shiá
;

2587 
u32
 
max_hw_£ùÜs
;

2588 #ifdeà
HAVE_DEV_PM_INFO_SET_LATENCY_TOLERANCE


2589 
boÞ
 
´ev_­¡_’abËd
;

2592 
»t
 = 
ù¾
->
Ýs
->
	`»g_»ad32
(ù¾, 
NVME_REG_VS
, &ù¾->
vs
);

2593 ià(
»t
) {

2594 
	`dev_”r
(
ù¾
->
deviû
, "R—dšg VS fažed (%d)\n", 
»t
);

2595  
»t
;

2598 
»t
 = 
ù¾
->
Ýs
->
	`»g_»ad64
(ù¾, 
NVME_REG_CAP
, &
ÿp
);

2599 ià(
»t
) {

2600 
	`dev_”r
(
ù¾
->
deviû
, "R—dšg CAP fažed (%d)\n", 
»t
);

2601  
»t
;

2603 
·ge_shiá
 = 
	`NVME_CAP_MPSMIN
(
ÿp
) + 12;

2605 ià(
ù¾
->
vs
 >ð
	`NVME_VS
(1, 1, 0))

2606 
ù¾
->
subsy¡em
 = 
	`NVME_CAP_NSSRC
(
ÿp
);

2608 
»t
 = 
	`nvme_id’tify_ù¾
(
ù¾
, &
id
);

2609 ià(
»t
) {

2610 
	`dev_”r
(
ù¾
->
deviû
, "Id’tify CÚŒÞË¸çžed (%d)\n", 
»t
);

2611  -
EIO
;

2614 ià(
id
->
Ía
 & 
NVME_CTRL_LPA_CMD_EFFECTS_LOG
) {

2615 
»t
 = 
	`nvme_g‘_efãùs_log
(
ù¾
);

2616 ià(
»t
 < 0)

2617 
out_ä“
;

2620 ià(!
ù¾
->
id’tif›d
) {

2621 
i
;

2623 
»t
 = 
	`nvme_š™_subsy¡em
(
ù¾
, 
id
);

2624 ià(
»t
)

2625 
out_ä“
;

2635 
i
 = 0; i < 
	`ARRAY_SIZE
(
cÜe_quœks
); i++) {

2636 ià(
	`quœk_m©ches
(
id
, &
cÜe_quœks
[
i
]))

2637 
ù¾
->
quœks
 |ð
cÜe_quœks
[
i
].quirks;

2641 ià(
fÜû_­¡
 && (
ù¾
->
quœks
 & 
NVME_QUIRK_NO_DEEPEST_PS
)) {

2642 
	`dev_w¬n
(
ù¾
->
deviû
, "forcibly‡llowing‡ll…ower states dueo‚vme_core.force_apst -- use‡t your own„isk\n");

2643 
ù¾
->
quœks
 &ð~
NVME_QUIRK_NO_DEEPEST_PS
;

2646 
ù¾
->
ßcs
 = 
	`Ë16_to_ýu
(
id
->oacs);

2647 
ù¾
->
Úcs
 = 
	`Ë16_to_ýup
(&
id
->oncs);

2648 
ù¾
->
ßes
 = 
	`Ë32_to_ýu
(
id
->oaes);

2649 
	`©omic_£t
(&
ù¾
->
abÜt_lim™
, 
id
->
aþ
 + 1);

2650 
ù¾
->
vwc
 = 
id
->vwc;

2651 
ù¾
->
úŽid
 = 
	`Ë16_to_ýup
(&
id
->cntlid);

2652 ià(
id
->
mdts
)

2653 
max_hw_£ùÜs
 = 1 << (
id
->
mdts
 + 
·ge_shiá
 - 9);

2655 
max_hw_£ùÜs
 = 
UINT_MAX
;

2656 
ù¾
->
max_hw_£ùÜs
 =

2657 
	`mš_nÙ_z”o
(
ù¾
->
max_hw_£ùÜs
, max_hw_sectors);

2659 
	`nvme_£t_queue_lim™s
(
ù¾
, cŒl->
admš_q
);

2660 
ù¾
->
sgls
 = 
	`Ë32_to_ýu
(
id
->sgls);

2661 
ù¾
->
kas
 = 
	`Ë16_to_ýu
(
id
->kas);

2663 ià(
id
->
¹d3e
) {

2665 
u32
 
Œªs™iÚ_time
 = 
	`Ë32_to_ýu
(
id
->
¹d3e
) / 1000000;

2667 
ù¾
->
shutdown_timeout
 = 
	`þamp_t
(, 
Œªs™iÚ_time
,

2668 
shutdown_timeout
, 60);

2670 ià(
ù¾
->
shutdown_timeout
 != shutdown_timeout)

2671 
	`dev_šfo
(
ù¾
->
deviû
,

2673 
ù¾
->
shutdown_timeout
);

2675 
ù¾
->
shutdown_timeout
 = shutdown_timeout;

2677 #ifdeà
HAVE_DEV_PM_INFO_SET_LATENCY_TOLERANCE


2678 
ù¾
->
Åss
 = 
id
->npss;

2679 
ù¾
->
­¡a
 = 
id
->apsta;

2680 
´ev_­¡_’abËd
 = 
ù¾
->
­¡_’abËd
;

2681 ià(
ù¾
->
quœks
 & 
NVME_QUIRK_NO_APST
) {

2682 ià(
fÜû_­¡
 && 
id
->
­¡a
) {

2683 
	`dev_w¬n
(
ù¾
->
deviû
, "forcibly‡llowing APST dueo‚vme_core.force_apst -- use‡t your own„isk\n");

2684 
ù¾
->
­¡_’abËd
 = 
Œue
;

2686 
ù¾
->
­¡_’abËd
 = 
çl£
;

2689 
ù¾
->
­¡_’abËd
 = 
id
->
­¡a
;

2691 
	`memýy
(
ù¾
->
psd
, 
id
->psd, (ctrl->psd));

2694 ià(
ù¾
->
Ýs
->
æags
 & 
NVME_F_FABRICS
) {

2695 
ù¾
->
icdoff
 = 
	`Ë16_to_ýu
(
id
->icdoff);

2696 
ù¾
->
ioccsz
 = 
	`Ë32_to_ýu
(
id
->ioccsz);

2697 
ù¾
->
iÜcsz
 = 
	`Ë32_to_ýu
(
id
->iorcsz);

2698 
ù¾
->
maxcmd
 = 
	`Ë16_to_ýu
(
id
->maxcmd);

2704 ià(
ù¾
->
úŽid
 !ð
	`Ë16_to_ýu
(
id
->cntlid)) {

2705 
»t
 = -
EINVAL
;

2706 
out_ä“
;

2709 ià(!
ù¾
->
Ýts
->
discov”y_nqn
 && !ù¾->
kas
) {

2710 
	`dev_”r
(
ù¾
->
deviû
,

2712 
»t
 = -
EINVAL
;

2713 
out_ä“
;

2716 
ù¾
->
úŽid
 = 
	`Ë16_to_ýu
(
id
->cntlid);

2717 
ù¾
->
hm´e
 = 
	`Ë32_to_ýu
(
id
->hmpre);

2718 
ù¾
->
hmmš
 = 
	`Ë32_to_ýu
(
id
->hmmin);

2719 
ù¾
->
hmmšds
 = 
	`Ë32_to_ýu
(
id
->hmminds);

2720 
ù¾
->
hmmaxd
 = 
	`Ë16_to_ýu
(
id
->hmmaxd);

2723 
	`kä“
(
id
);

2725 #ifdeà
HAVE_DEV_PM_INFO_SET_LATENCY_TOLERANCE


2726 ià(
ù¾
->
­¡_’abËd
 && !
´ev_­¡_’abËd
)

2727 
	`dev_pm_qos_expo£_Ï‹ncy_tÞ”ªû
(
ù¾
->
deviû
);

2728 ià(!
ù¾
->
­¡_’abËd
 && 
´ev_­¡_’abËd
)

2729 
	`dev_pm_qos_hide_Ï‹ncy_tÞ”ªû
(
ù¾
->
deviû
);

2731 
»t
 = 
	`nvme_cÚfigu»_­¡
(
ù¾
);

2732 ià(
»t
 < 0)

2733  
»t
;

2736 
»t
 = 
	`nvme_cÚfigu»_time¡amp
(
ù¾
);

2737 ià(
»t
 < 0)

2738  
»t
;

2740 #ifdeà
HAVE_BLK_MAX_WRITE_HINTS


2741 
»t
 = 
	`nvme_cÚfigu»_dœeùives
(
ù¾
);

2742 ià(
»t
 < 0)

2743  
»t
;

2746 
ù¾
->
id’tif›d
 = 
Œue
;

2750 
out_ä“
:

2751 
	`kä“
(
id
);

2752  
»t
;

2753 
	}
}

2754 
EXPORT_SYMBOL_GPL
(
nvme_š™_id’tify
);

2756 
	$nvme_dev_Ý’
(
šode
 *šode, 
fže
 *file)

2758 
nvme_ù¾
 *
ù¾
 =

2759 
	`cÚš”_of
(
šode
->
i_cdev
, 
nvme_ù¾
, 
cdev
);

2761 
ù¾
->
¡©e
) {

2762 
NVME_CTRL_LIVE
:

2763 
NVME_CTRL_ADMIN_ONLY
:

2766  -
EWOULDBLOCK
;

2769 
fže
->
´iv©e_d©a
 = 
ù¾
;

2771 
	}
}

2773 
	$nvme_dev_u£r_cmd
(
nvme_ù¾
 *
ù¾
, 
__u£r
 *
¬gp
)

2775 
nvme_ns
 *
ns
;

2776 
»t
;

2778 
	`down_»ad
(&
ù¾
->
Çme¥aûs_rw£m
);

2779 ià(
	`li¡_em±y
(&
ù¾
->
Çme¥aûs
)) {

2780 
»t
 = -
ENOTTY
;

2781 
out_uÆock
;

2784 
ns
 = 
	`li¡_fœ¡_’Œy
(&
ù¾
->
Çme¥aûs
, 
nvme_ns
, 
li¡
);

2785 ià(
ns
 !ð
	`li¡_Ï¡_’Œy
(&
ù¾
->
Çme¥aûs
, 
nvme_ns
, 
li¡
)) {

2786 
	`dev_w¬n
(
ù¾
->
deviû
,

2788 
»t
 = -
EINVAL
;

2789 
out_uÆock
;

2792 
	`dev_w¬n
(
ù¾
->
deviû
,

2794 
	`k»f_g‘
(&
ns
->
k»f
);

2795 
	`up_»ad
(&
ù¾
->
Çme¥aûs_rw£m
);

2797 
»t
 = 
	`nvme_u£r_cmd
(
ù¾
, 
ns
, 
¬gp
);

2798 
	`nvme_put_ns
(
ns
);

2799  
»t
;

2801 
out_uÆock
:

2802 
	`up_»ad
(&
ù¾
->
Çme¥aûs_rw£m
);

2803  
»t
;

2804 
	}
}

2806 
	$nvme_dev_ioùl
(
fže
 *fže, 
cmd
,

2807 
¬g
)

2809 
nvme_ù¾
 *
ù¾
 = 
fže
->
´iv©e_d©a
;

2810 
__u£r
 *
¬gp
 = (__u£¸*)
¬g
;

2812 
cmd
) {

2813 
NVME_IOCTL_ADMIN_CMD
:

2814  
	`nvme_u£r_cmd
(
ù¾
, 
NULL
, 
¬gp
);

2815 
NVME_IOCTL_IO_CMD
:

2816  
	`nvme_dev_u£r_cmd
(
ù¾
, 
¬gp
);

2817 
NVME_IOCTL_RESET
:

2818 
	`dev_w¬n
(
ù¾
->
deviû
, "resetting controller\n");

2819  
	`nvme_»£t_ù¾_sync
(
ù¾
);

2820 
NVME_IOCTL_SUBSYS_RESET
:

2821  
	`nvme_»£t_subsy¡em
(
ù¾
);

2822 
NVME_IOCTL_RESCAN
:

2823 
	`nvme_queue_sÿn
(
ù¾
);

2826  -
ENOTTY
;

2828 
	}
}

2830 cÚ¡ 
fže_Ý”©iÚs
 
	gnvme_dev_fÝs
 = {

2831 .
owÃr
 = 
THIS_MODULE
,

2832 .
	gÝ’
 = 
nvme_dev_Ý’
,

2833 .
	guÆocked_ioùl
 = 
nvme_dev_ioùl
,

2834 .
	gcom·t_ioùl
 = 
nvme_dev_ioùl
,

2837 
ssize_t
 
	$nvme_sysfs_»£t
(
deviû
 *
dev
,

2838 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
,

2839 
size_t
 
couÁ
)

2841 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

2842 
»t
;

2844 
»t
 = 
	`nvme_»£t_ù¾_sync
(
ù¾
);

2845 ià(
»t
 < 0)

2846  
»t
;

2847  
couÁ
;

2848 
	}
}

2849 
DEVICE_ATTR
(
»£t_cÚŒÞËr
, 
S_IWUSR
, 
NULL
, 
nvme_sysfs_»£t
);

2851 
ssize_t
 
	$nvme_sysfs_»sÿn
(
deviû
 *
dev
,

2852 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
,

2853 
size_t
 
couÁ
)

2855 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

2857 
	`nvme_queue_sÿn
(
ù¾
);

2858  
couÁ
;

2859 
	}
}

2860 
DEVICE_ATTR
(
»sÿn_cÚŒÞËr
, 
S_IWUSR
, 
NULL
, 
nvme_sysfs_»sÿn
);

2862 
šlše
 
nvme_ns_h—d
 *
	$dev_to_ns_h—d
(
deviû
 *
dev
)

2864 
g’disk
 *
disk
 = 
	`dev_to_disk
(
dev
);

2866 ià(
disk
->
fÝs
 =ð&
nvme_fÝs
)

2867  
	`nvme_g‘_ns_äom_dev
(
dev
)->
h—d
;

2869  
disk
->
´iv©e_d©a
;

2870 
	}
}

2872 
ssize_t
 
	$wwid_show
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
,

2873 *
buf
)

2875 
nvme_ns_h—d
 *
h—d
 = 
	`dev_to_ns_h—d
(
dev
);

2876 
nvme_ns_ids
 *
ids
 = &
h—d
->ids;

2877 
nvme_subsy¡em
 *
subsys
 = 
h—d
->subsys;

2878 
£rŸl_Ën
 = (
subsys
->
£rŸl
);

2879 
mod–_Ën
 = (
subsys
->
mod–
);

2881 #ifdeà
HAVE_UUID_IS_NULL


2882 ià(!
	`uuid_is_nuÎ
(&
ids
->
uuid
))

2883  
	`¥rštf
(
buf
, "uuid.%pU\n", &
ids
->
uuid
);

2886 ià(
	`memchr_šv
(
ids
->
nguid
, 0, (ids->nguid)))

2887  
	`¥rštf
(
buf
, "eui.%16phN\n", 
ids
->
nguid
);

2889 ià(
	`memchr_šv
(
ids
->
eui64
, 0, (ids->eui64)))

2890  
	`¥rštf
(
buf
, "eui.%8phN\n", 
ids
->
eui64
);

2892 
£rŸl_Ën
 > 0 && (
subsys
->
£rŸl
[serial_len - 1] == ' ' ||

2893 
subsys
->
£rŸl
[
£rŸl_Ën
 - 1] == '\0'))

2894 
£rŸl_Ën
--;

2895 
mod–_Ën
 > 0 && (
subsys
->
mod–
[model_len - 1] == ' ' ||

2896 
subsys
->
mod–
[
mod–_Ën
 - 1] == '\0'))

2897 
mod–_Ën
--;

2899  
	`¥rštf
(
buf
, "nvme.%04x-%*phN-%*phN-%08x\n", 
subsys
->
v’dÜ_id
,

2900 
£rŸl_Ën
, 
subsys
->
£rŸl
, 
mod–_Ën
, subsys->
mod–
,

2901 
h—d
->
ns_id
);

2902 
	}
}

2903 
DEVICE_ATTR_RO
(
wwid
);

2905 #ifdeà
HAVE_UUID_IS_NULL


2906 
ssize_t
 
	$nguid_show
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
,

2907 *
buf
)

2909  
	`¥rštf
(
buf
, "%pU\n", 
	`dev_to_ns_h—d
(
dev
)->
ids
.
nguid
);

2910 
	}
}

2911 
DEVICE_ATTR_RO
(
nguid
);

2914 
ssize_t
 
	$uuid_show
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
,

2915 *
buf
)

2917 
nvme_ns_ids
 *
ids
 = &
	`dev_to_ns_h—d
(
dev
)->ids;

2922 #ifdeà
HAVE_UUID_IS_NULL


2923 ià(
	`uuid_is_nuÎ
(&
ids
->
uuid
)) {

2924 
	`´štk_¿‹lim™ed
(
KERN_WARNING


2926  
	`¥rštf
(
buf
, "%pU\n", 
ids
->
nguid
);

2929  
	`¥rštf
(
buf
, "%pU\n", &
ids
->
uuid
);

2930 
	}
}

2931 
DEVICE_ATTR_RO
(
uuid
);

2933 
ssize_t
 
	$eui_show
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
,

2934 *
buf
)

2936  
	`¥rštf
(
buf
, "%8ph\n", 
	`dev_to_ns_h—d
(
dev
)->
ids
.
eui64
);

2937 
	}
}

2938 
DEVICE_ATTR_RO
(
eui
);

2940 
ssize_t
 
	$nsid_show
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
,

2941 *
buf
)

2943  
	`¥rštf
(
buf
, "%d\n", 
	`dev_to_ns_h—d
(
dev
)->
ns_id
);

2944 
	}
}

2945 
DEVICE_ATTR_RO
(
nsid
);

2947 
©Œibu‹
 *
	gnvme_ns_id_©Œs
[] = {

2948 &
dev_©Œ_wwid
.
©Œ
,

2949 &
dev_©Œ_uuid
.
©Œ
,

2950 #ifdeà
HAVE_UUID_IS_NULL


2951 &
dev_©Œ_nguid
.
©Œ
,

2953 &
dev_©Œ_eui
.
©Œ
,

2954 &
dev_©Œ_nsid
.
©Œ
,

2955 
NULL
,

2958 
umode_t
 
	$nvme_ns_id_©Œs_¬e_visibË
(
kobjeù
 *
kobj
,

2959 
©Œibu‹
 *
a
, 
n
)

2961 
deviû
 *
dev
 = 
	`cÚš”_of
(
kobj
, device, kobj);

2962 
nvme_ns_ids
 *
ids
 = &
	`dev_to_ns_h—d
(
dev
)->ids;

2964 ià(
a
 =ð&
dev_©Œ_uuid
.
©Œ
) {

2965 #ifdeà
HAVE_UUID_IS_NULL


2966 ià(
	`uuid_is_nuÎ
(&
ids
->
uuid
) &&

2967 !
	`memchr_šv
(
ids
->
nguid
, 0, (ids->nguid)))

2970 ià(
a
 =ð&
dev_©Œ_nguid
.
©Œ
) {

2972 ià(!
	`memchr_šv
(
ids
->
nguid
, 0, (ids->nguid)))

2975 ià(
a
 =ð&
dev_©Œ_eui
.
©Œ
) {

2976 ià(!
	`memchr_šv
(
ids
->
eui64
, 0, (ids->eui64)))

2979  
a
->
mode
;

2980 
	}
}

2982 cÚ¡ 
©Œibu‹_group
 
	gnvme_ns_id_©Œ_group
 = {

2983 .
©Œs
 = 
nvme_ns_id_©Œs
,

2984 .
	gis_visibË
 = 
nvme_ns_id_©Œs_¬e_visibË
,

2987 
	#nvme_show_¡r_funùiÚ
(
f›ld
) \

2988 
ssize_t
 
f›ld
##
	`_show
(
deviû
 *
dev
, \

2989 
deviû_©Œibu‹
 *
©Œ
, *
buf
) \

2991 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
); \

2992  
	`¥rštf
(
buf
, "%.*s\n", \

2993 ()(
ù¾
->
subsys
->
f›ld
), ctrl->subsys->field); \

2995 
	`DEVICE_ATTR
(
f›ld
, 
S_IRUGO
, f›ld##
_show
, 
NULL
);

	)

2997 
nvme_show_¡r_funùiÚ
(
mod–
);

2998 
nvme_show_¡r_funùiÚ
(
£rŸl
);

2999 
nvme_show_¡r_funùiÚ
(
fœmw¬e_»v
);

3001 
	#nvme_show_št_funùiÚ
(
f›ld
) \

3002 
ssize_t
 
f›ld
##
	`_show
(
deviû
 *
dev
, \

3003 
deviû_©Œibu‹
 *
©Œ
, *
buf
) \

3005 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
); \

3006  
	`¥rštf
(
buf
, "%d\n", 
ù¾
->
f›ld
); \

3008 
	`DEVICE_ATTR
(
f›ld
, 
S_IRUGO
, f›ld##
_show
, 
NULL
);

	)

3010 
nvme_show_št_funùiÚ
(
úŽid
);

3012 #ifdeà
HAVE_DEVICE_REMOVE_FILE_SELF


3013 
ssize_t
 
	$nvme_sysfs_d–‘e
(
deviû
 *
dev
,

3014 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
,

3015 
size_t
 
couÁ
)

3017 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

3019 ià(
	`deviû_»move_fže_£lf
(
dev
, 
©Œ
))

3020 
	`nvme_d–‘e_ù¾_sync
(
ù¾
);

3021  
couÁ
;

3022 
	}
}

3024 
	$nvme_d–‘e_ÿÎback
(
deviû
 *
dev
)

3026 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

3028 
	`nvme_d–‘e_ù¾_sync
(
ù¾
);

3029 
	}
}

3031 
ssize_t
 
	$nvme_sysfs_d–‘e
(
deviû
 *
dev
,

3032 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
,

3033 
size_t
 
couÁ
)

3035 
»t
;

3040 
»t
 = 
	`deviû_scheduË_ÿÎback
(
dev
, 
nvme_d–‘e_ÿÎback
);

3041 ià(
»t
)

3042 
couÁ
 = 
»t
;

3045 
	`m¦“p
(500);

3047  
couÁ
;

3048 
	}
}

3050 
DEVICE_ATTR
(
d–‘e_cÚŒÞËr
, 
S_IWUSR
, 
NULL
, 
nvme_sysfs_d–‘e
);

3052 
ssize_t
 
	$nvme_sysfs_show_Œª¥Üt
(
deviû
 *
dev
,

3053 
deviû_©Œibu‹
 *
©Œ
,

3054 *
buf
)

3056 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

3058  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%s\n", 
ù¾
->
Ýs
->
Çme
);

3059 
	}
}

3060 
DEVICE_ATTR
(
Œª¥Üt
, 
S_IRUGO
, 
nvme_sysfs_show_Œª¥Üt
, 
NULL
);

3062 
ssize_t
 
	$nvme_sysfs_show_¡©e
(
deviû
 *
dev
,

3063 
deviû_©Œibu‹
 *
©Œ
,

3064 *
buf
)

3066 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

3067 cÚ¡ *cÚ¡ 
¡©e_Çme
[] = {

3068 [
NVME_CTRL_NEW
] = "new",

3069 [
NVME_CTRL_LIVE
] = "live",

3070 [
NVME_CTRL_ADMIN_ONLY
] = "only-admin",

3071 [
NVME_CTRL_RESETTING
] = "resetting",

3072 [
NVME_CTRL_CONNECTING
] = "connecting",

3073 [
NVME_CTRL_DELETING
] = "deleting",

3074 [
NVME_CTRL_DEAD
] = "dead",

3077 ià(()
ù¾
->
¡©e
 < 
	`ARRAY_SIZE
(
¡©e_Çme
) &&

3078 
¡©e_Çme
[
ù¾
->
¡©e
])

3079  
	`¥rštf
(
buf
, "%s\n", 
¡©e_Çme
[
ù¾
->
¡©e
]);

3081  
	`¥rštf
(
buf
, "unknown state\n");

3082 
	}
}

3084 
DEVICE_ATTR
(
¡©e
, 
S_IRUGO
, 
nvme_sysfs_show_¡©e
, 
NULL
);

3086 
ssize_t
 
	$nvme_sysfs_show_subsy¢qn
(
deviû
 *
dev
,

3087 
deviû_©Œibu‹
 *
©Œ
,

3088 *
buf
)

3090 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

3092  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%s\n", 
ù¾
->
subsys
->
subnqn
);

3093 
	}
}

3094 
DEVICE_ATTR
(
subsy¢qn
, 
S_IRUGO
, 
nvme_sysfs_show_subsy¢qn
, 
NULL
);

3096 
ssize_t
 
	$nvme_sysfs_show_add»ss
(
deviû
 *
dev
,

3097 
deviû_©Œibu‹
 *
©Œ
,

3098 *
buf
)

3100 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

3102  
ù¾
->
Ýs
->
	`g‘_add»ss
(ù¾, 
buf
, 
PAGE_SIZE
);

3103 
	}
}

3104 
DEVICE_ATTR
(
add»ss
, 
S_IRUGO
, 
nvme_sysfs_show_add»ss
, 
NULL
);

3106 
©Œibu‹
 *
	gnvme_dev_©Œs
[] = {

3107 &
dev_©Œ_»£t_cÚŒÞËr
.
©Œ
,

3108 &
dev_©Œ_»sÿn_cÚŒÞËr
.
©Œ
,

3109 &
dev_©Œ_mod–
.
©Œ
,

3110 &
dev_©Œ_£rŸl
.
©Œ
,

3111 &
dev_©Œ_fœmw¬e_»v
.
©Œ
,

3112 &
dev_©Œ_úŽid
.
©Œ
,

3113 &
dev_©Œ_d–‘e_cÚŒÞËr
.
©Œ
,

3114 &
dev_©Œ_Œª¥Üt
.
©Œ
,

3115 &
dev_©Œ_subsy¢qn
.
©Œ
,

3116 &
dev_©Œ_add»ss
.
©Œ
,

3117 &
dev_©Œ_¡©e
.
©Œ
,

3118 
NULL


3121 
umode_t
 
	$nvme_dev_©Œs_¬e_visibË
(
kobjeù
 *
kobj
,

3122 
©Œibu‹
 *
a
, 
n
)

3124 
deviû
 *
dev
 = 
	`cÚš”_of
(
kobj
, device, kobj);

3125 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

3127 ià(
a
 =ð&
dev_©Œ_d–‘e_cÚŒÞËr
.
©Œ
 && !
ù¾
->
Ýs
->
d–‘e_ù¾
)

3129 ià(
a
 =ð&
dev_©Œ_add»ss
.
©Œ
 && !
ù¾
->
Ýs
->
g‘_add»ss
)

3132  
a
->
mode
;

3133 
	}
}

3135 
©Œibu‹_group
 
	gnvme_dev_©Œs_group
 = {

3136 .
©Œs
 = 
nvme_dev_©Œs
,

3137 .
	gis_visibË
 = 
nvme_dev_©Œs_¬e_visibË
,

3140 cÚ¡ 
©Œibu‹_group
 *
	gnvme_dev_©Œ_groups
[] = {

3141 &
nvme_dev_©Œs_group
,

3142 
NULL
,

3145 
nvme_ns_h—d
 *
	$__nvme_fšd_ns_h—d
(
nvme_subsy¡em
 *
subsys
,

3146 
nsid
)

3148 
nvme_ns_h—d
 *
h
;

3150 
	`lockd•_as£¹_h–d
(&
subsys
->
lock
);

3152 
	`li¡_fÜ_—ch_’Œy
(
h
, &
subsys
->
nsh—ds
, 
’Œy
) {

3153 ià(
h
->
ns_id
 =ð
nsid
 && 
	`k»f_g‘_uÆess_z”o
(&h->
»f
))

3154  
h
;

3157  
NULL
;

3158 
	}
}

3160 
	$__nvme_check_ids
(
nvme_subsy¡em
 *
subsys
,

3161 
nvme_ns_h—d
 *
Ãw
)

3163 
nvme_ns_h—d
 *
h
;

3165 
	`lockd•_as£¹_h–d
(&
subsys
->
lock
);

3167 
	`li¡_fÜ_—ch_’Œy
(
h
, &
subsys
->
nsh—ds
, 
’Œy
) {

3168 ià(
	`nvme_ns_ids_v®id
(&
Ãw
->
ids
) &&

3169 !
	`li¡_em±y
(&
h
->
li¡
) &&

3170 
	`nvme_ns_ids_equ®
(&
Ãw
->
ids
, &
h
->ids))

3171  -
EINVAL
;

3175 
	}
}

3177 
nvme_ns_h—d
 *
	$nvme_®loc_ns_h—d
(
nvme_ù¾
 *
ù¾
,

3178 
nsid
, 
nvme_id_ns
 *
id
)

3180 
nvme_ns_h—d
 *
h—d
;

3181 
»t
 = -
ENOMEM
;

3183 
h—d
 = 
	`kz®loc
((*h—d), 
GFP_KERNEL
);

3184 ià(!
h—d
)

3185 
out
;

3186 
»t
 = 
	`ida_sim¶e_g‘
(&
ù¾
->
subsys
->
ns_ida
, 1, 0, 
GFP_KERNEL
);

3187 ià(
»t
 < 0)

3188 
out_ä“_h—d
;

3189 
h—d
->
š¡ªû
 = 
»t
;

3190 
	`INIT_LIST_HEAD
(&
h—d
->
li¡
);

3191 #iâdeà
HAVE_CLEANUP_SRCU_STRUCT_QUIESCED


3192 
	`INIT_WORK
(&
h—d
->
ä“_wÜk
, 
nvme_ä“_ns_h—d_wÜk
);

3194 
»t
 = 
	`š™_¤cu_¡ruù
(&
h—d
->
¤cu
);

3195 ià(
»t
)

3196 
out_ida_»move
;

3197 
h—d
->
subsys
 = 
ù¾
->subsys;

3198 
h—d
->
ns_id
 = 
nsid
;

3199 
	`k»f_š™
(&
h—d
->
»f
);

3201 
	`nvme_»pÜt_ns_ids
(
ù¾
, 
nsid
, 
id
, &
h—d
->
ids
);

3203 
»t
 = 
	`__nvme_check_ids
(
ù¾
->
subsys
, 
h—d
);

3204 ià(
»t
) {

3205 
	`dev_”r
(
ù¾
->
deviû
,

3206 "du¶iÿ‹ ID fÜ‚sid %d\n", 
nsid
);

3207 
out_þ—nup_¤cu
;

3210 
»t
 = 
	`nvme_m·th_®loc_disk
(
ù¾
, 
h—d
);

3211 ià(
»t
)

3212 
out_þ—nup_¤cu
;

3214 
	`li¡_add_ž
(&
h—d
->
’Œy
, &
ù¾
->
subsys
->
nsh—ds
);

3216 
	`k»f_g‘
(&
ù¾
->
subsys
->
»f
);

3218  
h—d
;

3219 
out_þ—nup_¤cu
:

3220 
	`þ—nup_¤cu_¡ruù
(&
h—d
->
¤cu
);

3221 
out_ida_»move
:

3222 
	`ida_sim¶e_»move
(&
ù¾
->
subsys
->
ns_ida
, 
h—d
->
š¡ªû
);

3223 
out_ä“_h—d
:

3224 
	`kä“
(
h—d
);

3225 
out
:

3226  
	`ERR_PTR
(
»t
);

3227 
	}
}

3229 
	$nvme_š™_ns_h—d
(
nvme_ns
 *
ns
, 
nsid
,

3230 
nvme_id_ns
 *
id
)

3232 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

3233 
boÞ
 
is_sh¬ed
 = 
id
->
nmic
 & (1 << 0);

3234 
nvme_ns_h—d
 *
h—d
 = 
NULL
;

3235 
»t
 = 0;

3237 
	`mu‹x_lock
(&
ù¾
->
subsys
->
lock
);

3238 ià(
is_sh¬ed
)

3239 
h—d
 = 
	`__nvme_fšd_ns_h—d
(
ù¾
->
subsys
, 
nsid
);

3240 ià(!
h—d
) {

3241 
h—d
 = 
	`nvme_®loc_ns_h—d
(
ù¾
, 
nsid
, 
id
);

3242 ià(
	`IS_ERR
(
h—d
)) {

3243 
»t
 = 
	`PTR_ERR
(
h—d
);

3244 
out_uÆock
;

3247 
nvme_ns_ids
 
ids
;

3249 
	`nvme_»pÜt_ns_ids
(
ù¾
, 
nsid
, 
id
, &
ids
);

3250 ià(!
	`nvme_ns_ids_equ®
(&
h—d
->
ids
, &ids)) {

3251 
	`dev_”r
(
ù¾
->
deviû
,

3253 
nsid
);

3254 
»t
 = -
EINVAL
;

3255 
out_uÆock
;

3259 
	`li¡_add_ž
(&
ns
->
siblšgs
, &
h—d
->
li¡
);

3260 
ns
->
h—d
 = head;

3262 
out_uÆock
:

3263 
	`mu‹x_uÆock
(&
ù¾
->
subsys
->
lock
);

3264  
»t
;

3265 
	}
}

3267 
	$ns_cmp
(*
´iv
, 
li¡_h—d
 *
a
, li¡_h—d *
b
)

3269 
nvme_ns
 *
n§
 = 
	`cÚš”_of
(
a
, nvme_ns, 
li¡
);

3270 
nvme_ns
 *
nsb
 = 
	`cÚš”_of
(
b
, nvme_ns, 
li¡
);

3272  
n§
->
h—d
->
ns_id
 - 
nsb
->head->ns_id;

3273 
	}
}

3275 
nvme_ns
 *
	$nvme_fšd_g‘_ns
(
nvme_ù¾
 *
ù¾
, 
nsid
)

3277 
nvme_ns
 *
ns
, *
»t
 = 
NULL
;

3279 
	`down_»ad
(&
ù¾
->
Çme¥aûs_rw£m
);

3280 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
) {

3281 ià(
ns
->
h—d
->
ns_id
 =ð
nsid
) {

3282 ià(!
	`k»f_g‘_uÆess_z”o
(&
ns
->
k»f
))

3284 
»t
 = 
ns
;

3287 ià(
ns
->
h—d
->
ns_id
 > 
nsid
)

3290 
	`up_»ad
(&
ù¾
->
Çme¥aûs_rw£m
);

3291  
»t
;

3292 
	}
}

3294 #ifdeà
HAVE_BLK_MAX_WRITE_HINTS


3295 
	$nvme_£tup_¡»ams_ns
(
nvme_ù¾
 *
ù¾
, 
nvme_ns
 *
ns
)

3297 
¡»ams_dœeùive_·¿ms
 
s
;

3298 
»t
;

3300 ià(!
ù¾
->
Ä_¡»ams
)

3303 
»t
 = 
	`nvme_g‘_¡»am_·¿ms
(
ù¾
, &
s
, 
ns
->
h—d
->
ns_id
);

3304 ià(
»t
)

3305  
»t
;

3307 
ns
->
sws
 = 
	`Ë32_to_ýu
(
s
.sws);

3308 
ns
->
sgs
 = 
	`Ë16_to_ýu
(
s
.sgs);

3310 ià(
ns
->
sws
) {

3311 
bs
 = 1 << 
ns
->
lba_shiá
;

3313 
	`blk_queue_io_mš
(
ns
->
queue
, 
bs
 *‚s->
sws
);

3314 ià(
ns
->
sgs
)

3315 
	`blk_queue_io_Ýt
(
ns
->
queue
, 
bs
 *‚s->
sws
 *‚s->
sgs
);

3319 
	}
}

3322 
	$nvme_®loc_ns
(
nvme_ù¾
 *
ù¾
, 
nsid
)

3324 
nvme_ns
 *
ns
;

3325 
g’disk
 *
disk
;

3326 
nvme_id_ns
 *
id
;

3327 
disk_Çme
[
DISK_NAME_LEN
];

3328 
node
 = 
	`dev_to_node
(
ù¾
->
dev
), 
æags
 = 
GENHD_FL_EXT_DEVT
;

3330 
ns
 = 
	`kz®loc_node
((*ns), 
GFP_KERNEL
, 
node
);

3331 ià(!
ns
)

3334 
ns
->
queue
 = 
	`blk_mq_š™_queue
(
ù¾
->
g£t
);

3335 ià(
	`IS_ERR
(
ns
->
queue
))

3336 
out_ä“_ns
;

3337 
	`blk_queue_æag_£t
(
QUEUE_FLAG_NONROT
, 
ns
->
queue
);

3338 
ns
->
queue
->
queued©a
 =‚s;

3339 
ns
->
ù¾
 = ctrl;

3341 
	`k»f_š™
(&
ns
->
k»f
);

3342 
ns
->
lba_shiá
 = 9;

3344 
	`blk_queue_logiÿl_block_size
(
ns
->
queue
, 1 <<‚s->
lba_shiá
);

3345 
	`nvme_£t_queue_lim™s
(
ù¾
, 
ns
->
queue
);

3347 
id
 = 
	`nvme_id’tify_ns
(
ù¾
, 
nsid
);

3348 ià(!
id
)

3349 
out_ä“_queue
;

3351 ià(
id
->
nÿp
 == 0)

3352 
out_ä“_id
;

3354 ià(
	`nvme_š™_ns_h—d
(
ns
, 
nsid
, 
id
))

3355 
out_ä“_id
;

3356 #ifdeà
HAVE_BLK_MAX_WRITE_HINTS


3357 
	`nvme_£tup_¡»ams_ns
(
ù¾
, 
ns
);

3359 
	`nvme_£t_disk_Çme
(
disk_Çme
, 
ns
, 
ù¾
, &
æags
);

3361 ià((
ù¾
->
quœks
 & 
NVME_QUIRK_LIGHTNVM
è&& 
id
->
vs
[0] == 0x1) {

3362 ià(
	`nvme_nvm_»gi¡”
(
ns
, 
disk_Çme
, 
node
)) {

3363 
	`dev_w¬n
(
ù¾
->
deviû
, "LightNVM init failure\n");

3364 
out_uÆšk_ns
;

3368 
disk
 = 
	`®loc_disk_node
(0, 
node
);

3369 ià(!
disk
)

3370 
out_uÆšk_ns
;

3372 
disk
->
fÝs
 = &
nvme_fÝs
;

3373 
disk
->
´iv©e_d©a
 = 
ns
;

3374 
disk
->
queue
 = 
ns
->queue;

3375 #iâdeà
HAVE_DEVICE_ADD_DISK


3376 
disk
->
driv”fs_dev
 = 
ù¾
->
deviû
;

3378 
disk
->
æags
 = flags;

3379 
	`memýy
(
disk
->
disk_Çme
, disk_Çme, 
DISK_NAME_LEN
);

3380 
ns
->
disk
 = disk;

3382 
	`__nvme_»v®id©e_disk
(
disk
, 
id
);

3384 
	`down_wr™e
(&
ù¾
->
Çme¥aûs_rw£m
);

3385 
	`li¡_add_ž
(&
ns
->
li¡
, &
ù¾
->
Çme¥aûs
);

3386 
	`up_wr™e
(&
ù¾
->
Çme¥aûs_rw£m
);

3388 
	`nvme_g‘_ù¾
(
ù¾
);

3390 
	`kä“
(
id
);

3392 #ifdeà
HAVE_DEVICE_ADD_DISK


3393 
	`deviû_add_disk
(
ù¾
->
deviû
, 
ns
->
disk
);

3395 
	`add_disk
(
ns
->
disk
);

3397 ià(
	`sysfs_ü—‹_group
(&
	`disk_to_dev
(
ns
->
disk
)->
kobj
,

3398 &
nvme_ns_id_©Œ_group
))

3399 
	`´_w¬n
("%s: failedo create sysfs group for identification\n",

3400 
ns
->
disk
->
disk_Çme
);

3401 ià(
ns
->
ndev
 && 
	`nvme_nvm_»gi¡”_sysfs
(ns))

3402 
	`´_w¬n
("%s: failedo„egister†ightnvm sysfs group for identification\n",

3403 
ns
->
disk
->
disk_Çme
);

3405 
	`nvme_m·th_add_disk
(
ns
->
h—d
);

3406 
	`nvme_çuÉ_šjeù_š™
(
ns
);

3408 
out_uÆšk_ns
:

3409 
	`mu‹x_lock
(&
ù¾
->
subsys
->
lock
);

3410 
	`li¡_d–_rcu
(&
ns
->
siblšgs
);

3411 
	`mu‹x_uÆock
(&
ù¾
->
subsys
->
lock
);

3412 
out_ä“_id
:

3413 
	`kä“
(
id
);

3414 
out_ä“_queue
:

3415 
	`blk_þ—nup_queue
(
ns
->
queue
);

3416 
out_ä“_ns
:

3417 
	`kä“
(
ns
);

3418 
	}
}

3420 
	$nvme_ns_»move
(
nvme_ns
 *
ns
)

3422 ià(
	`‹¡_ªd_£t_b™
(
NVME_NS_REMOVING
, &
ns
->
æags
))

3425 
	`nvme_çuÉ_šjeù_fši
(
ns
);

3426 ià(
ns
->
disk
 &&‚s->disk->
æags
 & 
GENHD_FL_UP
) {

3427 
	`sysfs_»move_group
(&
	`disk_to_dev
(
ns
->
disk
)->
kobj
,

3428 &
nvme_ns_id_©Œ_group
);

3429 ià(
ns
->
ndev
)

3430 
	`nvme_nvm_uÄegi¡”_sysfs
(
ns
);

3431 
	`d–_g’disk
(
ns
->
disk
);

3432 
	`blk_þ—nup_queue
(
ns
->
queue
);

3433 ià(
	`blk_g‘_š‹gr™y
(
ns
->
disk
))

3434 
	`blk_š‹gr™y_uÄegi¡”
(
ns
->
disk
);

3437 
	`mu‹x_lock
(&
ns
->
ù¾
->
subsys
->
lock
);

3438 
	`nvme_m·th_þ—r_cu¼’t_·th
(
ns
);

3439 
	`li¡_d–_rcu
(&
ns
->
siblšgs
);

3440 
	`mu‹x_uÆock
(&
ns
->
ù¾
->
subsys
->
lock
);

3442 
	`down_wr™e
(&
ns
->
ù¾
->
Çme¥aûs_rw£m
);

3443 
	`li¡_d–_š™
(&
ns
->
li¡
);

3444 
	`up_wr™e
(&
ns
->
ù¾
->
Çme¥aûs_rw£m
);

3446 
	`synchrÚize_¤cu
(&
ns
->
h—d
->
¤cu
);

3447 
	`nvme_m·th_check_Ï¡_·th
(
ns
);

3448 
	`nvme_put_ns
(
ns
);

3449 
	}
}

3451 
	$nvme_v®id©e_ns
(
nvme_ù¾
 *
ù¾
, 
nsid
)

3453 
nvme_ns
 *
ns
;

3455 
ns
 = 
	`nvme_fšd_g‘_ns
(
ù¾
, 
nsid
);

3456 ià(
ns
) {

3457 ià(
ns
->
disk
 && 
	`»v®id©e_disk
(ns->disk))

3458 
	`nvme_ns_»move
(
ns
);

3459 
	`nvme_put_ns
(
ns
);

3461 
	`nvme_®loc_ns
(
ù¾
, 
nsid
);

3462 
	}
}

3464 
	$nvme_»move_šv®id_Çme¥aûs
(
nvme_ù¾
 *
ù¾
,

3465 
nsid
)

3467 
nvme_ns
 *
ns
, *
Ãxt
;

3468 
	`LIST_HEAD
(
rm_li¡
);

3470 
	`down_wr™e
(&
ù¾
->
Çme¥aûs_rw£m
);

3471 
	`li¡_fÜ_—ch_’Œy_§ã
(
ns
, 
Ãxt
, &
ù¾
->
Çme¥aûs
, 
li¡
) {

3472 ià(
ns
->
h—d
->
ns_id
 > 
nsid
)

3473 
	`li¡_move_ž
(&
ns
->
li¡
, &
rm_li¡
);

3475 
	`up_wr™e
(&
ù¾
->
Çme¥aûs_rw£m
);

3477 
	`li¡_fÜ_—ch_’Œy_§ã
(
ns
, 
Ãxt
, &
rm_li¡
, 
li¡
)

3478 
	`nvme_ns_»move
(
ns
);

3480 
	}
}

3482 
	$nvme_sÿn_ns_li¡
(
nvme_ù¾
 *
ù¾
, 
Â
)

3484 
nvme_ns
 *
ns
;

3485 
__Ë32
 *
ns_li¡
;

3486 
i
, 
j
, 
nsid
, 
´ev
 = 0, 
num_li¡s
 = 
	`DIV_ROUND_UP
(
Â
, 1024);

3487 
»t
 = 0;

3489 
ns_li¡
 = 
	`kz®loc
(
NVME_IDENTIFY_DATA_SIZE
, 
GFP_KERNEL
);

3490 ià(!
ns_li¡
)

3491  -
ENOMEM
;

3493 
i
 = 0; i < 
num_li¡s
; i++) {

3494 
»t
 = 
	`nvme_id’tify_ns_li¡
(
ù¾
, 
´ev
, 
ns_li¡
);

3495 ià(
»t
)

3496 
ä“
;

3498 
j
 = 0; j < 
	`mš
(
Â
, 1024U); j++) {

3499 
nsid
 = 
	`Ë32_to_ýu
(
ns_li¡
[
j
]);

3500 ià(!
nsid
)

3501 
out
;

3503 
	`nvme_v®id©e_ns
(
ù¾
, 
nsid
);

3505 ++
´ev
 < 
nsid
) {

3506 
ns
 = 
	`nvme_fšd_g‘_ns
(
ù¾
, 
´ev
);

3507 ià(
ns
) {

3508 
	`nvme_ns_»move
(
ns
);

3509 
	`nvme_put_ns
(
ns
);

3513 
Â
 -ð
j
;

3515 
out
:

3516 
	`nvme_»move_šv®id_Çme¥aûs
(
ù¾
, 
´ev
);

3517 
ä“
:

3518 
	`kä“
(
ns_li¡
);

3519  
»t
;

3520 
	}
}

3522 
	$nvme_sÿn_ns_£qu’tŸl
(
nvme_ù¾
 *
ù¾
, 
Â
)

3524 
i
;

3526 
i
 = 1; i <ð
Â
; i++)

3527 
	`nvme_v®id©e_ns
(
ù¾
, 
i
);

3529 
	`nvme_»move_šv®id_Çme¥aûs
(
ù¾
, 
Â
);

3530 
	}
}

3532 
boÞ
 
	$nvme_sÿn_chªged_ns_log
(
nvme_ù¾
 *
ù¾
)

3534 
size_t
 
log_size
 = 
NVME_MAX_CHANGED_NAMESPACES
 * (
__Ë32
);

3535 
__Ë32
 *
log
;

3536 
”rÜ
, 
i
;

3537 
boÞ
 
»t
 = 
çl£
;

3539 
log
 = 
	`kz®loc
(
log_size
, 
GFP_KERNEL
);

3540 ià(!
log
)

3541  
çl£
;

3543 
”rÜ
 = 
	`nvme_g‘_log
(
ù¾
, 
NVME_LOG_CHANGED_NS
, 
log
, 
log_size
);

3544 ià(
”rÜ
) {

3545 
	`dev_w¬n
(
ù¾
->
deviû
,

3546 "»adšg chªged‚ log fažed: %d\n", 
”rÜ
);

3547 
out_ä“_log
;

3550 ià(
log
[0] =ð
	`ýu_to_Ë32
(0xffffffff))

3551 
out_ä“_log
;

3553 
i
 = 0; i < 
NVME_MAX_CHANGED_NAMESPACES
; i++) {

3554 
u32
 
nsid
 = 
	`Ë32_to_ýu
(
log
[
i
]);

3556 ià(
nsid
 == 0)

3558 
	`dev_šfo
(
ù¾
->
deviû
, "»sÿÂšg‚ame¥aû %d.\n", 
nsid
);

3559 
	`nvme_v®id©e_ns
(
ù¾
, 
nsid
);

3561 
»t
 = 
Œue
;

3563 
out_ä“_log
:

3564 
	`kä“
(
log
);

3565  
»t
;

3566 
	}
}

3568 
	$nvme_sÿn_wÜk
(
wÜk_¡ruù
 *
wÜk
)

3570 
nvme_ù¾
 *
ù¾
 =

3571 
	`cÚš”_of
(
wÜk
, 
nvme_ù¾
, 
sÿn_wÜk
);

3572 
nvme_id_ù¾
 *
id
;

3573 
Â
;

3575 ià(
ù¾
->
¡©e
 !ð
NVME_CTRL_LIVE
)

3578 
	`WARN_ON_ONCE
(!
ù¾
->
g£t
);

3580 ià(
	`‹¡_ªd_þ—r_b™
(
EVENT_NS_CHANGED
, &
ù¾
->
ev’ts
)) {

3581 ià(
	`nvme_sÿn_chªged_ns_log
(
ù¾
))

3582 
out_sÜt_Çme¥aûs
;

3583 
	`dev_šfo
(
ù¾
->
deviû
, "rescanning‚amespaces.\n");

3586 ià(
	`nvme_id’tify_ù¾
(
ù¾
, &
id
))

3589 
Â
 = 
	`Ë32_to_ýu
(
id
->nn);

3590 ià(
ù¾
->
vs
 >ð
	`NVME_VS
(1, 1, 0) &&

3591 !(
ù¾
->
quœks
 & 
NVME_QUIRK_IDENTIFY_CNS
)) {

3592 ià(!
	`nvme_sÿn_ns_li¡
(
ù¾
, 
Â
))

3593 
out_ä“_id
;

3595 
	`nvme_sÿn_ns_£qu’tŸl
(
ù¾
, 
Â
);

3596 
out_ä“_id
:

3597 
	`kä“
(
id
);

3598 
out_sÜt_Çme¥aûs
:

3599 
	`down_wr™e
(&
ù¾
->
Çme¥aûs_rw£m
);

3600 
	`li¡_sÜt
(
NULL
, &
ù¾
->
Çme¥aûs
, 
ns_cmp
);

3601 
	`up_wr™e
(&
ù¾
->
Çme¥aûs_rw£m
);

3602 
	}
}

3609 
	$nvme_»move_Çme¥aûs
(
nvme_ù¾
 *
ù¾
)

3611 
nvme_ns
 *
ns
, *
Ãxt
;

3612 
	`LIST_HEAD
(
ns_li¡
);

3620 ià(
ù¾
->
¡©e
 =ð
NVME_CTRL_DEAD
)

3621 
	`nvme_kžl_queues
(
ù¾
);

3623 
	`down_wr™e
(&
ù¾
->
Çme¥aûs_rw£m
);

3624 
	`li¡_¥liû_š™
(&
ù¾
->
Çme¥aûs
, &
ns_li¡
);

3625 
	`up_wr™e
(&
ù¾
->
Çme¥aûs_rw£m
);

3627 
	`li¡_fÜ_—ch_’Œy_§ã
(
ns
, 
Ãxt
, &
ns_li¡
, 
li¡
)

3628 
	`nvme_ns_»move
(
ns
);

3629 
	}
}

3630 
EXPORT_SYMBOL_GPL
(
nvme_»move_Çme¥aûs
);

3632 
	$nvme_«n_uev’t
(
nvme_ù¾
 *
ù¾
)

3634 *
’vp
[2] = { 
NULL
, NULL };

3635 
u32
 
«n_»suÉ
 = 
ù¾
->aen_result;

3637 
ù¾
->
«n_»suÉ
 = 0;

3638 ià(!
«n_»suÉ
)

3641 
’vp
[0] = 
	`ka¥rštf
(
GFP_KERNEL
, "NVME_AEN=%#08x", 
«n_»suÉ
);

3642 ià(!
’vp
[0])

3644 
	`kobjeù_uev’t_’v
(&
ù¾
->
deviû
->
kobj
, 
KOBJ_CHANGE
, 
’vp
);

3645 
	`kä“
(
’vp
[0]);

3646 
	}
}

3648 
	$nvme_async_ev’t_wÜk
(
wÜk_¡ruù
 *
wÜk
)

3650 
nvme_ù¾
 *
ù¾
 =

3651 
	`cÚš”_of
(
wÜk
, 
nvme_ù¾
, 
async_ev’t_wÜk
);

3653 
	`nvme_«n_uev’t
(
ù¾
);

3654 
ù¾
->
Ýs
->
	`subm™_async_ev’t
(ctrl);

3655 
	}
}

3657 
boÞ
 
	$nvme_ù¾_µ_¡©us
(
nvme_ù¾
 *
ù¾
)

3660 
u32
 
c¡s
;

3662 ià(
ù¾
->
Ýs
->
	`»g_»ad32
(ù¾, 
NVME_REG_CSTS
, &
c¡s
))

3663  
çl£
;

3665 ià(
c¡s
 == ~0)

3666  
çl£
;

3668  ((
ù¾
->
ù¾_cÚfig
 & 
NVME_CC_ENABLE
è&& (
c¡s
 & 
NVME_CSTS_PP
));

3669 
	}
}

3671 
	$nvme_g‘_fw_¦Ù_šfo
(
nvme_ù¾
 *
ù¾
)

3673 
nvme_fw_¦Ù_šfo_log
 *
log
;

3675 
log
 = 
	`km®loc
((*log), 
GFP_KERNEL
);

3676 ià(!
log
)

3679 ià(
	`nvme_g‘_log
(
ù¾
, 
NVME_LOG_FW_SLOT
, 
log
, (*log)))

3680 
	`dev_w¬n
(
ù¾
->
deviû
,

3682 
	`kä“
(
log
);

3683 
	}
}

3685 
	$nvme_fw_aù_wÜk
(
wÜk_¡ruù
 *
wÜk
)

3687 
nvme_ù¾
 *
ù¾
 = 
	`cÚš”_of
(
wÜk
,

3688 
nvme_ù¾
, 
fw_aù_wÜk
);

3689 
fw_aù_timeout
;

3691 ià(
ù¾
->
mtç
)

3692 
fw_aù_timeout
 = 
jiff›s
 +

3693 
	`m£cs_to_jiff›s
(
ù¾
->
mtç
 * 100);

3695 
fw_aù_timeout
 = 
jiff›s
 +

3696 
	`m£cs_to_jiff›s
(
admš_timeout
 * 1000);

3698 
	`nvme_¡Ý_queues
(
ù¾
);

3699 
	`nvme_ù¾_µ_¡©us
(
ù¾
)) {

3700 ià(
	`time_aá”
(
jiff›s
, 
fw_aù_timeout
)) {

3701 
	`dev_w¬n
(
ù¾
->
deviû
,

3703 
	`nvme_»£t_ù¾
(
ù¾
);

3706 
	`m¦“p
(100);

3709 ià(
ù¾
->
¡©e
 !ð
NVME_CTRL_LIVE
)

3712 
	`nvme_¡¬t_queues
(
ù¾
);

3714 
	`nvme_g‘_fw_¦Ù_šfo
(
ù¾
);

3715 
	}
}

3717 
	$nvme_hªdË_«n_nÙiû
(
nvme_ù¾
 *
ù¾
, 
u32
 
»suÉ
)

3719 (
»suÉ
 & 0xff00) >> 8) {

3720 
NVME_AER_NOTICE_NS_CHANGED
:

3721 
	`£t_b™
(
EVENT_NS_CHANGED
, &
ù¾
->
ev’ts
);

3722 
	`nvme_queue_sÿn
(
ù¾
);

3724 
NVME_AER_NOTICE_FW_ACT_STARTING
:

3725 
	`queue_wÜk
(
nvme_wq
, &
ù¾
->
fw_aù_wÜk
);

3728 
	`dev_w¬n
(
ù¾
->
deviû
, "asynøev’ˆ»suÉ %08x\n", 
»suÉ
);

3730 
	}
}

3732 
	$nvme_com¶‘e_async_ev’t
(
nvme_ù¾
 *
ù¾
, 
__Ë16
 
¡©us
,

3733 vÞ©ž
nvme_»suÉ
 *
»s
)

3735 
u32
 
»suÉ
 = 
	`Ë32_to_ýu
(
»s
->u32);

3737 ià(
	`Ë16_to_ýu
(
¡©us
è>> 1 !ð
NVME_SC_SUCCESS
)

3740 
»suÉ
 & 0x7) {

3741 
NVME_AER_NOTICE
:

3742 
	`nvme_hªdË_«n_nÙiû
(
ù¾
, 
»suÉ
);

3744 
NVME_AER_ERROR
:

3745 
NVME_AER_SMART
:

3746 
NVME_AER_CSS
:

3747 
NVME_AER_VS
:

3748 
ù¾
->
«n_»suÉ
 = 
»suÉ
;

3753 
	`queue_wÜk
(
nvme_wq
, &
ù¾
->
async_ev’t_wÜk
);

3754 
	}
}

3755 
EXPORT_SYMBOL_GPL
(
nvme_com¶‘e_async_ev’t
);

3757 
	$nvme_¡Ý_ù¾
(
nvme_ù¾
 *
ù¾
)

3759 
	`nvme_¡Ý_k“p_®ive
(
ù¾
);

3760 
	`æush_wÜk
(&
ù¾
->
async_ev’t_wÜk
);

3761 
	`æush_wÜk
(&
ù¾
->
sÿn_wÜk
);

3762 
	`ÿnûl_wÜk_sync
(&
ù¾
->
fw_aù_wÜk
);

3763 ià(
ù¾
->
Ýs
->
¡Ý_ù¾
)

3764 
ù¾
->
Ýs
->
	`¡Ý_ù¾
(ctrl);

3765 
	}
}

3766 
EXPORT_SYMBOL_GPL
(
nvme_¡Ý_ù¾
);

3768 
	$nvme_¡¬t_ù¾
(
nvme_ù¾
 *
ù¾
)

3770 ià(
ù¾
->
queue_couÁ
 > 1) {

3771 
	`nvme_queue_sÿn
(
ù¾
);

3772 
	`nvme_’abË_«n
(
ù¾
);

3773 
	`queue_wÜk
(
nvme_wq
, &
ù¾
->
async_ev’t_wÜk
);

3774 
	`nvme_¡¬t_queues
(
ù¾
);

3776 
	}
}

3777 
EXPORT_SYMBOL_GPL
(
nvme_¡¬t_ù¾
);

3779 
	$nvme_unš™_ù¾
(
nvme_ù¾
 *
ù¾
)

3781 
	`cdev_deviû_d–
(&
ù¾
->
cdev
, cŒl->
deviû
);

3782 
	}
}

3783 
EXPORT_SYMBOL_GPL
(
nvme_unš™_ù¾
);

3785 
	$nvme_ä“_ù¾
(
deviû
 *
dev
)

3787 
nvme_ù¾
 *
ù¾
 =

3788 
	`cÚš”_of
(
dev
, 
nvme_ù¾
, 
ù¾_deviû
);

3789 
nvme_subsy¡em
 *
subsys
 = 
ù¾
->subsys;

3791 
	`ida_sim¶e_»move
(&
nvme_š¡ªû_ida
, 
ù¾
->
š¡ªû
);

3792 
	`kä“
(
ù¾
->
efãùs
);

3794 ià(
subsys
) {

3795 
	`mu‹x_lock
(&
subsys
->
lock
);

3796 
	`li¡_d–
(&
ù¾
->
subsys_’Œy
);

3797 
	`mu‹x_uÆock
(&
subsys
->
lock
);

3798 
	`sysfs_»move_lšk
(&
subsys
->
dev
.
kobj
, 
	`dev_Çme
(
ù¾
->
deviû
));

3801 
ù¾
->
Ýs
->
	`ä“_ù¾
(ctrl);

3803 ià(
subsys
)

3804 
	`nvme_put_subsy¡em
(
subsys
);

3805 
	}
}

3812 
	$nvme_š™_ù¾
(
nvme_ù¾
 *
ù¾
, 
deviû
 *
dev
,

3813 cÚ¡ 
nvme_ù¾_Ýs
 *
Ýs
, 
quœks
)

3815 
»t
;

3817 
ù¾
->
¡©e
 = 
NVME_CTRL_NEW
;

3818 
	`¥š_lock_š™
(&
ù¾
->
lock
);

3819 
	`INIT_LIST_HEAD
(&
ù¾
->
Çme¥aûs
);

3820 
	`š™_rw£m
(&
ù¾
->
Çme¥aûs_rw£m
);

3821 
ù¾
->
dev
 = dev;

3822 
ù¾
->
Ýs
 = ops;

3823 
ù¾
->
quœks
 = quirks;

3824 
	`INIT_WORK
(&
ù¾
->
sÿn_wÜk
, 
nvme_sÿn_wÜk
);

3825 
	`INIT_WORK
(&
ù¾
->
async_ev’t_wÜk
, 
nvme_async_ev’t_wÜk
);

3826 
	`INIT_WORK
(&
ù¾
->
fw_aù_wÜk
, 
nvme_fw_aù_wÜk
);

3827 
	`INIT_WORK
(&
ù¾
->
d–‘e_wÜk
, 
nvme_d–‘e_ù¾_wÜk
);

3829 
»t
 = 
	`ida_sim¶e_g‘
(&
nvme_š¡ªû_ida
, 0, 0, 
GFP_KERNEL
);

3830 ià(
»t
 < 0)

3831 
out
;

3832 
ù¾
->
š¡ªû
 = 
»t
;

3834 
	`deviû_š™Ÿlize
(&
ù¾
->
ù¾_deviû
);

3835 
ù¾
->
deviû
 = &ù¾->
ù¾_deviû
;

3836 
ù¾
->
deviû
->
devt
 = 
	`MKDEV
(
	`MAJOR
(
nvme_chr_devt
), cŒl->
š¡ªû
);

3837 
ù¾
->
deviû
->
þass
 = 
nvme_þass
;

3838 
ù¾
->
deviû
->
·»Á
 = cŒl->
dev
;

3839 
ù¾
->
deviû
->
groups
 = 
nvme_dev_©Œ_groups
;

3840 
ù¾
->
deviû
->
»Ëa£
 = 
nvme_ä“_ù¾
;

3841 
	`dev_£t_drvd©a
(
ù¾
->
deviû
, ctrl);

3842 
»t
 = 
	`dev_£t_Çme
(
ù¾
->
deviû
, "nvme%d", cŒl->
š¡ªû
);

3843 ià(
»t
)

3844 
out_»Ëa£_š¡ªû
;

3846 
	`cdev_š™
(&
ù¾
->
cdev
, &
nvme_dev_fÝs
);

3847 
ù¾
->
cdev
.
owÃr
 = 
Ýs
->
moduË
;

3848 
»t
 = 
	`cdev_deviû_add
(&
ù¾
->
cdev
, cŒl->
deviû
);

3849 ià(
»t
)

3850 
out_ä“_Çme
;

3856 #ifdeà
HAVE_DEV_PM_INFO_SET_LATENCY_TOLERANCE


3857 
ù¾
->
deviû
->
pow”
.
£t_Ï‹ncy_tÞ”ªû
 = 
nvme_£t_Ï‹ncy_tÞ”ªû
;

3858 
	`dev_pm_qos_upd©e_u£r_Ï‹ncy_tÞ”ªû
(
ù¾
->
deviû
,

3859 
	`mš
(
deçuÉ_ps_max_Ï‹ncy_us
, ()
S32_MAX
));

3863 
out_ä“_Çme
:

3864 
	`kä“_cÚ¡
(
dev
->
kobj
.
Çme
);

3865 
out_»Ëa£_š¡ªû
:

3866 
	`ida_sim¶e_»move
(&
nvme_š¡ªû_ida
, 
ù¾
->
š¡ªû
);

3867 
out
:

3868  
»t
;

3869 
	}
}

3870 
EXPORT_SYMBOL_GPL
(
nvme_š™_ù¾
);

3879 
	$nvme_kžl_queues
(
nvme_ù¾
 *
ù¾
)

3881 
nvme_ns
 *
ns
;

3883 
	`down_»ad
(&
ù¾
->
Çme¥aûs_rw£m
);

3886 ià(
ù¾
->
admš_q
)

3887 #ifdeà
HAVE_BLK_MQ_UNQUIESCE_QUEUE


3888 
	`blk_mq_unqu›sû_queue
(
ù¾
->
admš_q
);

3890 
	`blk_mq_¡¬t_¡Ý³d_hw_queues
(
ù¾
->
admš_q
, 
Œue
);

3893 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
) {

3898 ià(!
ns
->
disk
 || 
	`‹¡_ªd_£t_b™
(
NVME_NS_DEAD
, &ns->
æags
))

3900 
	`»v®id©e_disk
(
ns
->
disk
);

3901 
	`blk_£t_queue_dyšg
(
ns
->
queue
);

3904 #ifdeà
HAVE_BLK_MQ_UNQUIESCE_QUEUE


3905 
	`blk_mq_unqu›sû_queue
(
ns
->
queue
);

3907 
	`blk_mq_¡¬t_¡Ý³d_hw_queues
(
ns
->
queue
, 
Œue
);

3910 
	`up_»ad
(&
ù¾
->
Çme¥aûs_rw£m
);

3911 
	}
}

3912 
EXPORT_SYMBOL_GPL
(
nvme_kžl_queues
);

3914 
	$nvme_unä“ze
(
nvme_ù¾
 *
ù¾
)

3916 
nvme_ns
 *
ns
;

3918 
	`down_»ad
(&
ù¾
->
Çme¥aûs_rw£m
);

3919 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
)

3920 
	`blk_mq_unä“ze_queue
(
ns
->
queue
);

3921 
	`up_»ad
(&
ù¾
->
Çme¥aûs_rw£m
);

3922 
	}
}

3923 
EXPORT_SYMBOL_GPL
(
nvme_unä“ze
);

3925 
	$nvme_wa™_ä“ze_timeout
(
nvme_ù¾
 *
ù¾
, 
timeout
)

3927 
nvme_ns
 *
ns
;

3929 
	`down_»ad
(&
ù¾
->
Çme¥aûs_rw£m
);

3930 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
) {

3931 
timeout
 = 
	`blk_mq_ä“ze_queue_wa™_timeout
(
ns
->
queue
,imeout);

3932 ià(
timeout
 <= 0)

3935 
	`up_»ad
(&
ù¾
->
Çme¥aûs_rw£m
);

3936 
	}
}

3937 
EXPORT_SYMBOL_GPL
(
nvme_wa™_ä“ze_timeout
);

3939 
	$nvme_wa™_ä“ze
(
nvme_ù¾
 *
ù¾
)

3941 
nvme_ns
 *
ns
;

3943 
	`down_»ad
(&
ù¾
->
Çme¥aûs_rw£m
);

3944 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
)

3945 
	`blk_mq_ä“ze_queue_wa™
(
ns
->
queue
);

3946 
	`up_»ad
(&
ù¾
->
Çme¥aûs_rw£m
);

3947 
	}
}

3948 
EXPORT_SYMBOL_GPL
(
nvme_wa™_ä“ze
);

3950 
	$nvme_¡¬t_ä“ze
(
nvme_ù¾
 *
ù¾
)

3952 
nvme_ns
 *
ns
;

3954 
	`down_»ad
(&
ù¾
->
Çme¥aûs_rw£m
);

3955 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
)

3956 #ifdeà
HAVE_BLK_FREEZE_QUEUE_START


3957 
	`blk_ä“ze_queue_¡¬t
(
ns
->
queue
);

3959 
	`blk_mq_ä“ze_queue_¡¬t
(
ns
->
queue
);

3961 
	`up_»ad
(&
ù¾
->
Çme¥aûs_rw£m
);

3962 
	}
}

3963 
EXPORT_SYMBOL_GPL
(
nvme_¡¬t_ä“ze
);

3965 
	$nvme_¡Ý_queues
(
nvme_ù¾
 *
ù¾
)

3967 
nvme_ns
 *
ns
;

3969 
	`down_»ad
(&
ù¾
->
Çme¥aûs_rw£m
);

3970 #ifdeà
HAVE_BLK_MQ_QUIESCE_QUEUE


3971 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
)

3972 
	`blk_mq_qu›sû_queue
(
ns
->
queue
);

3974 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
) {

3975 
	`blk_mq_ÿnûl_»queue_wÜk
(
ns
->
queue
);

3976 
	`blk_mq_¡Ý_hw_queues
(
ns
->
queue
);

3979 
	`up_»ad
(&
ù¾
->
Çme¥aûs_rw£m
);

3980 
	}
}

3981 
EXPORT_SYMBOL_GPL
(
nvme_¡Ý_queues
);

3983 
	$nvme_¡¬t_queues
(
nvme_ù¾
 *
ù¾
)

3985 
nvme_ns
 *
ns
;

3987 
	`down_»ad
(&
ù¾
->
Çme¥aûs_rw£m
);

3988 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
)

3989 #ifdeà
HAVE_BLK_MQ_UNQUIESCE_QUEUE


3990 
	`blk_mq_unqu›sû_queue
(
ns
->
queue
);

3992 
	`blk_mq_¡¬t_¡Ý³d_hw_queues
(
ns
->
queue
, 
Œue
);

3994 
	`up_»ad
(&
ù¾
->
Çme¥aûs_rw£m
);

3995 
	}
}

3996 
EXPORT_SYMBOL_GPL
(
nvme_¡¬t_queues
);

3998 #ià
defšed
(
HAVE_BLK_MQ_TAGSET_ITER
è|| defšed(
HAVE_BLK_MQ_REINIT_TAGSET_2_PARAM
)

3999 
	$nvme_»š™_g£t
(
nvme_ù¾
 *
ù¾
, 
blk_mq_g_£t
 *
£t
)

4001 ià(!
ù¾
->
Ýs
->
»š™_»que¡
)

4004 #ifdeà
HAVE_BLK_MQ_TAGSET_ITER


4005  
	`blk_mq_g£t_™”
(
£t
, s‘->
driv”_d©a
,

4006 
ù¾
->
Ýs
->
»š™_»que¡
);

4008  
	`blk_mq_»š™_g£t
(
£t
, 
ù¾
->
Ýs
->
»š™_»que¡
);

4010 
	}
}

4011 
EXPORT_SYMBOL_GPL
(
nvme_»š™_g£t
);

4014 
boÞ
 
	$disk_is_nvme
(
g’disk
 *
disk
)

4016 ià(!
	`disk_to_dev
(
disk
)->
·»Á
)

4017  
çl£
;

4019  
	`disk_to_dev
(
disk
)->
·»Á
->
þass
 =ð
nvme_þass
;

4020 
	}
}

4021 
EXPORT_SYMBOL_GPL
(
disk_is_nvme
);

4023 
__š™
 
	$nvme_cÜe_š™
()

4025 
»suÉ
 = -
ENOMEM
;

4027 
nvme_wq
 = 
	`®loc_wÜkqueue
("nvme-wq",

4028 
WQ_UNBOUND
 | 
WQ_MEM_RECLAIM
 | 
WQ_SYSFS
, 0);

4029 ià(!
nvme_wq
)

4030 
out
;

4032 
nvme_»£t_wq
 = 
	`®loc_wÜkqueue
("nvme-reset-wq",

4033 
WQ_UNBOUND
 | 
WQ_MEM_RECLAIM
 | 
WQ_SYSFS
, 0);

4034 ià(!
nvme_»£t_wq
)

4035 
de¡roy_wq
;

4037 
nvme_d–‘e_wq
 = 
	`®loc_wÜkqueue
("nvme-delete-wq",

4038 
WQ_UNBOUND
 | 
WQ_MEM_RECLAIM
 | 
WQ_SYSFS
, 0);

4039 ià(!
nvme_d–‘e_wq
)

4040 
de¡roy_»£t_wq
;

4042 
»suÉ
 = 
	`®loc_chrdev_»giÚ
(&
nvme_chr_devt
, 0, 
NVME_MINORS
, "nvme");

4043 ià(
»suÉ
 < 0)

4044 
de¡roy_d–‘e_wq
;

4046 
nvme_þass
 = 
	`þass_ü—‹
(
THIS_MODULE
, "nvme");

4047 ià(
	`IS_ERR
(
nvme_þass
)) {

4048 
»suÉ
 = 
	`PTR_ERR
(
nvme_þass
);

4049 
uÄegi¡”_chrdev
;

4052 
nvme_subsys_þass
 = 
	`þass_ü—‹
(
THIS_MODULE
, "nvme-subsystem");

4053 ià(
	`IS_ERR
(
nvme_subsys_þass
)) {

4054 
»suÉ
 = 
	`PTR_ERR
(
nvme_subsys_þass
);

4055 
de¡roy_þass
;

4059 
de¡roy_þass
:

4060 
	`þass_de¡roy
(
nvme_þass
);

4061 
uÄegi¡”_chrdev
:

4062 
	`uÄegi¡”_chrdev_»giÚ
(
nvme_chr_devt
, 
NVME_MINORS
);

4063 
de¡roy_d–‘e_wq
:

4064 
	`de¡roy_wÜkqueue
(
nvme_d–‘e_wq
);

4065 
de¡roy_»£t_wq
:

4066 
	`de¡roy_wÜkqueue
(
nvme_»£t_wq
);

4067 
de¡roy_wq
:

4068 
	`de¡roy_wÜkqueue
(
nvme_wq
);

4069 
out
:

4070  
»suÉ
;

4071 
	}
}

4073 
	$nvme_cÜe_ex™
()

4075 
	`ida_de¡roy
(&
nvme_subsy¡ems_ida
);

4076 
	`þass_de¡roy
(
nvme_subsys_þass
);

4077 
	`þass_de¡roy
(
nvme_þass
);

4078 
	`uÄegi¡”_chrdev_»giÚ
(
nvme_chr_devt
, 
NVME_MINORS
);

4079 
	`de¡roy_wÜkqueue
(
nvme_d–‘e_wq
);

4080 
	`de¡roy_wÜkqueue
(
nvme_»£t_wq
);

4081 
	`de¡roy_wÜkqueue
(
nvme_wq
);

4082 
	}
}

4084 
MODULE_LICENSE
("GPL");

4085 #ifdeà
RETPOLINE_MLNX


4086 
MODULE_INFO
(
»Þše
, "Y");

4088 
MODULE_VERSION
("1.0");

4089 
moduË_š™
(
nvme_cÜe_š™
);

4090 
moduË_ex™
(
nvme_cÜe_ex™
);

	@fabrics.c

14 #ifdeà
´_fmt


15 #undeà
´_fmt


17 
	#´_fmt
(
fmt
è
KBUILD_MODNAME
 ": " 
	)
fmt

18 
	~<lšux/š™.h
>

19 
	~<lšux/miscdeviû.h
>

20 
	~<lšux/moduË.h
>

21 
	~<lšux/mu‹x.h
>

22 
	~<lšux/·r£r.h
>

23 
	~<lšux/£q_fže.h
>

24 
	~"nvme.h
"

25 
	~"çbrics.h
"

27 
LIST_HEAD
(
nvmf_Œª¥Üts
);

28 
DECLARE_RWSEM
(
nvmf_Œª¥Üts_rw£m
);

30 
LIST_HEAD
(
nvmf_ho¡s
);

31 
DEFINE_MUTEX
(
nvmf_ho¡s_mu‹x
);

33 
nvmf_ho¡
 *
	gnvmf_deçuÉ_ho¡
;

35 
nvmf_ho¡
 *
	$__nvmf_ho¡_fšd
(cÚ¡ *
ho¡nqn
)

37 
nvmf_ho¡
 *
ho¡
;

39 
	`li¡_fÜ_—ch_’Œy
(
ho¡
, &
nvmf_ho¡s
, 
li¡
) {

40 ià(!
	`¡rcmp
(
ho¡
->
nqn
, 
ho¡nqn
))

41  
ho¡
;

44  
NULL
;

45 
	}
}

47 
nvmf_ho¡
 *
	$nvmf_ho¡_add
(cÚ¡ *
ho¡nqn
)

49 
nvmf_ho¡
 *
ho¡
;

51 
	`mu‹x_lock
(&
nvmf_ho¡s_mu‹x
);

52 
ho¡
 = 
	`__nvmf_ho¡_fšd
(
ho¡nqn
);

53 ià(
ho¡
) {

54 
	`k»f_g‘
(&
ho¡
->
»f
);

55 
out_uÆock
;

58 
ho¡
 = 
	`km®loc
((*ho¡), 
GFP_KERNEL
);

59 ià(!
ho¡
)

60 
out_uÆock
;

62 
	`k»f_š™
(&
ho¡
->
»f
);

63 
	`¡¾ýy
(
ho¡
->
nqn
, 
ho¡nqn
, 
NVMF_NQN_SIZE
);

65 
	`li¡_add_ž
(&
ho¡
->
li¡
, &
nvmf_ho¡s
);

66 
out_uÆock
:

67 
	`mu‹x_uÆock
(&
nvmf_ho¡s_mu‹x
);

68  
ho¡
;

69 
	}
}

71 
nvmf_ho¡
 *
	$nvmf_ho¡_deçuÉ
()

73 
nvmf_ho¡
 *
ho¡
;

75 
ho¡
 = 
	`km®loc
((*ho¡), 
GFP_KERNEL
);

76 ià(!
ho¡
)

77  
NULL
;

79 
	`k»f_š™
(&
ho¡
->
»f
);

80 
	`uuid_g’
(&
ho¡
->
id
);

81 
	`¢´štf
(
ho¡
->
nqn
, 
NVMF_NQN_SIZE
,

82 "nqn.2014-08.Üg.nvmex´ess:uuid:%pUb", &
ho¡
->
id
);

84 
	`mu‹x_lock
(&
nvmf_ho¡s_mu‹x
);

85 
	`li¡_add_ž
(&
ho¡
->
li¡
, &
nvmf_ho¡s
);

86 
	`mu‹x_uÆock
(&
nvmf_ho¡s_mu‹x
);

88  
ho¡
;

89 
	}
}

91 
	$nvmf_ho¡_de¡roy
(
k»f
 *
»f
)

93 
nvmf_ho¡
 *
ho¡
 = 
	`cÚš”_of
(
»f
, nvmf_host,„ef);

95 
	`mu‹x_lock
(&
nvmf_ho¡s_mu‹x
);

96 
	`li¡_d–
(&
ho¡
->
li¡
);

97 
	`mu‹x_uÆock
(&
nvmf_ho¡s_mu‹x
);

99 
	`kä“
(
ho¡
);

100 
	}
}

102 
	$nvmf_ho¡_put
(
nvmf_ho¡
 *
ho¡
)

104 ià(
ho¡
)

105 
	`k»f_put
(&
ho¡
->
»f
, 
nvmf_ho¡_de¡roy
);

106 
	}
}

114 
	$nvmf_g‘_add»ss
(
nvme_ù¾
 *
ù¾
, *
buf
, 
size
)

116 
Ën
 = 0;

118 ià(
ù¾
->
Ýts
->
mask
 & 
NVMF_OPT_TRADDR
)

119 
Ën
 +ð
	`¢´štf
(
buf
, 
size
, "Œaddr=%s", 
ù¾
->
Ýts
->
Œaddr
);

120 ià(
ù¾
->
Ýts
->
mask
 & 
NVMF_OPT_TRSVCID
)

121 
Ën
 +ð
	`¢´štf
(
buf
 +†’, 
size
 -†en, "%strsvcid=%s",

122 (
Ën
è? "," : "", 
ù¾
->
Ýts
->
Œsvcid
);

123 ià(
ù¾
->
Ýts
->
mask
 & 
NVMF_OPT_HOST_TRADDR
)

124 
Ën
 +ð
	`¢´štf
(
buf
 +†’, 
size
 -†en, "%shost_traddr=%s",

125 (
Ën
è? "," : "", 
ù¾
->
Ýts
->
ho¡_Œaddr
);

126 
Ën
 +ð
	`¢´štf
(
buf
 +†’, 
size
 -†en, "\n");

128  
Ën
;

129 
	}
}

130 
EXPORT_SYMBOL_GPL
(
nvmf_g‘_add»ss
);

153 
	$nvmf_»g_»ad32
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, u32 *
v®
)

155 
nvme_commªd
 
cmd
;

156 
nvme_»suÉ
 
»s
;

157 
»t
;

159 
	`mem£t
(&
cmd
, 0, (cmd));

160 
cmd
.
´Ý_g‘
.
Ýcode
 = 
nvme_çbrics_commªd
;

161 
cmd
.
´Ý_g‘
.
fùy³
 = 
nvme_çbrics_ty³_´Ý”ty_g‘
;

162 
cmd
.
´Ý_g‘
.
off£t
 = 
	`ýu_to_Ë32
(
off
);

164 #ifdeà
HAVE_BLK_MQ_ALLOC_REQUEST_HAS_3_PARAMS


165 
»t
 = 
	`__nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
cmd
, &
»s
, 
NULL
, 0, 0,

166 
NVME_QID_ANY
, 0, 0);

168 
»t
 = 
	`__nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
cmd
, &
»s
, 
NULL
, 0, 0,

169 
NVME_QID_ANY
, 0, 
GFP_KERNEL
, 
çl£
);

172 ià(
»t
 >= 0)

173 *
v®
 = 
	`Ë64_to_ýu
(
»s
.
u64
);

174 ià(
	`uÆik–y
(
»t
 != 0))

175 
	`dev_”r
(
ù¾
->
deviû
,

177 
»t
 > 0 ?„‘ & ~
NVME_SC_DNR
 :„‘, 
off
);

179  
»t
;

180 
	}
}

181 
EXPORT_SYMBOL_GPL
(
nvmf_»g_»ad32
);

204 
	$nvmf_»g_»ad64
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, 
u64
 *
v®
)

206 
nvme_commªd
 
cmd
;

207 
nvme_»suÉ
 
»s
;

208 
»t
;

210 
	`mem£t
(&
cmd
, 0, (cmd));

211 
cmd
.
´Ý_g‘
.
Ýcode
 = 
nvme_çbrics_commªd
;

212 
cmd
.
´Ý_g‘
.
fùy³
 = 
nvme_çbrics_ty³_´Ý”ty_g‘
;

213 
cmd
.
´Ý_g‘
.
©Œib
 = 1;

214 
cmd
.
´Ý_g‘
.
off£t
 = 
	`ýu_to_Ë32
(
off
);

216 #ifdeà
HAVE_BLK_MQ_ALLOC_REQUEST_HAS_3_PARAMS


217 
»t
 = 
	`__nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
cmd
, &
»s
, 
NULL
, 0, 0,

218 
NVME_QID_ANY
, 0, 0);

220 
»t
 = 
	`__nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
cmd
, &
»s
, 
NULL
, 0, 0,

221 
NVME_QID_ANY
, 0, 
GFP_KERNEL
, 
çl£
);

224 ià(
»t
 >= 0)

225 *
v®
 = 
	`Ë64_to_ýu
(
»s
.
u64
);

226 ià(
	`uÆik–y
(
»t
 != 0))

227 
	`dev_”r
(
ù¾
->
deviû
,

229 
»t
 > 0 ?„‘ & ~
NVME_SC_DNR
 :„‘, 
off
);

230  
»t
;

231 
	}
}

232 
EXPORT_SYMBOL_GPL
(
nvmf_»g_»ad64
);

255 
	$nvmf_»g_wr™e32
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, u32 
v®
)

257 
nvme_commªd
 
cmd
;

258 
»t
;

260 
	`mem£t
(&
cmd
, 0, (cmd));

261 
cmd
.
´Ý_£t
.
Ýcode
 = 
nvme_çbrics_commªd
;

262 
cmd
.
´Ý_£t
.
fùy³
 = 
nvme_çbrics_ty³_´Ý”ty_£t
;

263 
cmd
.
´Ý_£t
.
©Œib
 = 0;

264 
cmd
.
´Ý_£t
.
off£t
 = 
	`ýu_to_Ë32
(
off
);

265 
cmd
.
´Ý_£t
.
v®ue
 = 
	`ýu_to_Ë64
(
v®
);

267 #ifdeà
HAVE_BLK_MQ_ALLOC_REQUEST_HAS_3_PARAMS


268 
»t
 = 
	`__nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
cmd
, 
NULL
, NULL, 0, 0,

269 
NVME_QID_ANY
, 0, 0);

271 
»t
 = 
	`__nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
cmd
, 
NULL
, NULL, 0, 0,

272 
NVME_QID_ANY
, 0, 
GFP_KERNEL
, 
çl£
);

274 ià(
	`uÆik–y
(
»t
))

275 
	`dev_”r
(
ù¾
->
deviû
,

277 
»t
 > 0 ?„‘ & ~
NVME_SC_DNR
 :„‘, 
off
);

278  
»t
;

279 
	}
}

280 
EXPORT_SYMBOL_GPL
(
nvmf_»g_wr™e32
);

297 
	$nvmf_log_cÚÃù_”rÜ
(
nvme_ù¾
 *
ù¾
,

298 
”rv®
, 
off£t
, 
nvme_commªd
 *
cmd
,

299 
nvmf_cÚÃù_d©a
 *
d©a
)

301 
”r_sùy³
 = 
”rv®
 & (~
NVME_SC_DNR
);

303 
”r_sùy³
) {

305 (
NVME_SC_CONNECT_INVALID_PARAM
):

306 ià(
off£t
 >> 16) {

307 *
šv_d©a
 = "Connect Invalid Data Parameter";

309 
off£t
 & 0xffff) {

310 (
	`off£tof
(
nvmf_cÚÃù_d©a
, 
úŽid
)):

311 
	`dev_”r
(
ù¾
->
deviû
,

313 
šv_d©a
, 
d©a
->
úŽid
);

315 (
	`off£tof
(
nvmf_cÚÃù_d©a
, 
ho¡nqn
)):

316 
	`dev_”r
(
ù¾
->
deviû
,

318 
šv_d©a
, 
d©a
->
ho¡nqn
);

320 (
	`off£tof
(
nvmf_cÚÃù_d©a
, 
subsy¢qn
)):

321 
	`dev_”r
(
ù¾
->
deviû
,

323 
šv_d©a
, 
d©a
->
subsy¢qn
);

326 
	`dev_”r
(
ù¾
->
deviû
,

328 
šv_d©a
, 
off£t
 & 0xffff);

332 *
šv_sqe
 = "Connect Invalid SQE Parameter";

334 
off£t
) {

335 (
	`off£tof
(
nvmf_cÚÃù_commªd
, 
qid
)):

336 
	`dev_”r
(
ù¾
->
deviû
,

338 
šv_sqe
, 
cmd
->
cÚÃù
.
qid
);

341 
	`dev_”r
(
ù¾
->
deviû
,

343 
šv_sqe
, 
off£t
);

348 
NVME_SC_CONNECT_INVALID_HOST
:

349 
	`dev_”r
(
ù¾
->
deviû
,

351 
d©a
->
subsy¢qn
, d©a->
ho¡nqn
);

354 
NVME_SC_CONNECT_CTRL_BUSY
:

355 
	`dev_”r
(
ù¾
->
deviû
,

359 
NVME_SC_CONNECT_FORMAT
:

360 
	`dev_”r
(
ù¾
->
deviû
,

362 
cmd
->
cÚÃù
.
»cfmt
);

366 
	`dev_”r
(
ù¾
->
deviû
,

368 
”r_sùy³
);

371 
	}
}

393 
	$nvmf_cÚÃù_admš_queue
(
nvme_ù¾
 *
ù¾
)

395 
nvme_commªd
 
cmd
;

396 
nvme_»suÉ
 
»s
;

397 
nvmf_cÚÃù_d©a
 *
d©a
;

398 
»t
;

400 
	`mem£t
(&
cmd
, 0, (cmd));

401 
cmd
.
cÚÃù
.
Ýcode
 = 
nvme_çbrics_commªd
;

402 
cmd
.
cÚÃù
.
fùy³
 = 
nvme_çbrics_ty³_cÚÃù
;

403 
cmd
.
cÚÃù
.
qid
 = 0;

404 
cmd
.
cÚÃù
.
sqsize
 = 
	`ýu_to_Ë16
(
NVME_AQ_DEPTH
 - 1);

410 
cmd
.
cÚÃù
.
k©o
 = 
ù¾
->
Ýts
->
discov”y_nqn
 ? 0 :

411 
	`ýu_to_Ë32
((
ù¾
->
k©o
 + 
NVME_KATO_GRACE
) * 1000);

413 
d©a
 = 
	`kz®loc
((*d©a), 
GFP_KERNEL
);

414 ià(!
d©a
)

415  -
ENOMEM
;

417 
	`uuid_cÝy
(&
d©a
->
ho¡id
, &
ù¾
->
Ýts
->
ho¡
->
id
);

418 
d©a
->
úŽid
 = 
	`ýu_to_Ë16
(0xffff);

419 
	`¡ºýy
(
d©a
->
subsy¢qn
, 
ù¾
->
Ýts
->subsy¢qn, 
NVMF_NQN_SIZE
);

420 
	`¡ºýy
(
d©a
->
ho¡nqn
, 
ù¾
->
Ýts
->
ho¡
->
nqn
, 
NVMF_NQN_SIZE
);

422 #ifdeà
HAVE_BLK_MQ_ALLOC_REQUEST_HAS_3_PARAMS


423 
»t
 = 
	`__nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
cmd
, &
»s
,

424 
d©a
, (*d©a), 0, 
NVME_QID_ANY
, 1,

425 
BLK_MQ_REQ_RESERVED
 | 
BLK_MQ_REQ_NOWAIT
);

427 
»t
 = 
	`__nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
cmd
, &
»s
,

428 
d©a
, (*d©a), 0, 
NVME_QID_ANY
, 1,

429 
GFP_ATOMIC
, 
Œue
);

431 ià(
»t
) {

432 
	`nvmf_log_cÚÃù_”rÜ
(
ù¾
, 
»t
, 
	`Ë32_to_ýu
(
»s
.
u32
),

433 &
cmd
, 
d©a
);

434 
out_ä“_d©a
;

437 
ù¾
->
úŽid
 = 
	`Ë16_to_ýu
(
»s
.
u16
);

439 
out_ä“_d©a
:

440 
	`kä“
(
d©a
);

441  
»t
;

442 
	}
}

443 
EXPORT_SYMBOL_GPL
(
nvmf_cÚÃù_admš_queue
);

465 
	$nvmf_cÚÃù_io_queue
(
nvme_ù¾
 *
ù¾
, 
u16
 
qid
)

467 
nvme_commªd
 
cmd
;

468 
nvmf_cÚÃù_d©a
 *
d©a
;

469 
nvme_»suÉ
 
»s
;

470 
»t
;

472 
	`mem£t
(&
cmd
, 0, (cmd));

473 
cmd
.
cÚÃù
.
Ýcode
 = 
nvme_çbrics_commªd
;

474 
cmd
.
cÚÃù
.
fùy³
 = 
nvme_çbrics_ty³_cÚÃù
;

475 
cmd
.
cÚÃù
.
qid
 = 
	`ýu_to_Ë16
(qid);

476 
cmd
.
cÚÃù
.
sqsize
 = 
	`ýu_to_Ë16
(
ù¾
->sqsize);

478 
d©a
 = 
	`kz®loc
((*d©a), 
GFP_KERNEL
);

479 ià(!
d©a
)

480  -
ENOMEM
;

482 
	`uuid_cÝy
(&
d©a
->
ho¡id
, &
ù¾
->
Ýts
->
ho¡
->
id
);

483 
d©a
->
úŽid
 = 
	`ýu_to_Ë16
(
ù¾
->cntlid);

484 
	`¡ºýy
(
d©a
->
subsy¢qn
, 
ù¾
->
Ýts
->subsy¢qn, 
NVMF_NQN_SIZE
);

485 
	`¡ºýy
(
d©a
->
ho¡nqn
, 
ù¾
->
Ýts
->
ho¡
->
nqn
, 
NVMF_NQN_SIZE
);

487 #ifdeà
HAVE_BLK_MQ_ALLOC_REQUEST_HAS_3_PARAMS


488 
»t
 = 
	`__nvme_subm™_sync_cmd
(
ù¾
->
cÚÃù_q
, &
cmd
, &
»s
,

489 
d©a
, (*d©a), 0, 
qid
, 1,

490 
BLK_MQ_REQ_RESERVED
 | 
BLK_MQ_REQ_NOWAIT
);

492 
»t
 = 
	`__nvme_subm™_sync_cmd
(
ù¾
->
cÚÃù_q
, &
cmd
, &
»s
,

493 
d©a
, (*d©a), 0, 
qid
, 1,

494 
GFP_ATOMIC
, 
Œue
);

496 ià(
»t
) {

497 
	`nvmf_log_cÚÃù_”rÜ
(
ù¾
, 
»t
, 
	`Ë32_to_ýu
(
»s
.
u32
),

498 &
cmd
, 
d©a
);

500 
	`kä“
(
d©a
);

501  
»t
;

502 
	}
}

503 
EXPORT_SYMBOL_GPL
(
nvmf_cÚÃù_io_queue
);

505 
boÞ
 
	$nvmf_should_»cÚÃù
(
nvme_ù¾
 *
ù¾
)

507 ià(
ù¾
->
Ýts
->
max_»cÚÃùs
 != -1 &&

508 
ù¾
->
Ä_»cÚÃùs
 < cŒl->
Ýts
->
max_»cÚÃùs
)

509  
Œue
;

511  
çl£
;

512 
	}
}

513 
EXPORT_SYMBOL_GPL
(
nvmf_should_»cÚÃù
);

524 
	$nvmf_»gi¡”_Œª¥Üt
(
nvmf_Œª¥Üt_Ýs
 *
Ýs
)

526 ià(!
Ýs
->
ü—‹_ù¾
)

527  -
EINVAL
;

529 
	`down_wr™e
(&
nvmf_Œª¥Üts_rw£m
);

530 
	`li¡_add_ž
(&
Ýs
->
’Œy
, &
nvmf_Œª¥Üts
);

531 
	`up_wr™e
(&
nvmf_Œª¥Üts_rw£m
);

534 
	}
}

535 
EXPORT_SYMBOL_GPL
(
nvmf_»gi¡”_Œª¥Üt
);

546 
	$nvmf_uÄegi¡”_Œª¥Üt
(
nvmf_Œª¥Üt_Ýs
 *
Ýs
)

548 
	`down_wr™e
(&
nvmf_Œª¥Üts_rw£m
);

549 
	`li¡_d–
(&
Ýs
->
’Œy
);

550 
	`up_wr™e
(&
nvmf_Œª¥Üts_rw£m
);

551 
	}
}

552 
EXPORT_SYMBOL_GPL
(
nvmf_uÄegi¡”_Œª¥Üt
);

554 
nvmf_Œª¥Üt_Ýs
 *
	$nvmf_lookup_Œª¥Üt
(

555 
nvmf_ù¾_ÝtiÚs
 *
Ýts
)

557 
nvmf_Œª¥Üt_Ýs
 *
Ýs
;

559 
	`lockd•_as£¹_h–d
(&
nvmf_Œª¥Üts_rw£m
);

561 
	`li¡_fÜ_—ch_’Œy
(
Ýs
, &
nvmf_Œª¥Üts
, 
’Œy
) {

562 ià(
	`¡rcmp
(
Ýs
->
Çme
, 
Ýts
->
Œª¥Üt
) == 0)

563  
Ýs
;

566  
NULL
;

567 
	}
}

569 
blk_¡©us_t
 
	$nvmf_check_if_»ady
(
nvme_ù¾
 *
ù¾
, 
»que¡
 *
rq
,

570 
boÞ
 
queue_live
, boÞ 
is_cÚÃùed
)

572 
nvme_commªd
 *
cmd
 = 
	`nvme_»q
(
rq
)->cmd;

574 ià(
	`lik–y
(
ù¾
->
¡©e
 =ð
NVME_CTRL_LIVE
 && 
is_cÚÃùed
))

575  
BLK_STS_OK
;

577 
ù¾
->
¡©e
) {

578 
NVME_CTRL_NEW
:

579 
NVME_CTRL_CONNECTING
:

580 
NVME_CTRL_DELETING
:

590 ià(!
is_cÚÃùed
)

599 ià(
queue_live
 && !(
	`nvme_»q
(
rq
)->
æags
 & 
NVME_REQ_USERCMD
))

600  
BLK_STS_OK
;

607 ià(!
queue_live
 && 
	`blk_rq_is_·s¡hrough
(
rq
) &&

608 
cmd
->
commÚ
.
Ýcode
 =ð
nvme_çbrics_commªd
 &&

609 
cmd
->
çbrics
.
fùy³
 =ð
nvme_çbrics_ty³_cÚÃù
)

610  
BLK_STS_OK
;

624 #ifdeà
CONFIG_NVME_MULTIPATH


625 ià(!
	`blk_nÜ‘ry_»que¡
(
rq
è&& !Ôq->
cmd_æags
 & 
REQ_NVME_MPATH
))

626  
BLK_STS_RESOURCE
;

628 ià(!
	`blk_nÜ‘ry_»que¡
(
rq
))

629  
BLK_STS_RESOURCE
;

631 
	`nvme_»q
(
rq
)->
¡©us
 = 
NVME_SC_ABORT_REQ
;

632  
BLK_STS_IOERR
;

633 
	}
}

634 
EXPORT_SYMBOL_GPL
(
nvmf_check_if_»ady
);

636 cÚ¡ 
m©ch_bË_t
 
	gÝt_tok’s
 = {

637 { 
NVMF_OPT_TRANSPORT
, "transport=%s" },

638 { 
NVMF_OPT_TRADDR
, "traddr=%s" },

639 { 
NVMF_OPT_TRSVCID
, "trsvcid=%s" },

640 { 
NVMF_OPT_NQN
, "nqn=%s" },

641 { 
NVMF_OPT_QUEUE_SIZE
, "queue_size=%d" },

642 { 
NVMF_OPT_NR_IO_QUEUES
, "nr_io_queues=%d" },

643 { 
NVMF_OPT_RECONNECT_DELAY
, "reconnect_delay=%d" },

644 { 
NVMF_OPT_CTRL_LOSS_TMO
, "ctrl_loss_tmo=%d" },

645 { 
NVMF_OPT_KATO
, "keep_alive_tmo=%d" },

646 { 
NVMF_OPT_HOSTNQN
, "hostnqn=%s" },

647 { 
NVMF_OPT_HOST_TRADDR
, "host_traddr=%s" },

648 { 
NVMF_OPT_HOST_ID
, "hostid=%s" },

649 { 
NVMF_OPT_DUP_CONNECT
, "duplicate_connect" },

650 { 
NVMF_OPT_ERR
, 
NULL
 }

653 
	$nvmf_·r£_ÝtiÚs
(
nvmf_ù¾_ÝtiÚs
 *
Ýts
,

654 cÚ¡ *
buf
)

656 
sub¡ršg_t
 
¬gs
[
MAX_OPT_ARGS
];

657 *
ÝtiÚs
, *
o
, *
p
;

658 
tok’
, 
»t
 = 0;

659 
size_t
 
nqÆ’
 = 0;

660 
ù¾_loss_tmo
 = 
NVMF_DEF_CTRL_LOSS_TMO
;

661 
uuid_t
 
ho¡id
;

664 
Ýts
->
queue_size
 = 
NVMF_DEF_QUEUE_SIZE
;

665 #ifdeà
HAVE_BLK_MQ_ALLOC_REQUEST_HCTX


666 
Ýts
->
Ä_io_queues
 = 
	`num_Úlše_ýus
();

668 
Ýts
->
Ä_io_queues
 = 1;

670 
Ýts
->
»cÚÃù_d–ay
 = 
NVMF_DEF_RECONNECT_DELAY
;

671 
Ýts
->
k©o
 = 
NVME_DEFAULT_KATO
;

672 
Ýts
->
du¶iÿ‹_cÚÃù
 = 
çl£
;

674 
ÝtiÚs
 = 
o
 = 
	`k¡rdup
(
buf
, 
GFP_KERNEL
);

675 ià(!
ÝtiÚs
)

676  -
ENOMEM
;

678 
	`uuid_g’
(&
ho¡id
);

680 (
p
 = 
	`¡r£p
(&
o
, ",\n")è!ð
NULL
) {

681 ià(!*
p
)

684 
tok’
 = 
	`m©ch_tok’
(
p
, 
Ýt_tok’s
, 
¬gs
);

685 
Ýts
->
mask
 |ð
tok’
;

686 
tok’
) {

687 
NVMF_OPT_TRANSPORT
:

688 
p
 = 
	`m©ch_¡rdup
(
¬gs
);

689 ià(!
p
) {

690 
»t
 = -
ENOMEM
;

691 
out
;

693 
	`kä“
(
Ýts
->
Œª¥Üt
);

694 
Ýts
->
Œª¥Üt
 = 
p
;

696 
NVMF_OPT_NQN
:

697 
p
 = 
	`m©ch_¡rdup
(
¬gs
);

698 ià(!
p
) {

699 
»t
 = -
ENOMEM
;

700 
out
;

702 
	`kä“
(
Ýts
->
subsy¢qn
);

703 
Ýts
->
subsy¢qn
 = 
p
;

704 
nqÆ’
 = 
	`¡¾’
(
Ýts
->
subsy¢qn
);

705 ià(
nqÆ’
 >ð
NVMF_NQN_SIZE
) {

706 
	`´_”r
("%s‚eedso be < %d bytes\n",

707 
Ýts
->
subsy¢qn
, 
NVMF_NQN_SIZE
);

708 
»t
 = -
EINVAL
;

709 
out
;

711 
Ýts
->
discov”y_nqn
 =

712 !(
	`¡rcmp
(
Ýts
->
subsy¢qn
,

713 
NVME_DISC_SUBSYS_NAME
));

715 
NVMF_OPT_TRADDR
:

716 
p
 = 
	`m©ch_¡rdup
(
¬gs
);

717 ià(!
p
) {

718 
»t
 = -
ENOMEM
;

719 
out
;

721 
	`kä“
(
Ýts
->
Œaddr
);

722 
Ýts
->
Œaddr
 = 
p
;

724 
NVMF_OPT_TRSVCID
:

725 
p
 = 
	`m©ch_¡rdup
(
¬gs
);

726 ià(!
p
) {

727 
»t
 = -
ENOMEM
;

728 
out
;

730 
	`kä“
(
Ýts
->
Œsvcid
);

731 
Ýts
->
Œsvcid
 = 
p
;

733 
NVMF_OPT_QUEUE_SIZE
:

734 ià(
	`m©ch_št
(
¬gs
, &
tok’
)) {

735 
»t
 = -
EINVAL
;

736 
out
;

738 ià(
tok’
 < 
NVMF_MIN_QUEUE_SIZE
 ||

739 
tok’
 > 
NVMF_MAX_QUEUE_SIZE
) {

740 
	`´_”r
("Inv®id queue_siz%d\n", 
tok’
);

741 
»t
 = -
EINVAL
;

742 
out
;

744 
Ýts
->
queue_size
 = 
tok’
;

746 
NVMF_OPT_NR_IO_QUEUES
:

747 ià(
	`m©ch_št
(
¬gs
, &
tok’
)) {

748 
»t
 = -
EINVAL
;

749 
out
;

751 ià(
tok’
 <= 0) {

752 
	`´_”r
("Inv®id‚umb” oàIOQ %d\n", 
tok’
);

753 
»t
 = -
EINVAL
;

754 
out
;

756 ià(
Ýts
->
discov”y_nqn
) {

757 
	`´_debug
("Ignoring‚r_io_queues value for discovery controller\n");

761 
Ýts
->
Ä_io_queues
 = 
	`mš_t
(,

762 
	`num_Úlše_ýus
(), 
tok’
);

764 
NVMF_OPT_KATO
:

765 ià(
	`m©ch_št
(
¬gs
, &
tok’
)) {

766 
»t
 = -
EINVAL
;

767 
out
;

770 ià(
tok’
 < 0) {

771 
	`´_”r
("Inv®id k“p_®ive_tmØ%d\n", 
tok’
);

772 
»t
 = -
EINVAL
;

773 
out
;

774 } ià(
tok’
 =ð0 && !
Ýts
->
discov”y_nqn
) {

776 
	`´_w¬n
("keep_alive_tmo 0 won'tƒxecute keep‡lives!!!\n");

778 
Ýts
->
k©o
 = 
tok’
;

780 ià(
Ýts
->
discov”y_nqn
 && o±s->
k©o
) {

781 
	`´_”r
("Discovery controllers cannot‡ccept KATO != 0\n");

782 
»t
 = -
EINVAL
;

783 
out
;

787 
NVMF_OPT_CTRL_LOSS_TMO
:

788 ià(
	`m©ch_št
(
¬gs
, &
tok’
)) {

789 
»t
 = -
EINVAL
;

790 
out
;

793 ià(
tok’
 < 0)

794 
	`´_w¬n
("ctrl_loss_tmo < 0 will„econnect forever\n");

795 
ù¾_loss_tmo
 = 
tok’
;

797 
NVMF_OPT_HOSTNQN
:

798 ià(
Ýts
->
ho¡
) {

799 
	`´_”r
("hostnqn‡lready user-assigned: %s\n",

800 
Ýts
->
ho¡
->
nqn
);

801 
»t
 = -
EADDRINUSE
;

802 
out
;

804 
p
 = 
	`m©ch_¡rdup
(
¬gs
);

805 ià(!
p
) {

806 
»t
 = -
ENOMEM
;

807 
out
;

809 
nqÆ’
 = 
	`¡¾’
(
p
);

810 ià(
nqÆ’
 >ð
NVMF_NQN_SIZE
) {

811 
	`´_”r
("%s‚eedso be < %d bytes\n",

812 
p
, 
NVMF_NQN_SIZE
);

813 
	`kä“
(
p
);

814 
»t
 = -
EINVAL
;

815 
out
;

817 
	`nvmf_ho¡_put
(
Ýts
->
ho¡
);

818 
Ýts
->
ho¡
 = 
	`nvmf_ho¡_add
(
p
);

819 
	`kä“
(
p
);

820 ià(!
Ýts
->
ho¡
) {

821 
»t
 = -
ENOMEM
;

822 
out
;

825 
NVMF_OPT_RECONNECT_DELAY
:

826 ià(
	`m©ch_št
(
¬gs
, &
tok’
)) {

827 
»t
 = -
EINVAL
;

828 
out
;

830 ià(
tok’
 <= 0) {

831 
	`´_”r
("Inv®id„ecÚÃù_d–ay %d\n", 
tok’
);

832 
»t
 = -
EINVAL
;

833 
out
;

835 
Ýts
->
»cÚÃù_d–ay
 = 
tok’
;

837 
NVMF_OPT_HOST_TRADDR
:

838 
p
 = 
	`m©ch_¡rdup
(
¬gs
);

839 ià(!
p
) {

840 
»t
 = -
ENOMEM
;

841 
out
;

843 
	`kä“
(
Ýts
->
ho¡_Œaddr
);

844 
Ýts
->
ho¡_Œaddr
 = 
p
;

846 
NVMF_OPT_HOST_ID
:

847 
p
 = 
	`m©ch_¡rdup
(
¬gs
);

848 ià(!
p
) {

849 
»t
 = -
ENOMEM
;

850 
out
;

852 
»t
 = 
	`uuid_·r£
(
p
, &
ho¡id
);

853 ià(
»t
) {

854 
	`´_”r
("Inv®id ho¡id %s\n", 
p
);

855 
»t
 = -
EINVAL
;

856 
	`kä“
(
p
);

857 
out
;

859 
	`kä“
(
p
);

861 
NVMF_OPT_DUP_CONNECT
:

862 
Ýts
->
du¶iÿ‹_cÚÃù
 = 
Œue
;

865 
	`´_w¬n
("unknown…arameter or missing value '%s' in ctrl creation„equest\n",

866 
p
);

867 
»t
 = -
EINVAL
;

868 
out
;

872 ià(
Ýts
->
discov”y_nqn
) {

873 
Ýts
->
k©o
 = 0;

874 
Ýts
->
Ä_io_queues
 = 0;

875 
Ýts
->
du¶iÿ‹_cÚÃù
 = 
Œue
;

877 ià(
ù¾_loss_tmo
 < 0)

878 
Ýts
->
max_»cÚÃùs
 = -1;

880 
Ýts
->
max_»cÚÃùs
 = 
	`DIV_ROUND_UP
(
ù¾_loss_tmo
,

881 
Ýts
->
»cÚÃù_d–ay
);

883 ià(!
Ýts
->
ho¡
) {

884 
	`k»f_g‘
(&
nvmf_deçuÉ_ho¡
->
»f
);

885 
Ýts
->
ho¡
 = 
nvmf_deçuÉ_ho¡
;

888 
	`uuid_cÝy
(&
Ýts
->
ho¡
->
id
, &
ho¡id
);

890 
out
:

891 
	`kä“
(
ÝtiÚs
);

892  
»t
;

893 
	}
}

895 
	$nvmf_check_»quœed_Ýts
(
nvmf_ù¾_ÝtiÚs
 *
Ýts
,

896 
»quœed_Ýts
)

898 ià((
Ýts
->
mask
 & 
»quœed_Ýts
) !=„equired_opts) {

899 
i
;

901 
i
 = 0; i < 
	`ARRAY_SIZE
(
Ýt_tok’s
); i++) {

902 ià((
Ýt_tok’s
[
i
].
tok’
 & 
»quœed_Ýts
) &&

903 !(
Ýt_tok’s
[
i
].
tok’
 & 
Ýts
->
mask
)) {

904 
	`´_w¬n
("missing…arameter '%s'\n",

905 
Ýt_tok’s
[
i
].
·‰”n
);

909  -
EINVAL
;

913 
	}
}

915 
	$nvmf_check_®lowed_Ýts
(
nvmf_ù¾_ÝtiÚs
 *
Ýts
,

916 
®lowed_Ýts
)

918 ià(
Ýts
->
mask
 & ~
®lowed_Ýts
) {

919 
i
;

921 
i
 = 0; i < 
	`ARRAY_SIZE
(
Ýt_tok’s
); i++) {

922 ià((
Ýt_tok’s
[
i
].
tok’
 & 
Ýts
->
mask
) &&

923 (
Ýt_tok’s
[
i
].
tok’
 & ~
®lowed_Ýts
)) {

924 
	`´_w¬n
("invalid…arameter '%s'\n",

925 
Ýt_tok’s
[
i
].
·‰”n
);

929  -
EINVAL
;

933 
	}
}

935 
	$nvmf_ä“_ÝtiÚs
(
nvmf_ù¾_ÝtiÚs
 *
Ýts
)

937 
	`nvmf_ho¡_put
(
Ýts
->
ho¡
);

938 
	`kä“
(
Ýts
->
Œª¥Üt
);

939 
	`kä“
(
Ýts
->
Œaddr
);

940 
	`kä“
(
Ýts
->
Œsvcid
);

941 
	`kä“
(
Ýts
->
subsy¢qn
);

942 
	`kä“
(
Ýts
->
ho¡_Œaddr
);

943 
	`kä“
(
Ýts
);

944 
	}
}

945 
EXPORT_SYMBOL_GPL
(
nvmf_ä“_ÝtiÚs
);

947 
	#NVMF_REQUIRED_OPTS
 (
NVMF_OPT_TRANSPORT
 | 
NVMF_OPT_NQN
)

	)

948 
	#NVMF_ALLOWED_OPTS
 (
NVMF_OPT_QUEUE_SIZE
 | 
NVMF_OPT_NR_IO_QUEUES
 | \

949 
NVMF_OPT_KATO
 | 
NVMF_OPT_HOSTNQN
 | \

950 
NVMF_OPT_HOST_ID
 | 
NVMF_OPT_DUP_CONNECT
)

	)

952 
nvme_ù¾
 *

953 
	$nvmf_ü—‹_ù¾
(
deviû
 *
dev
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

955 
nvmf_ù¾_ÝtiÚs
 *
Ýts
;

956 
nvmf_Œª¥Üt_Ýs
 *
Ýs
;

957 
nvme_ù¾
 *
ù¾
;

958 
»t
;

960 
Ýts
 = 
	`kz®loc
((*Ýts), 
GFP_KERNEL
);

961 ià(!
Ýts
)

962  
	`ERR_PTR
(-
ENOMEM
);

964 
»t
 = 
	`nvmf_·r£_ÝtiÚs
(
Ýts
, 
buf
);

965 ià(
»t
)

966 
out_ä“_Ýts
;

969 
	`»que¡_moduË
("nvme-%s", 
Ýts
->
Œª¥Üt
);

976 
»t
 = 
	`nvmf_check_»quœed_Ýts
(
Ýts
, 
NVMF_REQUIRED_OPTS
);

977 ià(
»t
)

978 
out_ä“_Ýts
;

979 
Ýts
->
mask
 &ð~
NVMF_REQUIRED_OPTS
;

981 
	`down_»ad
(&
nvmf_Œª¥Üts_rw£m
);

982 
Ýs
 = 
	`nvmf_lookup_Œª¥Üt
(
Ýts
);

983 ià(!
Ýs
) {

984 
	`´_šfo
("no handler found forransport %s.\n",

985 
Ýts
->
Œª¥Üt
);

986 
»t
 = -
EINVAL
;

987 
out_uÆock
;

990 ià(!
	`Œy_moduË_g‘
(
Ýs
->
moduË
)) {

991 
»t
 = -
EBUSY
;

992 
out_uÆock
;

995 
»t
 = 
	`nvmf_check_»quœed_Ýts
(
Ýts
, 
Ýs
->
»quœed_Ýts
);

996 ià(
»t
)

997 
out_moduË_put
;

998 
»t
 = 
	`nvmf_check_®lowed_Ýts
(
Ýts
, 
NVMF_ALLOWED_OPTS
 |

999 
Ýs
->
®lowed_Ýts
 | ops->
»quœed_Ýts
);

1000 ià(
»t
)

1001 
out_moduË_put
;

1003 
ù¾
 = 
Ýs
->
	`ü—‹_ù¾
(
dev
, 
Ýts
);

1004 ià(
	`IS_ERR
(
ù¾
)) {

1005 
»t
 = 
	`PTR_ERR
(
ù¾
);

1006 
out_moduË_put
;

1009 
	`moduË_put
(
Ýs
->
moduË
);

1010 
	`up_»ad
(&
nvmf_Œª¥Üts_rw£m
);

1011  
ù¾
;

1013 
out_moduË_put
:

1014 
	`moduË_put
(
Ýs
->
moduË
);

1015 
out_uÆock
:

1016 
	`up_»ad
(&
nvmf_Œª¥Üts_rw£m
);

1017 
out_ä“_Ýts
:

1018 
	`nvmf_ä“_ÝtiÚs
(
Ýts
);

1019  
	`ERR_PTR
(
»t
);

1020 
	}
}

1022 
þass
 *
	gnvmf_þass
;

1023 
deviû
 *
	gnvmf_deviû
;

1024 
DEFINE_MUTEX
(
nvmf_dev_mu‹x
);

1026 
ssize_t
 
	$nvmf_dev_wr™e
(
fže
 *fže, cÚ¡ 
__u£r
 *
ubuf
,

1027 
size_t
 
couÁ
, 
loff_t
 *
pos
)

1029 
£q_fže
 *£q_fžð
fže
->
´iv©e_d©a
;

1030 
nvme_ù¾
 *
ù¾
;

1031 cÚ¡ *
buf
;

1032 
»t
 = 0;

1034 ià(
couÁ
 > 
PAGE_SIZE
)

1035  -
ENOMEM
;

1037 
buf
 = 
	`memdup_u£r_nul
(
ubuf
, 
couÁ
);

1038 ià(
	`IS_ERR
(
buf
))

1039  
	`PTR_ERR
(
buf
);

1041 
	`mu‹x_lock
(&
nvmf_dev_mu‹x
);

1042 ià(
£q_fže
->
´iv©e
) {

1043 
»t
 = -
EINVAL
;

1044 
out_uÆock
;

1047 
ù¾
 = 
	`nvmf_ü—‹_ù¾
(
nvmf_deviû
, 
buf
, 
couÁ
);

1048 ià(
	`IS_ERR
(
ù¾
)) {

1049 
»t
 = 
	`PTR_ERR
(
ù¾
);

1050 
out_uÆock
;

1053 
£q_fže
->
´iv©e
 = 
ù¾
;

1055 
out_uÆock
:

1056 
	`mu‹x_uÆock
(&
nvmf_dev_mu‹x
);

1057 
	`kä“
(
buf
);

1058  
»t
 ?„‘ : 
couÁ
;

1059 
	}
}

1061 
	$nvmf_dev_show
(
£q_fže
 *£q_fže, *
´iv©e
)

1063 
nvme_ù¾
 *
ù¾
;

1064 
»t
 = 0;

1066 
	`mu‹x_lock
(&
nvmf_dev_mu‹x
);

1067 
ù¾
 = 
£q_fže
->
´iv©e
;

1068 ià(!
ù¾
) {

1069 
»t
 = -
EINVAL
;

1070 
out_uÆock
;

1073 
	`£q_´štf
(
£q_fže
, "instance=%d,cntlid=%d\n",

1074 
ù¾
->
š¡ªû
, cŒl->
úŽid
);

1076 
out_uÆock
:

1077 
	`mu‹x_uÆock
(&
nvmf_dev_mu‹x
);

1078  
»t
;

1079 
	}
}

1081 
	$nvmf_dev_Ý’
(
šode
 *šode, 
fže
 *file)

1087 
fže
->
´iv©e_d©a
 = 
NULL
;

1088  
	`sšgË_Ý’
(
fže
, 
nvmf_dev_show
, 
NULL
);

1089 
	}
}

1091 
	$nvmf_dev_»Ëa£
(
šode
 *šode, 
fže
 *file)

1093 
£q_fže
 *£q_fžð
fže
->
´iv©e_d©a
;

1094 
nvme_ù¾
 *
ù¾
 = 
£q_fže
->
´iv©e
;

1096 ià(
ù¾
)

1097 
	`nvme_put_ù¾
(
ù¾
);

1098  
	`sšgË_»Ëa£
(
šode
, 
fže
);

1099 
	}
}

1101 cÚ¡ 
fže_Ý”©iÚs
 
	gnvmf_dev_fÝs
 = {

1102 .
owÃr
 = 
THIS_MODULE
,

1103 .
	gwr™e
 = 
nvmf_dev_wr™e
,

1104 .
	g»ad
 = 
£q_»ad
,

1105 .
	gÝ’
 = 
nvmf_dev_Ý’
,

1106 .
	g»Ëa£
 = 
nvmf_dev_»Ëa£
,

1109 
miscdeviû
 
	gnvmf_misc
 = {

1110 .
mšÜ
 = 
MISC_DYNAMIC_MINOR
,

1111 .
	gÇme
 = "nvme-fabrics",

1112 .
	gfÝs
 = &
nvmf_dev_fÝs
,

1115 
__š™
 
	$nvmf_š™
()

1117 
»t
;

1119 
nvmf_deçuÉ_ho¡
 = 
	`nvmf_ho¡_deçuÉ
();

1120 ià(!
nvmf_deçuÉ_ho¡
)

1121  -
ENOMEM
;

1123 
nvmf_þass
 = 
	`þass_ü—‹
(
THIS_MODULE
, "nvme-fabrics");

1124 ià(
	`IS_ERR
(
nvmf_þass
)) {

1125 
	`´_”r
("couldn't„egister class‚vme-fabrics\n");

1126 
»t
 = 
	`PTR_ERR
(
nvmf_þass
);

1127 
out_ä“_ho¡
;

1130 
nvmf_deviû
 =

1131 
	`deviû_ü—‹
(
nvmf_þass
, 
NULL
, 
	`MKDEV
(0, 0), NULL, "ctl");

1132 ià(
	`IS_ERR
(
nvmf_deviû
)) {

1133 
	`´_”r
("couldn't create‚vme-fabris device!\n");

1134 
»t
 = 
	`PTR_ERR
(
nvmf_deviû
);

1135 
out_de¡roy_þass
;

1138 
»t
 = 
	`misc_»gi¡”
(&
nvmf_misc
);

1139 ià(
»t
) {

1140 
	`´_”r
("couldn'ˆ»gi¡” misødeviû: %d\n", 
»t
);

1141 
out_de¡roy_deviû
;

1146 
out_de¡roy_deviû
:

1147 
	`deviû_de¡roy
(
nvmf_þass
, 
	`MKDEV
(0, 0));

1148 
out_de¡roy_þass
:

1149 
	`þass_de¡roy
(
nvmf_þass
);

1150 
out_ä“_ho¡
:

1151 
	`nvmf_ho¡_put
(
nvmf_deçuÉ_ho¡
);

1152  
»t
;

1153 
	}
}

1155 
__ex™
 
	$nvmf_ex™
()

1157 
	`misc_d”egi¡”
(&
nvmf_misc
);

1158 
	`deviû_de¡roy
(
nvmf_þass
, 
	`MKDEV
(0, 0));

1159 
	`þass_de¡roy
(
nvmf_þass
);

1160 
	`nvmf_ho¡_put
(
nvmf_deçuÉ_ho¡
);

1162 
	`BUILD_BUG_ON
((
nvmf_cÚÃù_commªd
) != 64);

1163 
	`BUILD_BUG_ON
((
nvmf_´Ý”ty_g‘_commªd
) != 64);

1164 
	`BUILD_BUG_ON
((
nvmf_´Ý”ty_£t_commªd
) != 64);

1165 
	`BUILD_BUG_ON
((
nvmf_cÚÃù_d©a
) != 1024);

1166 
	}
}

1168 
MODULE_LICENSE
("GPL v2");

1169 #ifdeà
RETPOLINE_MLNX


1170 
MODULE_INFO
(
»Þše
, "Y");

1173 
moduË_š™
(
nvmf_š™
);

1174 
moduË_ex™
(
nvmf_ex™
);

	@fabrics.h

14 #iâdeà
_NVME_FABRICS_H


15 
	#_NVME_FABRICS_H
 1

	)

17 
	~<lšux/š.h
>

18 
	~<lšux/š‘.h
>

20 
	#NVMF_MIN_QUEUE_SIZE
 16

	)

21 
	#NVMF_MAX_QUEUE_SIZE
 1024

	)

22 
	#NVMF_DEF_QUEUE_SIZE
 128

	)

23 
	#NVMF_DEF_RECONNECT_DELAY
 10

	)

25 
	#NVMF_DEF_CTRL_LOSS_TMO
 600

	)

27 #ifdeà
NVMF_NQN_FIELD_LEN


28 #undeà
NVMF_NQN_FIELD_LEN


31 
	#NVMF_NQN_FIELD_LEN
 256

	)

33 #ifdeà
NVMF_NQN_SIZE


34 #undeà
NVMF_NQN_SIZE


37 
	#NVMF_NQN_SIZE
 223

	)

47 
	snvmf_ho¡
 {

48 
k»f
 
	m»f
;

49 
li¡_h—d
 
	mli¡
;

50 
	mnqn
[
NVMF_NQN_SIZE
];

51 
uuid_t
 
	mid
;

58 
	mNVMF_OPT_ERR
 = 0,

59 
	mNVMF_OPT_TRANSPORT
 = 1 << 0,

60 
	mNVMF_OPT_NQN
 = 1 << 1,

61 
	mNVMF_OPT_TRADDR
 = 1 << 2,

62 
	mNVMF_OPT_TRSVCID
 = 1 << 3,

63 
	mNVMF_OPT_QUEUE_SIZE
 = 1 << 4,

64 
	mNVMF_OPT_NR_IO_QUEUES
 = 1 << 5,

65 
	mNVMF_OPT_TL_RETRY_COUNT
 = 1 << 6,

66 
	mNVMF_OPT_KATO
 = 1 << 7,

67 
	mNVMF_OPT_HOSTNQN
 = 1 << 8,

68 
	mNVMF_OPT_RECONNECT_DELAY
 = 1 << 9,

69 
	mNVMF_OPT_HOST_TRADDR
 = 1 << 10,

70 
	mNVMF_OPT_CTRL_LOSS_TMO
 = 1 << 11,

71 
	mNVMF_OPT_HOST_ID
 = 1 << 12,

72 
	mNVMF_OPT_DUP_CONNECT
 = 1 << 13,

101 
	snvmf_ù¾_ÝtiÚs
 {

102 
	mmask
;

103 *
	mŒª¥Üt
;

104 *
	msubsy¢qn
;

105 *
	mŒaddr
;

106 *
	mŒsvcid
;

107 *
	mho¡_Œaddr
;

108 
size_t
 
	mqueue_size
;

109 
	mÄ_io_queues
;

110 
	m»cÚÃù_d–ay
;

111 
boÞ
 
	mdiscov”y_nqn
;

112 
boÞ
 
	mdu¶iÿ‹_cÚÃù
;

113 
	mk©o
;

114 
nvmf_ho¡
 *
	mho¡
;

115 
	mmax_»cÚÃùs
;

140 
	snvmf_Œª¥Üt_Ýs
 {

141 
li¡_h—d
 
	m’Œy
;

142 
moduË
 *
	mmoduË
;

143 cÚ¡ *
	mÇme
;

144 
	m»quœed_Ýts
;

145 
	m®lowed_Ýts
;

146 
	mnvme_ù¾
 *(*
	mü—‹_ù¾
)(
deviû
 *
	mdev
,

147 
nvmf_ù¾_ÝtiÚs
 *
	mÝts
);

150 
šlše
 
boÞ


151 
	$nvmf_ùÌ_m©ches_ba£Ýts
(
nvme_ù¾
 *
ù¾
,

152 
nvmf_ù¾_ÝtiÚs
 *
Ýts
)

154 ià(
ù¾
->
¡©e
 =ð
NVME_CTRL_DELETING
 ||

155 
ù¾
->
¡©e
 =ð
NVME_CTRL_DEAD
 ||

156 
	`¡rcmp
(
Ýts
->
subsy¢qn
, 
ù¾
->opts->subsysnqn) ||

157 
	`¡rcmp
(
Ýts
->
ho¡
->
nqn
, 
ù¾
->opts->host->nqn) ||

158 
	`memcmp
(&
Ýts
->
ho¡
->
id
, &
ù¾
->Ýts->ho¡->id, (
uuid_t
)))

159  
çl£
;

161  
Œue
;

162 
	}
}

164 
nvmf_»g_»ad32
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, u32 *
v®
);

165 
nvmf_»g_»ad64
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, 
u64
 *
v®
);

166 
nvmf_»g_wr™e32
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, u32 
v®
);

167 
nvmf_cÚÃù_admš_queue
(
nvme_ù¾
 *
ù¾
);

168 
nvmf_cÚÃù_io_queue
(
nvme_ù¾
 *
ù¾
, 
u16
 
qid
);

169 
nvmf_»gi¡”_Œª¥Üt
(
nvmf_Œª¥Üt_Ýs
 *
Ýs
);

170 
nvmf_uÄegi¡”_Œª¥Üt
(
nvmf_Œª¥Üt_Ýs
 *
Ýs
);

171 
nvmf_ä“_ÝtiÚs
(
nvmf_ù¾_ÝtiÚs
 *
Ýts
);

172 
nvmf_g‘_add»ss
(
nvme_ù¾
 *
ù¾
, *
buf
, 
size
);

173 
boÞ
 
nvmf_should_»cÚÃù
(
nvme_ù¾
 *
ù¾
);

174 
blk_¡©us_t
 
nvmf_check_if_»ady
(
nvme_ù¾
 *
ù¾
,

175 
»que¡
 *
rq
, 
boÞ
 
queue_live
, boÞ 
is_cÚÃùed
);

	@fault_inject.c

8 
	~<lšux/moduË·¿m.h
>

9 
	~"nvme.h
"

11 
DECLARE_FAULT_ATTR
(
çž_deçuÉ_©Œ
);

15 *
	gçž_»que¡
;

16 
moduË_·¿m
(
çž_»que¡
, 
ch¬p
, 0000);

18 
	$nvme_çuÉ_šjeù_š™
(
nvme_ns
 *
ns
)

20 
d’Œy
 *
dœ
, *
·»Á
;

21 *
Çme
 = 
ns
->
disk
->
disk_Çme
;

22 
nvme_çuÉ_šjeù
 *
çuÉ_šj
 = &
ns
->
çuÉ_šjeù
;

23 
çuÉ_©Œ
 *
©Œ
 = &
çuÉ_šj
->attr;

26 ià(
çž_»que¡
)

27 
	`£tup_çuÉ_©Œ
(&
çž_deçuÉ_©Œ
, 
çž_»que¡
);

30 
·»Á
 = 
	`debugfs_ü—‹_dœ
(
Çme
, 
NULL
);

31 ià(!
·»Á
) {

32 
	`´_w¬n
("%s: fažedØü—‹ debugf dœeùÜy\n", 
Çme
);

36 *
©Œ
 = 
çž_deçuÉ_©Œ
;

37 
dœ
 = 
	`çuÉ_ü—‹_debugfs_©Œ
("çuÉ_šjeù", 
·»Á
, 
©Œ
);

38 ià(
	`IS_ERR
(
dœ
)) {

39 
	`´_w¬n
("%s: fažedØü—‹ debugf ©Œ\n", 
Çme
);

40 
	`debugfs_»move_»cursive
(
·»Á
);

43 
ns
->
çuÉ_šjeù
.
·»Á
 =…arent;

46 
çuÉ_šj
->
¡©us
 = 
NVME_SC_INVALID_OPCODE
;

47 
çuÉ_šj
->
dÚt_»Œy
 = 
Œue
;

48 
	`debugfs_ü—‹_x16
("¡©us", 0600, 
dœ
, &
çuÉ_šj
->
¡©us
);

49 
	`debugfs_ü—‹_boÞ
("dÚt_»Œy", 0600, 
dœ
, &
çuÉ_šj
->
dÚt_»Œy
);

50 
	}
}

52 
	$nvme_çuÉ_šjeù_fši
(
nvme_ns
 *
ns
)

55 
	`debugfs_»move_»cursive
(
ns
->
çuÉ_šjeù
.
·»Á
);

56 
	}
}

58 
	$nvme_should_çž
(
»que¡
 *
»q
)

60 
g’disk
 *
disk
 = 
»q
->
rq_disk
;

61 
nvme_ns
 *
ns
 = 
NULL
;

62 
u16
 
¡©us
;

67 ià(!
disk
)

70 
ns
 = 
disk
->
´iv©e_d©a
;

71 ià(
ns
 && 
	`should_çž
(&ns->
çuÉ_šjeù
.
©Œ
, 1)) {

73 
¡©us
 = 
ns
->
çuÉ_šjeù
.status;

74 ià(
ns
->
çuÉ_šjeù
.
dÚt_»Œy
)

75 
¡©us
 |ð
NVME_SC_DNR
;

76 
	`nvme_»q
(
»q
)->
¡©us
 = status;

78 
	}
}

79 
EXPORT_SYMBOL_GPL
(
nvme_should_çž
);

	@fc.c

17 #ifdeà
HAVE_LINUX_NVME_FC_DRIVER_H


19 #ifdeà
´_fmt


20 #undeà
´_fmt


22 
	#´_fmt
(
fmt
è
KBUILD_MODNAME
 ": " 
	)
fmt

23 
	~<lšux/moduË.h
>

24 
	~<lšux/·r£r.h
>

25 
	~<u­i/scsi/fc/fc_fs.h
>

26 
	~<u­i/scsi/fc/fc_–s.h
>

27 
	~<lšux/d–ay.h
>

29 
	~"nvme.h
"

30 
	~"çbrics.h
"

31 
	~<lšux/nvme-fc-driv”.h
>

32 
	~<lšux/nvme-fc.h
>

38 
	envme_fc_queue_æags
 {

39 
	mNVME_FC_Q_CONNECTED
 = 0,

40 
	mNVME_FC_Q_LIVE
,

43 
	#NVME_FC_DEFAULT_DEV_LOSS_TMO
 60

	)

45 
	snvme_fc_queue
 {

46 
nvme_fc_ù¾
 *
	mù¾
;

47 
deviû
 *
	mdev
;

48 
blk_mq_hw_ùx
 *
	mhùx
;

49 *
	mÎdd_hªdË
;

50 
size_t
 
	mcmnd_ÿpsuË_Ën
;

51 
u32
 
	mqnum
;

52 
u32
 
	mrqút
;

53 
u32
 
	m£qno
;

55 
u64
 
	mcÚÃùiÚ_id
;

56 
©omic_t
 
	mc¢
;

58 
	mæags
;

59 } 
__®igÃd
((
u64
));

61 
	envme_fcÝ_æags
 {

62 
	mFCOP_FLAGS_TERMIO
 = (1 << 0),

63 
	mFCOP_FLAGS_AEN
 = (1 << 1),

66 
	snvmefc_ls_»q_Ý
 {

67 
nvmefc_ls_»q
 
	mls_»q
;

69 
nvme_fc_½Üt
 *
	m½Üt
;

70 
nvme_fc_queue
 *
	mqueue
;

71 
»que¡
 *
	mrq
;

72 
u32
 
	mæags
;

74 
	mls_”rÜ
;

75 
com¶‘iÚ
 
	mls_dÚe
;

76 
li¡_h—d
 
	ml¤eq_li¡
;

77 
boÞ
 
	m»q_queued
;

80 
	envme_fýÝ_¡©e
 {

81 
	mFCPOP_STATE_UNINIT
 = 0,

82 
	mFCPOP_STATE_IDLE
 = 1,

83 
	mFCPOP_STATE_ACTIVE
 = 2,

84 
	mFCPOP_STATE_ABORTED
 = 3,

85 
	mFCPOP_STATE_COMPLETE
 = 4,

88 
	snvme_fc_fý_Ý
 {

89 
nvme_»que¡
 
	mÄeq
;

97 
nvmefc_fý_»q
 
	mfý_»q
;

99 
nvme_fc_ù¾
 *
	mù¾
;

100 
nvme_fc_queue
 *
	mqueue
;

101 
»que¡
 *
	mrq
;

103 
©omic_t
 
	m¡©e
;

104 
u32
 
	mæags
;

105 
u32
 
	mrqno
;

106 
u32
 
	mÃÁs
;

108 
nvme_fc_cmd_iu
 
	mcmd_iu
;

109 
nvme_fc_”¥_iu
 
	mr¥_iu
;

112 
	snvme_fc_ÍÜt
 {

113 
nvme_fc_loÿl_pÜt
 
	mloÿÍÜt
;

115 
ida
 
	m’dp_út
;

116 
li¡_h—d
 
	mpÜt_li¡
;

117 
li¡_h—d
 
	m’dp_li¡
;

118 
deviû
 *
	mdev
;

119 
nvme_fc_pÜt_‹m¶©e
 *
	mÝs
;

120 
k»f
 
	m»f
;

121 
©omic_t
 
	maù_½Üt_út
;

122 } 
__®igÃd
((
u64
));

124 
	snvme_fc_½Üt
 {

125 
nvme_fc_»mÙe_pÜt
 
	m»mÙ•Üt
;

127 
li¡_h—d
 
	m’dp_li¡
;

128 
li¡_h—d
 
	mù¾_li¡
;

129 
li¡_h—d
 
	mls_»q_li¡
;

130 
deviû
 *
	mdev
;

131 
nvme_fc_ÍÜt
 *
	mÍÜt
;

132 
¥šlock_t
 
	mlock
;

133 
k»f
 
	m»f
;

134 
©omic_t
 
	maù_ù¾_út
;

135 
	mdev_loss_’d
;

136 } 
__®igÃd
((
u64
));

138 
	envme_fcù¾_æags
 {

139 
	mFCCTRL_TERMIO
 = (1 << 0),

142 
	snvme_fc_ù¾
 {

143 
¥šlock_t
 
	mlock
;

144 
nvme_fc_queue
 *
	mqueues
;

145 
deviû
 *
	mdev
;

146 
nvme_fc_ÍÜt
 *
	mÍÜt
;

147 
nvme_fc_½Üt
 *
	m½Üt
;

148 
u32
 
	múum
;

150 
boÞ
 
	massoc_aùive
;

151 
u64
 
	massocŸtiÚ_id
;

153 
li¡_h—d
 
	mù¾_li¡
;

155 
blk_mq_g_£t
 
	madmš_g_£t
;

156 
blk_mq_g_£t
 
	mg_£t
;

158 
d–ayed_wÜk
 
	mcÚÃù_wÜk
;

160 
k»f
 
	m»f
;

161 
u32
 
	mæags
;

162 
u32
 
	mioút
;

163 
wa™_queue_h—d_t
 
	mißbÜt_wa™
;

165 
nvme_fc_fý_Ý
 
	m«n_Ýs
[
NVME_NR_AEN_COMMANDS
];

167 
nvme_ù¾
 
	mù¾
;

170 
šlše
 
nvme_fc_ù¾
 *

171 
	$to_fc_ù¾
(
nvme_ù¾
 *
ù¾
)

173  
	`cÚš”_of
(
ù¾
, 
nvme_fc_ù¾
, ctrl);

174 
	}
}

176 
šlše
 
nvme_fc_ÍÜt
 *

177 
	$loÿÍÜt_to_ÍÜt
(
nvme_fc_loÿl_pÜt
 *
pÜŒ
)

179  
	`cÚš”_of
(
pÜŒ
, 
nvme_fc_ÍÜt
, 
loÿÍÜt
);

180 
	}
}

182 
šlše
 
nvme_fc_½Üt
 *

183 
	$»mÙ•Üt_to_½Üt
(
nvme_fc_»mÙe_pÜt
 *
pÜŒ
)

185  
	`cÚš”_of
(
pÜŒ
, 
nvme_fc_½Üt
, 
»mÙ•Üt
);

186 
	}
}

188 
šlše
 
nvmefc_ls_»q_Ý
 *

189 
	$ls_»q_to_lsÝ
(
nvmefc_ls_»q
 *
l¤eq
)

191  
	`cÚš”_of
(
l¤eq
, 
nvmefc_ls_»q_Ý
, 
ls_»q
);

192 
	}
}

194 
šlše
 
nvme_fc_fý_Ý
 *

195 
	$fý_»q_to_fý_Ý
(
nvmefc_fý_»q
 *
fý»q
)

197  
	`cÚš”_of
(
fý»q
, 
nvme_fc_fý_Ý
, 
fý_»q
);

198 
	}
}

205 
DEFINE_SPINLOCK
(
nvme_fc_lock
);

207 
LIST_HEAD
(
nvme_fc_ÍÜt_li¡
);

208 
DEFINE_IDA
(
nvme_fc_loÿl_pÜt_út
);

209 
DEFINE_IDA
(
nvme_fc_ù¾_út
);

217 
þass
 *
	gfc_þass
;

218 
deviû
 *
	gfc_udev_deviû
;

223 
__nvme_fc_d–‘e_hw_queue
(
nvme_fc_ù¾
 *,

224 
nvme_fc_queue
 *, );

227 
	$nvme_fc_ä“_ÍÜt
(
k»f
 *
»f
)

229 
nvme_fc_ÍÜt
 *
ÍÜt
 =

230 
	`cÚš”_of
(
»f
, 
nvme_fc_ÍÜt
,„ef);

231 
æags
;

233 
	`WARN_ON
(
ÍÜt
->
loÿÍÜt
.
pÜt_¡©e
 !ð
FC_OBJSTATE_DELETED
);

234 
	`WARN_ON
(!
	`li¡_em±y
(&
ÍÜt
->
’dp_li¡
));

237 
	`¥š_lock_œq§ve
(&
nvme_fc_lock
, 
æags
);

238 
	`li¡_d–
(&
ÍÜt
->
pÜt_li¡
);

239 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

241 
	`ida_sim¶e_»move
(&
nvme_fc_loÿl_pÜt_út
, 
ÍÜt
->
loÿÍÜt
.
pÜt_num
);

242 
	`ida_de¡roy
(&
ÍÜt
->
’dp_út
);

244 
	`put_deviû
(
ÍÜt
->
dev
);

246 
	`kä“
(
ÍÜt
);

247 
	}
}

250 
	$nvme_fc_ÍÜt_put
(
nvme_fc_ÍÜt
 *
ÍÜt
)

252 
	`k»f_put
(&
ÍÜt
->
»f
, 
nvme_fc_ä“_ÍÜt
);

253 
	}
}

256 
	$nvme_fc_ÍÜt_g‘
(
nvme_fc_ÍÜt
 *
ÍÜt
)

258  
	`k»f_g‘_uÆess_z”o
(&
ÍÜt
->
»f
);

259 
	}
}

262 
nvme_fc_ÍÜt
 *

263 
	$nvme_fc_©ch_to_uÄeg_ÍÜt
(
nvme_fc_pÜt_šfo
 *
pšfo
,

264 
nvme_fc_pÜt_‹m¶©e
 *
Ýs
,

265 
deviû
 *
dev
)

267 
nvme_fc_ÍÜt
 *
ÍÜt
;

268 
æags
;

270 
	`¥š_lock_œq§ve
(&
nvme_fc_lock
, 
æags
);

272 
	`li¡_fÜ_—ch_’Œy
(
ÍÜt
, &
nvme_fc_ÍÜt_li¡
, 
pÜt_li¡
) {

273 ià(
ÍÜt
->
loÿÍÜt
.
node_Çme
 !ð
pšfo
->node_name ||

274 
ÍÜt
->
loÿÍÜt
.
pÜt_Çme
 !ð
pšfo
->port_name)

277 ià(
ÍÜt
->
dev
 != dev) {

278 
ÍÜt
 = 
	`ERR_PTR
(-
EXDEV
);

279 
out_dÚe
;

282 ià(
ÍÜt
->
loÿÍÜt
.
pÜt_¡©e
 !ð
FC_OBJSTATE_DELETED
) {

283 
ÍÜt
 = 
	`ERR_PTR
(-
EEXIST
);

284 
out_dÚe
;

287 ià(!
	`nvme_fc_ÍÜt_g‘
(
ÍÜt
)) {

292 
ÍÜt
 = 
NULL
;

293 
out_dÚe
;

298 
ÍÜt
->
Ýs
 = ops;

299 
ÍÜt
->
loÿÍÜt
.
pÜt_rÞe
 = 
pšfo
->port_role;

300 
ÍÜt
->
loÿÍÜt
.
pÜt_id
 = 
pšfo
->port_id;

301 
ÍÜt
->
loÿÍÜt
.
pÜt_¡©e
 = 
FC_OBJSTATE_ONLINE
;

303 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

305  
ÍÜt
;

308 
ÍÜt
 = 
NULL
;

310 
out_dÚe
:

311 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

313  
ÍÜt
;

314 
	}
}

334 
	$nvme_fc_»gi¡”_loÿÍÜt
(
nvme_fc_pÜt_šfo
 *
pšfo
,

335 
nvme_fc_pÜt_‹m¶©e
 *
‹m¶©e
,

336 
deviû
 *
dev
,

337 
nvme_fc_loÿl_pÜt
 **
pÜŒ
)

339 
nvme_fc_ÍÜt
 *
Ãw»c
;

340 
æags
;

341 
»t
, 
idx
;

343 ià(!
‹m¶©e
->
loÿÍÜt_d–‘e
 || !‹m¶©e->
»mÙ•Üt_d–‘e
 ||

344 !
‹m¶©e
->
ls_»q
 || !‹m¶©e->
fý_io
 ||

345 !
‹m¶©e
->
ls_abÜt
 || !‹m¶©e->
fý_abÜt
 ||

346 !
‹m¶©e
->
max_hw_queues
 || !‹m¶©e->
max_sgl_£gm’ts
 ||

347 !
‹m¶©e
->
max_dif_sgl_£gm’ts
 || !‹m¶©e->
dma_bound¬y
) {

348 
»t
 = -
EINVAL
;

349 
out_»gho¡_çžed
;

359 
Ãw»c
 = 
	`nvme_fc_©ch_to_uÄeg_ÍÜt
(
pšfo
, 
‹m¶©e
, 
dev
);

362 ià(
	`IS_ERR
(
Ãw»c
)) {

363 
»t
 = 
	`PTR_ERR
(
Ãw»c
);

364 
out_»gho¡_çžed
;

367 } ià(
Ãw»c
) {

368 *
pÜŒ
 = &
Ãw»c
->
loÿÍÜt
;

374 
Ãw»c
 = 
	`km®loc
(((*Ãw»cè+ 
‹m¶©e
->
loÿl_´iv_sz
),

375 
GFP_KERNEL
);

376 ià(!
Ãw»c
) {

377 
»t
 = -
ENOMEM
;

378 
out_»gho¡_çžed
;

381 
idx
 = 
	`ida_sim¶e_g‘
(&
nvme_fc_loÿl_pÜt_út
, 0, 0, 
GFP_KERNEL
);

382 ià(
idx
 < 0) {

383 
»t
 = -
ENOSPC
;

384 
out_çž_kä“
;

387 ià(!
	`g‘_deviû
(
dev
) && dev) {

388 
»t
 = -
ENODEV
;

389 
out_ida_put
;

392 
	`INIT_LIST_HEAD
(&
Ãw»c
->
pÜt_li¡
);

393 
	`INIT_LIST_HEAD
(&
Ãw»c
->
’dp_li¡
);

394 
	`k»f_š™
(&
Ãw»c
->
»f
);

395 
	`©omic_£t
(&
Ãw»c
->
aù_½Üt_út
, 0);

396 
Ãw»c
->
Ýs
 = 
‹m¶©e
;

397 
Ãw»c
->
dev
 = dev;

398 
	`ida_š™
(&
Ãw»c
->
’dp_út
);

399 
Ãw»c
->
loÿÍÜt
.
´iv©e
 = &newrec[1];

400 
Ãw»c
->
loÿÍÜt
.
node_Çme
 = 
pšfo
->node_name;

401 
Ãw»c
->
loÿÍÜt
.
pÜt_Çme
 = 
pšfo
->port_name;

402 
Ãw»c
->
loÿÍÜt
.
pÜt_rÞe
 = 
pšfo
->port_role;

403 
Ãw»c
->
loÿÍÜt
.
pÜt_id
 = 
pšfo
->port_id;

404 
Ãw»c
->
loÿÍÜt
.
pÜt_¡©e
 = 
FC_OBJSTATE_ONLINE
;

405 
Ãw»c
->
loÿÍÜt
.
pÜt_num
 = 
idx
;

407 
	`¥š_lock_œq§ve
(&
nvme_fc_lock
, 
æags
);

408 
	`li¡_add_ž
(&
Ãw»c
->
pÜt_li¡
, &
nvme_fc_ÍÜt_li¡
);

409 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

411 ià(
dev
)

412 
	`dma_£t_£g_bound¬y
(
dev
, 
‹m¶©e
->
dma_bound¬y
);

414 *
pÜŒ
 = &
Ãw»c
->
loÿÍÜt
;

417 
out_ida_put
:

418 
	`ida_sim¶e_»move
(&
nvme_fc_loÿl_pÜt_út
, 
idx
);

419 
out_çž_kä“
:

420 
	`kä“
(
Ãw»c
);

421 
out_»gho¡_çžed
:

422 *
pÜŒ
 = 
NULL
;

424  
»t
;

425 
	}
}

426 
EXPORT_SYMBOL_GPL
(
nvme_fc_»gi¡”_loÿÍÜt
);

440 
	$nvme_fc_uÄegi¡”_loÿÍÜt
(
nvme_fc_loÿl_pÜt
 *
pÜŒ
)

442 
nvme_fc_ÍÜt
 *
ÍÜt
 = 
	`loÿÍÜt_to_ÍÜt
(
pÜŒ
);

443 
æags
;

445 ià(!
pÜŒ
)

446  -
EINVAL
;

448 
	`¥š_lock_œq§ve
(&
nvme_fc_lock
, 
æags
);

450 ià(
pÜŒ
->
pÜt_¡©e
 !ð
FC_OBJSTATE_ONLINE
) {

451 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

452  -
EINVAL
;

454 
pÜŒ
->
pÜt_¡©e
 = 
FC_OBJSTATE_DELETED
;

456 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

458 ià(
	`©omic_»ad
(&
ÍÜt
->
aù_½Üt_út
) == 0)

459 
ÍÜt
->
Ýs
->
	`loÿÍÜt_d–‘e
(&ÍÜt->
loÿÍÜt
);

461 
	`nvme_fc_ÍÜt_put
(
ÍÜt
);

464 
	}
}

465 
EXPORT_SYMBOL_GPL
(
nvme_fc_uÄegi¡”_loÿÍÜt
);

475 
	#FCNVME_TRADDR_LENGTH
 64

	)

478 
	$nvme_fc_sigÇl_discov”y_sÿn
(
nvme_fc_ÍÜt
 *
ÍÜt
,

479 
nvme_fc_½Üt
 *
½Üt
)

481 
ho¡addr
[
FCNVME_TRADDR_LENGTH
];

482 
tgddr
[
FCNVME_TRADDR_LENGTH
];

483 *
’vp
[4] = { "FC_EVENTòvmediscov”y", 
ho¡addr
, 
tgddr
, 
NULL
 };

485 ià(!(
½Üt
->
»mÙ•Üt
.
pÜt_rÞe
 & 
FC_PORT_ROLE_NVME_DISCOVERY
))

488 
	`¢´štf
(
ho¡addr
, (hostaddr),

490 
ÍÜt
->
loÿÍÜt
.
node_Çme
,†pÜt->loÿÍÜt.
pÜt_Çme
);

491 
	`¢´štf
(
tgddr
, (tgtaddr),

493 
½Üt
->
»mÙ•Üt
.
node_Çme
,„pÜt->»mÙ•Üt.
pÜt_Çme
);

494 
	`kobjeù_uev’t_’v
(&
fc_udev_deviû
->
kobj
, 
KOBJ_CHANGE
, 
’vp
);

495 
	}
}

498 
	$nvme_fc_ä“_½Üt
(
k»f
 *
»f
)

500 
nvme_fc_½Üt
 *
½Üt
 =

501 
	`cÚš”_of
(
»f
, 
nvme_fc_½Üt
,„ef);

502 
nvme_fc_ÍÜt
 *
ÍÜt
 =

503 
	`loÿÍÜt_to_ÍÜt
(
½Üt
->
»mÙ•Üt
.
loÿÍÜt
);

504 
æags
;

506 
	`WARN_ON
(
½Üt
->
»mÙ•Üt
.
pÜt_¡©e
 !ð
FC_OBJSTATE_DELETED
);

507 
	`WARN_ON
(!
	`li¡_em±y
(&
½Üt
->
ù¾_li¡
));

510 
	`¥š_lock_œq§ve
(&
nvme_fc_lock
, 
æags
);

511 
	`li¡_d–
(&
½Üt
->
’dp_li¡
);

512 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

514 
	`ida_sim¶e_»move
(&
ÍÜt
->
’dp_út
, 
½Üt
->
»mÙ•Üt
.
pÜt_num
);

516 
	`kä“
(
½Üt
);

518 
	`nvme_fc_ÍÜt_put
(
ÍÜt
);

519 
	}
}

522 
	$nvme_fc_½Üt_put
(
nvme_fc_½Üt
 *
½Üt
)

524 
	`k»f_put
(&
½Üt
->
»f
, 
nvme_fc_ä“_½Üt
);

525 
	}
}

528 
	$nvme_fc_½Üt_g‘
(
nvme_fc_½Üt
 *
½Üt
)

530  
	`k»f_g‘_uÆess_z”o
(&
½Üt
->
»f
);

531 
	}
}

534 
	$nvme_fc_»sume_cÚŒÞËr
(
nvme_fc_ù¾
 *
ù¾
)

536 
ù¾
->ù¾.
¡©e
) {

537 
NVME_CTRL_NEW
:

538 
NVME_CTRL_CONNECTING
:

543 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

545 "A‰em±šg„ecÚÃù\n", 
ù¾
->
úum
);

547 
	`queue_d–ayed_wÜk
(
nvme_wq
, &
ù¾
->
cÚÃù_wÜk
, 0);

550 
NVME_CTRL_RESETTING
:

562 
	}
}

564 
nvme_fc_½Üt
 *

565 
	$nvme_fc_©ch_to_su¥’ded_½Üt
(
nvme_fc_ÍÜt
 *
ÍÜt
,

566 
nvme_fc_pÜt_šfo
 *
pšfo
)

568 
nvme_fc_½Üt
 *
½Üt
;

569 
nvme_fc_ù¾
 *
ù¾
;

570 
æags
;

572 
	`¥š_lock_œq§ve
(&
nvme_fc_lock
, 
æags
);

574 
	`li¡_fÜ_—ch_’Œy
(
½Üt
, &
ÍÜt
->
’dp_li¡
,ƒndp_list) {

575 ià(
½Üt
->
»mÙ•Üt
.
node_Çme
 !ð
pšfo
->node_name ||

576 
½Üt
->
»mÙ•Üt
.
pÜt_Çme
 !ð
pšfo
->port_name)

579 ià(!
	`nvme_fc_½Üt_g‘
(
½Üt
)) {

580 
½Üt
 = 
	`ERR_PTR
(-
ENOLCK
);

581 
out_dÚe
;

584 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

586 
	`¥š_lock_œq§ve
(&
½Üt
->
lock
, 
æags
);

589 ià(
½Üt
->
»mÙ•Üt
.
pÜt_¡©e
 !ð
FC_OBJSTATE_DELETED
) {

591 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

592 
	`nvme_fc_½Üt_put
(
½Üt
);

593  
	`ERR_PTR
(-
ESTALE
);

596 
½Üt
->
»mÙ•Üt
.
pÜt_rÞe
 = 
pšfo
->port_role;

597 
½Üt
->
»mÙ•Üt
.
pÜt_id
 = 
pšfo
->port_id;

598 
½Üt
->
»mÙ•Üt
.
pÜt_¡©e
 = 
FC_OBJSTATE_ONLINE
;

599 
½Üt
->
dev_loss_’d
 = 0;

605 
	`li¡_fÜ_—ch_’Œy
(
ù¾
, &
½Üt
->
ù¾_li¡
, ctrl_list)

606 
	`nvme_fc_»sume_cÚŒÞËr
(
ù¾
);

608 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

610  
½Üt
;

613 
½Üt
 = 
NULL
;

615 
out_dÚe
:

616 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

618  
½Üt
;

619 
	}
}

621 
šlše
 

622 
	$__nvme_fc_£t_dev_loss_tmo
(
nvme_fc_½Üt
 *
½Üt
,

623 
nvme_fc_pÜt_šfo
 *
pšfo
)

625 ià(
pšfo
->
dev_loss_tmo
)

626 
½Üt
->
»mÙ•Üt
.
dev_loss_tmo
 = 
pšfo
->dev_loss_tmo;

628 
½Üt
->
»mÙ•Üt
.
dev_loss_tmo
 = 
NVME_FC_DEFAULT_DEV_LOSS_TMO
;

629 
	}
}

648 
	$nvme_fc_»gi¡”_»mÙ•Üt
(
nvme_fc_loÿl_pÜt
 *
loÿÍÜt
,

649 
nvme_fc_pÜt_šfo
 *
pšfo
,

650 
nvme_fc_»mÙe_pÜt
 **
pÜŒ
)

652 
nvme_fc_ÍÜt
 *
ÍÜt
 = 
	`loÿÍÜt_to_ÍÜt
(
loÿÍÜt
);

653 
nvme_fc_½Üt
 *
Ãw»c
;

654 
æags
;

655 
»t
, 
idx
;

657 ià(!
	`nvme_fc_ÍÜt_g‘
(
ÍÜt
)) {

658 
»t
 = -
ESHUTDOWN
;

659 
out_»gho¡_çžed
;

667 
Ãw»c
 = 
	`nvme_fc_©ch_to_su¥’ded_½Üt
(
ÍÜt
, 
pšfo
);

670 ià(
	`IS_ERR
(
Ãw»c
)) {

671 
»t
 = 
	`PTR_ERR
(
Ãw»c
);

672 
out_ÍÜt_put
;

675 } ià(
Ãw»c
) {

676 
	`nvme_fc_ÍÜt_put
(
ÍÜt
);

677 
	`__nvme_fc_£t_dev_loss_tmo
(
Ãw»c
, 
pšfo
);

678 
	`nvme_fc_sigÇl_discov”y_sÿn
(
ÍÜt
, 
Ãw»c
);

679 *
pÜŒ
 = &
Ãw»c
->
»mÙ•Üt
;

685 
Ãw»c
 = 
	`km®loc
(((*Ãw»cè+ 
ÍÜt
->
Ýs
->
»mÙe_´iv_sz
),

686 
GFP_KERNEL
);

687 ià(!
Ãw»c
) {

688 
»t
 = -
ENOMEM
;

689 
out_ÍÜt_put
;

692 
idx
 = 
	`ida_sim¶e_g‘
(&
ÍÜt
->
’dp_út
, 0, 0, 
GFP_KERNEL
);

693 ià(
idx
 < 0) {

694 
»t
 = -
ENOSPC
;

695 
out_kä“_½Üt
;

698 
	`INIT_LIST_HEAD
(&
Ãw»c
->
’dp_li¡
);

699 
	`INIT_LIST_HEAD
(&
Ãw»c
->
ù¾_li¡
);

700 
	`INIT_LIST_HEAD
(&
Ãw»c
->
ls_»q_li¡
);

701 
	`k»f_š™
(&
Ãw»c
->
»f
);

702 
	`©omic_£t
(&
Ãw»c
->
aù_ù¾_út
, 0);

703 
	`¥š_lock_š™
(&
Ãw»c
->
lock
);

704 
Ãw»c
->
»mÙ•Üt
.
loÿÍÜt
 = &
ÍÜt
->localport;

705 
Ãw»c
->
dev
 = 
ÍÜt
->dev;

706 
Ãw»c
->
ÍÜt
 =†port;

707 
Ãw»c
->
»mÙ•Üt
.
´iv©e
 = &newrec[1];

708 
Ãw»c
->
»mÙ•Üt
.
pÜt_rÞe
 = 
pšfo
->port_role;

709 
Ãw»c
->
»mÙ•Üt
.
node_Çme
 = 
pšfo
->node_name;

710 
Ãw»c
->
»mÙ•Üt
.
pÜt_Çme
 = 
pšfo
->port_name;

711 
Ãw»c
->
»mÙ•Üt
.
pÜt_id
 = 
pšfo
->port_id;

712 
Ãw»c
->
»mÙ•Üt
.
pÜt_¡©e
 = 
FC_OBJSTATE_ONLINE
;

713 
Ãw»c
->
»mÙ•Üt
.
pÜt_num
 = 
idx
;

714 
	`__nvme_fc_£t_dev_loss_tmo
(
Ãw»c
, 
pšfo
);

716 
	`¥š_lock_œq§ve
(&
nvme_fc_lock
, 
æags
);

717 
	`li¡_add_ž
(&
Ãw»c
->
’dp_li¡
, &
ÍÜt
->endp_list);

718 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

720 
	`nvme_fc_sigÇl_discov”y_sÿn
(
ÍÜt
, 
Ãw»c
);

722 *
pÜŒ
 = &
Ãw»c
->
»mÙ•Üt
;

725 
out_kä“_½Üt
:

726 
	`kä“
(
Ãw»c
);

727 
out_ÍÜt_put
:

728 
	`nvme_fc_ÍÜt_put
(
ÍÜt
);

729 
out_»gho¡_çžed
:

730 *
pÜŒ
 = 
NULL
;

731  
»t
;

732 
	}
}

733 
EXPORT_SYMBOL_GPL
(
nvme_fc_»gi¡”_»mÙ•Üt
);

736 
	$nvme_fc_abÜt_lsÝs
(
nvme_fc_½Üt
 *
½Üt
)

738 
nvmefc_ls_»q_Ý
 *
lsÝ
;

739 
æags
;

741 
»¡¬t
:

742 
	`¥š_lock_œq§ve
(&
½Üt
->
lock
, 
æags
);

744 
	`li¡_fÜ_—ch_’Œy
(
lsÝ
, &
½Üt
->
ls_»q_li¡
, 
l¤eq_li¡
) {

745 ià(!(
lsÝ
->
æags
 & 
FCOP_FLAGS_TERMIO
)) {

746 
lsÝ
->
æags
 |ð
FCOP_FLAGS_TERMIO
;

747 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

748 
½Üt
->
ÍÜt
->
Ýs
->
	`ls_abÜt
(&½Üt->ÍÜt->
loÿÍÜt
,

749 &
½Üt
->
»mÙ•Üt
,

750 &
lsÝ
->
ls_»q
);

751 
»¡¬t
;

754 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

757 
	}
}

760 
	$nvme_fc_ù¾_cÚÃùiv™y_loss
(
nvme_fc_ù¾
 *
ù¾
)

762 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

764 "RecÚÃù", 
ù¾
->
úum
);

766 
ù¾
->ù¾.
¡©e
) {

767 
NVME_CTRL_NEW
:

768 
NVME_CTRL_LIVE
:

776 ià(
	`nvme_»£t_ù¾
(&
ù¾
->ctrl)) {

777 
	`dev_w¬n
(
ù¾
->ù¾.
deviû
,

779 
ù¾
->
úum
);

780 
	`nvme_d–‘e_ù¾
(&
ù¾
->ctrl);

784 
NVME_CTRL_CONNECTING
:

794 
NVME_CTRL_RESETTING
:

803 
NVME_CTRL_DELETING
:

808 
	}
}

822 
	$nvme_fc_uÄegi¡”_»mÙ•Üt
(
nvme_fc_»mÙe_pÜt
 *
pÜŒ
)

824 
nvme_fc_½Üt
 *
½Üt
 = 
	`»mÙ•Üt_to_½Üt
(
pÜŒ
);

825 
nvme_fc_ù¾
 *
ù¾
;

826 
æags
;

828 ià(!
pÜŒ
)

829  -
EINVAL
;

831 
	`¥š_lock_œq§ve
(&
½Üt
->
lock
, 
æags
);

833 ià(
pÜŒ
->
pÜt_¡©e
 !ð
FC_OBJSTATE_ONLINE
) {

834 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

835  -
EINVAL
;

837 
pÜŒ
->
pÜt_¡©e
 = 
FC_OBJSTATE_DELETED
;

839 
½Üt
->
dev_loss_’d
 = 
jiff›s
 + (
pÜŒ
->
dev_loss_tmo
 * 
HZ
);

841 
	`li¡_fÜ_—ch_’Œy
(
ù¾
, &
½Üt
->
ù¾_li¡
, ctrl_list) {

843 ià(!
pÜŒ
->
dev_loss_tmo
) {

844 
	`dev_w¬n
(
ù¾
->ù¾.
deviû
,

846 
ù¾
->
úum
);

847 
	`nvme_d–‘e_ù¾
(&
ù¾
->ctrl);

849 
	`nvme_fc_ù¾_cÚÃùiv™y_loss
(
ù¾
);

852 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

854 
	`nvme_fc_abÜt_lsÝs
(
½Üt
);

856 ià(
	`©omic_»ad
(&
½Üt
->
aù_ù¾_út
) == 0)

857 
½Üt
->
ÍÜt
->
Ýs
->
	`»mÙ•Üt_d–‘e
(
pÜŒ
);

864 
	`nvme_fc_½Üt_put
(
½Üt
);

867 
	}
}

868 
EXPORT_SYMBOL_GPL
(
nvme_fc_uÄegi¡”_»mÙ•Üt
);

879 
	$nvme_fc_»sÿn_»mÙ•Üt
(
nvme_fc_»mÙe_pÜt
 *
»mÙ•Üt
)

881 
nvme_fc_½Üt
 *
½Üt
 = 
	`»mÙ•Üt_to_½Üt
(
»mÙ•Üt
);

883 
	`nvme_fc_sigÇl_discov”y_sÿn
(
½Üt
->
ÍÜt
,„port);

884 
	}
}

885 
EXPORT_SYMBOL_GPL
(
nvme_fc_»sÿn_»mÙ•Üt
);

888 
	$nvme_fc_£t_»mÙ•Üt_devloss
(
nvme_fc_»mÙe_pÜt
 *
pÜŒ
,

889 
u32
 
dev_loss_tmo
)

891 
nvme_fc_½Üt
 *
½Üt
 = 
	`»mÙ•Üt_to_½Üt
(
pÜŒ
);

892 
æags
;

894 
	`¥š_lock_œq§ve
(&
½Üt
->
lock
, 
æags
);

896 ià(
pÜŒ
->
pÜt_¡©e
 !ð
FC_OBJSTATE_ONLINE
) {

897 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

898  -
EINVAL
;

902 
½Üt
->
»mÙ•Üt
.
dev_loss_tmo
 = dev_loss_tmo;

904 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

907 
	}
}

908 
EXPORT_SYMBOL_GPL
(
nvme_fc_£t_»mÙ•Üt_devloss
);

929 
šlše
 
dma_addr_t


930 
	$fc_dma_m­_sšgË
(
deviû
 *
dev
, *
±r
, 
size_t
 
size
,

931 
dma_d©a_dœeùiÚ
 
dœ
)

933  
dev
 ? 
	`dma_m­_sšgË
(dev, 
±r
, 
size
, 
dœ
è: (
dma_addr_t
)0L;

934 
	}
}

936 
šlše
 

937 
	$fc_dma_m­pšg_”rÜ
(
deviû
 *
dev
, 
dma_addr_t
 
dma_addr
)

939  
dev
 ? 
	`dma_m­pšg_”rÜ
(dev, 
dma_addr
) : 0;

940 
	}
}

942 
šlše
 

943 
	$fc_dma_unm­_sšgË
(
deviû
 *
dev
, 
dma_addr_t
 
addr
, 
size_t
 
size
,

944 
dma_d©a_dœeùiÚ
 
dœ
)

946 ià(
dev
)

947 
	`dma_unm­_sšgË
(
dev
, 
addr
, 
size
, 
dœ
);

948 
	}
}

950 
šlše
 

951 
	$fc_dma_sync_sšgË_fÜ_ýu
(
deviû
 *
dev
, 
dma_addr_t
 
addr
, 
size_t
 
size
,

952 
dma_d©a_dœeùiÚ
 
dœ
)

954 ià(
dev
)

955 
	`dma_sync_sšgË_fÜ_ýu
(
dev
, 
addr
, 
size
, 
dœ
);

956 
	}
}

958 
šlše
 

959 
	$fc_dma_sync_sšgË_fÜ_deviû
(
deviû
 *
dev
, 
dma_addr_t
 
addr
, 
size_t
 
size
,

960 
dma_d©a_dœeùiÚ
 
dœ
)

962 ià(
dev
)

963 
	`dma_sync_sšgË_fÜ_deviû
(
dev
, 
addr
, 
size
, 
dœ
);

964 
	}
}

968 
	$fc_m­_sg
(
sÿ‰”li¡
 *
sg
, 
ÃÁs
)

970 
sÿ‰”li¡
 *
s
;

971 
i
;

973 
	`WARN_ON
(
ÃÁs
 =ð0 || 
sg
[0].
Ëngth
 == 0);

975 
	`fÜ_—ch_sg
(
sg
, 
s
, 
ÃÁs
, 
i
) {

976 
s
->
dma_add»ss
 = 0L;

977 #ifdeà
CONFIG_NEED_SG_DMA_LENGTH


978 
s
->
dma_Ëngth
 = s->
Ëngth
;

981  
ÃÁs
;

982 
	}
}

984 
šlše
 

985 
	$fc_dma_m­_sg
(
deviû
 *
dev
, 
sÿ‰”li¡
 *
sg
, 
ÃÁs
,

986 
dma_d©a_dœeùiÚ
 
dœ
)

988  
dev
 ? 
	`dma_m­_sg
(dev, 
sg
, 
ÃÁs
, 
dœ
è: 
	`fc_m­_sg
(sg,‚ents);

989 
	}
}

991 
šlše
 

992 
	$fc_dma_unm­_sg
(
deviû
 *
dev
, 
sÿ‰”li¡
 *
sg
, 
ÃÁs
,

993 
dma_d©a_dœeùiÚ
 
dœ
)

995 ià(
dev
)

996 
	`dma_unm­_sg
(
dev
, 
sg
, 
ÃÁs
, 
dœ
);

997 
	}
}

1001 
nvme_fc_ù¾_put
(
nvme_fc_ù¾
 *);

1002 
nvme_fc_ù¾_g‘
(
nvme_fc_ù¾
 *);

1006 
	$__nvme_fc_fšish_ls_»q
(
nvmefc_ls_»q_Ý
 *
lsÝ
)

1008 
nvme_fc_½Üt
 *
½Üt
 = 
lsÝ
->rport;

1009 
nvmefc_ls_»q
 *
l¤eq
 = &
lsÝ
->
ls_»q
;

1010 
æags
;

1012 
	`¥š_lock_œq§ve
(&
½Üt
->
lock
, 
æags
);

1014 ià(!
lsÝ
->
»q_queued
) {

1015 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

1019 
	`li¡_d–
(&
lsÝ
->
l¤eq_li¡
);

1021 
lsÝ
->
»q_queued
 = 
çl£
;

1023 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

1025 
	`fc_dma_unm­_sšgË
(
½Üt
->
dev
, 
l¤eq
->
rq¡dma
,

1026 (
l¤eq
->
rq¡Ën
 +†¤eq->
r¥Ën
),

1027 
DMA_BIDIRECTIONAL
);

1029 
	`nvme_fc_½Üt_put
(
½Üt
);

1030 
	}
}

1033 
__nvme_fc_£nd_ls_»q
(
nvme_fc_½Üt
 *
½Üt
,

1034 
nvmefc_ls_»q_Ý
 *
lsÝ
,

1035 (*
dÚe
)(
nvmefc_ls_»q
 *
»q
, 
¡©us
))

1037 
nvmefc_ls_»q
 *
l¤eq
 = &
lsÝ
->
ls_»q
;

1038 
æags
;

1039 
»t
 = 0;

1041 ià(
½Üt
->
»mÙ•Üt
.
pÜt_¡©e
 !ð
FC_OBJSTATE_ONLINE
)

1042  -
ECONNREFUSED
;

1044 ià(!
	`nvme_fc_½Üt_g‘
(
½Üt
))

1045  -
ESHUTDOWN
;

1047 
l¤eq
->
dÚe
 = done;

1048 
lsÝ
->
½Üt
 =„port;

1049 
lsÝ
->
»q_queued
 = 
çl£
;

1050 
	`INIT_LIST_HEAD
(&
lsÝ
->
l¤eq_li¡
);

1051 
	`š™_com¶‘iÚ
(&
lsÝ
->
ls_dÚe
);

1053 
l¤eq
->
rq¡dma
 = 
	`fc_dma_m­_sšgË
(
½Üt
->
dev
,†¤eq->
rq¡addr
,

1054 
l¤eq
->
rq¡Ën
 +†¤eq->
r¥Ën
,

1055 
DMA_BIDIRECTIONAL
);

1056 ià(
	`fc_dma_m­pšg_”rÜ
(
½Üt
->
dev
, 
l¤eq
->
rq¡dma
)) {

1057 
»t
 = -
EFAULT
;

1058 
out_puŒpÜt
;

1060 
l¤eq
->
r¥dma
 =†¤eq->
rq¡dma
 +†¤eq->
rq¡Ën
;

1062 
	`¥š_lock_œq§ve
(&
½Üt
->
lock
, 
æags
);

1064 
	`li¡_add_ž
(&
lsÝ
->
l¤eq_li¡
, &
½Üt
->
ls_»q_li¡
);

1066 
lsÝ
->
»q_queued
 = 
Œue
;

1068 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

1070 
»t
 = 
½Üt
->
ÍÜt
->
Ýs
->
	`ls_»q
(&½Üt->ÍÜt->
loÿÍÜt
,

1071 &
½Üt
->
»mÙ•Üt
, 
l¤eq
);

1072 ià(
»t
)

1073 
out_uÆšk
;

1077 
out_uÆšk
:

1078 
lsÝ
->
ls_”rÜ
 = 
»t
;

1079 
	`¥š_lock_œq§ve
(&
½Üt
->
lock
, 
æags
);

1080 
lsÝ
->
»q_queued
 = 
çl£
;

1081 
	`li¡_d–
(&
lsÝ
->
l¤eq_li¡
);

1082 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

1083 
	`fc_dma_unm­_sšgË
(
½Üt
->
dev
, 
l¤eq
->
rq¡dma
,

1084 (
l¤eq
->
rq¡Ën
 +†¤eq->
r¥Ën
),

1085 
DMA_BIDIRECTIONAL
);

1086 
out_puŒpÜt
:

1087 
	`nvme_fc_½Üt_put
(
½Üt
);

1089  
»t
;

1090 
	}
}

1093 
	$nvme_fc_£nd_ls_»q_dÚe
(
nvmefc_ls_»q
 *
l¤eq
, 
¡©us
)

1095 
nvmefc_ls_»q_Ý
 *
lsÝ
 = 
	`ls_»q_to_lsÝ
(
l¤eq
);

1097 
lsÝ
->
ls_”rÜ
 = 
¡©us
;

1098 
	`com¶‘e
(&
lsÝ
->
ls_dÚe
);

1099 
	}
}

1102 
	$nvme_fc_£nd_ls_»q
(
nvme_fc_½Üt
 *
½Üt
, 
nvmefc_ls_»q_Ý
 *
lsÝ
)

1104 
nvmefc_ls_»q
 *
l¤eq
 = &
lsÝ
->
ls_»q
;

1105 
fúvme_ls_rjt
 *
rjt
 = 
l¤eq
->
r¥addr
;

1106 
»t
;

1108 
»t
 = 
	`__nvme_fc_£nd_ls_»q
(
½Üt
, 
lsÝ
, 
nvme_fc_£nd_ls_»q_dÚe
);

1110 ià(!
»t
) {

1117 
	`wa™_fÜ_com¶‘iÚ
(&
lsÝ
->
ls_dÚe
);

1119 
	`__nvme_fc_fšish_ls_»q
(
lsÝ
);

1121 
»t
 = 
lsÝ
->
ls_”rÜ
;

1124 ià(
»t
)

1125  
»t
;

1128 ià(
rjt
->
w0
.
ls_cmd
 =ð
FCNVME_LS_RJT
)

1129  -
ENXIO
;

1132 
	}
}

1135 
nvme_fc_£nd_ls_»q_async
(
nvme_fc_½Üt
 *
½Üt
,

1136 
nvmefc_ls_»q_Ý
 *
lsÝ
,

1137 (*
dÚe
)(
nvmefc_ls_»q
 *
»q
, 
¡©us
))

1141  
	`__nvme_fc_£nd_ls_»q
(
½Üt
, 
lsÝ
, 
dÚe
);

1142 
	}
}

1146 
	mVERR_NO_ERROR
 = 0,

1147 
	mVERR_LSACC
 = 1,

1148 
	mVERR_LSDESC_RQST
 = 2,

1149 
	mVERR_LSDESC_RQST_LEN
 = 3,

1150 
	mVERR_ASSOC_ID
 = 4,

1151 
	mVERR_ASSOC_ID_LEN
 = 5,

1152 
	mVERR_CONN_ID
 = 6,

1153 
	mVERR_CONN_ID_LEN
 = 7,

1154 
	mVERR_CR_ASSOC
 = 8,

1155 
	mVERR_CR_ASSOC_ACC_LEN
 = 9,

1156 
	mVERR_CR_CONN
 = 10,

1157 
	mVERR_CR_CONN_ACC_LEN
 = 11,

1158 
	mVERR_DISCONN
 = 12,

1159 
	mVERR_DISCONN_ACC_LEN
 = 13,

1162 *
	gv®id©iÚ_”rÜs
[] = {

1180 
	$nvme_fc_cÚÃù_admš_queue
(
nvme_fc_ù¾
 *
ù¾
,

1181 
nvme_fc_queue
 *
queue
, 
u16
 
qsize
, u16 
”¥_¿tio
)

1183 
nvmefc_ls_»q_Ý
 *
lsÝ
;

1184 
nvmefc_ls_»q
 *
l¤eq
;

1185 
fúvme_ls_ü_assoc_rq¡
 *
assoc_rq¡
;

1186 
fúvme_ls_ü_assoc_acc
 *
assoc_acc
;

1187 
»t
, 
fü‘
 = 0;

1189 
lsÝ
 = 
	`kz®loc
(((*lsop) +

1190 
ù¾
->
ÍÜt
->
Ýs
->
l¤q¡_´iv_sz
 +

1191 (*
assoc_rq¡
è+ (*
assoc_acc
)), 
GFP_KERNEL
);

1192 ià(!
lsÝ
) {

1193 
»t
 = -
ENOMEM
;

1194 
out_no_memÜy
;

1196 
l¤eq
 = &
lsÝ
->
ls_»q
;

1198 
l¤eq
->
´iv©e
 = (*)&
lsÝ
[1];

1199 
assoc_rq¡
 = (
fúvme_ls_ü_assoc_rq¡
 *)

1200 (
l¤eq
->
´iv©e
 + 
ù¾
->
ÍÜt
->
Ýs
->
l¤q¡_´iv_sz
);

1201 
assoc_acc
 = (
fúvme_ls_ü_assoc_acc
 *)&
assoc_rq¡
[1];

1203 
assoc_rq¡
->
w0
.
ls_cmd
 = 
FCNVME_LS_CREATE_ASSOCIATION
;

1204 
assoc_rq¡
->
desc_li¡_Ën
 =

1205 
	`ýu_to_be32
((
fúvme_lsdesc_ü_assoc_cmd
));

1207 
assoc_rq¡
->
assoc_cmd
.
desc_g
 =

1208 
	`ýu_to_be32
(
FCNVME_LSDESC_CREATE_ASSOC_CMD
);

1209 
assoc_rq¡
->
assoc_cmd
.
desc_Ën
 =

1210 
	`fúvme_lsdesc_Ën
(

1211 (
fúvme_lsdesc_ü_assoc_cmd
));

1213 
assoc_rq¡
->
assoc_cmd
.
”¥_¿tio
 = 
	`ýu_to_be16
(ersp_ratio);

1214 
assoc_rq¡
->
assoc_cmd
.
sqsize
 = 
	`ýu_to_be16
(
qsize
 - 1);

1216 
assoc_rq¡
->
assoc_cmd
.
úŽid
 = 
	`ýu_to_be16
(0xffff);

1217 
	`uuid_cÝy
(&
assoc_rq¡
->
assoc_cmd
.
ho¡id
, &
ù¾
->ù¾.
Ýts
->
ho¡
->
id
);

1218 
	`¡ºýy
(
assoc_rq¡
->
assoc_cmd
.
ho¡nqn
, 
ù¾
->ù¾.
Ýts
->
ho¡
->
nqn
,

1219 
	`mš
(
FCNVME_ASSOC_HOSTNQN_LEN
, 
NVMF_NQN_SIZE
));

1220 
	`¡ºýy
(
assoc_rq¡
->
assoc_cmd
.
subnqn
, 
ù¾
->ù¾.
Ýts
->
subsy¢qn
,

1221 
	`mš
(
FCNVME_ASSOC_SUBNQN_LEN
, 
NVMF_NQN_SIZE
));

1223 
lsÝ
->
queue
 = queue;

1224 
l¤eq
->
rq¡addr
 = 
assoc_rq¡
;

1225 
l¤eq
->
rq¡Ën
 = (*
assoc_rq¡
);

1226 
l¤eq
->
r¥addr
 = 
assoc_acc
;

1227 
l¤eq
->
r¥Ën
 = (*
assoc_acc
);

1228 
l¤eq
->
timeout
 = 
NVME_FC_CONNECT_TIMEOUT_SEC
;

1230 
»t
 = 
	`nvme_fc_£nd_ls_»q
(
ù¾
->
½Üt
, 
lsÝ
);

1231 ià(
»t
)

1232 
out_ä“_bufãr
;

1237 ià(
assoc_acc
->
hdr
.
w0
.
ls_cmd
 !ð
FCNVME_LS_ACC
)

1238 
fü‘
 = 
VERR_LSACC
;

1239 ià(
assoc_acc
->
hdr
.
desc_li¡_Ën
 !=

1240 
	`fúvme_lsdesc_Ën
(

1241 (
fúvme_ls_ü_assoc_acc
)))

1242 
fü‘
 = 
VERR_CR_ASSOC_ACC_LEN
;

1243 ià(
assoc_acc
->
hdr
.
rq¡
.
desc_g
 !=

1244 
	`ýu_to_be32
(
FCNVME_LSDESC_RQST
))

1245 
fü‘
 = 
VERR_LSDESC_RQST
;

1246 ià(
assoc_acc
->
hdr
.
rq¡
.
desc_Ën
 !=

1247 
	`fúvme_lsdesc_Ën
((
fúvme_lsdesc_rq¡
)))

1248 
fü‘
 = 
VERR_LSDESC_RQST_LEN
;

1249 ià(
assoc_acc
->
hdr
.
rq¡
.
w0
.
ls_cmd
 !ð
FCNVME_LS_CREATE_ASSOCIATION
)

1250 
fü‘
 = 
VERR_CR_ASSOC
;

1251 ià(
assoc_acc
->
associd
.
desc_g
 !=

1252 
	`ýu_to_be32
(
FCNVME_LSDESC_ASSOC_ID
))

1253 
fü‘
 = 
VERR_ASSOC_ID
;

1254 ià(
assoc_acc
->
associd
.
desc_Ën
 !=

1255 
	`fúvme_lsdesc_Ën
(

1256 (
fúvme_lsdesc_assoc_id
)))

1257 
fü‘
 = 
VERR_ASSOC_ID_LEN
;

1258 ià(
assoc_acc
->
cÚÃùid
.
desc_g
 !=

1259 
	`ýu_to_be32
(
FCNVME_LSDESC_CONN_ID
))

1260 
fü‘
 = 
VERR_CONN_ID
;

1261 ià(
assoc_acc
->
cÚÃùid
.
desc_Ën
 !=

1262 
	`fúvme_lsdesc_Ën
((
fúvme_lsdesc_cÚn_id
)))

1263 
fü‘
 = 
VERR_CONN_ID_LEN
;

1265 ià(
fü‘
) {

1266 
»t
 = -
EBADF
;

1267 
	`dev_”r
(
ù¾
->
dev
,

1269 
queue
->
qnum
, 
v®id©iÚ_”rÜs
[
fü‘
]);

1271 
ù¾
->
assocŸtiÚ_id
 =

1272 
	`be64_to_ýu
(
assoc_acc
->
associd
.
assocŸtiÚ_id
);

1273 
queue
->
cÚÃùiÚ_id
 =

1274 
	`be64_to_ýu
(
assoc_acc
->
cÚÃùid
.
cÚÃùiÚ_id
);

1275 
	`£t_b™
(
NVME_FC_Q_CONNECTED
, &
queue
->
æags
);

1278 
out_ä“_bufãr
:

1279 
	`kä“
(
lsÝ
);

1280 
out_no_memÜy
:

1281 ià(
»t
)

1282 
	`dev_”r
(
ù¾
->
dev
,

1284 
queue
->
qnum
, 
»t
);

1285  
»t
;

1286 
	}
}

1289 
	$nvme_fc_cÚÃù_queue
(
nvme_fc_ù¾
 *
ù¾
, 
nvme_fc_queue
 *
queue
,

1290 
u16
 
qsize
, u16 
”¥_¿tio
)

1292 
nvmefc_ls_»q_Ý
 *
lsÝ
;

1293 
nvmefc_ls_»q
 *
l¤eq
;

1294 
fúvme_ls_ü_cÚn_rq¡
 *
cÚn_rq¡
;

1295 
fúvme_ls_ü_cÚn_acc
 *
cÚn_acc
;

1296 
»t
, 
fü‘
 = 0;

1298 
lsÝ
 = 
	`kz®loc
(((*lsop) +

1299 
ù¾
->
ÍÜt
->
Ýs
->
l¤q¡_´iv_sz
 +

1300 (*
cÚn_rq¡
è+ (*
cÚn_acc
)), 
GFP_KERNEL
);

1301 ià(!
lsÝ
) {

1302 
»t
 = -
ENOMEM
;

1303 
out_no_memÜy
;

1305 
l¤eq
 = &
lsÝ
->
ls_»q
;

1307 
l¤eq
->
´iv©e
 = (*)&
lsÝ
[1];

1308 
cÚn_rq¡
 = (
fúvme_ls_ü_cÚn_rq¡
 *)

1309 (
l¤eq
->
´iv©e
 + 
ù¾
->
ÍÜt
->
Ýs
->
l¤q¡_´iv_sz
);

1310 
cÚn_acc
 = (
fúvme_ls_ü_cÚn_acc
 *)&
cÚn_rq¡
[1];

1312 
cÚn_rq¡
->
w0
.
ls_cmd
 = 
FCNVME_LS_CREATE_CONNECTION
;

1313 
cÚn_rq¡
->
desc_li¡_Ën
 = 
	`ýu_to_be32
(

1314 (
fúvme_lsdesc_assoc_id
) +

1315 (
fúvme_lsdesc_ü_cÚn_cmd
));

1317 
cÚn_rq¡
->
associd
.
desc_g
 = 
	`ýu_to_be32
(
FCNVME_LSDESC_ASSOC_ID
);

1318 
cÚn_rq¡
->
associd
.
desc_Ën
 =

1319 
	`fúvme_lsdesc_Ën
(

1320 (
fúvme_lsdesc_assoc_id
));

1321 
cÚn_rq¡
->
associd
.
assocŸtiÚ_id
 = 
	`ýu_to_be64
(
ù¾
->association_id);

1322 
cÚn_rq¡
->
cÚÃù_cmd
.
desc_g
 =

1323 
	`ýu_to_be32
(
FCNVME_LSDESC_CREATE_CONN_CMD
);

1324 
cÚn_rq¡
->
cÚÃù_cmd
.
desc_Ën
 =

1325 
	`fúvme_lsdesc_Ën
(

1326 (
fúvme_lsdesc_ü_cÚn_cmd
));

1327 
cÚn_rq¡
->
cÚÃù_cmd
.
”¥_¿tio
 = 
	`ýu_to_be16
(ersp_ratio);

1328 
cÚn_rq¡
->
cÚÃù_cmd
.
qid
 = 
	`ýu_to_be16
(
queue
->
qnum
);

1329 
cÚn_rq¡
->
cÚÃù_cmd
.
sqsize
 = 
	`ýu_to_be16
(
qsize
 - 1);

1331 
lsÝ
->
queue
 = queue;

1332 
l¤eq
->
rq¡addr
 = 
cÚn_rq¡
;

1333 
l¤eq
->
rq¡Ën
 = (*
cÚn_rq¡
);

1334 
l¤eq
->
r¥addr
 = 
cÚn_acc
;

1335 
l¤eq
->
r¥Ën
 = (*
cÚn_acc
);

1336 
l¤eq
->
timeout
 = 
NVME_FC_CONNECT_TIMEOUT_SEC
;

1338 
»t
 = 
	`nvme_fc_£nd_ls_»q
(
ù¾
->
½Üt
, 
lsÝ
);

1339 ià(
»t
)

1340 
out_ä“_bufãr
;

1345 ià(
cÚn_acc
->
hdr
.
w0
.
ls_cmd
 !ð
FCNVME_LS_ACC
)

1346 
fü‘
 = 
VERR_LSACC
;

1347 ià(
cÚn_acc
->
hdr
.
desc_li¡_Ën
 !=

1348 
	`fúvme_lsdesc_Ën
((
fúvme_ls_ü_cÚn_acc
)))

1349 
fü‘
 = 
VERR_CR_CONN_ACC_LEN
;

1350 ià(
cÚn_acc
->
hdr
.
rq¡
.
desc_g
 !ð
	`ýu_to_be32
(
FCNVME_LSDESC_RQST
))

1351 
fü‘
 = 
VERR_LSDESC_RQST
;

1352 ià(
cÚn_acc
->
hdr
.
rq¡
.
desc_Ën
 !=

1353 
	`fúvme_lsdesc_Ën
((
fúvme_lsdesc_rq¡
)))

1354 
fü‘
 = 
VERR_LSDESC_RQST_LEN
;

1355 ià(
cÚn_acc
->
hdr
.
rq¡
.
w0
.
ls_cmd
 !ð
FCNVME_LS_CREATE_CONNECTION
)

1356 
fü‘
 = 
VERR_CR_CONN
;

1357 ià(
cÚn_acc
->
cÚÃùid
.
desc_g
 !=

1358 
	`ýu_to_be32
(
FCNVME_LSDESC_CONN_ID
))

1359 
fü‘
 = 
VERR_CONN_ID
;

1360 ià(
cÚn_acc
->
cÚÃùid
.
desc_Ën
 !=

1361 
	`fúvme_lsdesc_Ën
((
fúvme_lsdesc_cÚn_id
)))

1362 
fü‘
 = 
VERR_CONN_ID_LEN
;

1364 ià(
fü‘
) {

1365 
»t
 = -
EBADF
;

1366 
	`dev_”r
(
ù¾
->
dev
,

1368 
queue
->
qnum
, 
v®id©iÚ_”rÜs
[
fü‘
]);

1370 
queue
->
cÚÃùiÚ_id
 =

1371 
	`be64_to_ýu
(
cÚn_acc
->
cÚÃùid
.
cÚÃùiÚ_id
);

1372 
	`£t_b™
(
NVME_FC_Q_CONNECTED
, &
queue
->
æags
);

1375 
out_ä“_bufãr
:

1376 
	`kä“
(
lsÝ
);

1377 
out_no_memÜy
:

1378 ià(
»t
)

1379 
	`dev_”r
(
ù¾
->
dev
,

1381 
queue
->
qnum
, 
»t
);

1382  
»t
;

1383 
	}
}

1386 
	$nvme_fc_discÚÃù_assoc_dÚe
(
nvmefc_ls_»q
 *
l¤eq
, 
¡©us
)

1388 
nvmefc_ls_»q_Ý
 *
lsÝ
 = 
	`ls_»q_to_lsÝ
(
l¤eq
);

1390 
	`__nvme_fc_fšish_ls_»q
(
lsÝ
);

1394 
	`kä“
(
lsÝ
);

1395 
	}
}

1415 
	$nvme_fc_xmt_discÚÃù_assoc
(
nvme_fc_ù¾
 *
ù¾
)

1417 
fúvme_ls_discÚÃù_rq¡
 *
discÚ_rq¡
;

1418 
fúvme_ls_discÚÃù_acc
 *
discÚ_acc
;

1419 
nvmefc_ls_»q_Ý
 *
lsÝ
;

1420 
nvmefc_ls_»q
 *
l¤eq
;

1421 
»t
;

1423 
lsÝ
 = 
	`kz®loc
(((*lsop) +

1424 
ù¾
->
ÍÜt
->
Ýs
->
l¤q¡_´iv_sz
 +

1425 (*
discÚ_rq¡
è+ (*
discÚ_acc
)),

1426 
GFP_KERNEL
);

1427 ià(!
lsÝ
)

1431 
l¤eq
 = &
lsÝ
->
ls_»q
;

1433 
l¤eq
->
´iv©e
 = (*)&
lsÝ
[1];

1434 
discÚ_rq¡
 = (
fúvme_ls_discÚÃù_rq¡
 *)

1435 (
l¤eq
->
´iv©e
 + 
ù¾
->
ÍÜt
->
Ýs
->
l¤q¡_´iv_sz
);

1436 
discÚ_acc
 = (
fúvme_ls_discÚÃù_acc
 *)&
discÚ_rq¡
[1];

1438 
discÚ_rq¡
->
w0
.
ls_cmd
 = 
FCNVME_LS_DISCONNECT
;

1439 
discÚ_rq¡
->
desc_li¡_Ën
 = 
	`ýu_to_be32
(

1440 (
fúvme_lsdesc_assoc_id
) +

1441 (
fúvme_lsdesc_discÚn_cmd
));

1443 
discÚ_rq¡
->
associd
.
desc_g
 = 
	`ýu_to_be32
(
FCNVME_LSDESC_ASSOC_ID
);

1444 
discÚ_rq¡
->
associd
.
desc_Ën
 =

1445 
	`fúvme_lsdesc_Ën
(

1446 (
fúvme_lsdesc_assoc_id
));

1448 
discÚ_rq¡
->
associd
.
assocŸtiÚ_id
 = 
	`ýu_to_be64
(
ù¾
->association_id);

1450 
discÚ_rq¡
->
discÚ_cmd
.
desc_g
 = 
	`ýu_to_be32
(

1451 
FCNVME_LSDESC_DISCONN_CMD
);

1452 
discÚ_rq¡
->
discÚ_cmd
.
desc_Ën
 =

1453 
	`fúvme_lsdesc_Ën
(

1454 (
fúvme_lsdesc_discÚn_cmd
));

1455 
discÚ_rq¡
->
discÚ_cmd
.
scÝe
 = 
FCNVME_DISCONN_ASSOCIATION
;

1456 
discÚ_rq¡
->
discÚ_cmd
.
id
 = 
	`ýu_to_be64
(
ù¾
->
assocŸtiÚ_id
);

1458 
l¤eq
->
rq¡addr
 = 
discÚ_rq¡
;

1459 
l¤eq
->
rq¡Ën
 = (*
discÚ_rq¡
);

1460 
l¤eq
->
r¥addr
 = 
discÚ_acc
;

1461 
l¤eq
->
r¥Ën
 = (*
discÚ_acc
);

1462 
l¤eq
->
timeout
 = 
NVME_FC_CONNECT_TIMEOUT_SEC
;

1464 
»t
 = 
	`nvme_fc_£nd_ls_»q_async
(
ù¾
->
½Üt
, 
lsÝ
,

1465 
nvme_fc_discÚÃù_assoc_dÚe
);

1466 ià(
»t
)

1467 
	`kä“
(
lsÝ
);

1470 
ù¾
->
assocŸtiÚ_id
 = 0;

1471 
	}
}

1476 
nvme_fc_”rÜ_»cov”y
(
nvme_fc_ù¾
 *
ù¾
, *
”rmsg
);

1479 
	$nvme_fc_»š™_»que¡
(*
d©a
, 
»que¡
 *
rq
)

1481 
nvme_fc_fý_Ý
 *
Ý
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1482 
nvme_fc_cmd_iu
 *
cmdiu
 = &
Ý
->
cmd_iu
;

1484 
	`mem£t
(
cmdiu
, 0, (*cmdiu));

1485 
cmdiu
->
scsi_id
 = 
NVME_CMD_SCSI_ID
;

1486 
cmdiu
->
fc_id
 = 
NVME_CMD_FC_ID
;

1487 
cmdiu
->
iu_Ën
 = 
	`ýu_to_be16
((*cmdiuè/ (
u32
));

1488 
	`mem£t
(&
Ý
->
r¥_iu
, 0, (op->rsp_iu));

1491 
	}
}

1494 
	$__nvme_fc_ex™_»que¡
(
nvme_fc_ù¾
 *
ù¾
,

1495 
nvme_fc_fý_Ý
 *
Ý
)

1497 
	`fc_dma_unm­_sšgË
(
ù¾
->
ÍÜt
->
dev
, 
Ý
->
fý_»q
.
r¥dma
,

1498 (
Ý
->
r¥_iu
), 
DMA_FROM_DEVICE
);

1499 
	`fc_dma_unm­_sšgË
(
ù¾
->
ÍÜt
->
dev
, 
Ý
->
fý_»q
.
cmddma
,

1500 (
Ý
->
cmd_iu
), 
DMA_TO_DEVICE
);

1502 
	`©omic_£t
(&
Ý
->
¡©e
, 
FCPOP_STATE_UNINIT
);

1503 
	}
}

1505 #ifdeà
HAVE_BLK_MQ_OPS_EXIT_REQUEST_HAS_3_PARAMS


1507 
	$nvme_fc_ex™_»que¡
(
blk_mq_g_£t
 *
£t
, 
»que¡
 *
rq
,

1508 
hùx_idx
)

1510 
nvme_fc_fý_Ý
 *
Ý
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1512  
	`__nvme_fc_ex™_»que¡
(
£t
->
driv”_d©a
, 
Ý
);

1513 
	}
}

1516 
	$nvme_fc_ex™_»que¡
(*
d©a
, 
»que¡
 *
rq
,

1517 
hùx_idx
, 
rq_idx
)

1519 
nvme_fc_fý_Ý
 *
Ý
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1521 
	`__nvme_fc_ex™_»que¡
(
d©a
, 
Ý
);

1522 
	}
}

1526 
	$__nvme_fc_abÜt_Ý
(
nvme_fc_ù¾
 *
ù¾
, 
nvme_fc_fý_Ý
 *
Ý
)

1528 
æags
;

1529 
Ý¡©e
;

1531 
	`¥š_lock_œq§ve
(&
ù¾
->
lock
, 
æags
);

1532 
Ý¡©e
 = 
	`©omic_xchg
(&
Ý
->
¡©e
, 
FCPOP_STATE_ABORTED
);

1533 ià(
Ý¡©e
 !ð
FCPOP_STATE_ACTIVE
)

1534 
	`©omic_£t
(&
Ý
->
¡©e
, 
Ý¡©e
);

1535 ià(
ù¾
->
æags
 & 
FCCTRL_TERMIO
)

1536 
ù¾
->
ioút
++;

1537 
	`¥š_uÆock_œq»¡Üe
(&
ù¾
->
lock
, 
æags
);

1539 ià(
Ý¡©e
 !ð
FCPOP_STATE_ACTIVE
)

1540  -
ECANCELED
;

1542 
ù¾
->
ÍÜt
->
Ýs
->
	`fý_abÜt
(&ù¾->ÍÜt->
loÿÍÜt
,

1543 &
ù¾
->
½Üt
->
»mÙ•Üt
,

1544 
Ý
->
queue
->
Îdd_hªdË
,

1545 &
Ý
->
fý_»q
);

1548 
	}
}

1551 
	$nvme_fc_abÜt_«n_Ýs
(
nvme_fc_ù¾
 *
ù¾
)

1553 
nvme_fc_fý_Ý
 *
«n_Ý
 = 
ù¾
->
«n_Ýs
;

1554 
i
;

1556 
i
 = 0; i < 
NVME_NR_AEN_COMMANDS
; i++, 
«n_Ý
++)

1557 
	`__nvme_fc_abÜt_Ý
(
ù¾
, 
«n_Ý
);

1558 
	}
}

1560 
šlše
 

1561 
	$__nvme_fc_fýÝ_chk_‹¬downs
(
nvme_fc_ù¾
 *
ù¾
,

1562 
nvme_fc_fý_Ý
 *
Ý
, 
Ý¡©e
)

1564 
æags
;

1566 ià(
Ý¡©e
 =ð
FCPOP_STATE_ABORTED
) {

1567 
	`¥š_lock_œq§ve
(&
ù¾
->
lock
, 
æags
);

1568 ià(
ù¾
->
æags
 & 
FCCTRL_TERMIO
) {

1569 ià(!--
ù¾
->
ioút
)

1570 
	`wake_up
(&
ù¾
->
ißbÜt_wa™
);

1572 
	`¥š_uÆock_œq»¡Üe
(&
ù¾
->
lock
, 
æags
);

1574 
	}
}

1577 
	$nvme_fc_fýio_dÚe
(
nvmefc_fý_»q
 *
»q
)

1579 
nvme_fc_fý_Ý
 *
Ý
 = 
	`fý_»q_to_fý_Ý
(
»q
);

1580 
»que¡
 *
rq
 = 
Ý
->rq;

1581 
nvmefc_fý_»q
 *
äeq
 = &
Ý
->
fý_»q
;

1582 
nvme_fc_ù¾
 *
ù¾
 = 
Ý
->ctrl;

1583 
nvme_fc_queue
 *
queue
 = 
Ý
->queue;

1584 
nvme_com¶‘iÚ
 *
cqe
 = &
Ý
->
r¥_iu
.cqe;

1585 
nvme_commªd
 *
sqe
 = &
Ý
->
cmd_iu
.sqe;

1586 
__Ë16
 
¡©us
 = 
	`ýu_to_Ë16
(
NVME_SC_SUCCESS
 << 1);

1587 
nvme_»suÉ
 
»suÉ
;

1588 
boÞ
 
‹rmš©e_assoc
 = 
Œue
;

1589 
Ý¡©e
;

1628 
Ý¡©e
 = 
	`©omic_xchg
(&
Ý
->
¡©e
, 
FCPOP_STATE_COMPLETE
);

1630 
	`fc_dma_sync_sšgË_fÜ_ýu
(
ù¾
->
ÍÜt
->
dev
, 
Ý
->
fý_»q
.
r¥dma
,

1631 (
Ý
->
r¥_iu
), 
DMA_FROM_DEVICE
);

1633 ià(
Ý¡©e
 =ð
FCPOP_STATE_ABORTED
)

1634 
¡©us
 = 
	`ýu_to_Ë16
(
NVME_SC_ABORT_REQ
 << 1);

1635 ià(
äeq
->
¡©us
)

1636 
¡©us
 = 
	`ýu_to_Ë16
(
NVME_SC_INTERNAL
 << 1);

1643 ià(
¡©us
)

1644 
dÚe
;

1653 
äeq
->
rcv_r¥Ën
) {

1656 
NVME_FC_SIZEOF_ZEROS_RSP
:

1662 ià(
äeq
->
Œªsã¼ed_Ëngth
 !=

1663 
	`be32_to_ýu
(
Ý
->
cmd_iu
.
d©a_Ën
)) {

1664 
¡©us
 = 
	`ýu_to_Ë16
(
NVME_SC_INTERNAL
 << 1);

1665 
dÚe
;

1667 
»suÉ
.
u64
 = 0;

1670 (
nvme_fc_”¥_iu
):

1675 ià(
	`uÆik–y
(
	`be16_to_ýu
(
Ý
->
r¥_iu
.
iu_Ën
) !=

1676 (
äeq
->
rcv_r¥Ën
 / 4) ||

1677 
	`be32_to_ýu
(
Ý
->
r¥_iu
.
xäd_Ën
) !=

1678 
äeq
->
Œªsã¼ed_Ëngth
 ||

1679 
Ý
->
r¥_iu
.
¡©us_code
 ||

1680 
sqe
->
commÚ
.
commªd_id
 !ð
cqe
->command_id)) {

1681 
¡©us
 = 
	`ýu_to_Ë16
(
NVME_SC_INTERNAL
 << 1);

1682 
dÚe
;

1684 
»suÉ
 = 
cqe
->result;

1685 
¡©us
 = 
cqe
->status;

1689 
¡©us
 = 
	`ýu_to_Ë16
(
NVME_SC_INTERNAL
 << 1);

1690 
dÚe
;

1693 
‹rmš©e_assoc
 = 
çl£
;

1695 
dÚe
:

1696 ià(
Ý
->
æags
 & 
FCOP_FLAGS_AEN
) {

1697 
	`nvme_com¶‘e_async_ev’t
(&
queue
->
ù¾
->ù¾, 
¡©us
, &
»suÉ
);

1698 
	`__nvme_fc_fýÝ_chk_‹¬downs
(
ù¾
, 
Ý
, 
Ý¡©e
);

1699 
	`©omic_£t
(&
Ý
->
¡©e
, 
FCPOP_STATE_IDLE
);

1700 
Ý
->
æags
 = 
FCOP_FLAGS_AEN
;

1701 
	`nvme_fc_ù¾_put
(
ù¾
);

1702 
check_”rÜ
;

1705 
	`__nvme_fc_fýÝ_chk_‹¬downs
(
ù¾
, 
Ý
, 
Ý¡©e
);

1706 
	`nvme_’d_»que¡
(
rq
, 
¡©us
, 
»suÉ
);

1708 
check_”rÜ
:

1709 ià(
‹rmš©e_assoc
)

1710 
	`nvme_fc_”rÜ_»cov”y
(
ù¾
, "transport detected ioƒrror");

1711 
	}
}

1714 
	$__nvme_fc_š™_»que¡
(
nvme_fc_ù¾
 *
ù¾
,

1715 
nvme_fc_queue
 *
queue
, 
nvme_fc_fý_Ý
 *
Ý
,

1716 
»que¡
 *
rq
, 
u32
 
rqno
)

1718 
nvme_fc_cmd_iu
 *
cmdiu
 = &
Ý
->
cmd_iu
;

1719 
»t
 = 0;

1721 
	`mem£t
(
Ý
, 0, (*op));

1722 
Ý
->
fý_»q
.
cmdaddr
 = &Ý->
cmd_iu
;

1723 
Ý
->
fý_»q
.
cmdËn
 = (Ý->
cmd_iu
);

1724 
Ý
->
fý_»q
.
r¥addr
 = &Ý->
r¥_iu
;

1725 
Ý
->
fý_»q
.
r¥Ën
 = (Ý->
r¥_iu
);

1726 
Ý
->
fý_»q
.
dÚe
 = 
nvme_fc_fýio_dÚe
;

1727 
Ý
->
fý_»q
.
fœ¡_sgl
 = (
sÿ‰”li¡
 *)&op[1];

1728 
Ý
->
fý_»q
.
´iv©e
 = &Ý->fý_»q.
fœ¡_sgl
[
SG_CHUNK_SIZE
];

1729 
Ý
->
ù¾
 = ctrl;

1730 
Ý
->
queue
 = queue;

1731 
Ý
->
rq
 =„q;

1732 
Ý
->
rqno
 =„qno;

1734 
cmdiu
->
scsi_id
 = 
NVME_CMD_SCSI_ID
;

1735 
cmdiu
->
fc_id
 = 
NVME_CMD_FC_ID
;

1736 
cmdiu
->
iu_Ën
 = 
	`ýu_to_be16
((*cmdiuè/ (
u32
));

1738 
Ý
->
fý_»q
.
cmddma
 = 
	`fc_dma_m­_sšgË
(
ù¾
->
ÍÜt
->
dev
,

1739 &
Ý
->
cmd_iu
, (Ý->cmd_iu), 
DMA_TO_DEVICE
);

1740 ià(
	`fc_dma_m­pšg_”rÜ
(
ù¾
->
ÍÜt
->
dev
, 
Ý
->
fý_»q
.
cmddma
)) {

1741 
	`dev_”r
(
ù¾
->
dev
,

1743 
»t
 = 
EFAULT
;

1744 
out_Ú_”rÜ
;

1747 
Ý
->
fý_»q
.
r¥dma
 = 
	`fc_dma_m­_sšgË
(
ù¾
->
ÍÜt
->
dev
,

1748 &
Ý
->
r¥_iu
, (op->rsp_iu),

1749 
DMA_FROM_DEVICE
);

1750 ià(
	`fc_dma_m­pšg_”rÜ
(
ù¾
->
ÍÜt
->
dev
, 
Ý
->
fý_»q
.
r¥dma
)) {

1751 
	`dev_”r
(
ù¾
->
dev
,

1753 
»t
 = 
EFAULT
;

1756 
	`©omic_£t
(&
Ý
->
¡©e
, 
FCPOP_STATE_IDLE
);

1757 
out_Ú_”rÜ
:

1758  
»t
;

1759 
	}
}

1761 #ifdeà
HAVE_BLK_MQ_OPS_INIT_REQUEST_HAS_4_PARAMS


1763 
	$nvme_fc_š™_»que¡
(
blk_mq_g_£t
 *
£t
, 
»que¡
 *
rq
,

1764 
hùx_idx
, 
numa_node
)

1766 
nvme_fc_ù¾
 *
ù¾
 = 
£t
->
driv”_d©a
;

1767 
nvme_fc_fý_Ý
 *
Ý
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1768 
queue_idx
 = (
£t
 =ð&
ù¾
->
g_£t
è? 
hùx_idx
 + 1 : 0;

1769 
nvme_fc_queue
 *
queue
 = &
ù¾
->
queues
[
queue_idx
];

1771  
	`__nvme_fc_š™_»que¡
(
ù¾
, 
queue
, 
Ý
, 
rq
, queue->
rqút
++);

1772 
	}
}

1775 
	$nvme_fc_š™_»que¡
(*
d©a
, 
»que¡
 *
rq
,

1776 
hùx_idx
, 
rq_idx
,

1777 
numa_node
)

1779 
nvme_fc_ù¾
 *
ù¾
 = 
d©a
;

1780 
nvme_fc_fý_Ý
 *
Ý
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1781 
nvme_fc_queue
 *
queue
 = &
ù¾
->
queues
[
hùx_idx
+1];

1783  
	`__nvme_fc_š™_»que¡
(
ù¾
, 
queue
, 
Ý
, 
rq
, queue->
rqút
++);

1784 
	}
}

1787 
	$nvme_fc_š™_admš_»que¡
(*
d©a
, 
»que¡
 *
rq
,

1788 
hùx_idx
, 
rq_idx
,

1789 
numa_node
)

1791 
nvme_fc_ù¾
 *
ù¾
 = 
d©a
;

1792 
nvme_fc_fý_Ý
 *
Ý
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1793 
nvme_fc_queue
 *
queue
 = &
ù¾
->
queues
[0];

1795  
	`__nvme_fc_š™_»que¡
(
ù¾
, 
queue
, 
Ý
, 
rq
, queue->
rqút
++);

1796 
	}
}

1800 
	$nvme_fc_š™_«n_Ýs
(
nvme_fc_ù¾
 *
ù¾
)

1802 
nvme_fc_fý_Ý
 *
«n_Ý
;

1803 
nvme_fc_cmd_iu
 *
cmdiu
;

1804 
nvme_commªd
 *
sqe
;

1805 *
´iv©e
;

1806 
i
, 
»t
;

1808 
«n_Ý
 = 
ù¾
->
«n_Ýs
;

1809 
i
 = 0; i < 
NVME_NR_AEN_COMMANDS
; i++, 
«n_Ý
++) {

1810 
´iv©e
 = 
	`kz®loc
(
ù¾
->
ÍÜt
->
Ýs
->
fýrq¡_´iv_sz
,

1811 
GFP_KERNEL
);

1812 ià(!
´iv©e
)

1813  -
ENOMEM
;

1815 
cmdiu
 = &
«n_Ý
->
cmd_iu
;

1816 
sqe
 = &
cmdiu
->sqe;

1817 
»t
 = 
	`__nvme_fc_š™_»que¡
(
ù¾
, &ù¾->
queues
[0],

1818 
«n_Ý
, (
»que¡
 *)
NULL
,

1819 (
NVME_AQ_BLK_MQ_DEPTH
 + 
i
));

1820 ià(
»t
) {

1821 
	`kä“
(
´iv©e
);

1822  
»t
;

1825 
«n_Ý
->
æags
 = 
FCOP_FLAGS_AEN
;

1826 
«n_Ý
->
fý_»q
.
fœ¡_sgl
 = 
NULL
;

1827 
«n_Ý
->
fý_»q
.
´iv©e
 =…rivate;

1829 
	`mem£t
(
sqe
, 0, (*sqe));

1830 
sqe
->
commÚ
.
Ýcode
 = 
nvme_admš_async_ev’t
;

1832 
sqe
->
commÚ
.
commªd_id
 = 
NVME_AQ_BLK_MQ_DEPTH
 + 
i
;

1835 
	}
}

1838 
	$nvme_fc_‹rm_«n_Ýs
(
nvme_fc_ù¾
 *
ù¾
)

1840 
nvme_fc_fý_Ý
 *
«n_Ý
;

1841 
i
;

1843 
«n_Ý
 = 
ù¾
->
«n_Ýs
;

1844 
i
 = 0; i < 
NVME_NR_AEN_COMMANDS
; i++, 
«n_Ý
++) {

1845 ià(!
«n_Ý
->
fý_»q
.
´iv©e
)

1848 
	`__nvme_fc_ex™_»que¡
(
ù¾
, 
«n_Ý
);

1850 
	`kä“
(
«n_Ý
->
fý_»q
.
´iv©e
);

1851 
«n_Ý
->
fý_»q
.
´iv©e
 = 
NULL
;

1853 
	}
}

1855 
šlše
 

1856 
	$__nvme_fc_š™_hùx
(
blk_mq_hw_ùx
 *
hùx
, 
nvme_fc_ù¾
 *
ù¾
,

1857 
qidx
)

1859 
nvme_fc_queue
 *
queue
 = &
ù¾
->
queues
[
qidx
];

1861 
hùx
->
driv”_d©a
 = 
queue
;

1862 
queue
->
hùx
 = hctx;

1863 
	}
}

1866 
	$nvme_fc_š™_hùx
(
blk_mq_hw_ùx
 *
hùx
, *
d©a
,

1867 
hùx_idx
)

1869 
nvme_fc_ù¾
 *
ù¾
 = 
d©a
;

1871 
	`__nvme_fc_š™_hùx
(
hùx
, 
ù¾
, 
hùx_idx
 + 1);

1874 
	}
}

1877 
	$nvme_fc_š™_admš_hùx
(
blk_mq_hw_ùx
 *
hùx
, *
d©a
,

1878 
hùx_idx
)

1880 
nvme_fc_ù¾
 *
ù¾
 = 
d©a
;

1882 
	`__nvme_fc_š™_hùx
(
hùx
, 
ù¾
, 
hùx_idx
);

1885 
	}
}

1888 
	$nvme_fc_š™_queue
(
nvme_fc_ù¾
 *
ù¾
, 
idx
)

1890 
nvme_fc_queue
 *
queue
;

1892 
queue
 = &
ù¾
->
queues
[
idx
];

1893 
	`mem£t
(
queue
, 0, (*queue));

1894 
queue
->
ù¾
 = ctrl;

1895 
queue
->
qnum
 = 
idx
;

1896 
	`©omic_£t
(&
queue
->
c¢
, 1);

1897 
queue
->
dev
 = 
ù¾
->dev;

1899 ià(
idx
 > 0)

1900 
queue
->
cmnd_ÿpsuË_Ën
 = 
ù¾
->ù¾.
ioccsz
 * 16;

1902 
queue
->
cmnd_ÿpsuË_Ën
 = (
nvme_commªd
);

1914 
	}
}

1925 
	$nvme_fc_ä“_queue
(
nvme_fc_queue
 *
queue
)

1927 ià(!
	`‹¡_ªd_þ—r_b™
(
NVME_FC_Q_CONNECTED
, &
queue
->
æags
))

1930 
	`þ—r_b™
(
NVME_FC_Q_LIVE
, &
queue
->
æags
);

1937 
queue
->
cÚÃùiÚ_id
 = 0;

1938 
	}
}

1941 
	$__nvme_fc_d–‘e_hw_queue
(
nvme_fc_ù¾
 *
ù¾
,

1942 
nvme_fc_queue
 *
queue
, 
qidx
)

1944 ià(
ù¾
->
ÍÜt
->
Ýs
->
d–‘e_queue
)

1945 
ù¾
->
ÍÜt
->
Ýs
->
	`d–‘e_queue
(&ù¾->ÍÜt->
loÿÍÜt
, 
qidx
,

1946 
queue
->
Îdd_hªdË
);

1947 
queue
->
Îdd_hªdË
 = 
NULL
;

1948 
	}
}

1951 
	$nvme_fc_ä“_io_queues
(
nvme_fc_ù¾
 *
ù¾
)

1953 
i
;

1955 
i
 = 1; i < 
ù¾
->ù¾.
queue_couÁ
; i++)

1956 
	`nvme_fc_ä“_queue
(&
ù¾
->
queues
[
i
]);

1957 
	}
}

1960 
	$__nvme_fc_ü—‹_hw_queue
(
nvme_fc_ù¾
 *
ù¾
,

1961 
nvme_fc_queue
 *
queue
, 
qidx
, 
u16
 
qsize
)

1963 
»t
 = 0;

1965 
queue
->
Îdd_hªdË
 = 
NULL
;

1966 ià(
ù¾
->
ÍÜt
->
Ýs
->
ü—‹_queue
)

1967 
»t
 = 
ù¾
->
ÍÜt
->
Ýs
->
	`ü—‹_queue
(&ù¾->ÍÜt->
loÿÍÜt
,

1968 
qidx
, 
qsize
, &
queue
->
Îdd_hªdË
);

1970  
»t
;

1971 
	}
}

1974 
	$nvme_fc_d–‘e_hw_io_queues
(
nvme_fc_ù¾
 *
ù¾
)

1976 
nvme_fc_queue
 *
queue
 = &
ù¾
->
queues
[ù¾->ù¾.
queue_couÁ
 - 1];

1977 
i
;

1979 
i
 = 
ù¾
->ù¾.
queue_couÁ
 - 1; i >ð1; i--, 
queue
--)

1980 
	`__nvme_fc_d–‘e_hw_queue
(
ù¾
, 
queue
, 
i
);

1981 
	}
}

1984 
	$nvme_fc_ü—‹_hw_io_queues
(
nvme_fc_ù¾
 *
ù¾
, 
u16
 
qsize
)

1986 
nvme_fc_queue
 *
queue
 = &
ù¾
->
queues
[1];

1987 
i
, 
»t
;

1989 
i
 = 1; i < 
ù¾
->ù¾.
queue_couÁ
; i++, 
queue
++) {

1990 
»t
 = 
	`__nvme_fc_ü—‹_hw_queue
(
ù¾
, 
queue
, 
i
, 
qsize
);

1991 ià(
»t
)

1992 
d–‘e_queues
;

1997 
d–‘e_queues
:

1998 ; 
i
 >= 0; i--)

1999 
	`__nvme_fc_d–‘e_hw_queue
(
ù¾
, &ù¾->
queues
[
i
], i);

2000  
»t
;

2001 
	}
}

2004 
	$nvme_fc_cÚÃù_io_queues
(
nvme_fc_ù¾
 *
ù¾
, 
u16
 
qsize
)

2006 
i
, 
»t
 = 0;

2008 
i
 = 1; i < 
ù¾
->ù¾.
queue_couÁ
; i++) {

2009 
»t
 = 
	`nvme_fc_cÚÃù_queue
(
ù¾
, &ù¾->
queues
[
i
], 
qsize
,

2010 (
qsize
 / 5));

2011 ià(
»t
)

2013 
»t
 = 
	`nvmf_cÚÃù_io_queue
(&
ù¾
->ù¾, 
i
);

2014 ià(
»t
)

2017 
	`£t_b™
(
NVME_FC_Q_LIVE
, &
ù¾
->
queues
[
i
].
æags
);

2020  
»t
;

2021 
	}
}

2024 
	$nvme_fc_š™_io_queues
(
nvme_fc_ù¾
 *
ù¾
)

2026 
i
;

2028 
i
 = 1; i < 
ù¾
->ù¾.
queue_couÁ
; i++)

2029 
	`nvme_fc_š™_queue
(
ù¾
, 
i
);

2030 
	}
}

2033 
	$nvme_fc_ù¾_ä“
(
k»f
 *
»f
)

2035 
nvme_fc_ù¾
 *
ù¾
 =

2036 
	`cÚš”_of
(
»f
, 
nvme_fc_ù¾
,„ef);

2037 
æags
;

2039 ià(
ù¾
->ù¾.
g£t
) {

2040 
	`blk_þ—nup_queue
(
ù¾
->ù¾.
cÚÃù_q
);

2041 
	`blk_mq_ä“_g_£t
(&
ù¾
->
g_£t
);

2045 
	`¥š_lock_œq§ve
(&
ù¾
->
½Üt
->
lock
, 
æags
);

2046 
	`li¡_d–
(&
ù¾
->
ù¾_li¡
);

2047 
	`¥š_uÆock_œq»¡Üe
(&
ù¾
->
½Üt
->
lock
, 
æags
);

2049 #ifdeà
HAVE_BLK_MQ_UNQUIESCE_QUEUE


2050 
	`blk_mq_unqu›sû_queue
(
ù¾
->ù¾.
admš_q
);

2052 
	`blk_mq_¡¬t_¡Ý³d_hw_queues
(
ù¾
->ù¾.
admš_q
, 
Œue
);

2054 
	`blk_þ—nup_queue
(
ù¾
->ù¾.
admš_q
);

2055 
	`blk_mq_ä“_g_£t
(&
ù¾
->
admš_g_£t
);

2057 
	`kä“
(
ù¾
->
queues
);

2059 
	`put_deviû
(
ù¾
->
dev
);

2060 
	`nvme_fc_½Üt_put
(
ù¾
->
½Üt
);

2062 
	`ida_sim¶e_»move
(&
nvme_fc_ù¾_út
, 
ù¾
->
úum
);

2063 ià(
ù¾
->ù¾.
Ýts
)

2064 
	`nvmf_ä“_ÝtiÚs
(
ù¾
->ù¾.
Ýts
);

2065 
	`kä“
(
ù¾
);

2066 
	}
}

2069 
	$nvme_fc_ù¾_put
(
nvme_fc_ù¾
 *
ù¾
)

2071 
	`k»f_put
(&
ù¾
->
»f
, 
nvme_fc_ù¾_ä“
);

2072 
	}
}

2075 
	$nvme_fc_ù¾_g‘
(
nvme_fc_ù¾
 *
ù¾
)

2077  
	`k»f_g‘_uÆess_z”o
(&
ù¾
->
»f
);

2078 
	}
}

2085 
	$nvme_fc_nvme_ù¾_ä“d
(
nvme_ù¾
 *
nù¾
)

2087 
nvme_fc_ù¾
 *
ù¾
 = 
	`to_fc_ù¾
(
nù¾
);

2089 
	`WARN_ON
(
nù¾
 !ð&
ù¾
->ctrl);

2091 
	`nvme_fc_ù¾_put
(
ù¾
);

2092 
	}
}

2095 
	$nvme_fc_”rÜ_»cov”y
(
nvme_fc_ù¾
 *
ù¾
, *
”rmsg
)

2098 ià(
ù¾
->ù¾.
¡©e
 !ð
NVME_CTRL_LIVE
)

2101 
	`dev_w¬n
(
ù¾
->ù¾.
deviû
,

2103 
ù¾
->
úum
, 
”rmsg
);

2104 
	`dev_w¬n
(
ù¾
->ù¾.
deviû
,

2105 "NVME-FC{%d}:„e£‰šg cÚŒÞËr\n", 
ù¾
->
úum
);

2107 
	`nvme_»£t_ù¾
(&
ù¾
->ctrl);

2108 
	}
}

2110 
blk_eh_tim”_»tuº


2111 
	$nvme_fc_timeout
(
»que¡
 *
rq
, 
boÞ
 
»£rved
)

2113 
nvme_fc_fý_Ý
 *
Ý
 = 
	`blk_mq_rq_to_pdu
(
rq
);

2114 
nvme_fc_ù¾
 *
ù¾
 = 
Ý
->ctrl;

2123 
	`nvme_fc_”rÜ_»cov”y
(
ù¾
, "ioimeoutƒrror");

2130  
BLK_EH_RESET_TIMER
;

2131 
	}
}

2134 
	$nvme_fc_m­_d©a
(
nvme_fc_ù¾
 *
ù¾
, 
»que¡
 *
rq
,

2135 
nvme_fc_fý_Ý
 *
Ý
)

2137 
nvmefc_fý_»q
 *
äeq
 = &
Ý
->
fý_»q
;

2138 
dma_d©a_dœeùiÚ
 
dœ
;

2139 
»t
;

2141 
äeq
->
sg_út
 = 0;

2143 #ifdeà
HAVE_BLK_RQ_NR_PAYLOAD_BYTES


2144 ià(!
	`blk_rq_·ylßd_by‹s
(
rq
))

2147 ià(!
	`nvme_m­_Ën
(
rq
))

2151 
äeq
->
sg_bË
.
sgl
 = f»q->
fœ¡_sgl
;

2152 #ifdeà
HAVE_SG_ALLOC_TABLE_CHAINED_4_PARAMS


2153 
»t
 = 
	`sg_®loc_bË_chašed
(&
äeq
->
sg_bË
,

2154 
	`blk_rq_Ä_phys_£gm’ts
(
rq
),

2155 
GFP_ATOMIC
,

2156 
äeq
->
sg_bË
.
sgl
);

2158 
»t
 = 
	`sg_®loc_bË_chašed
(&
äeq
->
sg_bË
,

2159 
	`blk_rq_Ä_phys_£gm’ts
(
rq
), 
äeq
->
sg_bË
.
sgl
);

2161 ià(
»t
)

2162  -
ENOMEM
;

2164 
Ý
->
ÃÁs
 = 
	`blk_rq_m­_sg
(
rq
->
q
,„q, 
äeq
->
sg_bË
.
sgl
);

2165 
	`WARN_ON
(
Ý
->
ÃÁs
 > 
	`blk_rq_Ä_phys_£gm’ts
(
rq
));

2166 
dœ
 = (
	`rq_d©a_dœ
(
rq
è=ð
WRITE
è? 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
;

2167 
äeq
->
sg_út
 = 
	`fc_dma_m­_sg
(
ù¾
->
ÍÜt
->
dev
, f»q->
sg_bË
.
sgl
,

2168 
Ý
->
ÃÁs
, 
dœ
);

2169 ià(
	`uÆik–y
(
äeq
->
sg_út
 <= 0)) {

2170 
	`sg_ä“_bË_chašed
(&
äeq
->
sg_bË
, 
Œue
);

2171 
äeq
->
sg_út
 = 0;

2172  -
EFAULT
;

2179 
	}
}

2182 
	$nvme_fc_unm­_d©a
(
nvme_fc_ù¾
 *
ù¾
, 
»que¡
 *
rq
,

2183 
nvme_fc_fý_Ý
 *
Ý
)

2185 
nvmefc_fý_»q
 *
äeq
 = &
Ý
->
fý_»q
;

2187 ià(!
äeq
->
sg_út
)

2190 
	`fc_dma_unm­_sg
(
ù¾
->
ÍÜt
->
dev
, 
äeq
->
sg_bË
.
sgl
, 
Ý
->
ÃÁs
,

2191 ((
	`rq_d©a_dœ
(
rq
è=ð
WRITE
) ?

2192 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
));

2194 
	`nvme_þ—nup_cmd
(
rq
);

2196 
	`sg_ä“_bË_chašed
(&
äeq
->
sg_bË
, 
Œue
);

2198 
äeq
->
sg_út
 = 0;

2199 
	}
}

2224 
blk_¡©us_t


2225 
	$nvme_fc_¡¬t_fý_Ý
(
nvme_fc_ù¾
 *
ù¾
, 
nvme_fc_queue
 *
queue
,

2226 
nvme_fc_fý_Ý
 *
Ý
, 
u32
 
d©a_Ën
,

2227 
nvmefc_fý_d©adœ
 
io_dœ
)

2229 
nvme_fc_cmd_iu
 *
cmdiu
 = &
Ý
->
cmd_iu
;

2230 
nvme_commªd
 *
sqe
 = &
cmdiu
->sqe;

2231 
u32
 
c¢
;

2232 
»t
, 
Ý¡©e
;

2238 ià(
ù¾
->
½Üt
->
»mÙ•Üt
.
pÜt_¡©e
 !ð
FC_OBJSTATE_ONLINE
)

2239  
BLK_STS_RESOURCE
;

2241 ià(!
	`nvme_fc_ù¾_g‘
(
ù¾
))

2242  
BLK_STS_IOERR
;

2245 
cmdiu
->
cÚÃùiÚ_id
 = 
	`ýu_to_be64
(
queue
->connection_id);

2246 
c¢
 = 
	`©omic_šc_»tuº
(&
queue
->csn);

2247 
cmdiu
->
c¢
 = 
	`ýu_to_be32
(csn);

2248 
cmdiu
->
d©a_Ën
 = 
	`ýu_to_be32
(data_len);

2249 
io_dœ
) {

2250 
NVMEFC_FCP_WRITE
:

2251 
cmdiu
->
æags
 = 
FCNVME_CMD_FLAGS_WRITE
;

2253 
NVMEFC_FCP_READ
:

2254 
cmdiu
->
æags
 = 
FCNVME_CMD_FLAGS_READ
;

2256 
NVMEFC_FCP_NODATA
:

2257 
cmdiu
->
æags
 = 0;

2260 
Ý
->
fý_»q
.
·ylßd_Ëngth
 = 
d©a_Ën
;

2261 
Ý
->
fý_»q
.
io_dœ
 = io_dir;

2262 
Ý
->
fý_»q
.
Œªsã¼ed_Ëngth
 = 0;

2263 
Ý
->
fý_»q
.
rcv_r¥Ën
 = 0;

2264 
Ý
->
fý_»q
.
¡©us
 = 
NVME_SC_SUCCESS
;

2265 
Ý
->
fý_»q
.
sqid
 = 
	`ýu_to_Ë16
(
queue
->
qnum
);

2271 
	`WARN_ON_ONCE
(
sqe
->
commÚ
.
m‘ad©a
);

2272 
sqe
->
commÚ
.
æags
 |ð
NVME_CMD_SGL_METABUF
;

2281 
sqe
->
rw
.
d±r
.
sgl
.
ty³
 = (
NVME_TRANSPORT_SGL_DATA_DESC
 << 4) |

2282 
NVME_SGL_FMT_TRANSPORT_A
;

2283 
sqe
->
rw
.
d±r
.
sgl
.
Ëngth
 = 
	`ýu_to_Ë32
(
d©a_Ën
);

2284 
sqe
->
rw
.
d±r
.
sgl
.
addr
 = 0;

2286 ià(!(
Ý
->
æags
 & 
FCOP_FLAGS_AEN
)) {

2287 
»t
 = 
	`nvme_fc_m­_d©a
(
ù¾
, 
Ý
->
rq
, op);

2288 ià(
»t
 < 0) {

2289 
	`nvme_þ—nup_cmd
(
Ý
->
rq
);

2290 
	`nvme_fc_ù¾_put
(
ù¾
);

2291 ià(
»t
 =ð-
ENOMEM
 ||„‘ =ð-
EAGAIN
)

2292  
BLK_STS_RESOURCE
;

2293  
BLK_STS_IOERR
;

2297 
	`fc_dma_sync_sšgË_fÜ_deviû
(
ù¾
->
ÍÜt
->
dev
, 
Ý
->
fý_»q
.
cmddma
,

2298 (
Ý
->
cmd_iu
), 
DMA_TO_DEVICE
);

2300 
	`©omic_£t
(&
Ý
->
¡©e
, 
FCPOP_STATE_ACTIVE
);

2302 ià(!(
Ý
->
æags
 & 
FCOP_FLAGS_AEN
))

2303 
	`blk_mq_¡¬t_»que¡
(
Ý
->
rq
);

2305 
»t
 = 
ù¾
->
ÍÜt
->
Ýs
->
	`fý_io
(&ù¾->ÍÜt->
loÿÍÜt
,

2306 &
ù¾
->
½Üt
->
»mÙ•Üt
,

2307 
queue
->
Îdd_hªdË
, &
Ý
->
fý_»q
);

2309 ià(
»t
) {

2310 
Ý¡©e
 = 
	`©omic_xchg
(&
Ý
->
¡©e
, 
FCPOP_STATE_COMPLETE
);

2311 
	`__nvme_fc_fýÝ_chk_‹¬downs
(
ù¾
, 
Ý
, 
Ý¡©e
);

2313 ià(!(
Ý
->
æags
 & 
FCOP_FLAGS_AEN
))

2314 
	`nvme_fc_unm­_d©a
(
ù¾
, 
Ý
->
rq
, op);

2316 
	`nvme_fc_ù¾_put
(
ù¾
);

2318 ià(
ù¾
->
½Üt
->
»mÙ•Üt
.
pÜt_¡©e
 =ð
FC_OBJSTATE_ONLINE
 &&

2319 
»t
 !ð-
EBUSY
)

2320  
BLK_STS_IOERR
;

2322  
BLK_STS_RESOURCE
;

2325  
BLK_STS_OK
;

2326 
	}
}

2328 
blk_¡©us_t


2329 
	$nvme_fc_queue_rq
(
blk_mq_hw_ùx
 *
hùx
,

2330 cÚ¡ 
blk_mq_queue_d©a
 *
bd
)

2332 
nvme_ns
 *
ns
 = 
hùx
->
queue
->
queued©a
;

2333 
nvme_fc_queue
 *
queue
 = 
hùx
->
driv”_d©a
;

2334 
nvme_fc_ù¾
 *
ù¾
 = 
queue
->ctrl;

2335 
»que¡
 *
rq
 = 
bd
->rq;

2336 
nvme_fc_fý_Ý
 *
Ý
 = 
	`blk_mq_rq_to_pdu
(
rq
);

2337 
nvme_fc_cmd_iu
 *
cmdiu
 = &
Ý
->
cmd_iu
;

2338 
nvme_commªd
 *
sqe
 = &
cmdiu
->sqe;

2339 
nvmefc_fý_d©adœ
 
io_dœ
;

2340 
u32
 
d©a_Ën
;

2341 
blk_¡©us_t
 
»t
;

2343 
»t
 = 
	`nvmf_check_if_»ady
(&
queue
->
ù¾
->ù¾, 
rq
,

2344 
	`‹¡_b™
(
NVME_FC_Q_LIVE
, &
queue
->
æags
),

2345 
ù¾
->
½Üt
->
»mÙ•Üt
.
pÜt_¡©e
 =ð
FC_OBJSTATE_ONLINE
);

2346 ià(
	`uÆik–y
(
»t
))

2347  
»t
;

2349 
»t
 = 
	`nvme_£tup_cmd
(
ns
, 
rq
, 
sqe
);

2350 ià(
»t
)

2351  
»t
;

2353 #ifdeà
HAVE_BLK_RQ_NR_PAYLOAD_BYTES


2354 
d©a_Ën
 = 
	`blk_rq_·ylßd_by‹s
(
rq
);

2356 
d©a_Ën
 = 
	`nvme_m­_Ën
(
rq
);

2358 ià(
d©a_Ën
)

2359 
io_dœ
 = ((
	`rq_d©a_dœ
(
rq
è=ð
WRITE
) ?

2360 
NVMEFC_FCP_WRITE
 : 
NVMEFC_FCP_READ
);

2362 
io_dœ
 = 
NVMEFC_FCP_NODATA
;

2364  
	`nvme_fc_¡¬t_fý_Ý
(
ù¾
, 
queue
, 
Ý
, 
d©a_Ën
, 
io_dœ
);

2365 
	}
}

2367 #ifdeà
HAVE_BLK_MQ_POLL


2368 
blk_mq_gs
 *

2369 
	$nvme_fc_g£t
(
nvme_fc_queue
 *
queue
)

2371 ià(
queue
->
qnum
 == 0)

2372  
queue
->
ù¾
->
admš_g_£t
.
gs
[queue->
qnum
];

2374  
queue
->
ù¾
->
g_£t
.
gs
[queue->
qnum
 - 1];

2375 
	}
}

2378 
	$nvme_fc_pÞl
(
blk_mq_hw_ùx
 *
hùx
, 
g
)

2381 
nvme_fc_queue
 *
queue
 = 
hùx
->
driv”_d©a
;

2382 
nvme_fc_ù¾
 *
ù¾
 = 
queue
->ctrl;

2383 
»que¡
 *
»q
;

2384 
nvme_fc_fý_Ý
 *
Ý
;

2386 
»q
 = 
	`blk_mq_g_to_rq
(
	`nvme_fc_g£t
(
queue
), 
g
);

2387 ià(!
»q
)

2390 
Ý
 = 
	`blk_mq_rq_to_pdu
(
»q
);

2392 ià((
	`©omic_»ad
(&
Ý
->
¡©e
è=ð
FCPOP_STATE_ACTIVE
) &&

2393 (
ù¾
->
ÍÜt
->
Ýs
->
pÞl_queue
))

2394 
ù¾
->
ÍÜt
->
Ýs
->
	`pÞl_queue
(&ù¾->ÍÜt->
loÿÍÜt
,

2395 
queue
->
Îdd_hªdË
);

2397  ((
	`©omic_»ad
(&
Ý
->
¡©e
è!ð
FCPOP_STATE_ACTIVE
));

2398 
	}
}

2402 
	$nvme_fc_subm™_async_ev’t
(
nvme_ù¾
 *
¬g
)

2404 
nvme_fc_ù¾
 *
ù¾
 = 
	`to_fc_ù¾
(
¬g
);

2405 
nvme_fc_fý_Ý
 *
«n_Ý
;

2406 
æags
;

2407 
boÞ
 
‹rmš©šg
 = 
çl£
;

2408 
blk_¡©us_t
 
»t
;

2410 
	`¥š_lock_œq§ve
(&
ù¾
->
lock
, 
æags
);

2411 ià(
ù¾
->
æags
 & 
FCCTRL_TERMIO
)

2412 
‹rmš©šg
 = 
Œue
;

2413 
	`¥š_uÆock_œq»¡Üe
(&
ù¾
->
lock
, 
æags
);

2415 ià(
‹rmš©šg
)

2418 
«n_Ý
 = &
ù¾
->
«n_Ýs
[0];

2420 
»t
 = 
	`nvme_fc_¡¬t_fý_Ý
(
ù¾
, 
«n_Ý
->
queue
,‡en_op, 0,

2421 
NVMEFC_FCP_NODATA
);

2422 ià(
»t
)

2423 
	`dev_”r
(
ù¾
->ù¾.
deviû
,

2425 
	}
}

2428 
	$nvme_fc_com¶‘e_rq
(
»que¡
 *
rq
)

2430 
nvme_fc_fý_Ý
 *
Ý
 = 
	`blk_mq_rq_to_pdu
(
rq
);

2431 
nvme_fc_ù¾
 *
ù¾
 = 
Ý
->ctrl;

2433 
	`©omic_£t
(&
Ý
->
¡©e
, 
FCPOP_STATE_IDLE
);

2435 
	`nvme_fc_unm­_d©a
(
ù¾
, 
rq
, 
Ý
);

2436 
	`nvme_com¶‘e_rq
(
rq
);

2437 
	`nvme_fc_ù¾_put
(
ù¾
);

2438 
	}
}

2454 
	$nvme_fc_‹rmš©e_exchªge
(
»que¡
 *
»q
, *
d©a
, 
boÞ
 
»£rved
)

2456 
nvme_ù¾
 *
nù¾
 = 
d©a
;

2457 
nvme_fc_ù¾
 *
ù¾
 = 
	`to_fc_ù¾
(
nù¾
);

2458 
nvme_fc_fý_Ý
 *
Ý
 = 
	`blk_mq_rq_to_pdu
(
»q
);

2460 ià(!
	`blk_mq_»que¡_¡¬‹d
(
»q
))

2463 
	`__nvme_fc_abÜt_Ý
(
ù¾
, 
Ý
);

2464 
	}
}

2467 cÚ¡ 
blk_mq_Ýs
 
	gnvme_fc_mq_Ýs
 = {

2468 .
queue_rq
 = 
nvme_fc_queue_rq
,

2469 .
	gcom¶‘e
 = 
nvme_fc_com¶‘e_rq
,

2470 .
	gš™_»que¡
 = 
nvme_fc_š™_»que¡
,

2471 .
	gex™_»que¡
 = 
nvme_fc_ex™_»que¡
,

2472 #ifdeà
HAVE_BLK_MQ_OPS_REINIT_REQUEST


2473 .
	g»š™_»que¡
 = 
nvme_fc_»š™_»que¡
,

2475 .
	gš™_hùx
 = 
nvme_fc_š™_hùx
,

2476 #ifdeà
HAVE_BLK_MQ_POLL


2477 .
	gpÞl
 = 
nvme_fc_pÞl
,

2479 .
	gtimeout
 = 
nvme_fc_timeout
,

2483 
	$nvme_fc_ü—‹_io_queues
(
nvme_fc_ù¾
 *
ù¾
)

2485 
nvmf_ù¾_ÝtiÚs
 *
Ýts
 = 
ù¾
->ctrl.opts;

2486 
Ä_io_queues
;

2487 
»t
;

2489 
Ä_io_queues
 = 
	`mš
(mš(
Ýts
->Ä_io_queues, 
	`num_Úlše_ýus
()),

2490 
ù¾
->
ÍÜt
->
Ýs
->
max_hw_queues
);

2491 
»t
 = 
	`nvme_£t_queue_couÁ
(&
ù¾
->ù¾, &
Ä_io_queues
);

2492 ià(
»t
) {

2493 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

2494 "£t_queue_couÁ fažed: %d\n", 
»t
);

2495  
»t
;

2498 
ù¾
->ù¾.
queue_couÁ
 = 
Ä_io_queues
 + 1;

2499 ià(!
Ä_io_queues
)

2502 
	`nvme_fc_š™_io_queues
(
ù¾
);

2504 
	`mem£t
(&
ù¾
->
g_£t
, 0, (ctrl->tag_set));

2505 
ù¾
->
g_£t
.
Ýs
 = &
nvme_fc_mq_Ýs
;

2506 
ù¾
->
g_£t
.
queue_d•th
 = cŒl->ù¾.
Ýts
->
queue_size
;

2507 
ù¾
->
g_£t
.
»£rved_gs
 = 1;

2508 
ù¾
->
g_£t
.
numa_node
 = 
NUMA_NO_NODE
;

2509 
ù¾
->
g_£t
.
æags
 = 
BLK_MQ_F_SHOULD_MERGE
;

2510 
ù¾
->
g_£t
.
cmd_size
 = (
nvme_fc_fý_Ý
) +

2511 (
SG_CHUNK_SIZE
 *

2512 (
sÿ‰”li¡
)) +

2513 
ù¾
->
ÍÜt
->
Ýs
->
fýrq¡_´iv_sz
;

2514 
ù¾
->
g_£t
.
driv”_d©a
 = ctrl;

2515 
ù¾
->
g_£t
.
Ä_hw_queues
 = cŒl->ù¾.
queue_couÁ
 - 1;

2516 
ù¾
->
g_£t
.
timeout
 = 
NVME_IO_TIMEOUT
;

2518 
»t
 = 
	`blk_mq_®loc_g_£t
(&
ù¾
->
g_£t
);

2519 ià(
»t
)

2520  
»t
;

2522 
ù¾
->ù¾.
g£t
 = &ù¾->
g_£t
;

2524 
ù¾
->ù¾.
cÚÃù_q
 = 
	`blk_mq_š™_queue
(&ù¾->
g_£t
);

2525 ià(
	`IS_ERR
(
ù¾
->ù¾.
cÚÃù_q
)) {

2526 
»t
 = 
	`PTR_ERR
(
ù¾
->ù¾.
cÚÃù_q
);

2527 
out_ä“_g_£t
;

2530 
»t
 = 
	`nvme_fc_ü—‹_hw_io_queues
(
ù¾
, cŒl->ù¾.
sqsize
 + 1);

2531 ià(
»t
)

2532 
out_þ—nup_blk_queue
;

2534 
»t
 = 
	`nvme_fc_cÚÃù_io_queues
(
ù¾
, cŒl->ù¾.
sqsize
 + 1);

2535 ià(
»t
)

2536 
out_d–‘e_hw_queues
;

2540 
out_d–‘e_hw_queues
:

2541 
	`nvme_fc_d–‘e_hw_io_queues
(
ù¾
);

2542 
out_þ—nup_blk_queue
:

2543 
	`blk_þ—nup_queue
(
ù¾
->ù¾.
cÚÃù_q
);

2544 
out_ä“_g_£t
:

2545 
	`blk_mq_ä“_g_£t
(&
ù¾
->
g_£t
);

2546 
	`nvme_fc_ä“_io_queues
(
ù¾
);

2549 
ù¾
->ù¾.
g£t
 = 
NULL
;

2551  
»t
;

2552 
	}
}

2555 
	$nvme_fc_»š™_io_queues
(
nvme_fc_ù¾
 *
ù¾
)

2557 
nvmf_ù¾_ÝtiÚs
 *
Ýts
 = 
ù¾
->ctrl.opts;

2558 
Ä_io_queues
;

2559 
»t
;

2561 
Ä_io_queues
 = 
	`mš
(mš(
Ýts
->Ä_io_queues, 
	`num_Úlše_ýus
()),

2562 
ù¾
->
ÍÜt
->
Ýs
->
max_hw_queues
);

2563 
»t
 = 
	`nvme_£t_queue_couÁ
(&
ù¾
->ù¾, &
Ä_io_queues
);

2564 ià(
»t
) {

2565 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

2566 "£t_queue_couÁ fažed: %d\n", 
»t
);

2567  
»t
;

2570 
ù¾
->ù¾.
queue_couÁ
 = 
Ä_io_queues
 + 1;

2572 ià(
ù¾
->ù¾.
queue_couÁ
 == 1)

2575 
	`nvme_fc_š™_io_queues
(
ù¾
);

2577 #ià
	`defšed
(
HAVE_BLK_MQ_TAGSET_ITER
è|| defšed(
HAVE_BLK_MQ_REINIT_TAGSET_2_PARAM
)

2578 
»t
 = 
	`nvme_»š™_g£t
(&
ù¾
->ù¾, cŒl->ù¾.
g£t
);

2580 
»t
 = 
	`blk_mq_»š™_g£t
(&
ù¾
->
g_£t
);

2582 ià(
»t
)

2583 
out_ä“_io_queues
;

2585 
»t
 = 
	`nvme_fc_ü—‹_hw_io_queues
(
ù¾
, cŒl->ù¾.
sqsize
 + 1);

2586 ià(
»t
)

2587 
out_ä“_io_queues
;

2589 
»t
 = 
	`nvme_fc_cÚÃù_io_queues
(
ù¾
, cŒl->ù¾.
sqsize
 + 1);

2590 ià(
»t
)

2591 
out_d–‘e_hw_queues
;

2593 
	`blk_mq_upd©e_Ä_hw_queues
(&
ù¾
->
g_£t
, 
Ä_io_queues
);

2597 
out_d–‘e_hw_queues
:

2598 
	`nvme_fc_d–‘e_hw_io_queues
(
ù¾
);

2599 
out_ä“_io_queues
:

2600 
	`nvme_fc_ä“_io_queues
(
ù¾
);

2601  
»t
;

2602 
	}
}

2605 
	$nvme_fc_½Üt_aùive_Ú_ÍÜt
(
nvme_fc_½Üt
 *
½Üt
)

2607 
nvme_fc_ÍÜt
 *
ÍÜt
 = 
½Üt
->lport;

2609 
	`©omic_šc
(&
ÍÜt
->
aù_½Üt_út
);

2610 
	}
}

2613 
	$nvme_fc_½Üt_šaùive_Ú_ÍÜt
(
nvme_fc_½Üt
 *
½Üt
)

2615 
nvme_fc_ÍÜt
 *
ÍÜt
 = 
½Üt
->lport;

2616 
u32
 
út
;

2618 
út
 = 
	`©omic_dec_»tuº
(&
ÍÜt
->
aù_½Üt_út
);

2619 ià(
út
 =ð0 && 
ÍÜt
->
loÿÍÜt
.
pÜt_¡©e
 =ð
FC_OBJSTATE_DELETED
)

2620 
ÍÜt
->
Ýs
->
	`loÿÍÜt_d–‘e
(&ÍÜt->
loÿÍÜt
);

2621 
	}
}

2624 
	$nvme_fc_ùÌ_aùive_Ú_½Üt
(
nvme_fc_ù¾
 *
ù¾
)

2626 
nvme_fc_½Üt
 *
½Üt
 = 
ù¾
->rport;

2627 
u32
 
út
;

2629 ià(
ù¾
->
assoc_aùive
)

2632 
ù¾
->
assoc_aùive
 = 
Œue
;

2633 
út
 = 
	`©omic_šc_»tuº
(&
½Üt
->
aù_ù¾_út
);

2634 ià(
út
 == 1)

2635 
	`nvme_fc_½Üt_aùive_Ú_ÍÜt
(
½Üt
);

2638 
	}
}

2641 
	$nvme_fc_ùÌ_šaùive_Ú_½Üt
(
nvme_fc_ù¾
 *
ù¾
)

2643 
nvme_fc_½Üt
 *
½Üt
 = 
ù¾
->rport;

2644 
nvme_fc_ÍÜt
 *
ÍÜt
 = 
½Üt
->lport;

2645 
u32
 
út
;

2649 
út
 = 
	`©omic_dec_»tuº
(&
½Üt
->
aù_ù¾_út
);

2650 ià(
út
 == 0) {

2651 ià(
½Üt
->
»mÙ•Üt
.
pÜt_¡©e
 =ð
FC_OBJSTATE_DELETED
)

2652 
ÍÜt
->
Ýs
->
	`»mÙ•Üt_d–‘e
(&
½Üt
->
»mÙ•Üt
);

2653 
	`nvme_fc_½Üt_šaùive_Ú_ÍÜt
(
½Üt
);

2657 
	}
}

2664 
	$nvme_fc_ü—‹_assocŸtiÚ
(
nvme_fc_ù¾
 *
ù¾
)

2666 
nvmf_ù¾_ÝtiÚs
 *
Ýts
 = 
ù¾
->ctrl.opts;

2667 
»t
;

2668 
boÞ
 
chªged
;

2670 ++
ù¾
->ù¾.
Ä_»cÚÃùs
;

2672 ià(
ù¾
->
½Üt
->
»mÙ•Üt
.
pÜt_¡©e
 !ð
FC_OBJSTATE_ONLINE
)

2673  -
ENODEV
;

2675 ià(
	`nvme_fc_ùÌ_aùive_Ú_½Üt
(
ù¾
))

2676  -
ENOTUNIQ
;

2682 
	`nvme_fc_š™_queue
(
ù¾
, 0);

2684 
»t
 = 
	`__nvme_fc_ü—‹_hw_queue
(
ù¾
, &ù¾->
queues
[0], 0,

2685 
NVME_AQ_DEPTH
);

2686 ià(
»t
)

2687 
out_ä“_queue
;

2689 
»t
 = 
	`nvme_fc_cÚÃù_admš_queue
(
ù¾
, &ù¾->
queues
[0],

2690 
NVME_AQ_DEPTH
, (NVME_AQ_DEPTH / 4));

2691 ià(
»t
)

2692 
out_d–‘e_hw_queue
;

2694 ià(
ù¾
->ù¾.
¡©e
 !ð
NVME_CTRL_NEW
)

2695 #ifdeà
HAVE_BLK_MQ_UNQUIESCE_QUEUE


2696 
	`blk_mq_unqu›sû_queue
(
ù¾
->ù¾.
admš_q
);

2698 
	`blk_mq_¡¬t_¡Ý³d_hw_queues
(
ù¾
->ù¾.
admš_q
, 
Œue
);

2701 
»t
 = 
	`nvmf_cÚÃù_admš_queue
(&
ù¾
->ctrl);

2702 ià(
»t
)

2703 
out_discÚÃù_admš_queue
;

2705 
	`£t_b™
(
NVME_FC_Q_LIVE
, &
ù¾
->
queues
[0].
æags
);

2714 
»t
 = 
	`nvmf_»g_»ad64
(&
ù¾
->ù¾, 
NVME_REG_CAP
, &ù¾->ù¾.
ÿp
);

2715 ià(
»t
) {

2716 
	`dev_”r
(
ù¾
->ù¾.
deviû
,

2718 
out_discÚÃù_admš_queue
;

2721 
ù¾
->ù¾.
sqsize
 =

2722 
	`mš_t
(, 
	`NVME_CAP_MQES
(
ù¾
->ù¾.
ÿp
), cŒl->ù¾.
sqsize
);

2724 
»t
 = 
	`nvme_’abË_ù¾
(&
ù¾
->ù¾, cŒl->ù¾.
ÿp
);

2725 ià(
»t
)

2726 
out_discÚÃù_admš_queue
;

2728 
ù¾
->ù¾.
max_hw_£ùÜs
 =

2729 (
ù¾
->
ÍÜt
->
Ýs
->
max_sgl_£gm’ts
 - 1è<< (
PAGE_SHIFT
 - 9);

2731 
»t
 = 
	`nvme_š™_id’tify
(&
ù¾
->ctrl);

2732 ià(
»t
)

2733 
out_discÚÃù_admš_queue
;

2738 ià(
ù¾
->ù¾.
icdoff
) {

2739 
	`dev_”r
(
ù¾
->ù¾.
deviû
, "icdoff %d is‚ot supported!\n",

2740 
ù¾
->ù¾.
icdoff
);

2741 
out_discÚÃù_admš_queue
;

2746 ià(
Ýts
->
queue_size
 > 
ù¾
->ù¾.
maxcmd
) {

2748 
	`dev_w¬n
(
ù¾
->ù¾.
deviû
,

2751 
Ýts
->
queue_size
, 
ù¾
->ù¾.
maxcmd
);

2752 
Ýts
->
queue_size
 = 
ù¾
->ù¾.
maxcmd
;

2755 ià(
Ýts
->
queue_size
 > 
ù¾
->ù¾.
sqsize
 + 1) {

2757 
	`dev_w¬n
(
ù¾
->ù¾.
deviû
,

2759 
Ýts
->
queue_size
, 
ù¾
->ù¾.
sqsize
 + 1);

2760 
Ýts
->
queue_size
 = 
ù¾
->ù¾.
sqsize
 + 1;

2763 
»t
 = 
	`nvme_fc_š™_«n_Ýs
(
ù¾
);

2764 ià(
»t
)

2765 
out_‹rm_«n_Ýs
;

2771 ià(
ù¾
->ù¾.
queue_couÁ
 > 1) {

2772 ià(
ù¾
->ù¾.
¡©e
 =ð
NVME_CTRL_NEW
)

2773 
»t
 = 
	`nvme_fc_ü—‹_io_queues
(
ù¾
);

2775 
»t
 = 
	`nvme_fc_»š™_io_queues
(
ù¾
);

2776 ià(
»t
)

2777 
out_‹rm_«n_Ýs
;

2780 
chªged
 = 
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_LIVE
);

2782 
ù¾
->ù¾.
Ä_»cÚÃùs
 = 0;

2784 ià(
chªged
)

2785 
	`nvme_¡¬t_ù¾
(&
ù¾
->ctrl);

2789 
out_‹rm_«n_Ýs
:

2790 
	`nvme_fc_‹rm_«n_Ýs
(
ù¾
);

2791 
out_discÚÃù_admš_queue
:

2793 
	`nvme_fc_xmt_discÚÃù_assoc
(
ù¾
);

2794 
out_d–‘e_hw_queue
:

2795 
	`__nvme_fc_d–‘e_hw_queue
(
ù¾
, &ù¾->
queues
[0], 0);

2796 
out_ä“_queue
:

2797 
	`nvme_fc_ä“_queue
(&
ù¾
->
queues
[0]);

2798 
ù¾
->
assoc_aùive
 = 
çl£
;

2799 
	`nvme_fc_ùÌ_šaùive_Ú_½Üt
(
ù¾
);

2801  
»t
;

2802 
	}
}

2811 
	$nvme_fc_d–‘e_assocŸtiÚ
(
nvme_fc_ù¾
 *
ù¾
)

2813 
æags
;

2815 ià(!
ù¾
->
assoc_aùive
)

2817 
ù¾
->
assoc_aùive
 = 
çl£
;

2819 
	`¥š_lock_œq§ve
(&
ù¾
->
lock
, 
æags
);

2820 
ù¾
->
æags
 |ð
FCCTRL_TERMIO
;

2821 
ù¾
->
ioút
 = 0;

2822 
	`¥š_uÆock_œq»¡Üe
(&
ù¾
->
lock
, 
æags
);

2836 ià(
ù¾
->ù¾.
queue_couÁ
 > 1) {

2837 
	`nvme_¡Ý_queues
(&
ù¾
->ctrl);

2838 
	`blk_mq_g£t_busy_™”
(&
ù¾
->
g_£t
,

2839 
nvme_fc_‹rmš©e_exchªge
, &
ù¾
->ctrl);

2859 ià(
ù¾
->ù¾.
¡©e
 !ð
NVME_CTRL_NEW
)

2860 #ifdeà
HAVE_BLK_MQ_UNQUIESCE_QUEUE


2861 
	`blk_mq_qu›sû_queue
(
ù¾
->ù¾.
admš_q
);

2863 
	`blk_mq_¡Ý_hw_queues
(
ù¾
->ù¾.
admš_q
);

2865 
	`blk_mq_g£t_busy_™”
(&
ù¾
->
admš_g_£t
,

2866 
nvme_fc_‹rmš©e_exchªge
, &
ù¾
->ctrl);

2869 
	`nvme_fc_abÜt_«n_Ýs
(
ù¾
);

2872 
	`¥š_lock_œq
(&
ù¾
->
lock
);

2873 
	`wa™_ev’t_lock_œq
(
ù¾
->
ißbÜt_wa™
, cŒl->
ioút
 =ð0, cŒl->
lock
);

2874 
ù¾
->
æags
 &ð~
FCCTRL_TERMIO
;

2875 
	`¥š_uÆock_œq
(&
ù¾
->
lock
);

2877 
	`nvme_fc_‹rm_«n_Ýs
(
ù¾
);

2885 ià(
ù¾
->
assocŸtiÚ_id
)

2886 
	`nvme_fc_xmt_discÚÃù_assoc
(
ù¾
);

2888 ià(
ù¾
->ù¾.
g£t
) {

2889 
	`nvme_fc_d–‘e_hw_io_queues
(
ù¾
);

2890 
	`nvme_fc_ä“_io_queues
(
ù¾
);

2893 
	`__nvme_fc_d–‘e_hw_queue
(
ù¾
, &ù¾->
queues
[0], 0);

2894 
	`nvme_fc_ä“_queue
(&
ù¾
->
queues
[0]);

2897 #ifdeà
HAVE_BLK_MQ_UNQUIESCE_QUEUE


2898 
	`blk_mq_unqu›sû_queue
(
ù¾
->ù¾.
admš_q
);

2900 
	`blk_mq_¡¬t_¡Ý³d_hw_queues
(
ù¾
->ù¾.
admš_q
, 
Œue
);

2903 
	`nvme_fc_ùÌ_šaùive_Ú_½Üt
(
ù¾
);

2904 
	}
}

2907 
	$nvme_fc_d–‘e_ù¾
(
nvme_ù¾
 *
nù¾
)

2909 
nvme_fc_ù¾
 *
ù¾
 = 
	`to_fc_ù¾
(
nù¾
);

2911 
	`ÿnûl_d–ayed_wÜk_sync
(&
ù¾
->
cÚÃù_wÜk
);

2916 
	`nvme_fc_d–‘e_assocŸtiÚ
(
ù¾
);

2919 
	`nvme_¡¬t_queues
(
nù¾
);

2920 
	}
}

2923 
	$nvme_fc_»cÚÃù_Ü_d–‘e
(
nvme_fc_ù¾
 *
ù¾
, 
¡©us
)

2925 
nvme_fc_½Üt
 *
½Üt
 = 
ù¾
->rport;

2926 
nvme_fc_»mÙe_pÜt
 *
pÜŒ
 = &
½Üt
->
»mÙ•Üt
;

2927 
»cÚ_d–ay
 = 
ù¾
->ù¾.
Ýts
->
»cÚÃù_d–ay
 * 
HZ
;

2928 
boÞ
 
»cÚ
 = 
Œue
;

2930 ià(
ù¾
->ù¾.
¡©e
 !ð
NVME_CTRL_CONNECTING
)

2933 ià(
pÜŒ
->
pÜt_¡©e
 =ð
FC_OBJSTATE_ONLINE
)

2934 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

2936 
ù¾
->
úum
, 
¡©us
);

2937 ià(
	`time_aá”_eq
(
jiff›s
, 
½Üt
->
dev_loss_’d
))

2938 
»cÚ
 = 
çl£
;

2940 ià(
»cÚ
 && 
	`nvmf_should_»cÚÃù
(&
ù¾
->ctrl)) {

2941 ià(
pÜŒ
->
pÜt_¡©e
 =ð
FC_OBJSTATE_ONLINE
)

2942 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

2945 
ù¾
->
úum
, 
»cÚ_d–ay
 / 
HZ
);

2946 ià(
	`time_aá”
(
jiff›s
 + 
»cÚ_d–ay
, 
½Üt
->
dev_loss_’d
))

2947 
»cÚ_d–ay
 = 
½Üt
->
dev_loss_’d
 - 
jiff›s
;

2949 
	`queue_d–ayed_wÜk
(
nvme_wq
, &
ù¾
->
cÚÃù_wÜk
, 
»cÚ_d–ay
);

2951 ià(
pÜŒ
->
pÜt_¡©e
 =ð
FC_OBJSTATE_ONLINE
)

2952 
	`dev_w¬n
(
ù¾
->ù¾.
deviû
,

2955 
ù¾
->
úum
, cŒl->ù¾.
Ä_»cÚÃùs
);

2957 
	`dev_w¬n
(
ù¾
->ù¾.
deviû
,

2960 
ù¾
->
úum
, 
pÜŒ
->
dev_loss_tmo
);

2961 
	`WARN_ON
(
	`nvme_d–‘e_ù¾
(&
ù¾
->ctrl));

2963 
	}
}

2966 
	$nvme_fc_»£t_ù¾_wÜk
(
wÜk_¡ruù
 *
wÜk
)

2968 
nvme_fc_ù¾
 *
ù¾
 =

2969 
	`cÚš”_of
(
wÜk
, 
nvme_fc_ù¾
, 
ù¾
.
»£t_wÜk
);

2970 
»t
;

2972 
	`nvme_¡Ý_ù¾
(&
ù¾
->ctrl);

2975 
	`nvme_fc_d–‘e_assocŸtiÚ
(
ù¾
);

2977 ià(!
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_CONNECTING
)) {

2978 
	`dev_”r
(
ù¾
->ù¾.
deviû
,

2980 "tØCONNECTING\n", 
ù¾
->
úum
);

2984 ià(
ù¾
->
½Üt
->
»mÙ•Üt
.
pÜt_¡©e
 =ð
FC_OBJSTATE_ONLINE
)

2985 
»t
 = 
	`nvme_fc_ü—‹_assocŸtiÚ
(
ù¾
);

2987 
»t
 = -
ENOTCONN
;

2989 ià(
»t
)

2990 
	`nvme_fc_»cÚÃù_Ü_d–‘e
(
ù¾
, 
»t
);

2992 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

2994 
ù¾
->
úum
);

2995 
	}
}

2997 cÚ¡ 
nvme_ù¾_Ýs
 
	gnvme_fc_ù¾_Ýs
 = {

2998 .
Çme
 = "fc",

2999 .
	gmoduË
 = 
THIS_MODULE
,

3000 .
	gæags
 = 
NVME_F_FABRICS
,

3001 .
	g»g_»ad32
 = 
nvmf_»g_»ad32
,

3002 .
	g»g_»ad64
 = 
nvmf_»g_»ad64
,

3003 .
	g»g_wr™e32
 = 
nvmf_»g_wr™e32
,

3004 .
	gä“_ù¾
 = 
nvme_fc_nvme_ù¾_ä“d
,

3005 .
	gsubm™_async_ev’t
 = 
nvme_fc_subm™_async_ev’t
,

3006 .
	gd–‘e_ù¾
 = 
nvme_fc_d–‘e_ù¾
,

3007 .
	gg‘_add»ss
 = 
nvmf_g‘_add»ss
,

3008 .
	g»š™_»que¡
 = 
nvme_fc_»š™_»que¡
,

3012 
	$nvme_fc_cÚÃù_ù¾_wÜk
(
wÜk_¡ruù
 *
wÜk
)

3014 
»t
;

3016 
nvme_fc_ù¾
 *
ù¾
 =

3017 
	`cÚš”_of
(
	`to_d–ayed_wÜk
(
wÜk
),

3018 
nvme_fc_ù¾
, 
cÚÃù_wÜk
);

3020 
»t
 = 
	`nvme_fc_ü—‹_assocŸtiÚ
(
ù¾
);

3021 ià(
»t
)

3022 
	`nvme_fc_»cÚÃù_Ü_d–‘e
(
ù¾
, 
»t
);

3024 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

3026 
ù¾
->
úum
);

3027 
	}
}

3030 cÚ¡ 
blk_mq_Ýs
 
	gnvme_fc_admš_mq_Ýs
 = {

3031 .
queue_rq
 = 
nvme_fc_queue_rq
,

3032 .
	gcom¶‘e
 = 
nvme_fc_com¶‘e_rq
,

3033 #ifdeà
HAVE_BLK_MQ_OPS_INIT_REQUEST_HAS_4_PARAMS


3034 .
	gš™_»que¡
 = 
nvme_fc_š™_»que¡
,

3036 .
	gš™_»que¡
 = 
nvme_fc_š™_admš_»que¡
,

3038 .
	gex™_»que¡
 = 
nvme_fc_ex™_»que¡
,

3039 #ifdeà
HAVE_BLK_MQ_OPS_REINIT_REQUEST


3040 .
	g»š™_»que¡
 = 
nvme_fc_»š™_»que¡
,

3042 .
	gš™_hùx
 = 
nvme_fc_š™_admš_hùx
,

3043 .
	gtimeout
 = 
nvme_fc_timeout
,

3055 
boÞ


3056 
	$nvme_fc_exi¡šg_cÚŒÞËr
(
nvme_fc_½Üt
 *
½Üt
,

3057 
nvmf_ù¾_ÝtiÚs
 *
Ýts
)

3059 
nvme_fc_ù¾
 *
ù¾
;

3060 
æags
;

3061 
boÞ
 
found
 = 
çl£
;

3063 
	`¥š_lock_œq§ve
(&
½Üt
->
lock
, 
æags
);

3064 
	`li¡_fÜ_—ch_’Œy
(
ù¾
, &
½Üt
->
ù¾_li¡
, ctrl_list) {

3065 
found
 = 
	`nvmf_ùÌ_m©ches_ba£Ýts
(&
ù¾
->ù¾, 
Ýts
);

3066 ià(
found
)

3069 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

3071  
found
;

3072 
	}
}

3074 
nvme_ù¾
 *

3075 
	$nvme_fc_š™_ù¾
(
deviû
 *
dev
, 
nvmf_ù¾_ÝtiÚs
 *
Ýts
,

3076 
nvme_fc_ÍÜt
 *
ÍÜt
, 
nvme_fc_½Üt
 *
½Üt
)

3078 
nvme_fc_ù¾
 *
ù¾
;

3079 
æags
;

3080 
»t
, 
idx
, 
»Œy
;

3082 ià(!(
½Üt
->
»mÙ•Üt
.
pÜt_rÞe
 &

3083 (
FC_PORT_ROLE_NVME_DISCOVERY
 | 
FC_PORT_ROLE_NVME_TARGET
))) {

3084 
»t
 = -
EBADR
;

3085 
out_çž
;

3088 ià(!
Ýts
->
du¶iÿ‹_cÚÃù
 &&

3089 
	`nvme_fc_exi¡šg_cÚŒÞËr
(
½Üt
, 
Ýts
)) {

3090 
»t
 = -
EALREADY
;

3091 
out_çž
;

3094 
ù¾
 = 
	`kz®loc
((*ù¾), 
GFP_KERNEL
);

3095 ià(!
ù¾
) {

3096 
»t
 = -
ENOMEM
;

3097 
out_çž
;

3100 
idx
 = 
	`ida_sim¶e_g‘
(&
nvme_fc_ù¾_út
, 0, 0, 
GFP_KERNEL
);

3101 ià(
idx
 < 0) {

3102 
»t
 = -
ENOSPC
;

3103 
out_ä“_ù¾
;

3106 
ù¾
->ù¾.
Ýts
 = opts;

3107 
	`INIT_LIST_HEAD
(&
ù¾
->
ù¾_li¡
);

3108 
ù¾
->
ÍÜt
 =†port;

3109 
ù¾
->
½Üt
 =„port;

3110 
ù¾
->
dev
 = 
ÍÜt
->dev;

3111 
ù¾
->
úum
 = 
idx
;

3112 
ù¾
->
assoc_aùive
 = 
çl£
;

3113 
	`š™_wa™queue_h—d
(&
ù¾
->
ißbÜt_wa™
);

3115 
	`g‘_deviû
(
ù¾
->
dev
);

3116 
	`k»f_š™
(&
ù¾
->
»f
);

3118 
	`INIT_WORK
(&
ù¾
->ù¾.
»£t_wÜk
, 
nvme_fc_»£t_ù¾_wÜk
);

3119 
	`INIT_DELAYED_WORK
(&
ù¾
->
cÚÃù_wÜk
, 
nvme_fc_cÚÃù_ù¾_wÜk
);

3120 
	`¥š_lock_š™
(&
ù¾
->
lock
);

3123 
ù¾
->ù¾.
queue_couÁ
 = 
	`mš_t
(,

3124 
Ýts
->
Ä_io_queues
,

3125 
ÍÜt
->
Ýs
->
max_hw_queues
);

3126 
ù¾
->ù¾.
queue_couÁ
++;

3128 
ù¾
->ù¾.
sqsize
 = 
Ýts
->
queue_size
 - 1;

3129 
ù¾
->ù¾.
k©o
 = 
Ýts
->kato;

3131 
»t
 = -
ENOMEM
;

3132 
ù¾
->
queues
 = 
	`kÿÎoc
(ù¾->ù¾.
queue_couÁ
,

3133 (
nvme_fc_queue
), 
GFP_KERNEL
);

3134 ià(!
ù¾
->
queues
)

3135 
out_ä“_ida
;

3137 
	`mem£t
(&
ù¾
->
admš_g_£t
, 0, (ctrl->admin_tag_set));

3138 
ù¾
->
admš_g_£t
.
Ýs
 = &
nvme_fc_admš_mq_Ýs
;

3139 
ù¾
->
admš_g_£t
.
queue_d•th
 = 
NVME_AQ_MQ_TAG_DEPTH
;

3140 
ù¾
->
admš_g_£t
.
»£rved_gs
 = 2;

3141 
ù¾
->
admš_g_£t
.
numa_node
 = 
NUMA_NO_NODE
;

3142 
ù¾
->
admš_g_£t
.
cmd_size
 = (
nvme_fc_fý_Ý
) +

3143 (
SG_CHUNK_SIZE
 *

3144 (
sÿ‰”li¡
)) +

3145 
ù¾
->
ÍÜt
->
Ýs
->
fýrq¡_´iv_sz
;

3146 
ù¾
->
admš_g_£t
.
driv”_d©a
 = ctrl;

3147 
ù¾
->
admš_g_£t
.
Ä_hw_queues
 = 1;

3148 
ù¾
->
admš_g_£t
.
timeout
 = 
ADMIN_TIMEOUT
;

3149 #ifdeà
HAVE_BLK_MQ_F_NO_SCHED


3150 
ù¾
->
admš_g_£t
.
æags
 = 
BLK_MQ_F_NO_SCHED
;

3153 
»t
 = 
	`blk_mq_®loc_g_£t
(&
ù¾
->
admš_g_£t
);

3154 ià(
»t
)

3155 
out_ä“_queues
;

3156 
ù¾
->ù¾.
admš_g£t
 = &ù¾->
admš_g_£t
;

3158 
ù¾
->ù¾.
admš_q
 = 
	`blk_mq_š™_queue
(&ù¾->
admš_g_£t
);

3159 ià(
	`IS_ERR
(
ù¾
->ù¾.
admš_q
)) {

3160 
»t
 = 
	`PTR_ERR
(
ù¾
->ù¾.
admš_q
);

3161 
out_ä“_admš_g_£t
;

3171 
»t
 = 
	`nvme_š™_ù¾
(&
ù¾
->ù¾, 
dev
, &
nvme_fc_ù¾_Ýs
, 0);

3172 ià(
»t
)

3173 
out_þ—nup_admš_q
;

3177 
	`¥š_lock_œq§ve
(&
½Üt
->
lock
, 
æags
);

3178 
	`li¡_add_ž
(&
ù¾
->
ù¾_li¡
, &
½Üt
->ctrl_list);

3179 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

3199 
»Œy
 = 0;„etry < 3;„etry++) {

3200 
»t
 = 
	`nvme_fc_ü—‹_assocŸtiÚ
(
ù¾
);

3201 ià(!
»t
)

3205 ià(
»t
) {

3206 
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_DELETING
);

3207 
	`ÿnûl_wÜk_sync
(&
ù¾
->ù¾.
»£t_wÜk
);

3208 
	`ÿnûl_d–ayed_wÜk_sync
(&
ù¾
->
cÚÃù_wÜk
);

3211 
	`dev_”r
(
ù¾
->ù¾.
deviû
,

3212 "NVME-FC{%d}: CÚÃù„‘ry fažed\n", 
ù¾
->
úum
);

3214 
ù¾
->ù¾.
Ýts
 = 
NULL
;

3217 
	`nvme_unš™_ù¾
(&
ù¾
->ctrl);

3220 
	`nvme_put_ù¾
(&
ù¾
->ctrl);

3229 
	`nvme_fc_½Üt_g‘
(
½Üt
);

3231 ià(
»t
 > 0)

3232 
»t
 = -
EIO
;

3233  
	`ERR_PTR
(
»t
);

3236 
	`nvme_g‘_ù¾
(&
ù¾
->ctrl);

3238 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

3240 
ù¾
->
úum
, cŒl->ù¾.
Ýts
->
subsy¢qn
);

3242  &
ù¾
->ctrl;

3244 
out_þ—nup_admš_q
:

3245 
	`blk_þ—nup_queue
(
ù¾
->ù¾.
admš_q
);

3246 
out_ä“_admš_g_£t
:

3247 
	`blk_mq_ä“_g_£t
(&
ù¾
->
admš_g_£t
);

3248 
out_ä“_queues
:

3249 
	`kä“
(
ù¾
->
queues
);

3250 
out_ä“_ida
:

3251 
	`put_deviû
(
ù¾
->
dev
);

3252 
	`ida_sim¶e_»move
(&
nvme_fc_ù¾_út
, 
ù¾
->
úum
);

3253 
out_ä“_ù¾
:

3254 
	`kä“
(
ù¾
);

3255 
out_çž
:

3257  
	`ERR_PTR
(
»t
);

3258 
	}
}

3261 
	snvm‘_fc_Œaddr
 {

3262 
u64
 
	mÂ
;

3263 
u64
 
	m²
;

3267 
	$__nvme_fc_·r£_u64
(
sub¡ršg_t
 *
s¡r
, 
u64
 *
v®
)

3269 
u64
 
tok’64
;

3271 ià(
	`m©ch_u64
(
s¡r
, &
tok’64
))

3272  -
EINVAL
;

3273 *
v®
 = 
tok’64
;

3276 
	}
}

3284 
	$nvme_fc_·r£_Œaddr
(
nvm‘_fc_Œaddr
 *
Œaddr
, *
buf
, 
size_t
 
bËn
)

3286 
Çme
[2 + 
NVME_FC_TRADDR_HEXNAMELEN
 + 1];

3287 
sub¡ršg_t
 
wwn
 = { 
Çme
, &name[(name)-1] };

3288 
Âoff£t
, 
²off£t
;

3291 ià(
	`¡ºËn
(
buf
, 
bËn
è=ð
NVME_FC_TRADDR_MAXLENGTH
 &&

3292 !
	`¡ºcmp
(
buf
, "Â-0x", 
NVME_FC_TRADDR_OXNNLEN
) &&

3293 !
	`¡ºcmp
(&
buf
[
NVME_FC_TRADDR_MAX_PN_OFFSET
],

3294 "²-0x", 
NVME_FC_TRADDR_OXNNLEN
)) {

3295 
Âoff£t
 = 
NVME_FC_TRADDR_OXNNLEN
;

3296 
²off£t
 = 
NVME_FC_TRADDR_MAX_PN_OFFSET
 +

3297 
NVME_FC_TRADDR_OXNNLEN
;

3298 } ià((
	`¡ºËn
(
buf
, 
bËn
è=ð
NVME_FC_TRADDR_MINLENGTH
 &&

3299 !
	`¡ºcmp
(
buf
, "Â-", 
NVME_FC_TRADDR_NNLEN
) &&

3300 !
	`¡ºcmp
(&
buf
[
NVME_FC_TRADDR_MIN_PN_OFFSET
],

3301 "²-", 
NVME_FC_TRADDR_NNLEN
))) {

3302 
Âoff£t
 = 
NVME_FC_TRADDR_NNLEN
;

3303 
²off£t
 = 
NVME_FC_TRADDR_MIN_PN_OFFSET
 + 
NVME_FC_TRADDR_NNLEN
;

3305 
out_ešv®
;

3307 
Çme
[0] = '0';

3308 
Çme
[1] = 'x';

3309 
Çme
[2 + 
NVME_FC_TRADDR_HEXNAMELEN
] = 0;

3311 
	`memýy
(&
Çme
[2], &
buf
[
Âoff£t
], 
NVME_FC_TRADDR_HEXNAMELEN
);

3312 ià(
	`__nvme_fc_·r£_u64
(&
wwn
, &
Œaddr
->
Â
))

3313 
out_ešv®
;

3315 
	`memýy
(&
Çme
[2], &
buf
[
²off£t
], 
NVME_FC_TRADDR_HEXNAMELEN
);

3316 ià(
	`__nvme_fc_·r£_u64
(&
wwn
, &
Œaddr
->
²
))

3317 
out_ešv®
;

3321 
out_ešv®
:

3322 
	`´_w¬n
("%s: bad¿dd¸¡ršg\n", 
__func__
);

3323  -
EINVAL
;

3324 
	}
}

3326 
nvme_ù¾
 *

3327 
	$nvme_fc_ü—‹_ù¾
(
deviû
 *
dev
, 
nvmf_ù¾_ÝtiÚs
 *
Ýts
)

3329 
nvme_fc_ÍÜt
 *
ÍÜt
;

3330 
nvme_fc_½Üt
 *
½Üt
;

3331 
nvme_ù¾
 *
ù¾
;

3332 
nvm‘_fc_Œaddr
 
Ïddr
 = { 0L, 0L };

3333 
nvm‘_fc_Œaddr
 
¿ddr
 = { 0L, 0L };

3334 
æags
;

3335 
»t
;

3337 
»t
 = 
	`nvme_fc_·r£_Œaddr
(&
¿ddr
, 
Ýts
->
Œaddr
, 
NVMF_TRADDR_SIZE
);

3338 ià(
»t
 || !
¿ddr
.
Â
 || !¿ddr.
²
)

3339  
	`ERR_PTR
(-
EINVAL
);

3341 
»t
 = 
	`nvme_fc_·r£_Œaddr
(&
Ïddr
, 
Ýts
->
ho¡_Œaddr
, 
NVMF_TRADDR_SIZE
);

3342 ià(
»t
 || !
Ïddr
.
Â
 || !Ïddr.
²
)

3343  
	`ERR_PTR
(-
EINVAL
);

3346 
	`¥š_lock_œq§ve
(&
nvme_fc_lock
, 
æags
);

3347 
	`li¡_fÜ_—ch_’Œy
(
ÍÜt
, &
nvme_fc_ÍÜt_li¡
, 
pÜt_li¡
) {

3348 ià(
ÍÜt
->
loÿÍÜt
.
node_Çme
 !ð
Ïddr
.
Â
 ||

3349 
ÍÜt
->
loÿÍÜt
.
pÜt_Çme
 !ð
Ïddr
.
²
)

3352 
	`li¡_fÜ_—ch_’Œy
(
½Üt
, &
ÍÜt
->
’dp_li¡
,ƒndp_list) {

3353 ià(
½Üt
->
»mÙ•Üt
.
node_Çme
 !ð
¿ddr
.
Â
 ||

3354 
½Üt
->
»mÙ•Üt
.
pÜt_Çme
 !ð
¿ddr
.
²
)

3358 ià(!
	`nvme_fc_½Üt_g‘
(
½Üt
))

3361 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

3363 
ù¾
 = 
	`nvme_fc_š™_ù¾
(
dev
, 
Ýts
, 
ÍÜt
, 
½Üt
);

3364 ià(
	`IS_ERR
(
ù¾
))

3365 
	`nvme_fc_½Üt_put
(
½Üt
);

3366  
ù¾
;

3369 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

3371 
	`´_w¬n
("%s: %s - %s combination‚ot found\n",

3372 
__func__
, 
Ýts
->
Œaddr
, o±s->
ho¡_Œaddr
);

3373  
	`ERR_PTR
(-
ENOENT
);

3374 
	}
}

3377 
nvmf_Œª¥Üt_Ýs
 
	gnvme_fc_Œª¥Üt
 = {

3378 .
Çme
 = "fc",

3379 .
	gmoduË
 = 
THIS_MODULE
,

3380 .
	g»quœed_Ýts
 = 
NVMF_OPT_TRADDR
 | 
NVMF_OPT_HOST_TRADDR
,

3381 .
	g®lowed_Ýts
 = 
NVMF_OPT_RECONNECT_DELAY
 | 
NVMF_OPT_CTRL_LOSS_TMO
,

3382 .
	gü—‹_ù¾
 = 
nvme_fc_ü—‹_ù¾
,

3385 
__š™
 
	$nvme_fc_š™_moduË
()

3387 
»t
;

3403 
fc_þass
 = 
	`þass_ü—‹
(
THIS_MODULE
, "fc");

3404 ià(
	`IS_ERR
(
fc_þass
)) {

3405 
	`´_”r
("couldn't„egister class fc\n");

3406  
	`PTR_ERR
(
fc_þass
);

3412 
fc_udev_deviû
 = 
	`deviû_ü—‹
(
fc_þass
, 
NULL
, 
	`MKDEV
(0, 0), NULL,

3414 ià(
	`IS_ERR
(
fc_udev_deviû
)) {

3415 
	`´_”r
("couldn't create fc_udev device!\n");

3416 
»t
 = 
	`PTR_ERR
(
fc_udev_deviû
);

3417 
out_de¡roy_þass
;

3420 
»t
 = 
	`nvmf_»gi¡”_Œª¥Üt
(&
nvme_fc_Œª¥Üt
);

3421 ià(
»t
)

3422 
out_de¡roy_deviû
;

3426 
out_de¡roy_deviû
:

3427 
	`deviû_de¡roy
(
fc_þass
, 
	`MKDEV
(0, 0));

3428 
out_de¡roy_þass
:

3429 
	`þass_de¡roy
(
fc_þass
);

3430  
»t
;

3431 
	}
}

3433 
__ex™
 
	$nvme_fc_ex™_moduË
()

3436 ià(!
	`li¡_em±y
(&
nvme_fc_ÍÜt_li¡
))

3437 
	`´_w¬n
("%s:†oÿÍÜˆli¡‚Ùƒm±y\n", 
__func__
);

3439 
	`nvmf_uÄegi¡”_Œª¥Üt
(&
nvme_fc_Œª¥Üt
);

3441 
	`ida_de¡roy
(&
nvme_fc_loÿl_pÜt_út
);

3442 
	`ida_de¡roy
(&
nvme_fc_ù¾_út
);

3444 
	`deviû_de¡roy
(
fc_þass
, 
	`MKDEV
(0, 0));

3445 
	`þass_de¡roy
(
fc_þass
);

3446 
	}
}

3448 
moduË_š™
(
nvme_fc_š™_moduË
);

3449 
moduË_ex™
(
nvme_fc_ex™_moduË
);

3451 
MODULE_LICENSE
("GPL v2");

3452 #ifdeà
RETPOLINE_MLNX


3453 
MODULE_INFO
(
»Þše
, "Y");

	@lightnvm.c

23 #ifdeà
HAVE_LIGHTNVM_NVM_DEV


25 
	~"nvme.h
"

27 
	~<lšux/nvme.h
>

28 
	~<lšux/b™Ýs.h
>

29 
	~<lšux/lighŠvm.h
>

30 
	~<lšux/vm®loc.h
>

31 #ifdeà
HAVE_NVM_USER_VIO


32 
	~<lšux/sched/sysùl.h
>

33 
	~<u­i/lšux/lighŠvm.h
>

36 
	envme_nvm_admš_Ýcode
 {

37 
	mnvme_nvm_admš_id’t™y
 = 0xe2,

38 
	mnvme_nvm_admš_g‘_l2p_tbl
 = 0xea,

39 
	mnvme_nvm_admš_g‘_bb_tbl
 = 0xf2,

40 
	mnvme_nvm_admš_£t_bb_tbl
 = 0xf1,

43 
	snvme_nvm_hb_rw
 {

44 
__u8
 
	mÝcode
;

45 
__u8
 
	mæags
;

46 
__u16
 
	mcommªd_id
;

47 
__Ë32
 
	mnsid
;

48 
__u64
 
	mrsvd2
;

49 
__Ë64
 
	mm‘ad©a
;

50 
__Ë64
 
	m´p1
;

51 
__Ë64
 
	m´p2
;

52 
__Ë64
 
	m¥ba
;

53 
__Ë16
 
	mËngth
;

54 
__Ë16
 
	mcÚŒÞ
;

55 
__Ë32
 
	mdsmgmt
;

56 
__Ë64
 
	m¦ba
;

59 
	snvme_nvm_ph_rw
 {

60 
__u8
 
	mÝcode
;

61 
__u8
 
	mæags
;

62 
__u16
 
	mcommªd_id
;

63 
__Ë32
 
	mnsid
;

64 
__u64
 
	mrsvd2
;

65 
__Ë64
 
	mm‘ad©a
;

66 
__Ë64
 
	m´p1
;

67 
__Ë64
 
	m´p2
;

68 
__Ë64
 
	m¥ba
;

69 
__Ë16
 
	mËngth
;

70 
__Ë16
 
	mcÚŒÞ
;

71 
__Ë32
 
	mdsmgmt
;

72 
__Ë64
 
	m»sv
;

75 
	snvme_nvm_id’t™y
 {

76 
__u8
 
	mÝcode
;

77 
__u8
 
	mæags
;

78 
__u16
 
	mcommªd_id
;

79 
__Ë32
 
	mnsid
;

80 
__u64
 
	mrsvd
[2];

81 
__Ë64
 
	m´p1
;

82 
__Ë64
 
	m´p2
;

83 
__Ë32
 
	mchÆ_off
;

84 
__u32
 
	mrsvd11
[5];

87 
	snvme_nvm_l2±bl
 {

88 
__u8
 
	mÝcode
;

89 
__u8
 
	mæags
;

90 
__u16
 
	mcommªd_id
;

91 
__Ë32
 
	mnsid
;

92 
__Ë32
 
	mcdw2
[4];

93 
__Ë64
 
	m´p1
;

94 
__Ë64
 
	m´p2
;

95 
__Ë64
 
	m¦ba
;

96 
__Ë32
 
	mÆb
;

97 
__Ë16
 
	mcdw14
[6];

100 
	snvme_nvm_g‘bbtbl
 {

101 
__u8
 
	mÝcode
;

102 
__u8
 
	mæags
;

103 
__u16
 
	mcommªd_id
;

104 
__Ë32
 
	mnsid
;

105 
__u64
 
	mrsvd
[2];

106 
__Ë64
 
	m´p1
;

107 
__Ë64
 
	m´p2
;

108 
__Ë64
 
	m¥ba
;

109 
__u32
 
	mrsvd4
[4];

112 
	snvme_nvm_£tbbtbl
 {

113 
__u8
 
	mÝcode
;

114 
__u8
 
	mæags
;

115 
__u16
 
	mcommªd_id
;

116 
__Ë32
 
	mnsid
;

117 
__Ë64
 
	mrsvd
[2];

118 
__Ë64
 
	m´p1
;

119 
__Ë64
 
	m´p2
;

120 
__Ë64
 
	m¥ba
;

121 
__Ë16
 
	mÆb
;

122 
__u8
 
	mv®ue
;

123 
__u8
 
	mrsvd3
;

124 
__u32
 
	mrsvd4
[3];

127 
	snvme_nvm_”a£_blk
 {

128 
__u8
 
	mÝcode
;

129 
__u8
 
	mæags
;

130 
__u16
 
	mcommªd_id
;

131 
__Ë32
 
	mnsid
;

132 
__u64
 
	mrsvd
[2];

133 
__Ë64
 
	m´p1
;

134 
__Ë64
 
	m´p2
;

135 
__Ë64
 
	m¥ba
;

136 
__Ë16
 
	mËngth
;

137 
__Ë16
 
	mcÚŒÞ
;

138 
__Ë32
 
	mdsmgmt
;

139 
__Ë64
 
	m»sv
;

142 
	snvme_nvm_commªd
 {

144 
nvme_commÚ_commªd
 
	mcommÚ
;

145 
nvme_nvm_id’t™y
 
	mid’t™y
;

146 
nvme_nvm_hb_rw
 
	mhb_rw
;

147 
nvme_nvm_ph_rw
 
	mph_rw
;

148 
nvme_nvm_l2±bl
 
	ml2p
;

149 
nvme_nvm_g‘bbtbl
 
	mg‘_bb
;

150 
nvme_nvm_£tbbtbl
 
	m£t_bb
;

151 
nvme_nvm_”a£_blk
 
	m”a£
;

155 
	#NVME_NVM_LP_MLC_PAIRS
 886

	)

156 
	snvme_nvm_Í_mlc
 {

157 
__Ë16
 
	mnum_·œs
;

158 
__u8
 
	m·œs
[
NVME_NVM_LP_MLC_PAIRS
];

161 
	snvme_nvm_Í_tbl
 {

162 
__u8
 
	mid
[8];

163 
nvme_nvm_Í_mlc
 
	mmlc
;

166 
	snvme_nvm_id_group
 {

167 
__u8
 
	mmty³
;

168 
__u8
 
	mfmty³
;

169 
__Ë16
 
	m»s16
;

170 
__u8
 
	mnum_ch
;

171 
__u8
 
	mnum_lun
;

172 
__u8
 
	mnum_¶n
;

173 
__u8
 
	mrsvd1
;

174 
__Ë16
 
	mnum_blk
;

175 
__Ë16
 
	mnum_pg
;

176 
__Ë16
 
	måg_sz
;

177 
__Ë16
 
	mc£cs
;

178 
__Ë16
 
	msos
;

179 
__Ë16
 
	mrsvd2
;

180 
__Ë32
 
	mŒdt
;

181 
__Ë32
 
	mŒdm
;

182 
__Ë32
 
	m¹
;

183 
__Ë32
 
	mrm
;

184 
__Ë32
 
	mtb‘
;

185 
__Ë32
 
	mtbem
;

186 
__Ë32
 
	mmpos
;

187 
__Ë32
 
	mmcÿp
;

188 
__Ë16
 
	mý¬
;

189 
__u8
 
	m»£rved
[10];

190 
nvme_nvm_Í_tbl
 
	mÍtbl
;

191 } 
	g__·cked
;

193 
	snvme_nvm_addr_fÜm©
 {

194 
__u8
 
	mch_off£t
;

195 
__u8
 
	mch_Ën
;

196 
__u8
 
	mlun_off£t
;

197 
__u8
 
	mlun_Ën
;

198 
__u8
 
	m¶n_off£t
;

199 
__u8
 
	m¶n_Ën
;

200 
__u8
 
	mblk_off£t
;

201 
__u8
 
	mblk_Ën
;

202 
__u8
 
	mpg_off£t
;

203 
__u8
 
	mpg_Ën
;

204 
__u8
 
	m£ù_off£t
;

205 
__u8
 
	m£ù_Ën
;

206 
__u8
 
	m»s
[4];

207 } 
	g__·cked
;

209 
	snvme_nvm_id
 {

210 
__u8
 
	mv”_id
;

211 
__u8
 
	mvmÁ
;

212 
__u8
 
	mcg½s
;

213 
__u8
 
	m»s
;

214 
__Ë32
 
	mÿp
;

215 
__Ë32
 
	mdom
;

216 
nvme_nvm_addr_fÜm©
 
	mµaf
;

217 
__u8
 
	m»sv
[228];

218 
nvme_nvm_id_group
 
	mgroups
[4];

219 } 
	g__·cked
;

221 
	snvme_nvm_bb_tbl
 {

222 
__u8
 
	mtblid
[4];

223 
__Ë16
 
	mv”id
;

224 
__Ë16
 
	m»vid
;

225 
__Ë32
 
	mrvsd1
;

226 
__Ë32
 
	mtblks
;

227 
__Ë32
 
	mtçù
;

228 
__Ë32
 
	mtgrown
;

229 
__Ë32
 
	mtd»sv
;

230 
__Ë32
 
	mth»sv
;

231 
__Ë32
 
	mrsvd2
[8];

232 
__u8
 
	mblk
[0];

238 
šlše
 
	$_nvme_nvm_check_size
()

240 
	`BUILD_BUG_ON
((
nvme_nvm_id’t™y
) != 64);

241 
	`BUILD_BUG_ON
((
nvme_nvm_hb_rw
) != 64);

242 
	`BUILD_BUG_ON
((
nvme_nvm_ph_rw
) != 64);

243 
	`BUILD_BUG_ON
((
nvme_nvm_g‘bbtbl
) != 64);

244 
	`BUILD_BUG_ON
((
nvme_nvm_£tbbtbl
) != 64);

245 
	`BUILD_BUG_ON
((
nvme_nvm_l2±bl
) != 64);

246 
	`BUILD_BUG_ON
((
nvme_nvm_”a£_blk
) != 64);

247 
	`BUILD_BUG_ON
((
nvme_nvm_id_group
) != 960);

248 
	`BUILD_BUG_ON
((
nvme_nvm_addr_fÜm©
) != 16);

249 
	`BUILD_BUG_ON
((
nvme_nvm_id
è!ð
NVME_IDENTIFY_DATA_SIZE
);

250 
	`BUILD_BUG_ON
((
nvme_nvm_bb_tbl
) != 64);

251 
	}
}

253 
	$š™_g½s
(
nvm_id
 *nvm_id, 
nvme_nvm_id
 *nvme_nvm_id)

255 
nvme_nvm_id_group
 *
¤c
;

256 
nvm_id_group
 *
d¡
;

258 #ifdeà
HAVE_LIGHTNVM_NVM_ID_GRP


259 ià(
nvme_nvm_id
->
cg½s
 != 1)

260  -
EINVAL
;

262 
¤c
 = &
nvme_nvm_id
->
groups
[0];

263 
d¡
 = &
nvm_id
->
g½
;

265 
d¡
->
mty³
 = 
¤c
->mtype;

266 
d¡
->
fmty³
 = 
¤c
->fmtype;

267 
d¡
->
num_ch
 = 
¤c
->num_ch;

268 
d¡
->
num_lun
 = 
¤c
->num_lun;

269 
d¡
->
num_¶n
 = 
¤c
->num_pln;

271 
d¡
->
num_pg
 = 
	`Ë16_to_ýu
(
¤c
->num_pg);

272 
d¡
->
num_blk
 = 
	`Ë16_to_ýu
(
¤c
->num_blk);

273 
d¡
->
åg_sz
 = 
	`Ë16_to_ýu
(
¤c
->fpg_sz);

274 
d¡
->
c£cs
 = 
	`Ë16_to_ýu
(
¤c
->csecs);

275 
d¡
->
sos
 = 
	`Ë16_to_ýu
(
¤c
->sos);

277 
d¡
->
Œdt
 = 
	`Ë32_to_ýu
(
¤c
->trdt);

278 
d¡
->
Œdm
 = 
	`Ë32_to_ýu
(
¤c
->trdm);

279 
d¡
->
¹
 = 
	`Ë32_to_ýu
(
¤c
->tprt);

280 
d¡
->
rm
 = 
	`Ë32_to_ýu
(
¤c
->tprm);

281 
d¡
->
tb‘
 = 
	`Ë32_to_ýu
(
¤c
->tbet);

282 
d¡
->
tbem
 = 
	`Ë32_to_ýu
(
¤c
->tbem);

283 
d¡
->
mpos
 = 
	`Ë32_to_ýu
(
¤c
->mpos);

284 
d¡
->
mcÿp
 = 
	`Ë32_to_ýu
(
¤c
->mccap);

286 
d¡
->
ý¬
 = 
	`Ë16_to_ýu
(
¤c
->cpar);

288 ià(
d¡
->
fmty³
 =ð
NVM_ID_FMTYPE_MLC
) {

289 
	`memýy
(
d¡
->
Ítbl
.
id
, 
¤c
->lptbl.id, 8);

290 
d¡
->
Ítbl
.
mlc
.
num_·œs
 =

291 
	`Ë16_to_ýu
(
¤c
->
Ítbl
.
mlc
.
num_·œs
);

293 ià(
d¡
->
Ítbl
.
mlc
.
num_·œs
 > 
NVME_NVM_LP_MLC_PAIRS
) {

294 
	`´_”r
("nvm:‚umber of MLC…airs‚ot supported\n");

295  -
EINVAL
;

298 
	`memýy
(
d¡
->
Ítbl
.
mlc
.
·œs
, 
¤c
->lptbl.mlc.pairs,

299 
d¡
->
Ítbl
.
mlc
.
num_·œs
);

302 
i
, 
’d
;

304 
’d
 = 
	`mš_t
(
u32
, 4, 
nvm_id
->
cg½s
);

305 
i
 = 0; i < 
’d
; i++) {

306 
¤c
 = &
nvme_nvm_id
->
groups
[
i
];

307 
d¡
 = &
nvm_id
->
groups
[
i
];

309 
d¡
->
mty³
 = 
¤c
->mtype;

310 
d¡
->
fmty³
 = 
¤c
->fmtype;

311 
d¡
->
num_ch
 = 
¤c
->num_ch;

312 
d¡
->
num_lun
 = 
¤c
->num_lun;

313 
d¡
->
num_¶n
 = 
¤c
->num_pln;

315 
d¡
->
num_pg
 = 
	`Ë16_to_ýu
(
¤c
->num_pg);

316 
d¡
->
num_blk
 = 
	`Ë16_to_ýu
(
¤c
->num_blk);

317 
d¡
->
åg_sz
 = 
	`Ë16_to_ýu
(
¤c
->fpg_sz);

318 
d¡
->
c£cs
 = 
	`Ë16_to_ýu
(
¤c
->csecs);

319 
d¡
->
sos
 = 
	`Ë16_to_ýu
(
¤c
->sos);

321 
d¡
->
Œdt
 = 
	`Ë32_to_ýu
(
¤c
->trdt);

322 
d¡
->
Œdm
 = 
	`Ë32_to_ýu
(
¤c
->trdm);

323 
d¡
->
¹
 = 
	`Ë32_to_ýu
(
¤c
->tprt);

324 
d¡
->
rm
 = 
	`Ë32_to_ýu
(
¤c
->tprm);

325 
d¡
->
tb‘
 = 
	`Ë32_to_ýu
(
¤c
->tbet);

326 
d¡
->
tbem
 = 
	`Ë32_to_ýu
(
¤c
->tbem);

327 
d¡
->
mpos
 = 
	`Ë32_to_ýu
(
¤c
->mpos);

328 
d¡
->
mcÿp
 = 
	`Ë32_to_ýu
(
¤c
->mccap);

330 
d¡
->
ý¬
 = 
	`Ë16_to_ýu
(
¤c
->cpar);

332 ià(
d¡
->
fmty³
 =ð
NVM_ID_FMTYPE_MLC
) {

333 
	`memýy
(
d¡
->
Ítbl
.
id
, 
¤c
->lptbl.id, 8);

334 
d¡
->
Ítbl
.
mlc
.
num_·œs
 =

335 
	`Ë16_to_ýu
(
¤c
->
Ítbl
.
mlc
.
num_·œs
);

337 if(
d¡
->
Ítbl
.
mlc
.
num_·œs
 > 
NVME_NVM_LP_MLC_PAIRS
) {

338 
	`´_”r
("nvm:‚umber of MLC…airs‚ot supported\n");

339  -
EINVAL
;

342 
	`memýy
(
d¡
->
Ítbl
.
mlc
.
·œs
, 
¤c
->lptbl.mlc.pairs,

343 
d¡
->
Ítbl
.
mlc
.
num_·œs
);

349 
	}
}

351 
	$nvme_nvm_id’t™y
(
nvm_dev
 *
nvmdev
, 
nvm_id
 *nvm_id)

353 
nvme_ns
 *
ns
 = 
nvmdev
->
q
->
queued©a
;

354 
nvme_nvm_id
 *nvme_nvm_id;

355 
nvme_nvm_commªd
 
c
 = {};

356 
»t
;

358 
c
.
id’t™y
.
Ýcode
 = 
nvme_nvm_admš_id’t™y
;

359 
c
.
id’t™y
.
nsid
 = 
	`ýu_to_Ë32
(
ns
->
h—d
->
ns_id
);

360 
c
.
id’t™y
.
chÆ_off
 = 0;

362 
nvme_nvm_id
 = 
	`km®loc
((nvme_nvm_id), 
GFP_KERNEL
);

363 ià(!
nvme_nvm_id
)

364  -
ENOMEM
;

366 
»t
 = 
	`nvme_subm™_sync_cmd
(
ns
->
ù¾
->
admš_q
, (
nvme_commªd
 *)&
c
,

367 
nvme_nvm_id
, (nvme_nvm_id));

368 ià(
»t
) {

369 
»t
 = -
EIO
;

370 
out
;

373 
nvm_id
->
v”_id
 = 
nvme_nvm_id
->ver_id;

374 
nvm_id
->
vmÁ
 = 
nvme_nvm_id
->vmnt;

375 #iâdeà
HAVE_LIGHTNVM_NVM_ID_GRP


376 
nvm_id
->
cg½s
 = 
nvme_nvm_id
->cgrps;

378 
nvm_id
->
ÿp
 = 
	`Ë32_to_ýu
(
nvme_nvm_id
->cap);

379 
nvm_id
->
dom
 = 
	`Ë32_to_ýu
(
nvme_nvm_id
->dom);

380 
	`memýy
(&
nvm_id
->
µaf
, &
nvme_nvm_id
->ppaf,

381 (
nvm_addr_fÜm©
));

383 
»t
 = 
	`š™_g½s
(
nvm_id
, 
nvme_nvm_id
);

384 
out
:

385 
	`kä“
(
nvme_nvm_id
);

386  
»t
;

387 
	}
}

389 
	$nvme_nvm_g‘_l2p_tbl
(
nvm_dev
 *
nvmdev
, 
u64
 
¦ba
, 
u32
 
Æb
,

390 
nvm_l2p_upd©e_â
 *
upd©e_l2p
, *
´iv
)

392 
nvme_ns
 *
ns
 = 
nvmdev
->
q
->
queued©a
;

393 
nvme_nvm_commªd
 
c
 = {};

394 
u32
 
Ën
 = 
	`queue_max_hw_£ùÜs
(
ns
->
ù¾
->
admš_q
) << 9;

395 
u32
 
Æb_´_rq
 = 
Ën
 / (
u64
);

396 
u64
 
cmd_¦ba
 = 
¦ba
;

397 *
’Œ›s
;

398 
»t
 = 0;

400 
c
.
l2p
.
Ýcode
 = 
nvme_nvm_admš_g‘_l2p_tbl
;

401 
c
.
l2p
.
nsid
 = 
	`ýu_to_Ë32
(
ns
->
h—d
->
ns_id
);

402 
’Œ›s
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

403 ià(!
’Œ›s
)

404  -
ENOMEM
;

406 
Æb
) {

407 
u32
 
cmd_Æb
 = 
	`mš
(
Æb_´_rq
, 
Æb
);

408 
u64
 
–ba
 = 
¦ba
 + 
cmd_Æb
;

410 
c
.
l2p
.
¦ba
 = 
	`ýu_to_Ë64
(
cmd_¦ba
);

411 
c
.
l2p
.
Æb
 = 
	`ýu_to_Ë32
(
cmd_Æb
);

413 
»t
 = 
	`nvme_subm™_sync_cmd
(
ns
->
ù¾
->
admš_q
,

414 (
nvme_commªd
 *)&
c
, 
’Œ›s
, 
Ën
);

415 ià(
»t
) {

416 
	`dev_”r
(
ns
->
ù¾
->
deviû
,

417 "L2PabË¿nsã¸çžed (%d)\n", 
»t
);

418 
»t
 = -
EIO
;

419 
out
;

422 ià(
	`uÆik–y
(
–ba
 > 
nvmdev
->
tÙ®_£cs
)) {

423 
	`´_”r
("nvm: L2P data from device is out of bounds!\n");

424 
»t
 = -
EINVAL
;

425 
out
;

428 #ifdeà
HAVE_NVMM_TYPE_HAS_PART_TO_TGT


430 
	`nvm_·¹_to_tgt
(
nvmdev
, 
’Œ›s
, 
cmd_Æb
);

433 ià(
	`upd©e_l2p
(
cmd_¦ba
, 
cmd_Æb
, 
’Œ›s
, 
´iv
)) {

434 
»t
 = -
EINTR
;

435 
out
;

438 
cmd_¦ba
 +ð
cmd_Æb
;

439 
Æb
 -ð
cmd_Æb
;

442 
out
:

443 
	`kä“
(
’Œ›s
);

444  
»t
;

445 
	}
}

447 
	$nvme_nvm_g‘_bb_tbl
(
nvm_dev
 *
nvmdev
, 
µa_addr
 
µa
,

448 
u8
 *
blks
)

450 
»que¡_queue
 *
q
 = 
nvmdev
->q;

451 #ifdeà
HAVE_NVM_GEO


452 
nvm_geo
 *
geo
 = &
nvmdev
->geo;

454 
nvme_ns
 *
ns
 = 
q
->
queued©a
;

455 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

456 
nvme_nvm_commªd
 
c
 = {};

457 
nvme_nvm_bb_tbl
 *
bb_tbl
;

458 #ifdeà
HAVE_NVM_GEO


459 
Ä_blks
 = 
geo
->
blks_³r_lun
 * geo->
¶ªe_mode
;

461 
Ä_blks
 = 
nvmdev
->
blks_³r_lun
 *‚vmdev->
¶ªe_mode
;

463 
tblsz
 = (
nvme_nvm_bb_tbl
è+ 
Ä_blks
;

464 
»t
 = 0;

466 
c
.
g‘_bb
.
Ýcode
 = 
nvme_nvm_admš_g‘_bb_tbl
;

467 
c
.
g‘_bb
.
nsid
 = 
	`ýu_to_Ë32
(
ns
->
h—d
->
ns_id
);

468 
c
.
g‘_bb
.
¥ba
 = 
	`ýu_to_Ë64
(
µa
.ppa);

470 
bb_tbl
 = 
	`kz®loc
(
tblsz
, 
GFP_KERNEL
);

471 ià(!
bb_tbl
)

472  -
ENOMEM
;

474 
»t
 = 
	`nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, (
nvme_commªd
 *)&
c
,

475 
bb_tbl
, 
tblsz
);

476 ià(
»t
) {

477 
	`dev_”r
(
ù¾
->
deviû
, "g‘ bad blockabË fažed (%d)\n", 
»t
);

478 
»t
 = -
EIO
;

479 
out
;

482 ià(
bb_tbl
->
tblid
[0] != 'B' || bb_tbl->tblid[1] != 'B' ||

483 
bb_tbl
->
tblid
[2] != 'L' || bb_tbl->tblid[3] != 'T') {

484 
	`dev_”r
(
ù¾
->
deviû
, "bbt format mismatch\n");

485 
»t
 = -
EINVAL
;

486 
out
;

489 ià(
	`Ë16_to_ýu
(
bb_tbl
->
v”id
) != 1) {

490 
»t
 = -
EINVAL
;

491 
	`dev_”r
(
ù¾
->
deviû
, "bbt version‚ot supported\n");

492 
out
;

495 ià(
	`Ë32_to_ýu
(
bb_tbl
->
tblks
è!ð
Ä_blks
) {

496 
»t
 = -
EINVAL
;

497 
	`dev_”r
(
ù¾
->
deviû
,

499 
	`Ë32_to_ýu
(
bb_tbl
->
tblks
), 
Ä_blks
);

500 
out
;

503 #ifdeà
HAVE_NVM_GEO


504 
	`memýy
(
blks
, 
bb_tbl
->
blk
, 
geo
->
blks_³r_lun
 * geo->
¶ªe_mode
);

506 
	`memýy
(
blks
, 
bb_tbl
->
blk
, 
nvmdev
->
blks_³r_lun
 *‚vmdev->
¶ªe_mode
);

508 
out
:

509 
	`kä“
(
bb_tbl
);

510  
»t
;

511 
	}
}

513 
	$nvme_nvm_£t_bb_tbl
(
nvm_dev
 *
nvmdev
, 
µa_addr
 *
µas
,

514 
Ä_µas
, 
ty³
)

516 
nvme_ns
 *
ns
 = 
nvmdev
->
q
->
queued©a
;

517 
nvme_nvm_commªd
 
c
 = {};

518 
»t
 = 0;

520 
c
.
£t_bb
.
Ýcode
 = 
nvme_nvm_admš_£t_bb_tbl
;

521 
c
.
£t_bb
.
nsid
 = 
	`ýu_to_Ë32
(
ns
->
h—d
->
ns_id
);

522 
c
.
£t_bb
.
¥ba
 = 
	`ýu_to_Ë64
(
µas
->
µa
);

523 
c
.
£t_bb
.
Æb
 = 
	`ýu_to_Ë16
(
Ä_µas
 - 1);

524 
c
.
£t_bb
.
v®ue
 = 
ty³
;

526 
»t
 = 
	`nvme_subm™_sync_cmd
(
ns
->
ù¾
->
admš_q
, (
nvme_commªd
 *)&
c
,

527 
NULL
, 0);

528 ià(
»t
)

529 
	`dev_”r
(
ns
->
ù¾
->
deviû
, "set bad blockable failed (%d)\n",

530 
»t
);

531  
»t
;

532 
	}
}

534 
šlše
 
	$nvme_nvm_rqtocmd
(
nvm_rq
 *
rqd
, 
nvme_ns
 *
ns
,

535 
nvme_nvm_commªd
 *
c
)

537 
c
->
ph_rw
.
Ýcode
 = 
rqd
->opcode;

538 
c
->
ph_rw
.
nsid
 = 
	`ýu_to_Ë32
(
ns
->
h—d
->
ns_id
);

539 
c
->
ph_rw
.
¥ba
 = 
	`ýu_to_Ë64
(
rqd
->
µa_addr
.
µa
);

540 
c
->
ph_rw
.
m‘ad©a
 = 
	`ýu_to_Ë64
(
rqd
->
dma_m‘a_li¡
);

541 
c
->
ph_rw
.
cÚŒÞ
 = 
	`ýu_to_Ë16
(
rqd
->
æags
);

542 
c
->
ph_rw
.
Ëngth
 = 
	`ýu_to_Ë16
(
rqd
->
Ä_µas
 - 1);

544 ià(
rqd
->
Ýcode
 =ð
NVM_OP_HBWRITE
 ||„qd->Ýcod=ð
NVM_OP_HBREAD
)

545 
c
->
hb_rw
.
¦ba
 = 
	`ýu_to_Ë64
(
	`nvme_block_Ä
(
ns
,

546 
rqd
->
bio
->
bi_™”
.
bi_£ùÜ
));

547 
	}
}

549 
	$nvme_nvm_’d_io
(
»que¡
 *
rq
, 
blk_¡©us_t
 
¡©us
)

551 
nvm_rq
 *
rqd
 = 
rq
->
’d_io_d©a
;

553 
rqd
->
µa_¡©us
 = 
	`Ë64_to_ýu
(
	`nvme_»q
(
rq
)->
»suÉ
.
u64
);

554 #ifdeà
HAVE_NVM_END_IO_1_PARAM


555 
rqd
->
”rÜ
 = 
	`nvme_»q
(
rq
)->
¡©us
;

556 
	`nvm_’d_io
(
rqd
);

558 
	`nvm_’d_io
(
rqd
, 
	`nvme_»q
(
rq
)->
¡©us
);

561 
	`kä“
(
	`nvme_»q
(
rq
)->
cmd
);

562 
	`blk_mq_ä“_»que¡
(
rq
);

563 
	}
}

565 
»que¡
 *
	$nvme_nvm_®loc_»que¡
(
»que¡_queue
 *
q
,

566 
nvm_rq
 *
rqd
,

567 
nvme_nvm_commªd
 *
cmd
)

569 
nvme_ns
 *
ns
 = 
q
->
queued©a
;

570 
»que¡
 *
rq
;

572 
	`nvme_nvm_rqtocmd
(
rqd
, 
ns
, 
cmd
);

574 
rq
 = 
	`nvme_®loc_»que¡
(
q
, (
nvme_commªd
 *)
cmd
, 0, 
NVME_QID_ANY
);

575 ià(
	`IS_ERR
(
rq
))

576  
rq
;

578 
rq
->
cmd_æags
 &ð~
REQ_FAILFAST_DRIVER
;

580 ià(
rqd
->
bio
) {

581 #ifdeà
HAVE_BLK_INIT_REQUEST_FROM_BIO


582 
	`blk_š™_»que¡_äom_bio
(
rq
, 
rqd
->
bio
);

584 
rq
->
iÝrio
 = 
	`bio_´io
(
rqd
->
bio
);

585 
rq
->
__d©a_Ën
 = 
rqd
->
bio
->
bi_™”
.
bi_size
;

586 
rq
->
bio
 =„q->
biÙaž
 = 
rqd
->bio;

587 ià(
	`bio_has_d©a
(
rqd
->
bio
))

588 
rq
->
Ä_phys_£gm’ts
 = 
	`bio_phys_£gm’ts
(
q
, 
rqd
->
bio
);

591 
rq
->
iÝrio
 = 
	`IOPRIO_PRIO_VALUE
(
IOPRIO_CLASS_BE
, 
IOPRIO_NORM
);

592 
rq
->
__d©a_Ën
 = 0;

595  
rq
;

596 
	}
}

598 
	$nvme_nvm_subm™_io
(
nvm_dev
 *
dev
, 
nvm_rq
 *
rqd
)

600 
»que¡_queue
 *
q
 = 
dev
->q;

601 
nvme_nvm_commªd
 *
cmd
;

602 
»que¡
 *
rq
;

604 
cmd
 = 
	`kz®loc
((
nvme_nvm_commªd
), 
GFP_KERNEL
);

605 ià(!
cmd
)

606  -
ENOMEM
;

608 
rq
 = 
	`nvme_nvm_®loc_»que¡
(
q
, 
rqd
, 
cmd
);

609 ià(
	`IS_ERR
(
rq
)) {

610 
	`kä“
(
cmd
);

611  
	`PTR_ERR
(
rq
);

614 
rq
->
’d_io_d©a
 = 
rqd
;

616 
	`blk_execu‹_rq_nowa™
(
q
, 
NULL
, 
rq
, 0, 
nvme_nvm_’d_io
);

619 
	}
}

621 #ifdeà
HAVE_NVM_DEV_OPS_SUBMIT_IO_SYNC


622 
	$nvme_nvm_subm™_io_sync
(
nvm_dev
 *
dev
, 
nvm_rq
 *
rqd
)

624 
»que¡_queue
 *
q
 = 
dev
->q;

625 
»que¡
 *
rq
;

626 
nvme_nvm_commªd
 
cmd
;

627 
»t
 = 0;

629 
	`mem£t
(&
cmd
, 0, (
nvme_nvm_commªd
));

631 
rq
 = 
	`nvme_nvm_®loc_»que¡
(
q
, 
rqd
, &
cmd
);

632 ià(
	`IS_ERR
(
rq
))

633  
	`PTR_ERR
(
rq
);

638 
	`blk_execu‹_rq
(
q
, 
NULL
, 
rq
, 0);

639 ià(
	`nvme_»q
(
rq
)->
æags
 & 
NVME_REQ_CANCELLED
)

640 
»t
 = -
EINTR
;

642 
rqd
->
µa_¡©us
 = 
	`Ë64_to_ýu
(
	`nvme_»q
(
rq
)->
»suÉ
.
u64
);

643 
rqd
->
”rÜ
 = 
	`nvme_»q
(
rq
)->
¡©us
;

645 
	`blk_mq_ä“_»que¡
(
rq
);

647  
»t
;

648 
	}
}

651 *
	$nvme_nvm_ü—‹_dma_poÞ
(
nvm_dev
 *
nvmdev
, *
Çme
)

653 
nvme_ns
 *
ns
 = 
nvmdev
->
q
->
queued©a
;

655  
	`dma_poÞ_ü—‹
(
Çme
, 
ns
->
ù¾
->
dev
, 
PAGE_SIZE
, PAGE_SIZE, 0);

656 
	}
}

658 
	$nvme_nvm_de¡roy_dma_poÞ
(*
poÞ
)

660 
dma_poÞ
 *dma_poÞ = 
poÞ
;

662 
	`dma_poÞ_de¡roy
(
dma_poÞ
);

663 
	}
}

665 *
	$nvme_nvm_dev_dma_®loc
(
nvm_dev
 *
dev
, *
poÞ
,

666 
gå_t
 
mem_æags
, 
dma_addr_t
 *
dma_hªdËr
)

668  
	`dma_poÞ_®loc
(
poÞ
, 
mem_æags
, 
dma_hªdËr
);

669 
	}
}

671 
	$nvme_nvm_dev_dma_ä“
(*
poÞ
, *
addr
,

672 
dma_addr_t
 
dma_hªdËr
)

674 
	`dma_poÞ_ä“
(
poÞ
, 
addr
, 
dma_hªdËr
);

675 
	}
}

677 
nvm_dev_Ýs
 
	gnvme_nvm_dev_Ýs
 = {

678 .
id’t™y
 = 
nvme_nvm_id’t™y
,

680 .
	gg‘_l2p_tbl
 = 
nvme_nvm_g‘_l2p_tbl
,

682 .
	gg‘_bb_tbl
 = 
nvme_nvm_g‘_bb_tbl
,

683 .
	g£t_bb_tbl
 = 
nvme_nvm_£t_bb_tbl
,

685 .
	gsubm™_io
 = 
nvme_nvm_subm™_io
,

686 #ifdeà
HAVE_NVM_DEV_OPS_SUBMIT_IO_SYNC


687 .
	gsubm™_io_sync
 = 
nvme_nvm_subm™_io_sync
,

690 .
	gü—‹_dma_poÞ
 = 
nvme_nvm_ü—‹_dma_poÞ
,

691 .
	gde¡roy_dma_poÞ
 = 
nvme_nvm_de¡roy_dma_poÞ
,

692 .
	gdev_dma_®loc
 = 
nvme_nvm_dev_dma_®loc
,

693 .
	gdev_dma_ä“
 = 
nvme_nvm_dev_dma_ä“
,

695 .
	gmax_phys_£ù
 = 64,

698 #ifdeà
HAVE_NVM_USER_VIO


699 
	$nvme_nvm_subm™_u£r_cmd
(
»que¡_queue
 *
q
,

700 
nvme_ns
 *
ns
,

701 
nvme_nvm_commªd
 *
vcmd
,

702 
__u£r
 *
ubuf
, 
bufæ’
,

703 
__u£r
 *
m‘a_buf
, 
m‘a_Ën
,

704 
__u£r
 *
µa_buf
, 
µa_Ën
,

705 
u32
 *
»suÉ
, 
u64
 *
¡©us
, 
timeout
)

707 
boÞ
 
wr™e
 = 
	`nvme_is_wr™e
((
nvme_commªd
 *)
vcmd
);

708 
nvm_dev
 *
dev
 = 
ns
->
ndev
;

709 
g’disk
 *
disk
 = 
ns
->disk;

710 
»que¡
 *
rq
;

711 
bio
 *biØð
NULL
;

712 
__Ë64
 *
µa_li¡
 = 
NULL
;

713 
dma_addr_t
 
µa_dma
;

714 
__Ë64
 *
m‘ad©a
 = 
NULL
;

715 
dma_addr_t
 
m‘ad©a_dma
;

716 
	`DECLARE_COMPLETION_ONSTACK
(
wa™
);

717 
»t
 = 0;

719 
rq
 = 
	`nvme_®loc_»que¡
(
q
, (
nvme_commªd
 *)
vcmd
, 0,

720 
NVME_QID_ANY
);

721 ià(
	`IS_ERR
(
rq
)) {

722 
»t
 = -
ENOMEM
;

723 
”r_cmd
;

726 
rq
->
timeout
 =imeouˆ?imeouˆ: 
ADMIN_TIMEOUT
;

728 ià(
µa_buf
 && 
µa_Ën
) {

729 
µa_li¡
 = 
	`dma_poÞ_®loc
(
dev
->
dma_poÞ
, 
GFP_KERNEL
, &
µa_dma
);

730 ià(!
µa_li¡
) {

731 
»t
 = -
ENOMEM
;

732 
”r_rq
;

734 ià(
	`cÝy_äom_u£r
(
µa_li¡
, (
__u£r
 *)
µa_buf
,

735 (
u64
è* (
µa_Ën
 + 1))) {

736 
»t
 = -
EFAULT
;

737 
”r_µa
;

739 
vcmd
->
ph_rw
.
¥ba
 = 
	`ýu_to_Ë64
(
µa_dma
);

741 
vcmd
->
ph_rw
.
¥ba
 = 
	`ýu_to_Ë64
((
ušŒ_t
)
µa_buf
);

744 ià(
ubuf
 && 
bufæ’
) {

745 
»t
 = 
	`blk_rq_m­_u£r
(
q
, 
rq
, 
NULL
, 
ubuf
, 
bufæ’
, 
GFP_KERNEL
);

746 ià(
»t
)

747 
”r_µa
;

748 
bio
 = 
rq
->bio;

750 ià(
m‘a_buf
 && 
m‘a_Ën
) {

751 
m‘ad©a
 = 
	`dma_poÞ_®loc
(
dev
->
dma_poÞ
, 
GFP_KERNEL
,

752 &
m‘ad©a_dma
);

753 ià(!
m‘ad©a
) {

754 
»t
 = -
ENOMEM
;

755 
”r_m­
;

758 ià(
wr™e
) {

759 ià(
	`cÝy_äom_u£r
(
m‘ad©a
,

760 (
__u£r
 *)
m‘a_buf
,

761 
m‘a_Ën
)) {

762 
»t
 = -
EFAULT
;

763 
”r_m‘a
;

766 
vcmd
->
ph_rw
.
m‘ad©a
 = 
	`ýu_to_Ë64
(
m‘ad©a_dma
);

769 #ifdeà
HAVE_BIO_BI_DISK


770 
bio
->
bi_disk
 = 
disk
;

772 ià(!
disk
)

773 
subm™
;

775 
bio
->
bi_bdev
 = 
	`bdg‘_disk
(
disk
, 0);

776 ià(!
bio
->
bi_bdev
) {

777 
»t
 = -
ENODEV
;

778 
”r_m‘a
;

783 #iâdeà
HAVE_BIO_BI_DISK


784 
subm™
:

786 
	`blk_execu‹_rq
(
q
, 
NULL
, 
rq
, 0);

788 ià(
	`nvme_»q
(
rq
)->
æags
 & 
NVME_REQ_CANCELLED
)

789 
»t
 = -
EINTR
;

790 ià(
	`nvme_»q
(
rq
)->
¡©us
 & 0x7ff)

791 
»t
 = -
EIO
;

792 ià(
»suÉ
)

793 *
»suÉ
 = 
	`nvme_»q
(
rq
)->
¡©us
 & 0x7ff;

794 ià(
¡©us
)

795 *
¡©us
 = 
	`Ë64_to_ýu
(
	`nvme_»q
(
rq
)->
»suÉ
.
u64
);

797 ià(
m‘ad©a
 && !
»t
 && !
wr™e
) {

798 ià(
	`cÝy_to_u£r
(
m‘a_buf
, (*)
m‘ad©a
, 
m‘a_Ën
))

799 
»t
 = -
EFAULT
;

801 
”r_m‘a
:

802 ià(
m‘a_buf
 && 
m‘a_Ën
)

803 
	`dma_poÞ_ä“
(
dev
->
dma_poÞ
, 
m‘ad©a
, 
m‘ad©a_dma
);

804 
”r_m­
:

805 #ifdeà
HAVE_BIO_BI_DISK


806 ià(
bio
)

807 
	`blk_rq_unm­_u£r
(
bio
);

809 ià(
bio
) {

810 ià(
disk
 && 
bio
->
bi_bdev
)

811 
	`bdput
(
bio
->
bi_bdev
);

812 
	`blk_rq_unm­_u£r
(
bio
);

815 
”r_µa
:

816 ià(
µa_buf
 && 
µa_Ën
)

817 
	`dma_poÞ_ä“
(
dev
->
dma_poÞ
, 
µa_li¡
, 
µa_dma
);

818 
”r_rq
:

819 
	`blk_mq_ä“_»que¡
(
rq
);

820 
”r_cmd
:

821  
»t
;

822 
	}
}

824 
	$nvme_nvm_subm™_vio
(
nvme_ns
 *
ns
,

825 
nvm_u£r_vio
 
__u£r
 *
uvio
)

827 
nvm_u£r_vio
 
vio
;

828 
nvme_nvm_commªd
 
c
;

829 
Ëngth
;

830 
»t
;

832 ià(
	`cÝy_äom_u£r
(&
vio
, 
uvio
, (vio)))

833  -
EFAULT
;

834 ià(
vio
.
æags
)

835  -
EINVAL
;

837 
	`mem£t
(&
c
, 0, (c));

838 
c
.
ph_rw
.
Ýcode
 = 
vio
.opcode;

839 
c
.
ph_rw
.
nsid
 = 
	`ýu_to_Ë32
(
ns
->
h—d
->
ns_id
);

840 
c
.
ph_rw
.
cÚŒÞ
 = 
	`ýu_to_Ë16
(
vio
.control);

841 
c
.
ph_rw
.
Ëngth
 = 
	`ýu_to_Ë16
(
vio
.
Å·s
);

843 
Ëngth
 = (
vio
.
Å·s
 + 1è<< 
ns
->
lba_shiá
;

845 
»t
 = 
	`nvme_nvm_subm™_u£r_cmd
(
ns
->
queue
,‚s, &
c
,

846 (
__u£r
 *)(
ušŒ_t
)
vio
.
addr
, 
Ëngth
,

847 (
__u£r
 *)(
ušŒ_t
)
vio
.
m‘ad©a
,

848 
vio
.
m‘ad©a_Ën
,

849 (
__u£r
 *)(
ušŒ_t
)
vio
.
µa_li¡
, vio.
Å·s
,

850 &
vio
.
»suÉ
, &vio.
¡©us
, 0);

852 ià(
»t
 && 
	`cÝy_to_u£r
(
uvio
, &
vio
, (vio)))

853  -
EFAULT
;

855  
»t
;

856 
	}
}

858 
	$nvme_nvm_u£r_vcmd
(
nvme_ns
 *
ns
, 
admš
,

859 
nvm_·s¡hru_vio
 
__u£r
 *
uvcmd
)

861 
nvm_·s¡hru_vio
 
vcmd
;

862 
nvme_nvm_commªd
 
c
;

863 
»que¡_queue
 *
q
;

864 
timeout
 = 0;

865 
»t
;

867 ià(
	`cÝy_äom_u£r
(&
vcmd
, 
uvcmd
, (vcmd)))

868  -
EFAULT
;

869 ià((
vcmd
.
Ýcode
 !ð0xF2è&& (!
	`ÿ·bË
(
CAP_SYS_ADMIN
)))

870  -
EACCES
;

871 ià(
vcmd
.
æags
)

872  -
EINVAL
;

874 
	`mem£t
(&
c
, 0, (c));

875 
c
.
commÚ
.
Ýcode
 = 
vcmd
.opcode;

876 
c
.
commÚ
.
nsid
 = 
	`ýu_to_Ë32
(
ns
->
h—d
->
ns_id
);

877 
c
.
commÚ
.
cdw2
[0] = 
	`ýu_to_Ë32
(
vcmd
.cdw2);

878 
c
.
commÚ
.
cdw2
[1] = 
	`ýu_to_Ë32
(
vcmd
.
cdw3
);

880 
c
.
ph_rw
.
Ëngth
 = 
	`ýu_to_Ë16
(
vcmd
.
Å·s
);

881 
c
.
ph_rw
.
cÚŒÞ
 = 
	`ýu_to_Ë16
(
vcmd
.control);

882 
c
.
commÚ
.
cdw10
[3] = 
	`ýu_to_Ë32
(
vcmd
.
cdw13
);

883 
c
.
commÚ
.
cdw10
[4] = 
	`ýu_to_Ë32
(
vcmd
.
cdw14
);

884 
c
.
commÚ
.
cdw10
[5] = 
	`ýu_to_Ë32
(
vcmd
.
cdw15
);

886 ià(
vcmd
.
timeout_ms
)

887 
timeout
 = 
	`m£cs_to_jiff›s
(
vcmd
.
timeout_ms
);

889 
q
 = 
admš
 ? 
ns
->
ù¾
->
admš_q
 :‚s->
queue
;

891 
»t
 = 
	`nvme_nvm_subm™_u£r_cmd
(
q
, 
ns
,

892 (
nvme_nvm_commªd
 *)&
c
,

893 (
__u£r
 *)(
ušŒ_t
)
vcmd
.
addr
, vcmd.
d©a_Ën
,

894 (
__u£r
 *)(
ušŒ_t
)
vcmd
.
m‘ad©a
,

895 
vcmd
.
m‘ad©a_Ën
,

896 (
__u£r
 *)(
ušŒ_t
)
vcmd
.
µa_li¡
, vcmd.
Å·s
,

897 &
vcmd
.
»suÉ
, &vcmd.
¡©us
, 
timeout
);

899 ià(
»t
 && 
	`cÝy_to_u£r
(
uvcmd
, &
vcmd
, (vcmd)))

900  -
EFAULT
;

902  
»t
;

903 
	}
}

905 
	$nvme_nvm_ioùl
(
nvme_ns
 *
ns
, 
cmd
, 
¬g
)

907 
cmd
) {

908 
NVME_NVM_IOCTL_ADMIN_VIO
:

909  
	`nvme_nvm_u£r_vcmd
(
ns
, 1, (
__u£r
 *)
¬g
);

910 
NVME_NVM_IOCTL_IO_VIO
:

911  
	`nvme_nvm_u£r_vcmd
(
ns
, 0, (
__u£r
 *)
¬g
);

912 
NVME_NVM_IOCTL_SUBMIT_VIO
:

913  
	`nvme_nvm_subm™_vio
(
ns
, (
__u£r
 *)
¬g
);

915  -
ENOTTY
;

917 
	}
}

920 
	$nvme_nvm_»gi¡”
(
nvme_ns
 *
ns
, *
disk_Çme
, 
node
)

922 
»que¡_queue
 *
q
 = 
ns
->
queue
;

923 
nvm_dev
 *
dev
;

925 
	`_nvme_nvm_check_size
();

927 
dev
 = 
	`nvm_®loc_dev
(
node
);

928 ià(!
dev
)

929  -
ENOMEM
;

931 
dev
->
q
 = q;

932 
	`memýy
(
dev
->
Çme
, 
disk_Çme
, 
DISK_NAME_LEN
);

933 
dev
->
Ýs
 = &
nvme_nvm_dev_Ýs
;

934 
dev
->
´iv©e_d©a
 = 
ns
;

935 
ns
->
ndev
 = 
dev
;

937  
	`nvm_»gi¡”
(
dev
);

938 
	}
}

940 
	$nvme_nvm_uÄegi¡”
(
nvme_ns
 *
ns
)

942 
	`nvm_uÄegi¡”
(
ns
->
ndev
);

943 
	}
}

945 
ssize_t
 
	$nvm_dev_©Œ_show
(
deviû
 *
dev
,

946 
deviû_©Œibu‹
 *
d©Œ
, *
·ge
)

948 
nvme_ns
 *
ns
 = 
	`nvme_g‘_ns_äom_dev
(
dev
);

949 
nvm_dev
 *
ndev
 = 
ns
->ndev;

950 
nvm_id
 *
id
;

951 
nvm_id_group
 *
g½
;

952 
©Œibu‹
 *
©Œ
;

954 ià(!
ndev
)

957 
id
 = &
ndev
->
id’t™y
;

958 #ifdeà
HAVE_LIGHTNVM_NVM_ID_GRP


959 
g½
 = &
id
->grp;

961 
g½
 = &
id
->
groups
[0];

963 
©Œ
 = &
d©Œ
->attr;

965 ià(
	`¡rcmp
(
©Œ
->
Çme
, "version") == 0) {

966  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
id
->
v”_id
);

967 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "vendor_opcode") == 0) {

968  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
id
->
vmÁ
);

969 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "capabilities") == 0) {

970  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
id
->
ÿp
);

971 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "device_mode") == 0) {

972  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
id
->
dom
);

974 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "media_manager") == 0) {

975  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%s\n", "gennvm");

976 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "ppa_format") == 0) {

977  
	`sú´štf
(
·ge
, 
PAGE_SIZE
,

979 
id
->
µaf
.
ch_off£t
, id->µaf.
ch_Ën
,

980 
id
->
µaf
.
lun_off£t
, id->µaf.
lun_Ën
,

981 
id
->
µaf
.
¶n_off£t
, id->µaf.
¶n_Ën
,

982 
id
->
µaf
.
blk_off£t
, id->µaf.
blk_Ën
,

983 
id
->
µaf
.
pg_off£t
, id->µaf.
pg_Ën
,

984 
id
->
µaf
.
£ù_off£t
, id->µaf.
£ù_Ën
);

985 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "media_type") == 0) {

986  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
mty³
);

987 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "flash_media_type") == 0) {

988  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
fmty³
);

989 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "num_channels") == 0) {

990  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
num_ch
);

991 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "num_luns") == 0) {

992  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
num_lun
);

993 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "num_planes") == 0) {

994  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
num_¶n
);

995 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "num_blocks") == 0) {

996  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
num_blk
);

997 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "num_pages") == 0) {

998  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
num_pg
);

999 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "page_size") == 0) {

1000  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
åg_sz
);

1001 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "hw_sector_size") == 0) {

1002  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
c£cs
);

1003 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "oob_sector_size") == 0) {

1004  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
sos
);

1005 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "read_typ") == 0) {

1006  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
Œdt
);

1007 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "read_max") == 0) {

1008  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
Œdm
);

1009 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "prog_typ") == 0) {

1010  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
¹
);

1011 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "prog_max") == 0) {

1012  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
rm
);

1013 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "erase_typ") == 0) {

1014  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
tb‘
);

1015 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "erase_max") == 0) {

1016  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
tbem
);

1017 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "multiplane_modes") == 0) {

1018  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "0x%08x\n", 
g½
->
mpos
);

1019 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "media_capabilities") == 0) {

1020  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "0x%08x\n", 
g½
->
mcÿp
);

1021 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "max_phys_secs") == 0) {

1022  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n",

1023 
ndev
->
Ýs
->
max_phys_£ù
);

1025  
	`sú´štf
(
·ge
,

1026 
PAGE_SIZE
,

1028 
©Œ
->
Çme
);

1030 
	}
}

1032 
	#NVM_DEV_ATTR_RO
(
_Çme
) \

1033 
	`DEVICE_ATTR
(
_Çme
, 
S_IRUGO
, 
nvm_dev_©Œ_show
, 
NULL
)

	)

1035 
NVM_DEV_ATTR_RO
(
v”siÚ
);

1036 
NVM_DEV_ATTR_RO
(
v’dÜ_Ýcode
);

1037 
NVM_DEV_ATTR_RO
(
ÿ·bž™›s
);

1038 
NVM_DEV_ATTR_RO
(
deviû_mode
);

1039 
NVM_DEV_ATTR_RO
(
µa_fÜm©
);

1040 
NVM_DEV_ATTR_RO
(
medŸ_mªag”
);

1042 
NVM_DEV_ATTR_RO
(
medŸ_ty³
);

1043 
NVM_DEV_ATTR_RO
(
æash_medŸ_ty³
);

1044 
NVM_DEV_ATTR_RO
(
num_chªÃls
);

1045 
NVM_DEV_ATTR_RO
(
num_luns
);

1046 
NVM_DEV_ATTR_RO
(
num_¶ªes
);

1047 
NVM_DEV_ATTR_RO
(
num_blocks
);

1048 
NVM_DEV_ATTR_RO
(
num_·ges
);

1049 
NVM_DEV_ATTR_RO
(
·ge_size
);

1050 
NVM_DEV_ATTR_RO
(
hw_£ùÜ_size
);

1051 
NVM_DEV_ATTR_RO
(
oob_£ùÜ_size
);

1052 
NVM_DEV_ATTR_RO
(
»ad_typ
);

1053 
NVM_DEV_ATTR_RO
(
»ad_max
);

1054 
NVM_DEV_ATTR_RO
(
´og_typ
);

1055 
NVM_DEV_ATTR_RO
(
´og_max
);

1056 
NVM_DEV_ATTR_RO
(
”a£_typ
);

1057 
NVM_DEV_ATTR_RO
(
”a£_max
);

1058 
NVM_DEV_ATTR_RO
(
muÉÏÃ_modes
);

1059 
NVM_DEV_ATTR_RO
(
medŸ_ÿ·bž™›s
);

1060 
NVM_DEV_ATTR_RO
(
max_phys_£cs
);

1062 
©Œibu‹
 *
	gnvm_dev_©Œs
[] = {

1063 &
dev_©Œ_v”siÚ
.
©Œ
,

1064 &
dev_©Œ_v’dÜ_Ýcode
.
©Œ
,

1065 &
dev_©Œ_ÿ·bž™›s
.
©Œ
,

1066 &
dev_©Œ_deviû_mode
.
©Œ
,

1067 &
dev_©Œ_medŸ_mªag”
.
©Œ
,

1069 &
dev_©Œ_µa_fÜm©
.
©Œ
,

1070 &
dev_©Œ_medŸ_ty³
.
©Œ
,

1071 &
dev_©Œ_æash_medŸ_ty³
.
©Œ
,

1072 &
dev_©Œ_num_chªÃls
.
©Œ
,

1073 &
dev_©Œ_num_luns
.
©Œ
,

1074 &
dev_©Œ_num_¶ªes
.
©Œ
,

1075 &
dev_©Œ_num_blocks
.
©Œ
,

1076 &
dev_©Œ_num_·ges
.
©Œ
,

1077 &
dev_©Œ_·ge_size
.
©Œ
,

1078 &
dev_©Œ_hw_£ùÜ_size
.
©Œ
,

1079 &
dev_©Œ_oob_£ùÜ_size
.
©Œ
,

1080 &
dev_©Œ_»ad_typ
.
©Œ
,

1081 &
dev_©Œ_»ad_max
.
©Œ
,

1082 &
dev_©Œ_´og_typ
.
©Œ
,

1083 &
dev_©Œ_´og_max
.
©Œ
,

1084 &
dev_©Œ_”a£_typ
.
©Œ
,

1085 &
dev_©Œ_”a£_max
.
©Œ
,

1086 &
dev_©Œ_muÉÏÃ_modes
.
©Œ
,

1087 &
dev_©Œ_medŸ_ÿ·bž™›s
.
©Œ
,

1088 &
dev_©Œ_max_phys_£cs
.
©Œ
,

1089 
NULL
,

1092 cÚ¡ 
©Œibu‹_group
 
	gnvm_dev_©Œ_group
 = {

1093 .
Çme
 = "lightnvm",

1094 .
	g©Œs
 = 
nvm_dev_©Œs
,

1097 
	$nvme_nvm_»gi¡”_sysfs
(
nvme_ns
 *
ns
)

1099  
	`sysfs_ü—‹_group
(&
	`disk_to_dev
(
ns
->
disk
)->
kobj
,

1100 &
nvm_dev_©Œ_group
);

1101 
	}
}

1103 
	$nvme_nvm_uÄegi¡”_sysfs
(
nvme_ns
 *
ns
)

1105 
	`sysfs_»move_group
(&
	`disk_to_dev
(
ns
->
disk
)->
kobj
,

1106 &
nvm_dev_©Œ_group
);

1107 
	}
}

	@multipath.c

14 
	~<lšux/moduË·¿m.h
>

15 
	~"nvme.h
"

17 
boÞ
 
	gmuÉ©h
 = 
Œue
;

18 
moduË_·¿m
(
muÉ©h
, 
boÞ
, 0444);

19 
MODULE_PARM_DESC
(
muÉ©h
,

29 
	$nvme_£t_disk_Çme
(*
disk_Çme
, 
nvme_ns
 *
ns
,

30 
nvme_ù¾
 *
ù¾
, *
æags
)

32 ià(!
muÉ©h
) {

33 
	`¥rštf
(
disk_Çme
, "nvme%dn%d", 
ù¾
->
š¡ªû
, 
ns
->
h—d
->instance);

34 } ià(
ns
->
h—d
->
disk
) {

35 
	`¥rštf
(
disk_Çme
, "nvme%dc%dn%d", 
ù¾
->
subsys
->
š¡ªû
,

36 
ù¾
->
úŽid
, 
ns
->
h—d
->
š¡ªû
);

37 *
æags
 = 
GENHD_FL_HIDDEN
;

39 
	`¥rštf
(
disk_Çme
, "nvme%dn%d", 
ù¾
->
subsys
->
š¡ªû
,

40 
ns
->
h—d
->
š¡ªû
);

42 
	}
}

44 
	$nvme_çžov”_»q
(
»que¡
 *
»q
)

46 
nvme_ns
 *
ns
 = 
»q
->
q
->
queued©a
;

47 
æags
;

49 
	`¥š_lock_œq§ve
(&
ns
->
h—d
->
»queue_lock
, 
æags
);

50 
	`blk_¡—l_bios
(&
ns
->
h—d
->
»queue_li¡
, 
»q
);

51 
	`¥š_uÆock_œq»¡Üe
(&
ns
->
h—d
->
»queue_lock
, 
æags
);

52 
	`blk_mq_’d_»que¡
(
»q
, 0);

54 
	`nvme_»£t_ù¾
(
ns
->
ù¾
);

55 
	`kblockd_scheduË_wÜk
(&
ns
->
h—d
->
»queue_wÜk
);

56 
	}
}

58 
boÞ
 
	$nvme_»q_Ãeds_çžov”
(
»que¡
 *
»q
, 
blk_¡©us_t
 
”rÜ
)

60 ià(!(
»q
->
cmd_æags
 & 
REQ_NVME_MPATH
))

61  
çl£
;

62  
	`blk_·th_”rÜ
(
”rÜ
);

63 
	}
}

65 
	$nvme_kick_»queue_li¡s
(
nvme_ù¾
 *
ù¾
)

67 
nvme_ns
 *
ns
;

69 
	`down_»ad
(&
ù¾
->
Çme¥aûs_rw£m
);

70 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
) {

71 ià(
ns
->
h—d
->
disk
)

72 
	`kblockd_scheduË_wÜk
(&
ns
->
h—d
->
»queue_wÜk
);

74 
	`up_»ad
(&
ù¾
->
Çme¥aûs_rw£m
);

75 
	}
}

77 
nvme_ns
 *
	$__nvme_fšd_·th
(
nvme_ns_h—d
 *
h—d
)

79 
nvme_ns
 *
ns
;

81 
	`li¡_fÜ_—ch_’Œy_rcu
(
ns
, &
h—d
->
li¡
, 
siblšgs
) {

82 ià(
ns
->
ù¾
->
¡©e
 =ð
NVME_CTRL_LIVE
) {

83 
	`rcu_assign_poš‹r
(
h—d
->
cu¼’t_·th
, 
ns
);

84  
ns
;

88  
NULL
;

89 
	}
}

91 
šlše
 
nvme_ns
 *
	$nvme_fšd_·th
(
nvme_ns_h—d
 *
h—d
)

93 
nvme_ns
 *
ns
 = 
	`¤cu_d”eã»nû
(
h—d
->
cu¼’t_·th
, &h—d->
¤cu
);

95 ià(
	`uÆik–y
(!
ns
 ||‚s->
ù¾
->
¡©e
 !ð
NVME_CTRL_LIVE
))

96 
ns
 = 
	`__nvme_fšd_·th
(
h—d
);

97  
ns
;

98 
	}
}

100 
blk_qc_t
 
	$nvme_ns_h—d_make_»que¡
(
»que¡_queue
 *
q
,

101 
bio
 *bio)

103 
nvme_ns_h—d
 *
h—d
 = 
q
->
queued©a
;

104 
deviû
 *
dev
 = 
	`disk_to_dev
(
h—d
->
disk
);

105 
nvme_ns
 *
ns
;

106 
blk_qc_t
 
»t
 = 
BLK_QC_T_NONE
;

107 
¤cu_idx
;

109 
¤cu_idx
 = 
	`¤cu_»ad_lock
(&
h—d
->
¤cu
);

110 
ns
 = 
	`nvme_fšd_·th
(
h—d
);

111 ià(
	`lik–y
(
ns
)) {

112 
bio
->
bi_disk
 = 
ns
->
disk
;

113 
bio
->
bi_Ýf
 |ð
REQ_NVME_MPATH
;

114 
»t
 = 
	`dœeù_make_»que¡
(
bio
);

115 } ià(!
	`li¡_em±y_ÿ»ful
(&
h—d
->
li¡
)) {

116 
	`dev_w¬n_¿‹lim™ed
(
dev
, "no…ath‡vailable -„equeuing I/O\n");

118 
	`¥š_lock_œq
(&
h—d
->
»queue_lock
);

119 
	`bio_li¡_add
(&
h—d
->
»queue_li¡
, 
bio
);

120 
	`¥š_uÆock_œq
(&
h—d
->
»queue_lock
);

122 
	`dev_w¬n_¿‹lim™ed
(
dev
, "no…ath - failing I/O\n");

124 
bio
->
bi_¡©us
 = 
BLK_STS_IOERR
;

125 
	`bio_’dio
(
bio
);

128 
	`¤cu_»ad_uÆock
(&
h—d
->
¤cu
, 
¤cu_idx
);

129  
»t
;

130 
	}
}

132 
boÞ
 
	$nvme_ns_h—d_pÞl
(
»que¡_queue
 *
q
, 
blk_qc_t
 
qc
)

134 
nvme_ns_h—d
 *
h—d
 = 
q
->
queued©a
;

135 
nvme_ns
 *
ns
;

136 
boÞ
 
found
 = 
çl£
;

137 
¤cu_idx
;

139 
¤cu_idx
 = 
	`¤cu_»ad_lock
(&
h—d
->
¤cu
);

140 
ns
 = 
	`¤cu_d”eã»nû
(
h—d
->
cu¼’t_·th
, &h—d->
¤cu
);

141 ià(
	`lik–y
(
ns
 &&‚s->
ù¾
->
¡©e
 =ð
NVME_CTRL_LIVE
))

142 
found
 = 
ns
->
queue
->
	`pÞl_â
(
q
, 
qc
);

143 
	`¤cu_»ad_uÆock
(&
h—d
->
¤cu
, 
¤cu_idx
);

144  
found
;

145 
	}
}

147 
	$nvme_»queue_wÜk
(
wÜk_¡ruù
 *
wÜk
)

149 
nvme_ns_h—d
 *
h—d
 =

150 
	`cÚš”_of
(
wÜk
, 
nvme_ns_h—d
, 
»queue_wÜk
);

151 
bio
 *bio, *
Ãxt
;

153 
	`¥š_lock_œq
(&
h—d
->
»queue_lock
);

154 
Ãxt
 = 
	`bio_li¡_g‘
(&
h—d
->
»queue_li¡
);

155 
	`¥š_uÆock_œq
(&
h—d
->
»queue_lock
);

157 (
bio
 = 
Ãxt
è!ð
NULL
) {

158 
Ãxt
 = 
bio
->
bi_Ãxt
;

159 
bio
->
bi_Ãxt
 = 
NULL
;

165 
bio
->
bi_disk
 = 
h—d
->
disk
;

166 
	`g’”ic_make_»que¡
(
bio
);

168 
	}
}

170 
	$nvme_m·th_®loc_disk
(
nvme_ù¾
 *
ù¾
, 
nvme_ns_h—d
 *
h—d
)

172 
»que¡_queue
 *
q
;

173 
boÞ
 
vwc
 = 
çl£
;

175 
	`bio_li¡_š™
(&
h—d
->
»queue_li¡
);

176 
	`¥š_lock_š™
(&
h—d
->
»queue_lock
);

177 
	`INIT_WORK
(&
h—d
->
»queue_wÜk
, 
nvme_»queue_wÜk
);

184 ià(!(
ù¾
->
subsys
->
cmic
 & (1 << 1)è|| !
muÉ©h
)

187 
q
 = 
	`blk_®loc_queue_node
(
GFP_KERNEL
, 
NUMA_NO_NODE
, 
NULL
);

188 ià(!
q
)

189 
out
;

190 
q
->
queued©a
 = 
h—d
;

191 
	`blk_queue_make_»que¡
(
q
, 
nvme_ns_h—d_make_»que¡
);

192 
q
->
pÞl_â
 = 
nvme_ns_h—d_pÞl
;

193 
	`blk_queue_æag_£t
(
QUEUE_FLAG_NONROT
, 
q
);

195 
	`blk_queue_logiÿl_block_size
(
q
, 512);

198 ià(
ù¾
->
vwc
 & 
NVME_CTRL_VWC_PRESENT
)

199 
vwc
 = 
Œue
;

200 
	`blk_queue_wr™e_ÿche
(
q
, 
vwc
, vwc);

202 
h—d
->
disk
 = 
	`®loc_disk
(0);

203 ià(!
h—d
->
disk
)

204 
out_þ—nup_queue
;

205 
h—d
->
disk
->
fÝs
 = &
nvme_ns_h—d_Ýs
;

206 
h—d
->
disk
->
´iv©e_d©a
 = head;

207 
h—d
->
disk
->
queue
 = 
q
;

208 
h—d
->
disk
->
æags
 = 
GENHD_FL_EXT_DEVT
;

209 
	`¥rštf
(
h—d
->
disk
->
disk_Çme
, "nvme%dn%d",

210 
ù¾
->
subsys
->
š¡ªû
, 
h—d
->instance);

213 
out_þ—nup_queue
:

214 
	`blk_þ—nup_queue
(
q
);

215 
out
:

216  -
ENOMEM
;

217 
	}
}

219 
	$nvme_m·th_add_disk
(
nvme_ns_h—d
 *
h—d
)

221 ià(!
h—d
->
disk
)

224 
	`mu‹x_lock
(&
h—d
->
subsys
->
lock
);

225 ià(!(
h—d
->
disk
->
æags
 & 
GENHD_FL_UP
)) {

226 
	`deviû_add_disk
(&
h—d
->
subsys
->
dev
, h—d->
disk
);

227 ià(
	`sysfs_ü—‹_group
(&
	`disk_to_dev
(
h—d
->
disk
)->
kobj
,

228 &
nvme_ns_id_©Œ_group
))

229 
	`´_w¬n
("%s: failedo create sysfs group for identification\n",

230 
h—d
->
disk
->
disk_Çme
);

232 
	`mu‹x_uÆock
(&
h—d
->
subsys
->
lock
);

233 
	}
}

235 
	$nvme_m·th_»move_disk
(
nvme_ns_h—d
 *
h—d
)

237 ià(!
h—d
->
disk
)

239 
	`sysfs_»move_group
(&
	`disk_to_dev
(
h—d
->
disk
)->
kobj
,

240 &
nvme_ns_id_©Œ_group
);

241 
	`d–_g’disk
(
h—d
->
disk
);

242 
	`blk_£t_queue_dyšg
(
h—d
->
disk
->
queue
);

244 
	`kblockd_scheduË_wÜk
(&
h—d
->
»queue_wÜk
);

245 
	`æush_wÜk
(&
h—d
->
»queue_wÜk
);

246 
	`blk_þ—nup_queue
(
h—d
->
disk
->
queue
);

247 
	`put_disk
(
h—d
->
disk
);

248 
	}
}

	@nvme-core_dummy.c

33 
	~<lšux/moduË.h
>

34 
	~<lšux/š™.h
>

35 
	~<lšux/”ºo.h
>

37 
	#DRV_NAME
 "nvme-cÜe"

	)

38 
	#PFX
 
DRV_NAME
 ": "

	)

39 
	#DRV_VERSION
 "2.0.0"

	)

40 
	#DRV_RELDATE
 "Novemb” 13, 2016"

	)

42 
MODULE_AUTHOR
("Alaa Hleihel");

43 
MODULE_DESCRIPTION
("nvme-core dummy kernel module");

44 
MODULE_LICENSE
("Dual BSD/GPL");

45 #ifdeà
RETPOLINE_MLNX


46 
MODULE_INFO
(
»Þše
, "Y");

48 
MODULE_VERSION
(
DRV_VERSION
);

50 
__š™
 
	$nvme_cÜe_š™
()

53 
	}
}

55 
__ex™
 
	$nvme_cÜe_þ—nup
()

57 
	}
}

59 
moduË_š™
(
nvme_cÜe_š™
);

60 
moduË_ex™
(
nvme_cÜe_þ—nup
);

	@nvme-fabrics_dummy.c

33 
	~<lšux/moduË.h
>

34 
	~<lšux/š™.h
>

35 
	~<lšux/”ºo.h
>

37 
	#DRV_NAME
 "nvme-çbrics"

	)

38 
	#PFX
 
DRV_NAME
 ": "

	)

39 
	#DRV_VERSION
 "2.0.0"

	)

40 
	#DRV_RELDATE
 "Novemb” 13, 2016"

	)

42 
MODULE_AUTHOR
("Alaa Hleihel");

43 
MODULE_DESCRIPTION
("nvme-fabrics dummy kernel module");

44 
MODULE_LICENSE
("Dual BSD/GPL");

45 #ifdeà
RETPOLINE_MLNX


46 
MODULE_INFO
(
»Þše
, "Y");

48 
MODULE_VERSION
(
DRV_VERSION
);

50 
__š™
 
	$nvme_çbrics_š™
()

53 
	}
}

55 
__ex™
 
	$nvme_çbrics_þ—nup
()

57 
	}
}

59 
moduË_š™
(
nvme_çbrics_š™
);

60 
moduË_ex™
(
nvme_çbrics_þ—nup
);

	@nvme-fc_dummy.c

33 
	~<lšux/moduË.h
>

34 
	~<lšux/š™.h
>

35 
	~<lšux/”ºo.h
>

37 
	#DRV_NAME
 "nvme-fc"

	)

38 
	#PFX
 
DRV_NAME
 ": "

	)

39 
	#DRV_VERSION
 "2.0.0"

	)

40 
	#DRV_RELDATE
 "July 27, 2017"

	)

42 
MODULE_AUTHOR
("Alaa Hleihel");

43 
MODULE_DESCRIPTION
("nvme-fc dummy kernel module");

44 
MODULE_LICENSE
("Dual BSD/GPL");

45 #ifdeà
RETPOLINE_MLNX


46 
MODULE_INFO
(
»Þše
, "Y");

48 
MODULE_VERSION
(
DRV_VERSION
);

50 
__š™
 
	$nvme_fc_š™
()

53 
	}
}

55 
__ex™
 
	$nvme_fc_þ—nup
()

57 
	}
}

59 
moduË_š™
(
nvme_fc_š™
);

60 
moduË_ex™
(
nvme_fc_þ—nup
);

	@nvme-rdma_dummy.c

33 
	~<lšux/moduË.h
>

34 
	~<lšux/š™.h
>

35 
	~<lšux/”ºo.h
>

37 
	#DRV_NAME
 "nvme-rdma"

	)

38 
	#PFX
 
DRV_NAME
 ": "

	)

39 
	#DRV_VERSION
 "2.0.0"

	)

40 
	#DRV_RELDATE
 "Novemb” 13, 2016"

	)

42 
MODULE_AUTHOR
("Alaa Hleihel");

43 
MODULE_DESCRIPTION
("nvme-rdma dummy kernel module");

44 
MODULE_LICENSE
("Dual BSD/GPL");

45 #ifdeà
RETPOLINE_MLNX


46 
MODULE_INFO
(
»Þše
, "Y");

48 
MODULE_VERSION
(
DRV_VERSION
);

50 
__š™
 
	$nvme_rdma_š™
()

53 
	}
}

55 
__ex™
 
	$nvme_rdma_þ—nup
()

57 
	}
}

59 
moduË_š™
(
nvme_rdma_š™
);

60 
moduË_ex™
(
nvme_rdma_þ—nup
);

	@nvme.h

14 #iâdeà
_NVME_H


15 
	#_NVME_H


	)

17 
	~<lšux/nvme.h
>

18 
	~<lšux/cdev.h
>

19 
	~<lšux/pci.h
>

20 
	~<lšux/k»f.h
>

21 
	~<lšux/blk-mq.h
>

22 #ifdeà
HAVE_LIGHTNVM_H


23 
	~<lšux/lighŠvm.h
>

25 #ifdeà
HAVE_LINUX_SED_OPAL_H


26 
	~<lšux/£d-Ý®.h
>

28 
	~<lšux/çuÉ-šjeù.h
>

29 
	~<lšux/rcupd©e.h
>

31 
nvme_io_timeout
;

32 
	#NVME_IO_TIMEOUT
 (
nvme_io_timeout
 * 
HZ
)

	)

34 
admš_timeout
;

35 
	#ADMIN_TIMEOUT
 (
admš_timeout
 * 
HZ
)

	)

37 
	#NVME_DEFAULT_KATO
 5

	)

38 
	#NVME_KATO_GRACE
 10

	)

40 
wÜkqueue_¡ruù
 *
nvme_wq
;

41 
wÜkqueue_¡ruù
 *
nvme_»£t_wq
;

42 
wÜkqueue_¡ruù
 *
nvme_d–‘e_wq
;

45 
	mNVME_NS_LBA
 = 0,

46 
	mNVME_NS_LIGHTNVM
 = 1,

53 
	envme_quœks
 {

58 
	mNVME_QUIRK_STRIPE_SIZE
 = (1 << 0),

64 
	mNVME_QUIRK_IDENTIFY_CNS
 = (1 << 1),

66 #ifdeà
HAVE_BLK_QUEUE_MAX_WRITE_ZEROES_SECTORS


71 
	mNVME_QUIRK_DEALLOCATE_ZEROES
 = (1 << 2),

77 
	mNVME_QUIRK_DISCARD_ZEROES
 = (1 << 2),

84 
	mNVME_QUIRK_DELAY_BEFORE_CHK_RDY
 = (1 << 3),

89 
	mNVME_QUIRK_NO_APST
 = (1 << 4),

94 
	mNVME_QUIRK_NO_DEEPEST_PS
 = (1 << 5),

99 
	mNVME_QUIRK_LIGHTNVM
 = (1 << 6),

104 
	mNVME_QUIRK_MEDIUM_PRIO_SQ
 = (1 << 7),

111 
	snvme_»que¡
 {

112 
nvme_commªd
 *
	mcmd
;

113 
nvme_»suÉ
 
	m»suÉ
;

114 
u8
 
	m»Œ›s
;

115 
u8
 
	mæags
;

116 
u16
 
	m¡©us
;

122 
	#REQ_NVME_MPATH
 
REQ_DRV


	)

125 
	mNVME_REQ_CANCELLED
 = (1 << 0),

126 
	mNVME_REQ_USERCMD
 = (1 << 1),

129 
šlše
 
nvme_»que¡
 *
	$nvme_»q
(
»que¡
 *
»q
)

131  
	`blk_mq_rq_to_pdu
(
»q
);

132 
	}
}

139 
	#NVME_QUIRK_DELAY_AMOUNT
 2300

	)

141 
	envme_ù¾_¡©e
 {

142 
	mNVME_CTRL_NEW
,

143 
	mNVME_CTRL_LIVE
,

144 
	mNVME_CTRL_ADMIN_ONLY
,

145 
	mNVME_CTRL_RESETTING
,

146 
	mNVME_CTRL_CONNECTING
,

147 
	mNVME_CTRL_DELETING
,

148 
	mNVME_CTRL_DEAD
,

151 
	snvme_ù¾
 {

152 
nvme_ù¾_¡©e
 
	m¡©e
;

153 
boÞ
 
	mid’tif›d
;

154 
¥šlock_t
 
	mlock
;

155 cÚ¡ 
nvme_ù¾_Ýs
 *
	mÝs
;

156 
»que¡_queue
 *
	madmš_q
;

157 
»que¡_queue
 *
	mcÚÃù_q
;

158 
deviû
 *
	mdev
;

159 
	mš¡ªû
;

160 
blk_mq_g_£t
 *
	mg£t
;

161 
blk_mq_g_£t
 *
	madmš_g£t
;

162 
li¡_h—d
 
	mÇme¥aûs
;

163 
rw_£m­hÜe
 
	mÇme¥aûs_rw£m
;

164 
deviû
 
	mù¾_deviû
;

165 
deviû
 *
	mdeviû
;

166 
cdev
 
	mcdev
;

167 
wÜk_¡ruù
 
	m»£t_wÜk
;

168 
wÜk_¡ruù
 
	md–‘e_wÜk
;

170 
nvme_subsy¡em
 *
	msubsys
;

171 
li¡_h—d
 
	msubsys_’Œy
;

173 #ifdeà
HAVE_LINUX_SED_OPAL_H


174 
Ý®_dev
 *
	mÝ®_dev
;

177 
	mÇme
[12];

178 
u16
 
	múŽid
;

180 
u32
 
	mù¾_cÚfig
;

181 
u16
 
	mmtç
;

182 
u32
 
	mqueue_couÁ
;

184 
u64
 
	mÿp
;

185 
u32
 
	m·ge_size
;

186 
u32
 
	mmax_hw_£ùÜs
;

187 
u16
 
	mÚcs
;

188 
u16
 
	mßcs
;

189 #ifdeà
HAVE_BLK_MAX_WRITE_HINTS


190 
u16
 
	mns§
;

191 
u16
 
	mÄ_¡»ams
;

193 
©omic_t
 
	mabÜt_lim™
;

194 
u8
 
	mvwc
;

195 
u32
 
	mvs
;

196 
u32
 
	msgls
;

197 
u16
 
	mkas
;

198 
u8
 
	mÅss
;

199 
u8
 
	m­¡a
;

200 
u32
 
	mßes
;

201 
u32
 
	m«n_»suÉ
;

202 
	mshutdown_timeout
;

203 
	mk©o
;

204 
boÞ
 
	msubsy¡em
;

205 
	mquœks
;

206 
nvme_id_pow”_¡©e
 
	mpsd
[32];

207 
nvme_efãùs_log
 *
	mefãùs
;

208 
wÜk_¡ruù
 
	msÿn_wÜk
;

209 
wÜk_¡ruù
 
	masync_ev’t_wÜk
;

210 
d–ayed_wÜk
 
	mka_wÜk
;

211 
nvme_commªd
 
	mka_cmd
;

212 
wÜk_¡ruù
 
	mfw_aù_wÜk
;

213 #iâdeà
HAVE_BLK_QUEUE_VIRT_BOUNDARY


214 
boÞ
 
	msg_g­s_suµÜt
;

216 
	#EVENT_NS_CHANGED
 (1 << 0)

	)

217 
	mev’ts
;

220 
u64
 
	mps_max_Ï‹ncy_us
;

221 
boÞ
 
	m­¡_’abËd
;

224 
u32
 
	mhm´e
;

225 
u32
 
	mhmmš
;

226 
u32
 
	mhmmšds
;

227 
u16
 
	mhmmaxd
;

230 
u16
 
	msqsize
;

231 
u32
 
	mioccsz
;

232 
u32
 
	miÜcsz
;

233 
u16
 
	micdoff
;

234 
u16
 
	mmaxcmd
;

235 
	mÄ_»cÚÃùs
;

236 
nvmf_ù¾_ÝtiÚs
 *
	mÝts
;

239 
	snvme_subsy¡em
 {

240 
	mš¡ªû
;

241 
deviû
 
	mdev
;

246 
k»f
 
	m»f
;

247 
li¡_h—d
 
	m’Œy
;

248 
mu‹x
 
	mlock
;

249 
li¡_h—d
 
	mù¾s
;

250 
li¡_h—d
 
	mnsh—ds
;

251 
	msubnqn
[
NVMF_NQN_SIZE
];

252 
	m£rŸl
[20];

253 
	mmod–
[40];

254 
	mfœmw¬e_»v
[8];

255 
u8
 
	mcmic
;

256 
u16
 
	mv’dÜ_id
;

257 
ida
 
	mns_ida
;

263 
	snvme_ns_ids
 {

264 
u8
 
	meui64
[8];

265 
u8
 
	mnguid
[16];

266 
uuid_t
 
	muuid
;

276 
	snvme_ns_h—d
 {

277 #ifdeà
CONFIG_NVME_MULTIPATH


278 
g’disk
 *
	mdisk
;

279 
nvme_ns
 
__rcu
 *
	mcu¼’t_·th
;

280 
bio_li¡
 
	m»queue_li¡
;

281 
¥šlock_t
 
	m»queue_lock
;

282 
wÜk_¡ruù
 
	m»queue_wÜk
;

284 
li¡_h—d
 
	mli¡
;

285 
¤cu_¡ruù
 
	m¤cu
;

286 
nvme_subsy¡em
 *
	msubsys
;

287 
	mns_id
;

288 
nvme_ns_ids
 
	mids
;

289 
li¡_h—d
 
	m’Œy
;

290 
k»f
 
	m»f
;

291 
	mš¡ªû
;

292 #iâdeà
HAVE_CLEANUP_SRCU_STRUCT_QUIESCED


293 
wÜk_¡ruù
 
	mä“_wÜk
;

297 #ifdeà
CONFIG_FAULT_INJECTION_DEBUG_FS


298 
	snvme_çuÉ_šjeù
 {

299 
çuÉ_©Œ
 
	m©Œ
;

300 
d’Œy
 *
	m·»Á
;

301 
boÞ
 
	mdÚt_»Œy
;

302 
u16
 
	m¡©us
;

306 
	snvme_ns
 {

307 
li¡_h—d
 
	mli¡
;

309 
nvme_ù¾
 *
	mù¾
;

310 
»que¡_queue
 *
	mqueue
;

311 
g’disk
 *
	mdisk
;

312 
li¡_h—d
 
	msiblšgs
;

313 
nvm_dev
 *
	mndev
;

314 
k»f
 
	mk»f
;

315 
nvme_ns_h—d
 *
	mh—d
;

317 
	mlba_shiá
;

318 
u16
 
	mms
;

319 #ifdeà
HAVE_BLK_MAX_WRITE_HINTS


320 
u16
 
	msgs
;

321 
u32
 
	msws
;

323 
boÞ
 
	mext
;

324 
u8
 
	mpi_ty³
;

325 
	mæags
;

326 
	#NVME_NS_REMOVING
 0

	)

327 
	#NVME_NS_DEAD
 1

	)

328 
u16
 
	mnoiob
;

330 #ifdeà
CONFIG_FAULT_INJECTION_DEBUG_FS


331 
nvme_çuÉ_šjeù
 
	mçuÉ_šjeù
;

336 
	snvme_ù¾_Ýs
 {

337 cÚ¡ *
	mÇme
;

338 
moduË
 *
	mmoduË
;

339 
	mæags
;

340 
	#NVME_F_FABRICS
 (1 << 0)

	)

341 
	#NVME_F_METADATA_SUPPORTED
 (1 << 1)

	)

342 (*
	m»g_»ad32
)(
nvme_ù¾
 *
	mù¾
, 
u32
 
	moff
, u32 *
	mv®
);

343 (*
	m»g_wr™e32
)(
nvme_ù¾
 *
	mù¾
, 
u32
 
	moff
, u32 
	mv®
);

344 (*
	m»g_»ad64
)(
nvme_ù¾
 *
	mù¾
, 
u32
 
	moff
, 
u64
 *
	mv®
);

345 (*
	mä“_ù¾
)(
nvme_ù¾
 *
	mù¾
);

346 (*
	msubm™_async_ev’t
)(
nvme_ù¾
 *
	mù¾
);

347 (*
	md–‘e_ù¾
)(
nvme_ù¾
 *
	mù¾
);

348 (*
	mg‘_add»ss
)(
nvme_ù¾
 *
	mù¾
, *
	mbuf
, 
	msize
);

349 (*
	m»š™_»que¡
)(*
	md©a
, 
»que¡
 *
	mrq
);

350 (*
	m¡Ý_ù¾
)(
nvme_ù¾
 *
	mù¾
);

353 #ifdeà
CONFIG_FAULT_INJECTION_DEBUG_FS


354 
nvme_çuÉ_šjeù_š™
(
nvme_ns
 *
ns
);

355 
nvme_çuÉ_šjeù_fši
(
nvme_ns
 *
ns
);

356 
nvme_should_çž
(
»que¡
 *
»q
);

358 
šlše
 
	$nvme_çuÉ_šjeù_š™
(
nvme_ns
 *
ns
è{
	}
}

359 
šlše
 
	$nvme_çuÉ_šjeù_fši
(
nvme_ns
 *
ns
è{
	}
}

360 
šlše
 
	$nvme_should_çž
(
»que¡
 *
»q
è{
	}
}

363 
šlše
 
boÞ
 
	$nvme_ù¾_»ady
(
nvme_ù¾
 *
ù¾
)

365 
u32
 
v®
 = 0;

367 ià(
ù¾
->
Ýs
->
	`»g_»ad32
(ù¾, 
NVME_REG_CSTS
, &
v®
))

368  
çl£
;

369  
v®
 & 
NVME_CSTS_RDY
;

370 
	}
}

372 
šlše
 
	$nvme_»£t_subsy¡em
(
nvme_ù¾
 *
ù¾
)

374 ià(!
ù¾
->
subsy¡em
)

375  -
ENOTTY
;

376  
ù¾
->
Ýs
->
	`»g_wr™e32
(ù¾, 
NVME_REG_NSSR
, 0x4E564D65);

377 
	}
}

379 
šlše
 
u64
 
	$nvme_block_Ä
(
nvme_ns
 *
ns
, 
£ùÜ_t
 
£ùÜ
)

381  (
£ùÜ
 >> (
ns
->
lba_shiá
 - 9));

382 
	}
}

384 #iâdeà
HAVE_BLK_RQ_NR_PAYLOAD_BYTES


385 
šlše
 
	$nvme_m­_Ën
(
»que¡
 *
rq
)

387 #ifdeà
HAVE_BLK_TYPES_REQ_OP_DISCARD


388 ià(
	`»q_Ý
(
rq
è=ð
REQ_OP_DISCARD
)

390 ià(
rq
->
cmd_æags
 & 
REQ_DISCARD
)

392  (
nvme_dsm_¿nge
);

394  
	`blk_rq_by‹s
(
rq
);

395 
	}
}

398 
šlše
 
	$nvme_þ—nup_cmd
(
»que¡
 *
»q
)

400 #ifdeà
HAVE_REQUEST_RQ_FLAGS


401 ià(
»q
->
rq_æags
 & 
RQF_SPECIAL_PAYLOAD
) {

402 
	`kä“
(
	`·ge_add»ss
(
»q
->
¥ecŸl_vec
.
bv_·ge
) +

403 
»q
->
¥ecŸl_vec
.
bv_off£t
);

406 #ifdeà
HAVE_BLK_TYPES_REQ_OP_DISCARD


407 ià(
	`»q_Ý
(
»q
è=ð
REQ_OP_DISCARD
)

409 ià(
»q
->
cmd_æags
 & 
REQ_DISCARD
)

411 
	`kä“
(
»q
->
com¶‘iÚ_d©a
);

413 
	}
}

415 
šlše
 
	$nvme_’d_»que¡
(
»que¡
 *
»q
, 
__Ë16
 
¡©us
,

416 
nvme_»suÉ
 
»suÉ
)

418 
nvme_»que¡
 *
rq
 = 
	`nvme_»q
(
»q
);

420 
rq
->
¡©us
 = 
	`Ë16_to_ýu
(status) >> 1;

421 
rq
->
»suÉ
 =„esult;

423 
	`nvme_should_çž
(
»q
);

424 #ifdeà
HAVE_BLK_MQ_COMPLETE_REQUEST_HAS_2_PARAMS


425 
	`blk_mq_com¶‘e_»que¡
(
»q
, 0);

427 
	`blk_mq_com¶‘e_»que¡
(
»q
);

429 
	}
}

431 
šlše
 
	$nvme_g‘_ù¾
(
nvme_ù¾
 *
ù¾
)

433 
	`g‘_deviû
(
ù¾
->
deviû
);

434 
	}
}

436 
šlše
 
	$nvme_put_ù¾
(
nvme_ù¾
 *
ù¾
)

438 
	`put_deviû
(
ù¾
->
deviû
);

439 
	}
}

441 
nvme_com¶‘e_rq
(
»que¡
 *
»q
);

442 
nvme_ÿnûl_»que¡
(
»que¡
 *
»q
, *
d©a
, 
boÞ
 
»£rved
);

443 
boÞ
 
nvme_chªge_ù¾_¡©e
(
nvme_ù¾
 *
ù¾
,

444 
nvme_ù¾_¡©e
 
Ãw_¡©e
);

445 
nvme_di§bË_ù¾
(
nvme_ù¾
 *
ù¾
, 
u64
 
ÿp
);

446 
nvme_’abË_ù¾
(
nvme_ù¾
 *
ù¾
, 
u64
 
ÿp
);

447 
nvme_shutdown_ù¾
(
nvme_ù¾
 *
ù¾
);

448 
nvme_š™_ù¾
(
nvme_ù¾
 *
ù¾
, 
deviû
 *
dev
,

449 cÚ¡ 
nvme_ù¾_Ýs
 *
Ýs
, 
quœks
);

450 
nvme_unš™_ù¾
(
nvme_ù¾
 *
ù¾
);

451 
nvme_¡¬t_ù¾
(
nvme_ù¾
 *
ù¾
);

452 
nvme_¡Ý_ù¾
(
nvme_ù¾
 *
ù¾
);

453 
nvme_put_ù¾
(
nvme_ù¾
 *
ù¾
);

454 
nvme_š™_id’tify
(
nvme_ù¾
 *
ù¾
);

456 
nvme_»move_Çme¥aûs
(
nvme_ù¾
 *
ù¾
);

458 #ifdeà
HAVE_LINUX_SED_OPAL_H


459 
nvme_£c_subm™
(*
d©a
, 
u16
 
¥¥
, 
u8
 
£ý
, *
bufãr
, 
size_t
 
Ën
,

460 
boÞ
 
£nd
);

463 
nvme_com¶‘e_async_ev’t
(
nvme_ù¾
 *
ù¾
, 
__Ë16
 
¡©us
,

464 vÞ©ž
nvme_»suÉ
 *
»s
);

466 
nvme_¡Ý_queues
(
nvme_ù¾
 *
ù¾
);

467 
nvme_¡¬t_queues
(
nvme_ù¾
 *
ù¾
);

468 
nvme_kžl_queues
(
nvme_ù¾
 *
ù¾
);

469 
nvme_unä“ze
(
nvme_ù¾
 *
ù¾
);

470 
nvme_wa™_ä“ze
(
nvme_ù¾
 *
ù¾
);

471 
nvme_wa™_ä“ze_timeout
(
nvme_ù¾
 *
ù¾
, 
timeout
);

472 
nvme_¡¬t_ä“ze
(
nvme_ù¾
 *
ù¾
);

473 
nvme_»š™_g£t
(
nvme_ù¾
 *
ù¾
, 
blk_mq_g_£t
 *
£t
);

475 
	#NVME_QID_ANY
 -1

	)

476 #ifdeà
HAVE_BLK_MQ_ALLOC_REQUEST_HAS_3_PARAMS


477 
»que¡
 *
nvme_®loc_»que¡
(
»que¡_queue
 *
q
,

478 
nvme_commªd
 *
cmd
, 
blk_mq_»q_æags_t
 
æags
, 
qid
);

480 
»que¡
 *
nvme_®loc_»que¡
(
»que¡_queue
 *
q
,

481 
nvme_commªd
 *
cmd
, 
gå_t
 
gå
, 
boÞ
 
»£rved
, 
qid
);

483 
blk_¡©us_t
 
nvme_£tup_cmd
(
nvme_ns
 *
ns
, 
»que¡
 *
»q
,

484 
nvme_commªd
 *
cmd
);

485 
nvme_subm™_sync_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

486 *
buf
, 
bufæ’
);

487 #ifdeà
HAVE_BLK_MQ_ALLOC_REQUEST_HAS_3_PARAMS


488 
__nvme_subm™_sync_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

489 
nvme_»suÉ
 *
»suÉ
, *
bufãr
, 
bufæ’
,

490 
timeout
, 
qid
, 
©_h—d
,

491 
blk_mq_»q_æags_t
 
æags
);

493 
__nvme_subm™_sync_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

494 
nvme_»suÉ
 *
»suÉ
, *
bufãr
, 
bufæ’
,

495 
timeout
, 
qid
, 
©_h—d
, 
gå_t
 
gå
, 
boÞ
 
»£rved
);

497 
nvme_£t_queue_couÁ
(
nvme_ù¾
 *
ù¾
, *
couÁ
);

498 
nvme_¡Ý_k“p_®ive
(
nvme_ù¾
 *
ù¾
);

499 
nvme_»£t_ù¾
(
nvme_ù¾
 *
ù¾
);

500 
nvme_»£t_ù¾_sync
(
nvme_ù¾
 *
ù¾
);

501 
nvme_d–‘e_ù¾
(
nvme_ù¾
 *
ù¾
);

502 
nvme_d–‘e_ù¾_sync
(
nvme_ù¾
 *
ù¾
);

504 
nvme_g‘_log_ext
(
nvme_ù¾
 *
ù¾
, 
nvme_ns
 *
ns
,

505 
u8
 
log_·ge
, *
log
, 
size_t
 
size
, 
u64
 
off£t
);

507 cÚ¡ 
©Œibu‹_group
 
nvme_ns_id_©Œ_group
;

508 cÚ¡ 
block_deviû_Ý”©iÚs
 
nvme_ns_h—d_Ýs
;

510 #ifdeà
CONFIG_NVME_MULTIPATH


511 
nvme_£t_disk_Çme
(*
disk_Çme
, 
nvme_ns
 *
ns
,

512 
nvme_ù¾
 *
ù¾
, *
æags
);

513 
nvme_çžov”_»q
(
»que¡
 *
»q
);

514 
boÞ
 
nvme_»q_Ãeds_çžov”
(
»que¡
 *
»q
, 
blk_¡©us_t
 
”rÜ
);

515 
nvme_kick_»queue_li¡s
(
nvme_ù¾
 *
ù¾
);

516 
nvme_m·th_®loc_disk
(
nvme_ù¾
 *
ù¾
,
nvme_ns_h—d
 *
h—d
);

517 
nvme_m·th_add_disk
(
nvme_ns_h—d
 *
h—d
);

518 
nvme_m·th_»move_disk
(
nvme_ns_h—d
 *
h—d
);

520 
šlše
 
	$nvme_m·th_þ—r_cu¼’t_·th
(
nvme_ns
 *
ns
)

522 
nvme_ns_h—d
 *
h—d
 = 
ns
->head;

524 ià(
h—d
 && 
ns
 =ð
	`rcu_acûss_poš‹r
(h—d->
cu¼’t_·th
))

525 
	`rcu_assign_poš‹r
(
h—d
->
cu¼’t_·th
, 
NULL
);

526 
	}
}

527 
nvme_ns
 *
nvme_fšd_·th
(
nvme_ns_h—d
 *
h—d
);

529 
šlše
 
	$nvme_m·th_check_Ï¡_·th
(
nvme_ns
 *
ns
)

531 
nvme_ns_h—d
 *
h—d
 = 
ns
->head;

533 ià(
h—d
->
disk
 && 
	`li¡_em±y
(&h—d->
li¡
))

534 
	`kblockd_scheduË_wÜk
(&
h—d
->
»queue_wÜk
);

535 
	}
}

542 
šlše
 
	$nvme_£t_disk_Çme
(*
disk_Çme
, 
nvme_ns
 *
ns
,

543 
nvme_ù¾
 *
ù¾
, *
æags
)

545 
	`¥rštf
(
disk_Çme
, "nvme%dn%d", 
ù¾
->
š¡ªû
, 
ns
->
h—d
->instance);

546 
	}
}

548 
šlše
 
	$nvme_çžov”_»q
(
»que¡
 *
»q
)

550 
	}
}

551 
šlše
 
boÞ
 
	$nvme_»q_Ãeds_çžov”
(
»que¡
 *
»q
,

552 
blk_¡©us_t
 
”rÜ
)

554  
çl£
;

555 
	}
}

556 
šlše
 
	$nvme_kick_»queue_li¡s
(
nvme_ù¾
 *
ù¾
)

558 
	}
}

559 
šlše
 
	$nvme_m·th_®loc_disk
(
nvme_ù¾
 *
ù¾
,

560 
nvme_ns_h—d
 *
h—d
)

563 
	}
}

564 
šlše
 
	$nvme_m·th_add_disk
(
nvme_ns_h—d
 *
h—d
)

566 
	}
}

567 
šlše
 
	$nvme_m·th_»move_disk
(
nvme_ns_h—d
 *
h—d
)

569 
	}
}

570 
šlše
 
	$nvme_m·th_þ—r_cu¼’t_·th
(
nvme_ns
 *
ns
)

572 
	}
}

573 
šlše
 
	$nvme_m·th_check_Ï¡_·th
(
nvme_ns
 *
ns
)

575 
	}
}

578 #ià
defšed
(
CONFIG_NVM
è&& defšed(
HAVE_LIGHTNVM_NVM_DEV
)

579 
nvme_nvm_upd©e_nvm_šfo
(
nvme_ns
 *
ns
);

580 
nvme_nvm_»gi¡”
(
nvme_ns
 *
ns
, *
disk_Çme
, 
node
);

581 
nvme_nvm_uÄegi¡”
(
nvme_ns
 *
ns
);

582 
nvme_nvm_»gi¡”_sysfs
(
nvme_ns
 *
ns
);

583 
nvme_nvm_uÄegi¡”_sysfs
(
nvme_ns
 *
ns
);

584 #ifdeà
HAVE_NVM_USER_VIO


585 
nvme_nvm_ioùl
(
nvme_ns
 *
ns
, 
cmd
, 
¬g
);

588 
šlše
 
	$nvme_nvm_upd©e_nvm_šfo
(
nvme_ns
 *
ns
è{
	}
};

589 
šlše
 
	$nvme_nvm_»gi¡”
(
nvme_ns
 *
ns
, *
disk_Çme
,

590 
node
)

593 
	}
}

595 
šlše
 
	$nvme_nvm_uÄegi¡”
(
nvme_ns
 *
ns
è{
	}
};

596 
šlše
 
	$nvme_nvm_»gi¡”_sysfs
(
nvme_ns
 *
ns
)

599 
	}
}

600 
šlše
 
	$nvme_nvm_uÄegi¡”_sysfs
(
nvme_ns
 *
ns
è{
	}
};

601 #ifdeà
HAVE_NVM_USER_VIO


602 
šlše
 
	$nvme_nvm_ioùl
(
nvme_ns
 *
ns
, 
cmd
,

603 
¬g
)

605  -
ENOTTY
;

606 
	}
}

610 
šlše
 
nvme_ns
 *
	$nvme_g‘_ns_äom_dev
(
deviû
 *
dev
)

612  
	`dev_to_disk
(
dev
)->
´iv©e_d©a
;

613 
	}
}

615 
boÞ
 
disk_is_nvme
(
g’disk
 *
disk
);

616 
__š™
 
nvme_cÜe_š™
();

617 
nvme_cÜe_ex™
();

619 #iâdeà
HAVE_BLK_RQ_NR_PHYS_SEGMENTS


620 
šlše
 
	$blk_rq_Ä_phys_£gm’ts
(
»que¡
 *
rq
)

622 #ifdeà
HAVE_REQUEST_RQ_FLAGS


623 ià(
rq
->
rq_æags
 & 
RQF_SPECIAL_PAYLOAD
)

626  
rq
->
Ä_phys_£gm’ts
;

627 
	}
}

	@nvme_dummy.c

33 
	~<lšux/moduË.h
>

34 
	~<lšux/š™.h
>

35 
	~<lšux/”ºo.h
>

37 
	#DRV_NAME
 "nvme"

	)

38 
	#PFX
 
DRV_NAME
 ": "

	)

39 
	#DRV_VERSION
 "2.0.0"

	)

40 
	#DRV_RELDATE
 "Novemb” 13, 2016"

	)

42 
MODULE_AUTHOR
("Alaa Hleihel");

43 
MODULE_DESCRIPTION
("nvme dummy kernel module");

44 
MODULE_LICENSE
("Dual BSD/GPL");

45 #ifdeà
RETPOLINE_MLNX


46 
MODULE_INFO
(
»Þše
, "Y");

48 
MODULE_VERSION
(
DRV_VERSION
);

50 
__š™
 
	$nvme_š™
()

53 
	}
}

55 
__ex™
 
	$nvme_þ—nup
()

57 
	}
}

59 
moduË_š™
(
nvme_š™
);

60 
moduË_ex™
(
nvme_þ—nup
);

	@pci.c

15 
	~<lšux/«r.h
>

16 
	~<lšux/async.h
>

17 
	~<lšux/blkdev.h
>

18 
	~<lšux/blk-mq.h
>

19 
	~<lšux/blk-mq-pci.h
>

20 
	~<lšux/dmi.h
>

21 
	~<lšux/š™.h
>

22 
	~<lšux/š‹¼u±.h
>

23 
	~<lšux/io.h
>

24 
	~<lšux/mm.h
>

25 
	~<lšux/moduË.h
>

26 
	~<lšux/mu‹x.h
>

27 #ifdeà
HAVE_ONCE_H


28 
	~<lšux/Úû.h
>

30 
	~<lšux/pci.h
>

31 
	~<lšux/nvme-³”.h
>

32 
	~<lšux/t10-pi.h
>

33 
	~<lšux/ty³s.h
>

34 #ifdeà
HAVE_IO_64_NONATOMIC_LO_HI_H


35 
	~<lšux/io-64-nÚ©omic-lo-hi.h
>

37 
	~<asm-g’”ic/io-64-nÚ©omic-lo-hi.h
>

39 #ifdeà
HAVE_LINUX_SED_OPAL_H


40 
	~<lšux/£d-Ý®.h
>

42 
	~<lšux/sizes.h
>

44 
	~"nvme.h
"

46 
	#SQ_SIZE
(
d•th
è(d•th * (
nvme_commªd
))

	)

47 
	#CQ_SIZE
(
d•th
è(d•th * (
nvme_com¶‘iÚ
))

	)

49 
	#SGES_PER_PAGE
 (
PAGE_SIZE
 / (
nvme_sgl_desc
))

	)

51 
	gu£_th»aded_š‹¼u±s
;

52 
moduË_·¿m
(
u£_th»aded_š‹¼u±s
, , 0);

54 
boÞ
 
	gu£_cmb_sqes
 = 
Œue
;

55 
moduË_·¿m
(
u£_cmb_sqes
, 
boÞ
, 0644);

56 
MODULE_PARM_DESC
(
u£_cmb_sqes
, "use controller's memory buffer for I/O SQes");

58 
	gmax_ho¡_mem_size_mb
 = 128;

59 
moduË_·¿m
(
max_ho¡_mem_size_mb
, 
ušt
, 0444);

60 
MODULE_PARM_DESC
(
max_ho¡_mem_size_mb
,

63 
	gsgl_th»shÞd
 = 
SZ_32K
;

64 
moduË_·¿m
(
sgl_th»shÞd
, 
ušt
, 0644);

65 
MODULE_PARM_DESC
(
sgl_th»shÞd
,

69 
io_queue_d•th_£t
(cÚ¡ *
v®
, cÚ¡ 
k”Ãl_·¿m
 *
kp
);

70 cÚ¡ 
k”Ãl_·¿m_Ýs
 
	gio_queue_d•th_Ýs
 = {

71 .
£t
 = 
io_queue_d•th_£t
,

72 .
	gg‘
 = 
·¿m_g‘_št
,

75 
	gio_queue_d•th
 = 1024;

76 
moduË_·¿m_cb
(
io_queue_d•th
, &
io_queue_d•th_Ýs
, &io_queue_depth, 0644);

77 
MODULE_PARM_DESC
(
io_queue_d•th
, "set io queue depth, should >= 2");

79 
num_p2p_queues_£t
(cÚ¡ *
v®
, cÚ¡ 
k”Ãl_·¿m
 *
kp
);

80 cÚ¡ 
k”Ãl_·¿m_Ýs
 
	gnum_p2p_queues_Ýs
 = {

81 .
£t
 = 
num_p2p_queues_£t
,

82 .
	gg‘
 = 
·¿m_g‘_št
,

85 
	gnum_p2p_queues
 = 0;

86 
moduË_·¿m_cb
(
num_p2p_queues
, &
num_p2p_queues_Ýs
, &num_p2p_queues, 
S_IRUGO
);

87 
MODULE_PARM_DESC
(
num_p2p_queues
,

90 
	gnvme_dev
;

91 
	gnvme_queue
;

93 
nvme_dev_di§bË
(
nvme_dev
 *
dev
, 
boÞ
 
shutdown
);

94 
nvme_ü—‹_queue
(
nvme_queue
 *
nvmeq
, 
qid
);

95 
nvme_su¥’d_queue
(
nvme_queue
 *
nvmeq
);

96 
ad­‹r_d–‘e_sq
(
nvme_dev
 *
dev
, 
u16
 
sqid
);

97 
ad­‹r_d–‘e_cq
(
nvme_dev
 *
dev
, 
u16
 
cqid
);

102 
	snvme_dev
 {

103 
nvme_queue
 *
	mqueues
;

104 
blk_mq_g_£t
 
	mg£t
;

105 
blk_mq_g_£t
 
	madmš_g£t
;

106 
u32
 
__iomem
 *
	mdbs
;

107 
deviû
 *
	mdev
;

108 
dma_poÞ
 *
	m´p_·ge_poÞ
;

109 
dma_poÞ
 *
	m´p_sm®l_poÞ
;

110 
	mÚlše_queues
;

111 
	mmax_qid
;

112 #ià
defšed
(
HAVE_PCI_IRQ_API
è&& defšed(
HAVE_IRQ_CALC_AFFINITY_VECTORS_3_ARGS
)

113 
	mnum_vecs
;

115 
	mq_d•th
;

116 
u32
 
	mdb_¡ride
;

117 #iâdeà
HAVE_PCI_IRQ_API


118 
msix_’Œy
 *
	m’Œy
;

120 
__iomem
 *
	mb¬
;

121 
	mb¬_m­³d_size
;

122 
wÜk_¡ruù
 
	m»move_wÜk
;

123 
mu‹x
 
	mshutdown_lock
;

124 
boÞ
 
	msubsy¡em
;

125 
__iomem
 *
	mcmb
;

126 #ifdeà
HAVE_PCI_BUS_ADDR_T


127 
pci_bus_addr_t
 
	mcmb_bus_addr
;

129 
dma_addr_t
 
	mcmb_dma_addr
;

131 
u64
 
	mcmb_size
;

132 
u32
 
	mcmbsz
;

133 
u32
 
	mcmbloc
;

134 
nvme_ù¾
 
	mù¾
;

135 
com¶‘iÚ
 
	mioq_wa™
;

136 
	mnum_p2p_queues
;

139 
u32
 *
	mdbbuf_dbs
;

140 
dma_addr_t
 
	mdbbuf_dbs_dma_addr
;

141 
u32
 *
	mdbbuf_eis
;

142 
dma_addr_t
 
	mdbbuf_eis_dma_addr
;

145 
u64
 
	mho¡_mem_size
;

146 
u32
 
	mÄ_ho¡_mem_descs
;

147 
dma_addr_t
 
	mho¡_mem_descs_dma
;

148 
nvme_ho¡_mem_buf_desc
 *
	mho¡_mem_descs
;

149 **
	mho¡_mem_desc_bufs
;

152 
	$io_queue_d•th_£t
(cÚ¡ *
v®
, cÚ¡ 
k”Ãl_·¿m
 *
kp
)

154 
n
 = 0, 
»t
;

156 
»t
 = 
	`k¡¹ošt
(
v®
, 10, &
n
);

157 ià(
»t
 !ð0 || 
n
 < 2)

158  -
EINVAL
;

160  
	`·¿m_£t_št
(
v®
, 
kp
);

161 
	}
}

163 
	$num_p2p_queues_£t
(cÚ¡ *
v®
, cÚ¡ 
k”Ãl_·¿m
 *
kp
)

165 
n
 = 0;

166 
»t
;

168 
»t
 = 
	`k¡¹oušt
(
v®
, 0, &
n
);

169 ià(
»t
 !ð0 || 
n
 > 65534)

170  -
EINVAL
;

172  
	`·¿m_£t_ušt
(
v®
, 
kp
);

173 
	}
}

175 
šlše
 
	$sq_idx
(
qid
, 
u32
 
¡ride
)

177  
qid
 * 2 * 
¡ride
;

178 
	}
}

180 
šlše
 
	$cq_idx
(
qid
, 
u32
 
¡ride
)

182  (
qid
 * 2 + 1è* 
¡ride
;

183 
	}
}

185 
šlše
 
nvme_dev
 *
	$to_nvme_dev
(
nvme_ù¾
 *
ù¾
)

187  
	`cÚš”_of
(
ù¾
, 
nvme_dev
, ctrl);

188 
	}
}

194 
	snvme_queue
 {

195 
deviû
 *
	mq_dmadev
;

196 
nvme_dev
 *
	mdev
;

197 #iâdeà
HAVE_PCI_FREE_IRQ


198 
	mœqÇme
[24];

200 
¥šlock_t
 
	msq_lock
;

201 
nvme_commªd
 *
	msq_cmds
;

202 
nvme_commªd
 
__iomem
 *
	msq_cmds_io
;

203 
¥šlock_t
 
cq_lock
 
	m____ÿch–še_®igÃd_š_smp
;

204 vÞ©ž
nvme_com¶‘iÚ
 *
	mcqes
;

205 
blk_mq_gs
 **
	mgs
;

206 
dma_addr_t
 
	msq_dma_addr
;

207 
dma_addr_t
 
	mcq_dma_addr
;

208 
u32
 
__iomem
 *
	mq_db
;

209 
u16
 
	mq_d•th
;

210 
s16
 
	mcq_veùÜ
;

211 
u16
 
	msq_ž
;

212 
u16
 
	mcq_h—d
;

213 
u16
 
	mÏ¡_cq_h—d
;

214 
u16
 
	mqid
;

215 
u8
 
	mcq_pha£
;

216 
u32
 *
	mdbbuf_sq_db
;

217 
u32
 *
	mdbbuf_cq_db
;

218 
u32
 *
	mdbbuf_sq_ei
;

219 
u32
 *
	mdbbuf_cq_ei
;

222 
boÞ
 
	mp2p
;

223 
nvme_³”_»sourû
 
	m»sourû
;

232 
	snvme_iod
 {

233 
nvme_»que¡
 
	m»q
;

234 
nvme_queue
 *
	mnvmeq
;

235 
boÞ
 
	mu£_sgl
;

236 
	mabÜ‹d
;

237 
	mÅages
;

238 
	mÃÁs
;

239 
	mËngth
;

240 
dma_addr_t
 
	mfœ¡_dma
;

241 
sÿ‰”li¡
 
	mm‘a_sg
;

242 
sÿ‰”li¡
 *
	msg
;

243 
sÿ‰”li¡
 
	mšlše_sg
[0];

246 
nvme_³”_š™_»sourû
(
nvme_queue
 *
nvmeq
,

247 
nvme_³”_»sourû_mask
 
mask
,

248 (* 
¡Ý_ma¡”_³”
)(*
´iv
), *
dd_d©a
)

250 
nvme_dev
 *
dev
 = 
nvmeq
->dev;

251 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

252 
qid
 = 
nvmeq
->qid;

253 
»t
 = 0;

255 ià(
mask
 & 
NVME_PEER_SQT_DBR
)

257 #iâdeà
CONFIG_PPC


258 
nvmeq
->
»sourû
.
sqt_dbr_addr
 = 
	`pci_bus_add»ss
(
pdev
, 0è+ (0x1000 + ((2 * (
qid
)è* (4 << 
	`NVME_CAP_STRIDE
(
dev
->
ù¾
.
ÿp
))));

260 
nvmeq
->
»sourû
.
sqt_dbr_addr
 = 0x800000000000000 | (
	`pci_»sourû_¡¬t
(
pdev
, 0è+ (0x1000 + ((2 * (
qid
)è* (4 << 
	`NVME_CAP_STRIDE
(
dev
->
ù¾
.
ÿp
)))));

263 ià(
mask
 & 
NVME_PEER_CQH_DBR
)

265 #iâdeà
CONFIG_PPC


266 
nvmeq
->
»sourû
.
cqh_dbr_addr
 = 
	`pci_bus_add»ss
(
pdev
, 0è+ (0x1000 + ((2 * (
qid
è+ 1è* (4 << 
	`NVME_CAP_STRIDE
(
dev
->
ù¾
.
ÿp
))));

268 
nvmeq
->
»sourû
.
cqh_dbr_addr
 = 0x800000000000000 | (
	`pci_»sourû_¡¬t
(
pdev
, 0è+ (0x1000 + ((2 * (
qid
è+ 1è* (4 << 
	`NVME_CAP_STRIDE
(
dev
->
ù¾
.
ÿp
)))));

271 ià(
mask
 & 
NVME_PEER_SQ_PAS
)

272 
nvmeq
->
»sourû
.
sq_dma_addr
 =‚vmeq->sq_dma_addr;

274 ià(
mask
 & 
NVME_PEER_CQ_PAS
)

275 
nvmeq
->
»sourû
.
cq_dma_addr
 =‚vmeq->cq_dma_addr;

277 ià(
mask
 & 
NVME_PEER_SQ_SZ
)

278 
nvmeq
->
»sourû
.
nvme_sq_size
 = 
	`SQ_SIZE
(
dev
->
q_d•th
);

280 ià(
mask
 & 
NVME_PEER_CQ_SZ
)

281 
nvmeq
->
»sourû
.
nvme_cq_size
 = 
	`CQ_SIZE
(
dev
->
q_d•th
);

283 ià(
mask
 & 
NVME_PEER_MEM_LOG_PG_SZ
)

284 
nvmeq
->
»sourû
.
memÜy_log_·ge_size
 = 
	`__ffs
(
dev
->
ù¾
.
·ge_size
 >> 12);

286 
nvmeq
->
»sourû
.
æags
 = 
NVME_QUEUE_PHYS_CONTIG
;

287 
nvmeq
->
»sourû
.
¡Ý_ma¡”_³”
 = stop_master_peer;

288 
nvmeq
->
»sourû
.
dd_d©a
 = dd_data;

290  
»t
;

291 
	}
}

293 
	$nvme_³”_put_»sourû
(
nvme_³”_»sourû
 *
»sourû
, 
boÞ
 
»¡¬t
)

295 
nvme_queue
 *
nvmeq
 = 
	`cÚš”_of
(
»sourû
, nvme_queue,

296 
»sourû
);

297 
	`mu‹x_lock
(&
»sourû
->
lock
);

298 
»sourû
->
š_u£
 = 
çl£
;

299 
»sourû
->
¡Ý_ma¡”_³”
 = 
NULL
;

300 
»sourû
->
dd_d©a
 = 
NULL
;

301 
	`mu‹x_uÆock
(&
»sourû
->
lock
);

306 ià(
»¡¬t
) {

307 
	`nvme_su¥’d_queue
(
nvmeq
);

308 
	`ad­‹r_d–‘e_sq
(
nvmeq
->
dev
,‚vmeq->
qid
);

309 
	`ad­‹r_d–‘e_cq
(
nvmeq
->
dev
,‚vmeq->
qid
);

310 
	`nvme_ü—‹_queue
(
nvmeq
,‚vmeq->
qid
);

312 
	}
}

313 
EXPORT_SYMBOL_GPL
(
nvme_³”_put_»sourû
);

315 
nvme_³”_»sourû
 *
nvme_³”_g‘_»sourû
(
pci_dev
 *
pdev
,

316 
nvme_³”_»sourû_mask
 
mask
,

317 (* 
¡Ý_ma¡”_³”
)(*
´iv
), *
dd_d©a
)

319 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

320 
nvme_queue
 *
nvmeq
;

321 
i
;

322 
»t
;

324 ià(!
dev
)

325  
NULL
;

327 
i
 = 0; i < 
dev
->
Úlše_queues
; i++) {

328 
nvmeq
 = &
dev
->
queues
[
i
];

329 ià(
nvmeq
->
p2p
) {

330 
	`mu‹x_lock
(&
nvmeq
->
»sourû
.
lock
);

331 ià(!
nvmeq
->
»sourû
.
š_u£
) {

332 
»t
 = 
	`nvme_³”_š™_»sourû
(
nvmeq
, 
mask
,

333 
¡Ý_ma¡”_³”
,

334 
dd_d©a
);

335 ià(!
»t
) {

336 
nvmeq
->
»sourû
.
š_u£
 = 
Œue
;

337 
	`mu‹x_uÆock
(&
nvmeq
->
»sourû
.
lock
);

338  &
nvmeq
->
»sourû
;

341 
	`mu‹x_uÆock
(&
nvmeq
->
»sourû
.
lock
);

345  
NULL
;

346 
	}
}

347 
EXPORT_SYMBOL_GPL
(
nvme_³”_g‘_»sourû
);

352 
šlše
 
	$_nvme_check_size
()

354 
	`BUILD_BUG_ON
((
nvme_rw_commªd
) != 64);

355 
	`BUILD_BUG_ON
((
nvme_ü—‹_cq
) != 64);

356 
	`BUILD_BUG_ON
((
nvme_ü—‹_sq
) != 64);

357 
	`BUILD_BUG_ON
((
nvme_d–‘e_queue
) != 64);

358 
	`BUILD_BUG_ON
((
nvme_ã©u»s
) != 64);

359 
	`BUILD_BUG_ON
((
nvme_fÜm©_cmd
) != 64);

360 
	`BUILD_BUG_ON
((
nvme_abÜt_cmd
) != 64);

361 
	`BUILD_BUG_ON
((
nvme_commªd
) != 64);

362 
	`BUILD_BUG_ON
((
nvme_id_ù¾
è!ð
NVME_IDENTIFY_DATA_SIZE
);

363 
	`BUILD_BUG_ON
((
nvme_id_ns
è!ð
NVME_IDENTIFY_DATA_SIZE
);

364 
	`BUILD_BUG_ON
((
nvme_lba_¿nge_ty³
) != 64);

365 
	`BUILD_BUG_ON
((
nvme_sm¬t_log
) != 512);

366 
	`BUILD_BUG_ON
((
nvme_dbbuf
) != 64);

367 
	}
}

369 
šlše
 
	$nvme_dbbuf_size
(
u32
 
¡ride
)

371  ((
	`num_possibË_ýus
(è+ 1è* 8 * 
¡ride
);

372 
	}
}

374 
	$nvme_dbbuf_dma_®loc
(
nvme_dev
 *
dev
)

376 
mem_size
 = 
	`nvme_dbbuf_size
(
dev
->
db_¡ride
);

378 ià(
dev
->
dbbuf_dbs
)

381 
dev
->
dbbuf_dbs
 = 
	`dma_®loc_coh”’t
(dev->dev, 
mem_size
,

382 &
dev
->
dbbuf_dbs_dma_addr
,

383 
GFP_KERNEL
);

384 ià(!
dev
->
dbbuf_dbs
)

385  -
ENOMEM
;

386 
dev
->
dbbuf_eis
 = 
	`dma_®loc_coh”’t
(dev->dev, 
mem_size
,

387 &
dev
->
dbbuf_eis_dma_addr
,

388 
GFP_KERNEL
);

389 ià(!
dev
->
dbbuf_eis
) {

390 
	`dma_ä“_coh”’t
(
dev
->dev, 
mem_size
,

391 
dev
->
dbbuf_dbs
, dev->
dbbuf_dbs_dma_addr
);

392 
dev
->
dbbuf_dbs
 = 
NULL
;

393  -
ENOMEM
;

397 
	}
}

399 
	$nvme_dbbuf_dma_ä“
(
nvme_dev
 *
dev
)

401 
mem_size
 = 
	`nvme_dbbuf_size
(
dev
->
db_¡ride
);

403 ià(
dev
->
dbbuf_dbs
) {

404 
	`dma_ä“_coh”’t
(
dev
->dev, 
mem_size
,

405 
dev
->
dbbuf_dbs
, dev->
dbbuf_dbs_dma_addr
);

406 
dev
->
dbbuf_dbs
 = 
NULL
;

408 ià(
dev
->
dbbuf_eis
) {

409 
	`dma_ä“_coh”’t
(
dev
->dev, 
mem_size
,

410 
dev
->
dbbuf_eis
, dev->
dbbuf_eis_dma_addr
);

411 
dev
->
dbbuf_eis
 = 
NULL
;

413 
	}
}

415 
	$nvme_dbbuf_š™
(
nvme_dev
 *
dev
,

416 
nvme_queue
 *
nvmeq
, 
qid
)

418 ià(!
dev
->
dbbuf_dbs
 || !
qid
)

421 
nvmeq
->
dbbuf_sq_db
 = &
dev
->
dbbuf_dbs
[
	`sq_idx
(
qid
, dev->
db_¡ride
)];

422 
nvmeq
->
dbbuf_cq_db
 = &
dev
->
dbbuf_dbs
[
	`cq_idx
(
qid
, dev->
db_¡ride
)];

423 
nvmeq
->
dbbuf_sq_ei
 = &
dev
->
dbbuf_eis
[
	`sq_idx
(
qid
, dev->
db_¡ride
)];

424 
nvmeq
->
dbbuf_cq_ei
 = &
dev
->
dbbuf_eis
[
	`cq_idx
(
qid
, dev->
db_¡ride
)];

425 
	}
}

427 
	$nvme_dbbuf_£t
(
nvme_dev
 *
dev
)

429 
nvme_commªd
 
c
;

431 ià(!
dev
->
dbbuf_dbs
)

434 
	`mem£t
(&
c
, 0, (c));

435 
c
.
dbbuf
.
Ýcode
 = 
nvme_admš_dbbuf
;

436 
c
.
dbbuf
.
´p1
 = 
	`ýu_to_Ë64
(
dev
->
dbbuf_dbs_dma_addr
);

437 
c
.
dbbuf
.
´p2
 = 
	`ýu_to_Ë64
(
dev
->
dbbuf_eis_dma_addr
);

439 ià(
	`nvme_subm™_sync_cmd
(
dev
->
ù¾
.
admš_q
, &
c
, 
NULL
, 0)) {

440 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
, "unableo set dbbuf\n");

442 
	`nvme_dbbuf_dma_ä“
(
dev
);

444 
	}
}

446 
šlše
 
	$nvme_dbbuf_Ãed_ev’t
(
u16
 
ev’t_idx
, u16 
Ãw_idx
, u16 
Þd
)

448  (
u16
)(
Ãw_idx
 - 
ev’t_idx
 - 1è< (u16)Òew_idx - 
Þd
);

449 
	}
}

452 
boÞ
 
	$nvme_dbbuf_upd©e_ªd_check_ev’t
(
u16
 
v®ue
, 
u32
 *
dbbuf_db
,

453 vÞ©ž
u32
 *
dbbuf_ei
)

455 ià(
dbbuf_db
) {

456 
u16
 
Þd_v®ue
;

462 
	`wmb
();

464 
Þd_v®ue
 = *
dbbuf_db
;

465 *
dbbuf_db
 = 
v®ue
;

467 ià(!
	`nvme_dbbuf_Ãed_ev’t
(*
dbbuf_ei
, 
v®ue
, 
Þd_v®ue
))

468  
çl£
;

471  
Œue
;

472 
	}
}

477 
	#NVME_INT_PAGES
 2

	)

478 
	#NVME_INT_BYTES
(
dev
è(
NVME_INT_PAGES
 * (dev)->
ù¾
.
·ge_size
)

	)

485 
	$nvme_Åages
(
size
, 
nvme_dev
 *
dev
)

487 
Å½s
 = 
	`DIV_ROUND_UP
(
size
 + 
dev
->
ù¾
.
·ge_size
,

488 
dev
->
ù¾
.
·ge_size
);

489  
	`DIV_ROUND_UP
(8 * 
Å½s
, 
PAGE_SIZE
 - 8);

490 
	}
}

496 
	$nvme_pci_Åages_sgl
(
num_£g
)

498  
	`DIV_ROUND_UP
(
num_£g
 * (
nvme_sgl_desc
), 
PAGE_SIZE
);

499 
	}
}

501 
	$nvme_pci_iod_®loc_size
(
nvme_dev
 *
dev
,

502 
size
, 
n£g
, 
boÞ
 
u£_sgl
)

504 
size_t
 
®loc_size
;

506 ià(
u£_sgl
)

507 
®loc_size
 = (
__Ë64
 *è* 
	`nvme_pci_Åages_sgl
(
n£g
);

509 
®loc_size
 = (
__Ë64
 *è* 
	`nvme_Åages
(
size
, 
dev
);

511  
®loc_size
 + (
sÿ‰”li¡
è* 
n£g
;

512 
	}
}

514 
	$nvme_pci_cmd_size
(
nvme_dev
 *
dev
, 
boÞ
 
u£_sgl
)

516 
®loc_size
 = 
	`nvme_pci_iod_®loc_size
(
dev
,

517 
	`NVME_INT_BYTES
(
dev
), 
NVME_INT_PAGES
,

518 
u£_sgl
);

520  (
nvme_iod
è+ 
®loc_size
;

521 
	}
}

523 #iâdeà
HAVE_PCI_FREE_IRQ


524 
	$nvmeq_œq
(
nvme_queue
 *
nvmeq
)

526 #ifdeà
HAVE_PCI_IRQ_API


527  
	`pci_œq_veùÜ
(
	`to_pci_dev
(
nvmeq
->
dev
->dev),‚vmeq->
cq_veùÜ
);

529  
nvmeq
->
dev
->
’Œy
[nvmeq->
cq_veùÜ
].
veùÜ
;

531 
	}
}

534 
	$nvme_admš_š™_hùx
(
blk_mq_hw_ùx
 *
hùx
, *
d©a
,

535 
hùx_idx
)

537 
nvme_dev
 *
dev
 = 
d©a
;

538 
nvme_queue
 *
nvmeq
 = &
dev
->
queues
[0];

540 
	`WARN_ON
(
hùx_idx
 != 0);

541 
	`WARN_ON
(
dev
->
admš_g£t
.
gs
[0] !ð
hùx
->tags);

542 
	`WARN_ON
(
nvmeq
->
gs
);

544 
hùx
->
driv”_d©a
 = 
nvmeq
;

545 
nvmeq
->
gs
 = &
dev
->
admš_g£t
.tags[0];

547 
	}
}

549 
	$nvme_admš_ex™_hùx
(
blk_mq_hw_ùx
 *
hùx
, 
hùx_idx
)

551 
nvme_queue
 *
nvmeq
 = 
hùx
->
driv”_d©a
;

553 
nvmeq
->
gs
 = 
NULL
;

554 
	}
}

556 
	$nvme_š™_hùx
(
blk_mq_hw_ùx
 *
hùx
, *
d©a
,

557 
hùx_idx
)

559 
nvme_dev
 *
dev
 = 
d©a
;

560 
nvme_queue
 *
nvmeq
 = &
dev
->
queues
[
hùx_idx
 + 1];

562 ià(!
nvmeq
->
gs
)

563 
nvmeq
->
gs
 = &
dev
->
g£t
.gs[
hùx_idx
];

565 
	`WARN_ON
(
dev
->
g£t
.
gs
[
hùx_idx
] !ð
hùx
->tags);

566 
hùx
->
driv”_d©a
 = 
nvmeq
;

568 
	}
}

570 #ifdeà
HAVE_BLK_MQ_OPS_INIT_REQUEST_HAS_4_PARAMS


571 
	$nvme_š™_»que¡
(
blk_mq_g_£t
 *
£t
, 
»que¡
 *
»q
,

572 
hùx_idx
, 
numa_node
)

574 
nvme_dev
 *
dev
 = 
£t
->
driv”_d©a
;

575 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

576 
queue_idx
 = (
£t
 =ð&
dev
->
g£t
è? 
hùx_idx
 + 1 : 0;

577 
nvme_queue
 *
nvmeq
 = &
dev
->
queues
[
queue_idx
];

579 
	`BUG_ON
(!
nvmeq
);

580 
iod
->
nvmeq
 =‚vmeq;

582 
	}
}

584 
	$nvme_š™_»que¡
(*
d©a
, 
»que¡
 *
»q
,

585 
hùx_idx
, 
rq_idx
,

586 
numa_node
)

588 
nvme_dev
 *
dev
 = 
d©a
;

589 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

590 
nvme_queue
 *
nvmeq
 = &
dev
->
queues
[
hùx_idx
 + 1];

592 
	`BUG_ON
(!
nvmeq
);

593 
iod
->
nvmeq
 =‚vmeq;

595 
	}
}

597 
	$nvme_admš_š™_»que¡
(*
d©a
, 
»que¡
 *
»q
,

598 
hùx_idx
, 
rq_idx
,

599 
numa_node
)

601 
nvme_dev
 *
dev
 = 
d©a
;

602 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

603 
nvme_queue
 *
nvmeq
 = &
dev
->
queues
[0];

605 
	`BUG_ON
(!
nvmeq
);

606 
iod
->
nvmeq
 =‚vmeq;

608 
	}
}

611 #ifdeà
HAVE_BLK_MQ_OPS_MAP_QUEUES


612 
	$nvme_pci_m­_queues
(
blk_mq_g_£t
 *
£t
)

614 
nvme_dev
 *
dev
 = 
£t
->
driv”_d©a
;

616 #ià
	`defšed
(
HAVE_PCI_IRQ_API
è&& defšed(
HAVE_IRQ_CALC_AFFINITY_VECTORS_3_ARGS
)

617 #ifdeà
HAVE_BLK_MQ_PCI_MAP_QUEUES_3_ARGS


618  
	`blk_mq_pci_m­_queues
(
£t
, 
	`to_pci_dev
(
dev
->dev),

619 
dev
->
num_vecs
 > 1 ? 1 : 0);

621  
	`__blk_mq_pci_m­_queues
(
£t
, 
	`to_pci_dev
(
dev
->dev),

622 
dev
->
num_vecs
 > 1 ? 1 : 0);

625 #ifdeà
HAVE_BLK_MQ_PCI_MAP_QUEUES_3_ARGS


626  
	`blk_mq_pci_m­_queues
(
£t
, 
	`to_pci_dev
(
dev
->dev), 0);

628  
	`__blk_mq_pci_m­_queues
(
£t
, 
	`to_pci_dev
(
dev
->dev), 0);

631 
	}
}

639 
	$nvme_subm™_cmd
(
nvme_queue
 *
nvmeq
, 
nvme_commªd
 *
cmd
)

641 
	`¥š_lock
(&
nvmeq
->
sq_lock
);

642 ià(
nvmeq
->
sq_cmds_io
)

643 
	`memýy_toio
(&
nvmeq
->
sq_cmds_io
[nvmeq->
sq_ž
], 
cmd
,

644 (*
cmd
));

646 
	`memýy
(&
nvmeq
->
sq_cmds
[nvmeq->
sq_ž
], 
cmd
, (*cmd));

648 ià(++
nvmeq
->
sq_ž
 =ðnvmeq->
q_d•th
)

649 
nvmeq
->
sq_ž
 = 0;

650 ià(
	`nvme_dbbuf_upd©e_ªd_check_ev’t
(
nvmeq
->
sq_ž
,

651 
nvmeq
->
dbbuf_sq_db
,‚vmeq->
dbbuf_sq_ei
))

652 
	`wr™–
(
nvmeq
->
sq_ž
,‚vmeq->
q_db
);

653 
	`¥š_uÆock
(&
nvmeq
->
sq_lock
);

654 
	}
}

656 **
	$nvme_pci_iod_li¡
(
»que¡
 *
»q
)

658 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

659  (**)(
iod
->
sg
 + 
	`blk_rq_Ä_phys_£gm’ts
(
»q
));

660 
	}
}

662 
šlše
 
boÞ
 
	$nvme_pci_u£_sgls
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
)

664 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

665 
n£g
 = 
	`blk_rq_Ä_phys_£gm’ts
(
»q
);

666 
avg_£g_size
;

668 ià(
n£g
 == 0)

669  
çl£
;

671 #ifdeà
HAVE_BLK_RQ_NR_PAYLOAD_BYTES


672 
avg_£g_size
 = 
	`DIV_ROUND_UP
(
	`blk_rq_·ylßd_by‹s
(
»q
), 
n£g
);

674 
avg_£g_size
 = 
	`DIV_ROUND_UP
(
	`nvme_m­_Ën
(
»q
), 
n£g
);

677 ià(!(
dev
->
ù¾
.
sgls
 & ((1 << 0) | (1 << 1))))

678  
çl£
;

679 ià(!
iod
->
nvmeq
->
qid
)

680  
çl£
;

681 ià(!
sgl_th»shÞd
 || 
avg_£g_size
 < sgl_threshold)

682  
çl£
;

683  
Œue
;

684 
	}
}

686 
blk_¡©us_t
 
	$nvme_š™_iod
(
»que¡
 *
rq
, 
nvme_dev
 *
dev
)

688 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
rq
);

689 
n£g
 = 
	`blk_rq_Ä_phys_£gm’ts
(
rq
);

690 #ifdeà
HAVE_BLK_RQ_NR_PAYLOAD_BYTES


691 
size
 = 
	`blk_rq_·ylßd_by‹s
(
rq
);

693 
size
 = 
	`nvme_m­_Ën
(
rq
);

696 
iod
->
u£_sgl
 = 
	`nvme_pci_u£_sgls
(
dev
, 
rq
);

698 ià(
n£g
 > 
NVME_INT_PAGES
 || 
size
 > 
	`NVME_INT_BYTES
(
dev
)) {

699 
size_t
 
®loc_size
 = 
	`nvme_pci_iod_®loc_size
(
dev
, 
size
, 
n£g
,

700 
iod
->
u£_sgl
);

702 
iod
->
sg
 = 
	`km®loc
(
®loc_size
, 
GFP_ATOMIC
);

703 ià(!
iod
->
sg
)

704  
BLK_STS_RESOURCE
;

706 
iod
->
sg
 = iod->
šlše_sg
;

709 
iod
->
abÜ‹d
 = 0;

710 
iod
->
Åages
 = -1;

711 
iod
->
ÃÁs
 = 0;

712 
iod
->
Ëngth
 = 
size
;

714  
BLK_STS_OK
;

715 
	}
}

717 
	$nvme_ä“_iod
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
)

719 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

720 cÚ¡ 
Ï¡_´p
 = 
dev
->
ù¾
.
·ge_size
 / (
__Ë64
) - 1;

721 
dma_addr_t
 
dma_addr
 = 
iod
->
fœ¡_dma
, 
Ãxt_dma_addr
;

723 
i
;

725 ià(
iod
->
Åages
 == 0)

726 
	`dma_poÞ_ä“
(
dev
->
´p_sm®l_poÞ
, 
	`nvme_pci_iod_li¡
(
»q
)[0],

727 
dma_addr
);

729 
i
 = 0; i < 
iod
->
Åages
; i++) {

730 *
addr
 = 
	`nvme_pci_iod_li¡
(
»q
)[
i
];

732 ià(
iod
->
u£_sgl
) {

733 
nvme_sgl_desc
 *
sg_li¡
 = 
addr
;

735 
Ãxt_dma_addr
 =

736 
	`Ë64_to_ýu
((
sg_li¡
[
SGES_PER_PAGE
 - 1]).
addr
);

738 
__Ë64
 *
´p_li¡
 = 
addr
;

740 
Ãxt_dma_addr
 = 
	`Ë64_to_ýu
(
´p_li¡
[
Ï¡_´p
]);

743 
	`dma_poÞ_ä“
(
dev
->
´p_·ge_poÞ
, 
addr
, 
dma_addr
);

744 
dma_addr
 = 
Ãxt_dma_addr
;

747 ià(
iod
->
sg
 !ðiod->
šlše_sg
)

748 
	`kä“
(
iod
->
sg
);

749 
	}
}

751 #ià
defšed
(
CONFIG_BLK_DEV_INTEGRITY
è&& defšed(
HAVE_BLK_TYPES_REQ_INTEGRITY
)

752 
	$nvme_dif_´•
(
u32
 
p
, u32 
v
, 
t10_pi_tu¶e
 *
pi
)

754 ià(
	`be32_to_ýu
(
pi
->
»f_g
è=ð
v
)

755 
pi
->
»f_g
 = 
	`ýu_to_be32
(
p
);

756 
	}
}

758 
	$nvme_dif_com¶‘e
(
u32
 
p
, u32 
v
, 
t10_pi_tu¶e
 *
pi
)

760 ià(
	`be32_to_ýu
(
pi
->
»f_g
è=ð
p
)

761 
pi
->
»f_g
 = 
	`ýu_to_be32
(
v
);

762 
	}
}

774 
nvme_dif_»m­
(
»que¡
 *
»q
,

775 (*
dif_sw­
)(
u32
 
p
, u32 
v
, 
t10_pi_tu¶e
 *
pi
))

777 
nvme_ns
 *
ns
 = 
»q
->
rq_disk
->
´iv©e_d©a
;

778 
bio_š‹gr™y_·ylßd
 *
b
;

779 
t10_pi_tu¶e
 *
pi
;

780 *
p
, *
pm­
;

781 
u32
 
i
, 
Æb
, 
ts
, 
phys
, 
vœt
;

783 ià(!
ns
->
pi_ty³
 ||‚s->pi_ty³ =ð
NVME_NS_DPS_PI_TYPE3
)

786 
b
 = 
	`bio_š‹gr™y
(
»q
->
bio
);

787 ià(!
b
)

790 
pm­
 = 
	`km­_©omic
(
b
->
b_vec
->
bv_·ge
è+ b->b_vec->
bv_off£t
;

792 
p
 = 
pm­
;

793 
vœt
 = 
	`b_g‘_£ed
(
b
);

794 
phys
 = 
	`nvme_block_Ä
(
ns
, 
	`blk_rq_pos
(
»q
));

795 
Æb
 = (
	`blk_rq_by‹s
(
»q
è>> 
ns
->
lba_shiá
);

796 
ts
 = 
ns
->
disk
->
queue
->
š‹gr™y
.
tu¶e_size
;

798 
i
 = 0; i < 
Æb
; i++, 
vœt
++, 
phys
++) {

799 
pi
 = (
t10_pi_tu¶e
 *)
p
;

800 
	`dif_sw­
(
phys
, 
vœt
, 
pi
);

801 
p
 +ð
ts
;

803 
	`kunm­_©omic
(
pm­
);

804 
	}
}

806 
nvme_dif_»m­
(
»que¡
 *
»q
,

807 (*
dif_sw­
)(
u32
 
p
, u32 
v
, 
t10_pi_tu¶e
 *
pi
))

809 
	}
}

810 
	$nvme_dif_´•
(
u32
 
p
, u32 
v
, 
t10_pi_tu¶e
 *
pi
)

812 
	}
}

813 
	$nvme_dif_com¶‘e
(
u32
 
p
, u32 
v
, 
t10_pi_tu¶e
 *
pi
)

815 
	}
}

818 #ifdeà
HAVE_ONCE_H


819 
	$nvme_´št_sgl
(
sÿ‰”li¡
 *
sgl
, 
ÃÁs
)

821 
i
;

822 
sÿ‰”li¡
 *
sg
;

824 
	`fÜ_—ch_sg
(
sgl
, 
sg
, 
ÃÁs
, 
i
) {

825 
dma_addr_t
 
phys
 = 
	`sg_phys
(
sg
);

826 
	`´_w¬n
("sg[%d]…hys_addr:%pad offset:%d†ength:%d "

828 
i
, &
phys
, 
sg
->
off£t
, sg->
Ëngth
, &
	`sg_dma_add»ss
(sg),

829 
	`sg_dma_Ën
(
sg
));

831 
	}
}

834 
blk_¡©us_t
 
	$nvme_pci_£tup_´ps
(
nvme_dev
 *
dev
,

835 
»que¡
 *
»q
, 
nvme_rw_commªd
 *
cmnd
)

837 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

838 
dma_poÞ
 *
poÞ
;

839 #ifdeà
HAVE_BLK_RQ_NR_PAYLOAD_BYTES


840 
Ëngth
 = 
	`blk_rq_·ylßd_by‹s
(
»q
);

842 
Ëngth
 = 
	`nvme_m­_Ën
(
»q
);

844 
sÿ‰”li¡
 *
sg
 = 
iod
->sg;

845 
dma_Ën
 = 
	`sg_dma_Ën
(
sg
);

846 
u64
 
dma_addr
 = 
	`sg_dma_add»ss
(
sg
);

847 
u32
 
·ge_size
 = 
dev
->
ù¾
.page_size;

848 
off£t
 = 
dma_addr
 & (
·ge_size
 - 1);

849 
__Ë64
 *
´p_li¡
;

850 **
li¡
 = 
	`nvme_pci_iod_li¡
(
»q
);

851 
dma_addr_t
 
´p_dma
;

852 
Å½s
, 
i
;

854 
Ëngth
 -ð(
·ge_size
 - 
off£t
);

855 ià(
Ëngth
 <= 0) {

856 
iod
->
fœ¡_dma
 = 0;

857 
dÚe
;

860 
dma_Ën
 -ð(
·ge_size
 - 
off£t
);

861 ià(
dma_Ën
) {

862 
dma_addr
 +ð(
·ge_size
 - 
off£t
);

864 
sg
 = 
	`sg_Ãxt
(sg);

865 
dma_addr
 = 
	`sg_dma_add»ss
(
sg
);

866 
dma_Ën
 = 
	`sg_dma_Ën
(
sg
);

869 ià(
Ëngth
 <ð
·ge_size
) {

870 
iod
->
fœ¡_dma
 = 
dma_addr
;

871 
dÚe
;

874 
Å½s
 = 
	`DIV_ROUND_UP
(
Ëngth
, 
·ge_size
);

875 ià(
Å½s
 <= (256 / 8)) {

876 
poÞ
 = 
dev
->
´p_sm®l_poÞ
;

877 
iod
->
Åages
 = 0;

879 
poÞ
 = 
dev
->
´p_·ge_poÞ
;

880 
iod
->
Åages
 = 1;

883 
´p_li¡
 = 
	`dma_poÞ_®loc
(
poÞ
, 
GFP_ATOMIC
, &
´p_dma
);

884 ià(!
´p_li¡
) {

885 
iod
->
fœ¡_dma
 = 
dma_addr
;

886 
iod
->
Åages
 = -1;

887  
BLK_STS_RESOURCE
;

889 
li¡
[0] = 
´p_li¡
;

890 
iod
->
fœ¡_dma
 = 
´p_dma
;

891 
i
 = 0;

893 ià(
i
 =ð
·ge_size
 >> 3) {

894 
__Ë64
 *
Þd_´p_li¡
 = 
´p_li¡
;

895 
´p_li¡
 = 
	`dma_poÞ_®loc
(
poÞ
, 
GFP_ATOMIC
, &
´p_dma
);

896 ià(!
´p_li¡
)

897  
BLK_STS_RESOURCE
;

898 
li¡
[
iod
->
Åages
++] = 
´p_li¡
;

899 
´p_li¡
[0] = 
Þd_´p_li¡
[
i
 - 1];

900 
Þd_´p_li¡
[
i
 - 1] = 
	`ýu_to_Ë64
(
´p_dma
);

901 
i
 = 1;

903 
´p_li¡
[
i
++] = 
	`ýu_to_Ë64
(
dma_addr
);

904 
dma_Ën
 -ð
·ge_size
;

905 
dma_addr
 +ð
·ge_size
;

906 
Ëngth
 -ð
·ge_size
;

907 ià(
Ëngth
 <= 0)

909 ià(
dma_Ën
 > 0)

911 ià(
	`uÆik–y
(
dma_Ën
 < 0))

912 
bad_sgl
;

913 
sg
 = 
	`sg_Ãxt
(sg);

914 
dma_addr
 = 
	`sg_dma_add»ss
(
sg
);

915 
dma_Ën
 = 
	`sg_dma_Ën
(
sg
);

918 
dÚe
:

919 
cmnd
->
d±r
.
´p1
 = 
	`ýu_to_Ë64
(
	`sg_dma_add»ss
(
iod
->
sg
));

920 
cmnd
->
d±r
.
´p2
 = 
	`ýu_to_Ë64
(
iod
->
fœ¡_dma
);

922  
BLK_STS_OK
;

924 
bad_sgl
:

925 #ifdeà
HAVE_ONCE_H


926 
	`WARN
(
	`DO_ONCE
(
nvme_´št_sgl
, 
iod
->
sg
, iod->
ÃÁs
),

928 #ifdeà
HAVE_BLK_RQ_NR_PAYLOAD_BYTES


929 
	`blk_rq_·ylßd_by‹s
(
»q
), 
iod
->
ÃÁs
);

931 
	`nvme_m­_Ën
(
»q
), 
iod
->
ÃÁs
);

934 ià(
	`WARN_ONCE
(1, "Invalid SGL for…ayload:%d‚ents:%d\n",

935 #ifdeà
HAVE_BLK_RQ_NR_PAYLOAD_BYTES


936 
	`blk_rq_·ylßd_by‹s
(
»q
), 
iod
->
ÃÁs
)) {

938 
	`nvme_m­_Ën
(
»q
), 
iod
->
ÃÁs
)) {

940 
	`fÜ_—ch_sg
(
iod
->
sg
, sg, iod->
ÃÁs
, 
i
) {

941 
dma_addr_t
 
phys
 = 
	`sg_phys
(
sg
);

942 
	`´_w¬n
("sg[%d]…hys_addr:%pad offset:%d†ength:%d "

943 "dma_add»ss:%·d dma_Ëngth:%d\n", 
i
, &
phys
,

944 
sg
->
off£t
, sg->
Ëngth
,

945 &
	`sg_dma_add»ss
(
sg
),

946 
	`sg_dma_Ën
(
sg
));

950  
BLK_STS_IOERR
;

951 
	}
}

953 
	$nvme_pci_sgl_£t_d©a
(
nvme_sgl_desc
 *
sge
,

954 
sÿ‰”li¡
 *
sg
)

956 
sge
->
addr
 = 
	`ýu_to_Ë64
(
	`sg_dma_add»ss
(
sg
));

957 
sge
->
Ëngth
 = 
	`ýu_to_Ë32
(
	`sg_dma_Ën
(
sg
));

958 
sge
->
ty³
 = 
NVME_SGL_FMT_DATA_DESC
 << 4;

959 
	}
}

961 
	$nvme_pci_sgl_£t_£g
(
nvme_sgl_desc
 *
sge
,

962 
dma_addr_t
 
dma_addr
, 
’Œ›s
)

964 
sge
->
addr
 = 
	`ýu_to_Ë64
(
dma_addr
);

965 ià(
’Œ›s
 < 
SGES_PER_PAGE
) {

966 
sge
->
Ëngth
 = 
	`ýu_to_Ë32
(
’Œ›s
 * (*sge));

967 
sge
->
ty³
 = 
NVME_SGL_FMT_LAST_SEG_DESC
 << 4;

969 
sge
->
Ëngth
 = 
	`ýu_to_Ë32
(
PAGE_SIZE
);

970 
sge
->
ty³
 = 
NVME_SGL_FMT_SEG_DESC
 << 4;

972 
	}
}

974 
blk_¡©us_t
 
	$nvme_pci_£tup_sgls
(
nvme_dev
 *
dev
,

975 
»que¡
 *
»q
, 
nvme_rw_commªd
 *
cmd
, 
’Œ›s
)

977 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

978 
dma_poÞ
 *
poÞ
;

979 
nvme_sgl_desc
 *
sg_li¡
;

980 
sÿ‰”li¡
 *
sg
 = 
iod
->sg;

981 
dma_addr_t
 
sgl_dma
;

982 
i
 = 0;

985 
cmd
->
æags
 = 
NVME_CMD_SGL_METABUF
;

987 ià(
’Œ›s
 == 1) {

988 
	`nvme_pci_sgl_£t_d©a
(&
cmd
->
d±r
.
sgl
, 
sg
);

989  
BLK_STS_OK
;

992 ià(
’Œ›s
 <ð(256 / (
nvme_sgl_desc
))) {

993 
poÞ
 = 
dev
->
´p_sm®l_poÞ
;

994 
iod
->
Åages
 = 0;

996 
poÞ
 = 
dev
->
´p_·ge_poÞ
;

997 
iod
->
Åages
 = 1;

1000 
sg_li¡
 = 
	`dma_poÞ_®loc
(
poÞ
, 
GFP_ATOMIC
, &
sgl_dma
);

1001 ià(!
sg_li¡
) {

1002 
iod
->
Åages
 = -1;

1003  
BLK_STS_RESOURCE
;

1006 
	`nvme_pci_iod_li¡
(
»q
)[0] = 
sg_li¡
;

1007 
iod
->
fœ¡_dma
 = 
sgl_dma
;

1009 
	`nvme_pci_sgl_£t_£g
(&
cmd
->
d±r
.
sgl
, 
sgl_dma
, 
’Œ›s
);

1012 ià(
i
 =ð
SGES_PER_PAGE
) {

1013 
nvme_sgl_desc
 *
Þd_sg_desc
 = 
sg_li¡
;

1014 
nvme_sgl_desc
 *
lšk
 = &
Þd_sg_desc
[
i
 - 1];

1016 
sg_li¡
 = 
	`dma_poÞ_®loc
(
poÞ
, 
GFP_ATOMIC
, &
sgl_dma
);

1017 ià(!
sg_li¡
)

1018  
BLK_STS_RESOURCE
;

1020 
i
 = 0;

1021 
	`nvme_pci_iod_li¡
(
»q
)[
iod
->
Åages
++] = 
sg_li¡
;

1022 
sg_li¡
[
i
++] = *
lšk
;

1023 
	`nvme_pci_sgl_£t_£g
(
lšk
, 
sgl_dma
, 
’Œ›s
);

1026 
	`nvme_pci_sgl_£t_d©a
(&
sg_li¡
[
i
++], 
sg
);

1027 
sg
 = 
	`sg_Ãxt
(sg);

1028 } --
’Œ›s
 > 0);

1030  
BLK_STS_OK
;

1031 
	}
}

1033 
blk_¡©us_t
 
	$nvme_m­_d©a
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
,

1034 
nvme_commªd
 *
cmnd
)

1036 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

1037 
»que¡_queue
 *
q
 = 
»q
->q;

1038 
dma_d©a_dœeùiÚ
 
dma_dœ
 = 
	`rq_d©a_dœ
(
»q
) ?

1039 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
;

1040 
blk_¡©us_t
 
»t
 = 
BLK_STS_IOERR
;

1041 
Ä_m­³d
;

1043 
	`sg_š™_bË
(
iod
->
sg
, 
	`blk_rq_Ä_phys_£gm’ts
(
»q
));

1044 
iod
->
ÃÁs
 = 
	`blk_rq_m­_sg
(
q
, 
»q
, iod->
sg
);

1045 ià(!
iod
->
ÃÁs
)

1046 
out
;

1048 
»t
 = 
BLK_STS_RESOURCE
;

1049 #ifdeà
HAVE_DMA_ATTR_NO_WARN


1050 
Ä_m­³d
 = 
	`dma_m­_sg_©Œs
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
,

1051 
DMA_ATTR_NO_WARN
);

1053 
Ä_m­³d
 = 
	`dma_m­_sg
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
);

1055 ià(!
Ä_m­³d
)

1056 
out
;

1058 ià(
iod
->
u£_sgl
)

1059 
»t
 = 
	`nvme_pci_£tup_sgls
(
dev
, 
»q
, &
cmnd
->
rw
, 
Ä_m­³d
);

1061 
»t
 = 
	`nvme_pci_£tup_´ps
(
dev
, 
»q
, &
cmnd
->
rw
);

1063 ià(
»t
 !ð
BLK_STS_OK
)

1064 
out_unm­
;

1066 
»t
 = 
BLK_STS_IOERR
;

1067 ià(
	`blk_š‹gr™y_rq
(
»q
)) {

1068 ià(
	`blk_rq_couÁ_š‹gr™y_sg
(
q
, 
»q
->
bio
) != 1)

1069 
out_unm­
;

1071 
	`sg_š™_bË
(&
iod
->
m‘a_sg
, 1);

1072 ià(
	`blk_rq_m­_š‹gr™y_sg
(
q
, 
»q
->
bio
, &
iod
->
m‘a_sg
) != 1)

1073 
out_unm­
;

1075 #ifdeà
HAVE_REQ_OP


1076 ià(
	`»q_Ý
(
»q
è=ð
REQ_OP_WRITE
)

1078 ià(
	`rq_d©a_dœ
(
»q
))

1080 
	`nvme_dif_»m­
(
»q
, 
nvme_dif_´•
);

1082 ià(!
	`dma_m­_sg
(
dev
->dev, &
iod
->
m‘a_sg
, 1, 
dma_dœ
))

1083 
out_unm­
;

1086 ià(
	`blk_š‹gr™y_rq
(
»q
))

1087 
cmnd
->
rw
.
m‘ad©a
 = 
	`ýu_to_Ë64
(
	`sg_dma_add»ss
(&
iod
->
m‘a_sg
));

1088  
BLK_STS_OK
;

1090 
out_unm­
:

1091 
	`dma_unm­_sg
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
);

1092 
out
:

1093  
»t
;

1094 
	}
}

1096 
	$nvme_unm­_d©a
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
)

1098 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

1099 
dma_d©a_dœeùiÚ
 
dma_dœ
 = 
	`rq_d©a_dœ
(
»q
) ?

1100 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
;

1102 ià(
iod
->
ÃÁs
) {

1103 
	`dma_unm­_sg
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
);

1104 ià(
	`blk_š‹gr™y_rq
(
»q
)) {

1105 #ifdeà
HAVE_REQ_OP


1106 ià(
	`»q_Ý
(
»q
è=ð
REQ_OP_READ
)

1108 ià(!
	`rq_d©a_dœ
(
»q
))

1110 
	`nvme_dif_»m­
(
»q
, 
nvme_dif_com¶‘e
);

1111 
	`dma_unm­_sg
(
dev
->dev, &
iod
->
m‘a_sg
, 1, 
dma_dœ
);

1115 
	`nvme_þ—nup_cmd
(
»q
);

1116 
	`nvme_ä“_iod
(
dev
, 
»q
);

1117 
	}
}

1122 
blk_¡©us_t
 
	$nvme_queue_rq
(
blk_mq_hw_ùx
 *
hùx
,

1123 cÚ¡ 
blk_mq_queue_d©a
 *
bd
)

1125 
nvme_ns
 *
ns
 = 
hùx
->
queue
->
queued©a
;

1126 
nvme_queue
 *
nvmeq
 = 
hùx
->
driv”_d©a
;

1127 
nvme_dev
 *
dev
 = 
nvmeq
->dev;

1128 
»que¡
 *
»q
 = 
bd
->
rq
;

1129 
nvme_commªd
 
cmnd
;

1130 
blk_¡©us_t
 
»t
;

1136 ià(
	`uÆik–y
(
nvmeq
->
cq_veùÜ
 < 0))

1137  
BLK_STS_IOERR
;

1139 
»t
 = 
	`nvme_£tup_cmd
(
ns
, 
»q
, &
cmnd
);

1140 ià(
»t
)

1141  
»t
;

1143 
»t
 = 
	`nvme_š™_iod
(
»q
, 
dev
);

1144 ià(
»t
)

1145 
out_ä“_cmd
;

1147 ià(
	`blk_rq_Ä_phys_£gm’ts
(
»q
)) {

1148 
»t
 = 
	`nvme_m­_d©a
(
dev
, 
»q
, &
cmnd
);

1149 ià(
»t
)

1150 
out_þ—nup_iod
;

1153 
	`blk_mq_¡¬t_»que¡
(
»q
);

1154 
	`nvme_subm™_cmd
(
nvmeq
, &
cmnd
);

1155  
BLK_STS_OK
;

1156 
out_þ—nup_iod
:

1157 
	`nvme_ä“_iod
(
dev
, 
»q
);

1158 
out_ä“_cmd
:

1159 
	`nvme_þ—nup_cmd
(
»q
);

1160  
»t
;

1161 
	}
}

1163 
	$nvme_pci_com¶‘e_rq
(
»que¡
 *
»q
)

1165 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

1167 
	`nvme_unm­_d©a
(
iod
->
nvmeq
->
dev
, 
»q
);

1168 
	`nvme_com¶‘e_rq
(
»q
);

1169 
	}
}

1172 
šlše
 
boÞ
 
	$nvme_cqe_³ndšg
(
nvme_queue
 *
nvmeq
)

1174  (
	`Ë16_to_ýu
(
nvmeq
->
cqes
[nvmeq->
cq_h—d
].
¡©us
) & 1) ==

1175 
nvmeq
->
cq_pha£
;

1176 
	}
}

1178 
šlše
 
	$nvme_ršg_cq_doÜb–l
(
nvme_queue
 *
nvmeq
)

1180 
u16
 
h—d
 = 
nvmeq
->
cq_h—d
;

1182 ià(
	`lik–y
(
nvmeq
->
cq_veùÜ
 >= 0)) {

1183 ià(
	`nvme_dbbuf_upd©e_ªd_check_ev’t
(
h—d
, 
nvmeq
->
dbbuf_cq_db
,

1184 
nvmeq
->
dbbuf_cq_ei
))

1185 
	`wr™–
(
h—d
, 
nvmeq
->
q_db
 +‚vmeq->
dev
->
db_¡ride
);

1187 
	}
}

1189 
šlše
 
	$nvme_hªdË_cqe
(
nvme_queue
 *
nvmeq
, 
u16
 
idx
)

1191 vÞ©ž
nvme_com¶‘iÚ
 *
cqe
 = &
nvmeq
->
cqes
[
idx
];

1192 
»que¡
 *
»q
;

1194 ià(
	`uÆik–y
(
cqe
->
commªd_id
 >ð
nvmeq
->
q_d•th
)) {

1195 
	`dev_w¬n
(
nvmeq
->
dev
->
ù¾
.
deviû
,

1197 
cqe
->
commªd_id
, 
	`Ë16_to_ýu
(cqe->
sq_id
));

1207 ià(
	`uÆik–y
(
nvmeq
->
qid
 == 0 &&

1208 
cqe
->
commªd_id
 >ð
NVME_AQ_BLK_MQ_DEPTH
)) {

1209 
	`nvme_com¶‘e_async_ev’t
(&
nvmeq
->
dev
->
ù¾
,

1210 
cqe
->
¡©us
, &cqe->
»suÉ
);

1214 
»q
 = 
	`blk_mq_g_to_rq
(*
nvmeq
->
gs
, 
cqe
->
commªd_id
);

1215 
	`nvme_’d_»que¡
(
»q
, 
cqe
->
¡©us
, cqe->
»suÉ
);

1216 
	}
}

1218 
	$nvme_com¶‘e_cqes
(
nvme_queue
 *
nvmeq
, 
u16
 
¡¬t
, u16 
’d
)

1220 
¡¬t
 !ð
’d
) {

1221 
	`nvme_hªdË_cqe
(
nvmeq
, 
¡¬t
);

1222 ià(++
¡¬t
 =ð
nvmeq
->
q_d•th
)

1223 
¡¬t
 = 0;

1225 
	}
}

1227 
šlše
 
	$nvme_upd©e_cq_h—d
(
nvme_queue
 *
nvmeq
)

1229 ià(++
nvmeq
->
cq_h—d
 =ðnvmeq->
q_d•th
) {

1230 
nvmeq
->
cq_h—d
 = 0;

1231 
nvmeq
->
cq_pha£
 = !nvmeq->cq_phase;

1233 
	}
}

1235 
šlše
 
boÞ
 
	$nvme_´oûss_cq
(
nvme_queue
 *
nvmeq
, 
u16
 *
¡¬t
,

1236 
u16
 *
’d
, 
g
)

1238 
boÞ
 
found
 = 
çl£
;

1240 *
¡¬t
 = 
nvmeq
->
cq_h—d
;

1241 !
found
 && 
	`nvme_cqe_³ndšg
(
nvmeq
)) {

1242 ià(
nvmeq
->
cqes
[nvmeq->
cq_h—d
].
commªd_id
 =ð
g
)

1243 
found
 = 
Œue
;

1244 
	`nvme_upd©e_cq_h—d
(
nvmeq
);

1246 *
’d
 = 
nvmeq
->
cq_h—d
;

1248 ià(*
¡¬t
 !ð*
’d
)

1249 
	`nvme_ršg_cq_doÜb–l
(
nvmeq
);

1250  
found
;

1251 
	}
}

1253 
œq»tuº_t
 
	$nvme_œq
(
œq
, *
d©a
)

1255 
nvme_queue
 *
nvmeq
 = 
d©a
;

1256 
œq»tuº_t
 
»t
 = 
IRQ_NONE
;

1257 
u16
 
¡¬t
, 
’d
;

1259 
	`¥š_lock
(&
nvmeq
->
cq_lock
);

1260 ià(
nvmeq
->
cq_h—d
 !ðnvmeq->
Ï¡_cq_h—d
)

1261 
»t
 = 
IRQ_HANDLED
;

1262 
	`nvme_´oûss_cq
(
nvmeq
, &
¡¬t
, &
’d
, -1);

1263 
nvmeq
->
Ï¡_cq_h—d
 =‚vmeq->
cq_h—d
;

1264 
	`¥š_uÆock
(&
nvmeq
->
cq_lock
);

1266 ià(
¡¬t
 !ð
’d
) {

1267 
	`nvme_com¶‘e_cqes
(
nvmeq
, 
¡¬t
, 
’d
);

1268  
IRQ_HANDLED
;

1271  
»t
;

1272 
	}
}

1274 
œq»tuº_t
 
	$nvme_œq_check
(
œq
, *
d©a
)

1276 
nvme_queue
 *
nvmeq
 = 
d©a
;

1277 ià(
	`nvme_cqe_³ndšg
(
nvmeq
))

1278  
IRQ_WAKE_THREAD
;

1279  
IRQ_NONE
;

1280 
	}
}

1282 
	$__nvme_pÞl
(
nvme_queue
 *
nvmeq
, 
g
)

1284 
u16
 
¡¬t
, 
’d
;

1285 
boÞ
 
found
;

1287 ià(!
	`nvme_cqe_³ndšg
(
nvmeq
))

1290 
	`¥š_lock_œq
(&
nvmeq
->
cq_lock
);

1291 
found
 = 
	`nvme_´oûss_cq
(
nvmeq
, &
¡¬t
, &
’d
, 
g
);

1292 
	`¥š_uÆock_œq
(&
nvmeq
->
cq_lock
);

1294 
	`nvme_com¶‘e_cqes
(
nvmeq
, 
¡¬t
, 
’d
);

1295  
found
;

1296 
	}
}

1298 #ifdeà
HAVE_BLK_MQ_POLL


1299 
	$nvme_pÞl
(
blk_mq_hw_ùx
 *
hùx
, 
g
)

1301 
nvme_queue
 *
nvmeq
 = 
hùx
->
driv”_d©a
;

1303  
	`__nvme_pÞl
(
nvmeq
, 
g
);

1304 
	}
}

1307 
	$nvme_pci_subm™_async_ev’t
(
nvme_ù¾
 *
ù¾
)

1309 
nvme_dev
 *
dev
 = 
	`to_nvme_dev
(
ù¾
);

1310 
nvme_queue
 *
nvmeq
 = &
dev
->
queues
[0];

1311 
nvme_commªd
 
c
;

1313 
	`mem£t
(&
c
, 0, (c));

1314 
c
.
commÚ
.
Ýcode
 = 
nvme_admš_async_ev’t
;

1315 
c
.
commÚ
.
commªd_id
 = 
NVME_AQ_BLK_MQ_DEPTH
;

1316 
	`nvme_subm™_cmd
(
nvmeq
, &
c
);

1317 
	}
}

1319 
	$ad­‹r_d–‘e_queue
(
nvme_dev
 *
dev
, 
u8
 
Ýcode
, 
u16
 
id
)

1321 
nvme_commªd
 
c
;

1323 
	`mem£t
(&
c
, 0, (c));

1324 
c
.
d–‘e_queue
.
Ýcode
 = opcode;

1325 
c
.
d–‘e_queue
.
qid
 = 
	`ýu_to_Ë16
(
id
);

1327  
	`nvme_subm™_sync_cmd
(
dev
->
ù¾
.
admš_q
, &
c
, 
NULL
, 0);

1328 
	}
}

1330 
	$ad­‹r_®loc_cq
(
nvme_dev
 *
dev
, 
u16
 
qid
,

1331 
nvme_queue
 *
nvmeq
, 
s16
 
veùÜ
)

1333 
nvme_commªd
 
c
;

1334 
æags
 = 
NVME_QUEUE_PHYS_CONTIG
;

1336 ià(!
nvmeq
->
p2p
)

1337 
æags
 |ð
NVME_CQ_IRQ_ENABLED
;

1343 
	`mem£t
(&
c
, 0, (c));

1344 
c
.
ü—‹_cq
.
Ýcode
 = 
nvme_admš_ü—‹_cq
;

1345 
c
.
ü—‹_cq
.
´p1
 = 
	`ýu_to_Ë64
(
nvmeq
->
cq_dma_addr
);

1346 
c
.
ü—‹_cq
.
cqid
 = 
	`ýu_to_Ë16
(
qid
);

1347 
c
.
ü—‹_cq
.
qsize
 = 
	`ýu_to_Ë16
(
nvmeq
->
q_d•th
 - 1);

1348 
c
.
ü—‹_cq
.
cq_æags
 = 
	`ýu_to_Ë16
(
æags
);

1349 
c
.
ü—‹_cq
.
œq_veùÜ
 = 
	`ýu_to_Ë16
(
veùÜ
);

1351  
	`nvme_subm™_sync_cmd
(
dev
->
ù¾
.
admš_q
, &
c
, 
NULL
, 0);

1352 
	}
}

1354 
	$ad­‹r_®loc_sq
(
nvme_dev
 *
dev
, 
u16
 
qid
,

1355 
nvme_queue
 *
nvmeq
)

1357 
nvme_ù¾
 *
ù¾
 = &
dev
->ctrl;

1358 
nvme_commªd
 
c
;

1359 
æags
 = 
NVME_QUEUE_PHYS_CONTIG
;

1366 ià(
ù¾
->
quœks
 & 
NVME_QUIRK_MEDIUM_PRIO_SQ
)

1367 
æags
 |ð
NVME_SQ_PRIO_MEDIUM
;

1373 
	`mem£t
(&
c
, 0, (c));

1374 
c
.
ü—‹_sq
.
Ýcode
 = 
nvme_admš_ü—‹_sq
;

1375 
c
.
ü—‹_sq
.
´p1
 = 
	`ýu_to_Ë64
(
nvmeq
->
sq_dma_addr
);

1376 
c
.
ü—‹_sq
.
sqid
 = 
	`ýu_to_Ë16
(
qid
);

1377 
c
.
ü—‹_sq
.
qsize
 = 
	`ýu_to_Ë16
(
nvmeq
->
q_d•th
 - 1);

1378 
c
.
ü—‹_sq
.
sq_æags
 = 
	`ýu_to_Ë16
(
æags
);

1379 
c
.
ü—‹_sq
.
cqid
 = 
	`ýu_to_Ë16
(
qid
);

1381  
	`nvme_subm™_sync_cmd
(
dev
->
ù¾
.
admš_q
, &
c
, 
NULL
, 0);

1382 
	}
}

1384 
	$ad­‹r_d–‘e_cq
(
nvme_dev
 *
dev
, 
u16
 
cqid
)

1386  
	`ad­‹r_d–‘e_queue
(
dev
, 
nvme_admš_d–‘e_cq
, 
cqid
);

1387 
	}
}

1389 
	$ad­‹r_d–‘e_sq
(
nvme_dev
 *
dev
, 
u16
 
sqid
)

1391  
	`ad­‹r_d–‘e_queue
(
dev
, 
nvme_admš_d–‘e_sq
, 
sqid
);

1392 
	}
}

1394 
	$abÜt_’dio
(
»que¡
 *
»q
, 
blk_¡©us_t
 
”rÜ
)

1396 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

1397 
nvme_queue
 *
nvmeq
 = 
iod
->nvmeq;

1399 
	`dev_w¬n
(
nvmeq
->
dev
->
ù¾
.
deviû
,

1400 "AbÜˆ¡©us: 0x%x", 
	`nvme_»q
(
»q
)->
¡©us
);

1401 
	`©omic_šc
(&
nvmeq
->
dev
->
ù¾
.
abÜt_lim™
);

1402 
	`blk_mq_ä“_»que¡
(
»q
);

1403 
	}
}

1405 
boÞ
 
	$nvme_should_»£t
(
nvme_dev
 *
dev
, 
u32
 
c¡s
)

1411 
boÞ
 
ns¤o
 = 
dev
->
subsy¡em
 && (
c¡s
 & 
NVME_CSTS_NSSRO
);

1414 
dev
->
ù¾
.
¡©e
) {

1415 
NVME_CTRL_RESETTING
:

1416 
NVME_CTRL_CONNECTING
:

1417  
çl£
;

1425 ià(!(
c¡s
 & 
NVME_CSTS_CFS
è&& !
ns¤o
)

1426  
çl£
;

1428  
Œue
;

1429 
	}
}

1431 
	$nvme_w¬n_»£t
(
nvme_dev
 *
dev
, 
u32
 
c¡s
)

1434 
u16
 
pci_¡©us
;

1435 
»suÉ
;

1437 
»suÉ
 = 
	`pci_»ad_cÚfig_wÜd
(
	`to_pci_dev
(
dev
->dev), 
PCI_STATUS
,

1438 &
pci_¡©us
);

1439 ià(
»suÉ
 =ð
PCIBIOS_SUCCESSFUL
)

1440 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

1442 
c¡s
, 
pci_¡©us
);

1444 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

1446 
c¡s
, 
»suÉ
);

1447 
	}
}

1449 
blk_eh_tim”_»tuº
 
	$nvme_timeout
(
»que¡
 *
»q
, 
boÞ
 
»£rved
)

1451 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

1452 
nvme_queue
 *
nvmeq
 = 
iod
->nvmeq;

1453 
nvme_dev
 *
dev
 = 
nvmeq
->dev;

1454 
»que¡
 *
abÜt_»q
;

1455 
nvme_commªd
 
cmd
;

1456 
u32
 
c¡s
 = 
	`»adl
(
dev
->
b¬
 + 
NVME_REG_CSTS
);

1461 
	`mb
();

1462 ià(
	`pci_chªÃl_ofæše
(
	`to_pci_dev
(
dev
->dev)))

1463  
BLK_EH_RESET_TIMER
;

1468 ià(
	`nvme_should_»£t
(
dev
, 
c¡s
)) {

1469 
	`nvme_w¬n_»£t
(
dev
, 
c¡s
);

1470 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

1471 
	`nvme_»£t_ù¾
(&
dev
->
ù¾
);

1472 #ifdeà
HAVE_BLK_EH_DONE


1473  
BLK_EH_DONE
;

1475  
BLK_EH_HANDLED
;

1482 ià(
	`__nvme_pÞl
(
nvmeq
, 
»q
->
g
)) {

1483 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

1485 
»q
->
g
, 
nvmeq
->
qid
);

1486 #ifdeà
HAVE_BLK_EH_DONE


1487  
BLK_EH_DONE
;

1489  
BLK_EH_HANDLED
;

1499 
dev
->
ù¾
.
¡©e
) {

1500 
NVME_CTRL_CONNECTING
:

1501 
NVME_CTRL_RESETTING
:

1502 
	`dev_w¬n_¿‹lim™ed
(
dev
->
ù¾
.
deviû
,

1504 
»q
->
g
, 
nvmeq
->
qid
);

1505 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

1506 
	`nvme_»q
(
»q
)->
æags
 |ð
NVME_REQ_CANCELLED
;

1507 #ifdeà
HAVE_BLK_EH_DONE


1508  
BLK_EH_DONE
;

1510  
BLK_EH_HANDLED
;

1521 ià(!
nvmeq
->
qid
 || 
iod
->
abÜ‹d
) {

1522 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

1524 
»q
->
g
, 
nvmeq
->
qid
);

1525 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

1526 
	`nvme_»£t_ù¾
(&
dev
->
ù¾
);

1528 
	`nvme_»q
(
»q
)->
æags
 |ð
NVME_REQ_CANCELLED
;

1529 #ifdeà
HAVE_BLK_EH_DONE


1530  
BLK_EH_DONE
;

1532  
BLK_EH_HANDLED
;

1536 ià(
	`©omic_dec_»tuº
(&
dev
->
ù¾
.
abÜt_lim™
) < 0) {

1537 
	`©omic_šc
(&
dev
->
ù¾
.
abÜt_lim™
);

1538  
BLK_EH_RESET_TIMER
;

1540 
iod
->
abÜ‹d
 = 1;

1542 
	`mem£t
(&
cmd
, 0, (cmd));

1543 
cmd
.
abÜt
.
Ýcode
 = 
nvme_admš_abÜt_cmd
;

1544 
cmd
.
abÜt
.
cid
 = 
»q
->
g
;

1545 
cmd
.
abÜt
.
sqid
 = 
	`ýu_to_Ë16
(
nvmeq
->
qid
);

1547 
	`dev_w¬n
(
nvmeq
->
dev
->
ù¾
.
deviû
,

1549 
»q
->
g
, 
nvmeq
->
qid
);

1551 #ifdeà
HAVE_BLK_MQ_ALLOC_REQUEST_HAS_3_PARAMS


1552 
abÜt_»q
 = 
	`nvme_®loc_»que¡
(
dev
->
ù¾
.
admš_q
, &
cmd
,

1553 
BLK_MQ_REQ_NOWAIT
, 
NVME_QID_ANY
);

1555 
abÜt_»q
 = 
	`nvme_®loc_»que¡
(
dev
->
ù¾
.
admš_q
, &
cmd
,

1556 
GFP_KERNEL
, 
»£rved
, 
NVME_QID_ANY
);

1558 ià(
	`IS_ERR
(
abÜt_»q
)) {

1559 
	`©omic_šc
(&
dev
->
ù¾
.
abÜt_lim™
);

1560  
BLK_EH_RESET_TIMER
;

1563 
abÜt_»q
->
timeout
 = 
ADMIN_TIMEOUT
;

1564 
abÜt_»q
->
’d_io_d©a
 = 
NULL
;

1565 
	`blk_execu‹_rq_nowa™
(
abÜt_»q
->
q
, 
NULL
,‡bÜt_»q, 0, 
abÜt_’dio
);

1572  
BLK_EH_RESET_TIMER
;

1573 
	}
}

1575 
	$nvme_ä“_queue
(
nvme_queue
 *
nvmeq
)

1577 
	`dma_ä“_coh”’t
(
nvmeq
->
q_dmadev
, 
	`CQ_SIZE
Òvmeq->
q_d•th
),

1578 (*)
nvmeq
->
cqes
,‚vmeq->
cq_dma_addr
);

1579 ià(
nvmeq
->
sq_cmds
)

1580 
	`dma_ä“_coh”’t
(
nvmeq
->
q_dmadev
, 
	`SQ_SIZE
Òvmeq->
q_d•th
),

1581 
nvmeq
->
sq_cmds
,‚vmeq->
sq_dma_addr
);

1582 
	}
}

1584 
	$nvme_ä“_queues
(
nvme_dev
 *
dev
, 
lowe¡
)

1586 
i
;

1588 
i
 = 
dev
->
ù¾
.
queue_couÁ
 - 1; i >ð
lowe¡
; i--) {

1589 
dev
->
ù¾
.
queue_couÁ
--;

1590 
	`nvme_ä“_queue
(&
dev
->
queues
[
i
]);

1592 
	}
}

1598 
	$nvme_su¥’d_queue
(
nvme_queue
 *
nvmeq
)

1600 
veùÜ
;

1602 
	`¥š_lock_œq
(&
nvmeq
->
cq_lock
);

1603 ià(
nvmeq
->
cq_veùÜ
 == -1) {

1604 
	`¥š_uÆock_œq
(&
nvmeq
->
cq_lock
);

1607 ià(!
nvmeq
->
p2p
)

1608 #ifdeà
HAVE_PCI_FREE_IRQ


1609 
veùÜ
 = 
nvmeq
->
cq_veùÜ
;

1611 
veùÜ
 = 
	`nvmeq_œq
(
nvmeq
);

1614 
	`mu‹x_lock
(&
nvmeq
->
»sourû
.
lock
);

1615 ià(
nvmeq
->
»sourû
.
š_u£
 &&‚vmeq->»sourû.
¡Ý_ma¡”_³”
) {

1616 
	`mu‹x_uÆock
(&
nvmeq
->
»sourû
.
lock
);

1617 
nvmeq
->
»sourû
.
	`¡Ý_ma¡”_³”
Òvmeq->»sourû.
dd_d©a
);

1619 
	`mu‹x_uÆock
(&
nvmeq
->
»sourû
.
lock
);

1622 
nvmeq
->
dev
->
Úlše_queues
--;

1623 
nvmeq
->
cq_veùÜ
 = -1;

1624 
	`¥š_uÆock_œq
(&
nvmeq
->
cq_lock
);

1630 
	`mb
();

1632 ià(!
nvmeq
->
qid
 &&‚vmeq->
dev
->
ù¾
.
admš_q
)

1633 #ifdeà
HAVE_BLK_MQ_UNQUIESCE_QUEUE


1634 
	`blk_mq_qu›sû_queue
(
nvmeq
->
dev
->
ù¾
.
admš_q
);

1636 
	`blk_mq_¡Ý_hw_queues
(
nvmeq
->
dev
->
ù¾
.
admš_q
);

1639 ià(!
nvmeq
->
p2p
)

1640 #ifdeà
HAVE_PCI_FREE_IRQ


1641 
	`pci_ä“_œq
(
	`to_pci_dev
(
nvmeq
->
dev
->dev), 
veùÜ
,‚vmeq);

1643 
	`ä“_œq
(
veùÜ
, 
nvmeq
);

1647 
	}
}

1649 
	$nvme_di§bË_admš_queue
(
nvme_dev
 *
dev
, 
boÞ
 
shutdown
)

1651 
nvme_queue
 *
nvmeq
 = &
dev
->
queues
[0];

1652 
u16
 
¡¬t
, 
’d
;

1654 ià(
shutdown
)

1655 
	`nvme_shutdown_ù¾
(&
dev
->
ù¾
);

1657 
	`nvme_di§bË_ù¾
(&
dev
->
ù¾
, dev->ù¾.
ÿp
);

1659 
	`¥š_lock_œq
(&
nvmeq
->
cq_lock
);

1660 
	`nvme_´oûss_cq
(
nvmeq
, &
¡¬t
, &
’d
, -1);

1661 
	`¥š_uÆock_œq
(&
nvmeq
->
cq_lock
);

1663 
	`nvme_com¶‘e_cqes
(
nvmeq
, 
¡¬t
, 
’d
);

1664 
	}
}

1666 
	$nvme_cmb_qd•th
(
nvme_dev
 *
dev
, 
Ä_io_queues
,

1667 
’Œy_size
)

1669 
q_d•th
 = 
dev
->q_depth;

1670 
q_size_®igÃd
 = 
	`roundup
(
q_d•th
 * 
’Œy_size
,

1671 
dev
->
ù¾
.
·ge_size
);

1673 ià(
q_size_®igÃd
 * 
Ä_io_queues
 > 
dev
->
cmb_size
) {

1674 
u64
 
mem_³r_q
 = 
	`div_u64
(
dev
->
cmb_size
, 
Ä_io_queues
);

1675 
mem_³r_q
 = 
	`round_down
(mem_³r_q, 
dev
->
ù¾
.
·ge_size
);

1676 
q_d•th
 = 
	`div_u64
(
mem_³r_q
, 
’Œy_size
);

1683 ià(
q_d•th
 < 64)

1684  -
ENOMEM
;

1687  
q_d•th
;

1688 
	}
}

1690 
	$nvme_®loc_sq_cmds
(
nvme_dev
 *
dev
, 
nvme_queue
 *
nvmeq
,

1691 
qid
, 
d•th
)

1694 ià(
qid
 && 
dev
->
cmb
 && 
u£_cmb_sqes
 && (dev->
cmbsz
 & 
NVME_CMBSZ_SQS
))

1697 
nvmeq
->
sq_cmds
 = 
	`dma_®loc_coh”’t
(
dev
->dev, 
	`SQ_SIZE
(
d•th
),

1698 &
nvmeq
->
sq_dma_addr
, 
GFP_KERNEL
);

1699 ià(!
nvmeq
->
sq_cmds
)

1700  -
ENOMEM
;

1702 
	}
}

1704 
	$nvme_®loc_queue
(
nvme_dev
 *
dev
, 
qid
, 
d•th
)

1706 
nvme_queue
 *
nvmeq
 = &
dev
->
queues
[
qid
];

1708 ià(
dev
->
ù¾
.
queue_couÁ
 > 
qid
)

1711 
nvmeq
->
cqes
 = 
	`dma_z®loc_coh”’t
(
dev
->dev, 
	`CQ_SIZE
(
d•th
),

1712 &
nvmeq
->
cq_dma_addr
, 
GFP_KERNEL
);

1713 ià(!
nvmeq
->
cqes
)

1714 
ä“_nvmeq
;

1716 ià(
	`nvme_®loc_sq_cmds
(
dev
, 
nvmeq
, 
qid
, 
d•th
))

1717 
ä“_cqdma
;

1719 
nvmeq
->
q_dmadev
 = 
dev
->dev;

1720 
nvmeq
->
dev
 = dev;

1721 #iâdeà
HAVE_PCI_FREE_IRQ


1722 
	`¢´štf
(
nvmeq
->
œqÇme
, (nvmeq->irqname), "nvme%dq%d",

1723 
dev
->
ù¾
.
š¡ªû
, 
qid
);

1725 
	`¥š_lock_š™
(&
nvmeq
->
sq_lock
);

1726 
	`¥š_lock_š™
(&
nvmeq
->
cq_lock
);

1727 
nvmeq
->
cq_h—d
 = 0;

1728 
nvmeq
->
cq_pha£
 = 1;

1729 
nvmeq
->
q_db
 = &
dev
->
dbs
[
qid
 * 2 * dev->
db_¡ride
];

1730 
nvmeq
->
q_d•th
 = 
d•th
;

1731 
nvmeq
->
qid
 = qid;

1732 
nvmeq
->
cq_veùÜ
 = -1;

1733 
nvmeq
->
p2p
 = 
qid
 > (
dev
->
max_qid
 - dev->
num_p2p_queues
);

1734 ià(
nvmeq
->
p2p
)

1735 
	`mu‹x_š™
(&
nvmeq
->
»sourû
.
lock
);

1736 
dev
->
ù¾
.
queue_couÁ
++;

1740 
ä“_cqdma
:

1741 
	`dma_ä“_coh”’t
(
dev
->dev, 
	`CQ_SIZE
(
d•th
), (*)
nvmeq
->
cqes
,

1742 
nvmeq
->
cq_dma_addr
);

1743 
ä“_nvmeq
:

1744  -
ENOMEM
;

1745 
	}
}

1747 
	$queue_»que¡_œq
(
nvme_queue
 *
nvmeq
)

1749 #ifdeà
HAVE_PCI_FREE_IRQ


1750 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
nvmeq
->
dev
->dev);

1751 
Ä
 = 
nvmeq
->
dev
->
ù¾
.
š¡ªû
;

1753 ià(
u£_th»aded_š‹¼u±s
) {

1754  
	`pci_»que¡_œq
(
pdev
, 
nvmeq
->
cq_veùÜ
, 
nvme_œq_check
,

1755 
nvme_œq
, 
nvmeq
, "nvme%dq%d", 
Ä
,‚vmeq->
qid
);

1757  
	`pci_»que¡_œq
(
pdev
, 
nvmeq
->
cq_veùÜ
, 
nvme_œq
,

1758 
NULL
, 
nvmeq
, "nvme%dq%d", 
Ä
,‚vmeq->
qid
);

1761 ià(
u£_th»aded_š‹¼u±s
)

1762  
	`»que¡_th»aded_œq
(
	`nvmeq_œq
(
nvmeq
), 
nvme_œq_check
,

1763 
nvme_œq
, 
IRQF_SHARED
, 
nvmeq
->
œqÇme
,‚vmeq);

1765  
	`»que¡_œq
(
	`nvmeq_œq
(
nvmeq
), 
nvme_œq
, 
IRQF_SHARED
,

1766 
nvmeq
->
œqÇme
,‚vmeq);

1768 
	}
}

1770 
	$nvme_š™_queue
(
nvme_queue
 *
nvmeq
, 
u16
 
qid
)

1772 
nvme_dev
 *
dev
 = 
nvmeq
->dev;

1774 
	`¥š_lock_œq
(&
nvmeq
->
cq_lock
);

1775 
nvmeq
->
sq_ž
 = 0;

1776 
nvmeq
->
cq_h—d
 = 0;

1777 
nvmeq
->
cq_pha£
 = 1;

1778 
nvmeq
->
q_db
 = &
dev
->
dbs
[
qid
 * 2 * dev->
db_¡ride
];

1779 
	`mem£t
((*)
nvmeq
->
cqes
, 0, 
	`CQ_SIZE
Òvmeq->
q_d•th
));

1780 
	`nvme_dbbuf_š™
(
dev
, 
nvmeq
, 
qid
);

1781 
dev
->
Úlše_queues
++;

1782 
	`¥š_uÆock_œq
(&
nvmeq
->
cq_lock
);

1783 
	}
}

1785 
	$nvme_ü—‹_queue
(
nvme_queue
 *
nvmeq
, 
qid
)

1787 
nvme_dev
 *
dev
 = 
nvmeq
->dev;

1788 
»suÉ
;

1789 
s16
 
veùÜ
;

1791 ià(
dev
->
cmb
 && 
u£_cmb_sqes
 && (dev->
cmbsz
 & 
NVME_CMBSZ_SQS
)) {

1792 
off£t
 = (
qid
 - 1è* 
	`roundup
(
	`SQ_SIZE
(
nvmeq
->
q_d•th
),

1793 
dev
->
ù¾
.
·ge_size
);

1794 #ifdeà
HAVE_PCI_BUS_ADDR_T


1795 
nvmeq
->
sq_dma_addr
 = 
dev
->
cmb_bus_addr
 + 
off£t
;

1797 
nvmeq
->
sq_dma_addr
 = 
dev
->
cmb_dma_addr
 + 
off£t
;

1799 
nvmeq
->
sq_cmds_io
 = 
dev
->
cmb
 + 
off£t
;

1806 #ià
	`defšed
(
HAVE_PCI_IRQ_API
è&& defšed(
HAVE_IRQ_CALC_AFFINITY_VECTORS_3_ARGS
)

1807 
veùÜ
 = 
dev
->
num_vecs
 =ð1 ? 0 : 
qid
;

1809 
veùÜ
 = 
qid
 - 1;

1811 
»suÉ
 = 
	`ad­‹r_®loc_cq
(
dev
, 
qid
, 
nvmeq
, 
veùÜ
);

1812 ià(
»suÉ
 < 0)

1813 
out
;

1815 
»suÉ
 = 
	`ad­‹r_®loc_sq
(
dev
, 
qid
, 
nvmeq
);

1816 ià(
»suÉ
 < 0)

1817 
»Ëa£_cq
;

1824 
nvmeq
->
cq_veùÜ
 = 
veùÜ
;

1825 
	`nvme_š™_queue
(
nvmeq
, 
qid
);

1826 ià(!
nvmeq
->
p2p
) {

1827 
»suÉ
 = 
	`queue_»que¡_œq
(
nvmeq
);

1828 ià(
»suÉ
 < 0)

1829 
»Ëa£_sq
;

1832  
»suÉ
;

1834 
»Ëa£_sq
:

1835 
nvmeq
->
cq_veùÜ
 = -1;

1836 
dev
->
Úlše_queues
--;

1837 
	`ad­‹r_d–‘e_sq
(
dev
, 
qid
);

1838 
»Ëa£_cq
:

1839 
	`ad­‹r_d–‘e_cq
(
dev
, 
qid
);

1840 
out
:

1841  
»suÉ
;

1842 
	}
}

1844 #ifdeà
HAVE_BLK_MQ_TAG_SET_HAS_CONST_POS


1845 cÚ¡ 
blk_mq_Ýs
 
	gnvme_mq_admš_Ýs
 = {

1847 
blk_mq_Ýs
 
nvme_mq_admš_Ýs
 = {

1849 .
queue_rq
 = 
nvme_queue_rq
,

1850 .
	gcom¶‘e
 = 
nvme_pci_com¶‘e_rq
,

1851 #ifdeà
HAVE_BLK_MQ_OPS_MAP_QUEUE


1852 .
	gm­_queue
 = 
blk_mq_m­_queue
,

1854 .
	gš™_hùx
 = 
nvme_admš_š™_hùx
,

1855 .
	gex™_hùx
 = 
nvme_admš_ex™_hùx
,

1856 #ifdeà
HAVE_BLK_MQ_OPS_INIT_REQUEST_HAS_4_PARAMS


1857 .
	gš™_»que¡
 = 
nvme_š™_»que¡
,

1859 .
	gš™_»que¡
 = 
nvme_admš_š™_»que¡
,

1861 .
	gtimeout
 = 
nvme_timeout
,

1864 #ifdeà
HAVE_BLK_MQ_TAG_SET_HAS_CONST_POS


1865 cÚ¡ 
blk_mq_Ýs
 
	gnvme_mq_Ýs
 = {

1867 
blk_mq_Ýs
 
nvme_mq_Ýs
 = {

1869 .
queue_rq
 = 
nvme_queue_rq
,

1870 .
	gcom¶‘e
 = 
nvme_pci_com¶‘e_rq
,

1871 #ifdeà
HAVE_BLK_MQ_OPS_MAP_QUEUE


1872 .
	gm­_queue
 = 
blk_mq_m­_queue
,

1874 .
	gš™_hùx
 = 
nvme_š™_hùx
,

1875 .
	gš™_»que¡
 = 
nvme_š™_»que¡
,

1876 #ifdeà
HAVE_BLK_MQ_OPS_MAP_QUEUES


1877 .
	gm­_queues
 = 
nvme_pci_m­_queues
,

1879 .
	gtimeout
 = 
nvme_timeout
,

1880 #ifdeà
HAVE_BLK_MQ_POLL


1881 .
	gpÞl
 = 
nvme_pÞl
,

1885 
	$nvme_dev_»move_admš
(
nvme_dev
 *
dev
)

1887 ià(
dev
->
ù¾
.
admš_q
 && !
	`blk_queue_dyšg
(dev->ctrl.admin_q)) {

1893 #ifdeà
HAVE_BLK_MQ_UNQUIESCE_QUEUE


1894 
	`blk_mq_unqu›sû_queue
(
dev
->
ù¾
.
admš_q
);

1896 
	`blk_mq_¡¬t_¡Ý³d_hw_queues
(
dev
->
ù¾
.
admš_q
, 
Œue
);

1898 
	`blk_þ—nup_queue
(
dev
->
ù¾
.
admš_q
);

1899 
	`blk_mq_ä“_g_£t
(&
dev
->
admš_g£t
);

1901 
	}
}

1903 
	$nvme_®loc_admš_gs
(
nvme_dev
 *
dev
)

1905 ià(!
dev
->
ù¾
.
admš_q
) {

1906 
dev
->
admš_g£t
.
Ýs
 = &
nvme_mq_admš_Ýs
;

1907 
dev
->
admš_g£t
.
Ä_hw_queues
 = 1;

1909 
dev
->
admš_g£t
.
queue_d•th
 = 
NVME_AQ_MQ_TAG_DEPTH
;

1910 
dev
->
admš_g£t
.
timeout
 = 
ADMIN_TIMEOUT
;

1911 
dev
->
admš_g£t
.
numa_node
 = 
	`dev_to_node
(dev->dev);

1912 
dev
->
admš_g£t
.
cmd_size
 = 
	`nvme_pci_cmd_size
(dev, 
çl£
);

1913 #ifdeà
HAVE_BLK_MQ_F_NO_SCHED


1914 
dev
->
admš_g£t
.
æags
 = 
BLK_MQ_F_NO_SCHED
;

1916 
dev
->
admš_g£t
.
driv”_d©a
 = dev;

1918 ià(
	`blk_mq_®loc_g_£t
(&
dev
->
admš_g£t
))

1919  -
ENOMEM
;

1920 
dev
->
ù¾
.
admš_g£t
 = &dev->admin_tagset;

1922 
dev
->
ù¾
.
admš_q
 = 
	`blk_mq_š™_queue
(&dev->
admš_g£t
);

1923 ià(
	`IS_ERR
(
dev
->
ù¾
.
admš_q
)) {

1924 
	`blk_mq_ä“_g_£t
(&
dev
->
admš_g£t
);

1925  -
ENOMEM
;

1927 ià(!
	`blk_g‘_queue
(
dev
->
ù¾
.
admš_q
)) {

1928 
	`nvme_dev_»move_admš
(
dev
);

1929 
dev
->
ù¾
.
admš_q
 = 
NULL
;

1930  -
ENODEV
;

1933 #ifdeà
HAVE_BLK_MQ_UNQUIESCE_QUEUE


1934 
	`blk_mq_unqu›sû_queue
(
dev
->
ù¾
.
admš_q
);

1936 
	`blk_mq_¡¬t_¡Ý³d_hw_queues
(
dev
->
ù¾
.
admš_q
, 
Œue
);

1940 
	}
}

1942 
	$db_b¬_size
(
nvme_dev
 *
dev
, 
Ä_io_queues
)

1944  
NVME_REG_DBS
 + ((
Ä_io_queues
 + 1è* 8 * 
dev
->
db_¡ride
);

1945 
	}
}

1947 
	$nvme_»m­_b¬
(
nvme_dev
 *
dev
, 
size
)

1949 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

1951 ià(
size
 <ð
dev
->
b¬_m­³d_size
)

1953 ià(
size
 > 
	`pci_»sourû_Ën
(
pdev
, 0))

1954  -
ENOMEM
;

1955 ià(
dev
->
b¬
)

1956 
	`iounm­
(
dev
->
b¬
);

1957 
dev
->
b¬
 = 
	`iÜem­
(
	`pci_»sourû_¡¬t
(
pdev
, 0), 
size
);

1958 ià(!
dev
->
b¬
) {

1959 
dev
->
b¬_m­³d_size
 = 0;

1960  -
ENOMEM
;

1962 
dev
->
b¬_m­³d_size
 = 
size
;

1963 
dev
->
dbs
 = dev->
b¬
 + 
NVME_REG_DBS
;

1966 
	}
}

1968 
	$nvme_pci_cÚfigu»_admš_queue
(
nvme_dev
 *
dev
)

1970 
»suÉ
;

1971 
u32
 
aqa
;

1972 
nvme_queue
 *
nvmeq
;

1974 
»suÉ
 = 
	`nvme_»m­_b¬
(
dev
, 
	`db_b¬_size
(dev, 0));

1975 ià(
»suÉ
 < 0)

1976  
»suÉ
;

1978 
dev
->
subsy¡em
 = 
	`»adl
(dev->
b¬
 + 
NVME_REG_VS
è>ð
	`NVME_VS
(1, 1, 0) ?

1979 
	`NVME_CAP_NSSRC
(
dev
->
ù¾
.
ÿp
) : 0;

1981 ià(
dev
->
subsy¡em
 &&

1982 (
	`»adl
(
dev
->
b¬
 + 
NVME_REG_CSTS
è& 
NVME_CSTS_NSSRO
))

1983 
	`wr™–
(
NVME_CSTS_NSSRO
, 
dev
->
b¬
 + 
NVME_REG_CSTS
);

1985 
»suÉ
 = 
	`nvme_di§bË_ù¾
(&
dev
->
ù¾
, dev->ù¾.
ÿp
);

1986 ià(
»suÉ
 < 0)

1987  
»suÉ
;

1989 
»suÉ
 = 
	`nvme_®loc_queue
(
dev
, 0, 
NVME_AQ_DEPTH
);

1990 ià(
»suÉ
)

1991  
»suÉ
;

1993 
nvmeq
 = &
dev
->
queues
[0];

1994 
aqa
 = 
nvmeq
->
q_d•th
 - 1;

1995 
aqa
 |=‡qa << 16;

1997 
	`wr™–
(
aqa
, 
dev
->
b¬
 + 
NVME_REG_AQA
);

1998 
	`lo_hi_wr™eq
(
nvmeq
->
sq_dma_addr
, 
dev
->
b¬
 + 
NVME_REG_ASQ
);

1999 
	`lo_hi_wr™eq
(
nvmeq
->
cq_dma_addr
, 
dev
->
b¬
 + 
NVME_REG_ACQ
);

2001 
»suÉ
 = 
	`nvme_’abË_ù¾
(&
dev
->
ù¾
, dev->ù¾.
ÿp
);

2002 ià(
»suÉ
)

2003  
»suÉ
;

2005 
nvmeq
->
cq_veùÜ
 = 0;

2006 
	`nvme_š™_queue
(
nvmeq
, 0);

2007 
»suÉ
 = 
	`queue_»que¡_œq
(
nvmeq
);

2008 ià(
»suÉ
) {

2009 
nvmeq
->
cq_veùÜ
 = -1;

2010  
»suÉ
;

2013  
»suÉ
;

2014 
	}
}

2016 
	$nvme_ü—‹_io_queues
(
nvme_dev
 *
dev
)

2018 
i
, 
max
;

2019 
»t
 = 0;

2021 
i
 = 
dev
->
ù¾
.
queue_couÁ
; i <ðdev->
max_qid
; i++) {

2022 ià(
	`nvme_®loc_queue
(
dev
, 
i
, dev->
q_d•th
)) {

2023 
»t
 = -
ENOMEM
;

2028 
max
 = 
	`mš
(
dev
->
max_qid
, dev->
ù¾
.
queue_couÁ
 - 1);

2029 
i
 = 
dev
->
Úlše_queues
; i <ð
max
; i++) {

2030 
»t
 = 
	`nvme_ü—‹_queue
(&
dev
->
queues
[
i
], i);

2031 ià(
»t
)

2041  
»t
 >= 0 ? 0 :„et;

2042 
	}
}

2044 
ssize_t
 
	$nvme_num_p2p_queues_show
(
deviû
 *
dev
,

2045 
deviû_©Œibu‹
 *
©Œ
,

2046 *
buf
)

2048 
nvme_dev
 *
ndev
 = 
	`to_nvme_dev
(
	`dev_g‘_drvd©a
(
dev
));

2049 
num_p2p_queues
 = 
ndev
->
Úlše_queues
 > 1 ?

2050 
ndev
->
num_p2p_queues
 : 0;

2052  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "%u\n", 
num_p2p_queues
);

2053 
	}
}

2054 
DEVICE_ATTR
(
num_p2p_queues
, 
S_IRUGO
, 
nvme_num_p2p_queues_show
, 
NULL
);

2056 
ssize_t
 
	$nvme_cmb_show
(
deviû
 *
dev
,

2057 
deviû_©Œibu‹
 *
©Œ
,

2058 *
buf
)

2060 
nvme_dev
 *
ndev
 = 
	`to_nvme_dev
(
	`dev_g‘_drvd©a
(
dev
));

2062  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "cmbloc : x%08x\ncmbsz : x%08x\n",

2063 
ndev
->
cmbloc
,‚dev->
cmbsz
);

2064 
	}
}

2065 
DEVICE_ATTR
(
cmb
, 
S_IRUGO
, 
nvme_cmb_show
, 
NULL
);

2067 
u64
 
	$nvme_cmb_size_un™
(
nvme_dev
 *
dev
)

2069 
u8
 
szu
 = (
dev
->
cmbsz
 >> 
NVME_CMBSZ_SZU_SHIFT
è& 
NVME_CMBSZ_SZU_MASK
;

2071  1ULL << (12 + 4 * 
szu
);

2072 
	}
}

2074 
u32
 
	$nvme_cmb_size
(
nvme_dev
 *
dev
)

2076  (
dev
->
cmbsz
 >> 
NVME_CMBSZ_SZ_SHIFT
è& 
NVME_CMBSZ_SZ_MASK
;

2077 
	}
}

2079 
	$nvme_m­_cmb
(
nvme_dev
 *
dev
)

2081 
u64
 
size
, 
off£t
;

2082 
»sourû_size_t
 
b¬_size
;

2083 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

2084 #ifdeà
HAVE_PCI_BUS_ADDR_T


2085 
b¬
;

2087 
dma_addr_t
 
dma_addr
;

2090 
dev
->
cmbsz
 = 
	`»adl
(dev->
b¬
 + 
NVME_REG_CMBSZ
);

2091 ià(!
dev
->
cmbsz
)

2093 
dev
->
cmbloc
 = 
	`»adl
(dev->
b¬
 + 
NVME_REG_CMBLOC
);

2095 ià(!
u£_cmb_sqes
)

2098 
size
 = 
	`nvme_cmb_size_un™
(
dev
è* 
	`nvme_cmb_size
(dev);

2099 
off£t
 = 
	`nvme_cmb_size_un™
(
dev
è* 
	`NVME_CMB_OFST
(dev->
cmbloc
);

2100 #ifdeà
HAVE_PCI_BUS_ADDR_T


2101 
b¬
 = 
	`NVME_CMB_BIR
(
dev
->
cmbloc
);

2102 
b¬_size
 = 
	`pci_»sourû_Ën
(
pdev
, 
b¬
);

2104 
b¬_size
 = 
	`pci_»sourû_Ën
(
pdev
, 
	`NVME_CMB_BIR
(
dev
->
cmbloc
));

2107 ià(
off£t
 > 
b¬_size
)

2115 ià(
size
 > 
b¬_size
 - 
off£t
)

2116 
size
 = 
b¬_size
 - 
off£t
;

2118 #ifdeà
HAVE_PCI_BUS_ADDR_T


2119 
dev
->
cmb
 = 
	`iÜem­_wc
(
	`pci_»sourû_¡¬t
(
pdev
, 
b¬
è+ 
off£t
, 
size
);

2121 
dma_addr
 = 
	`pci_»sourû_¡¬t
(
pdev
, 
	`NVME_CMB_BIR
(
dev
->
cmbloc
)è+ 
off£t
;

2122 
dev
->
cmb
 = 
	`iÜem­_wc
(
dma_addr
, 
size
);

2124 ià(!
dev
->
cmb
)

2127 #ifdeà
HAVE_PCI_BUS_ADDR_T


2128 
dev
->
cmb_bus_addr
 = 
	`pci_bus_add»ss
(
pdev
, 
b¬
è+ 
off£t
;

2130 
dev
->
cmb_dma_addr
 = 
dma_addr
;

2132 
dev
->
cmb_size
 = 
size
;

2134 ià(
	`sysfs_add_fže_to_group
(&
dev
->
ù¾
.
deviû
->
kobj
,

2135 &
dev_©Œ_cmb
.
©Œ
, 
NULL
))

2136 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

2138 
	}
}

2140 
šlše
 
	$nvme_»Ëa£_cmb
(
nvme_dev
 *
dev
)

2142 ià(
dev
->
cmb
) {

2143 
	`iounm­
(
dev
->
cmb
);

2144 
dev
->
cmb
 = 
NULL
;

2145 
	`sysfs_»move_fže_äom_group
(&
dev
->
ù¾
.
deviû
->
kobj
,

2146 &
dev_©Œ_cmb
.
©Œ
, 
NULL
);

2147 
dev
->
cmbsz
 = 0;

2149 
	}
}

2151 
	$nvme_£t_ho¡_mem
(
nvme_dev
 *
dev
, 
u32
 
b™s
)

2153 
u64
 
dma_addr
 = 
dev
->
ho¡_mem_descs_dma
;

2154 
nvme_commªd
 
c
;

2155 
»t
;

2157 
	`mem£t
(&
c
, 0, (c));

2158 
c
.
ã©u»s
.
Ýcode
 = 
nvme_admš_£t_ã©u»s
;

2159 
c
.
ã©u»s
.
fid
 = 
	`ýu_to_Ë32
(
NVME_FEAT_HOST_MEM_BUF
);

2160 
c
.
ã©u»s
.
dwÜd11
 = 
	`ýu_to_Ë32
(
b™s
);

2161 
c
.
ã©u»s
.
dwÜd12
 = 
	`ýu_to_Ë32
(
dev
->
ho¡_mem_size
 >>

2162 
	`žog2
(
dev
->
ù¾
.
·ge_size
));

2163 
c
.
ã©u»s
.
dwÜd13
 = 
	`ýu_to_Ë32
(
	`low”_32_b™s
(
dma_addr
));

2164 
c
.
ã©u»s
.
dwÜd14
 = 
	`ýu_to_Ë32
(
	`uµ”_32_b™s
(
dma_addr
));

2165 
c
.
ã©u»s
.
dwÜd15
 = 
	`ýu_to_Ë32
(
dev
->
Ä_ho¡_mem_descs
);

2167 
»t
 = 
	`nvme_subm™_sync_cmd
(
dev
->
ù¾
.
admš_q
, &
c
, 
NULL
, 0);

2168 ià(
»t
) {

2169 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

2171 
»t
, 
b™s
);

2173  
»t
;

2174 
	}
}

2176 
	$nvme_ä“_ho¡_mem
(
nvme_dev
 *
dev
)

2178 
i
;

2180 
i
 = 0; i < 
dev
->
Ä_ho¡_mem_descs
; i++) {

2181 
nvme_ho¡_mem_buf_desc
 *
desc
 = &
dev
->
ho¡_mem_descs
[
i
];

2182 
size_t
 
size
 = 
	`Ë32_to_ýu
(
desc
->sizeè* 
dev
->
ù¾
.
·ge_size
;

2184 
	`dma_ä“_coh”’t
(
dev
->dev, 
size
, dev->
ho¡_mem_desc_bufs
[
i
],

2185 
	`Ë64_to_ýu
(
desc
->
addr
));

2188 
	`kä“
(
dev
->
ho¡_mem_desc_bufs
);

2189 
dev
->
ho¡_mem_desc_bufs
 = 
NULL
;

2190 
	`dma_ä“_coh”’t
(
dev
->dev,

2191 
dev
->
Ä_ho¡_mem_descs
 * (*dev->
ho¡_mem_descs
),

2192 
dev
->
ho¡_mem_descs
, dev->
ho¡_mem_descs_dma
);

2193 
dev
->
ho¡_mem_descs
 = 
NULL
;

2194 
dev
->
Ä_ho¡_mem_descs
 = 0;

2195 
	}
}

2197 
	$__nvme_®loc_ho¡_mem
(
nvme_dev
 *
dev
, 
u64
 
´eã¼ed
,

2198 
u32
 
chunk_size
)

2200 
nvme_ho¡_mem_buf_desc
 *
descs
;

2201 
u32
 
max_’Œ›s
, 
Ën
;

2202 
dma_addr_t
 
descs_dma
;

2203 
i
 = 0;

2204 **
bufs
;

2205 
u64
 
size
, 
tmp
;

2207 
tmp
 = (
´eã¼ed
 + 
chunk_size
 - 1);

2208 
	`do_div
(
tmp
, 
chunk_size
);

2209 
max_’Œ›s
 = 
tmp
;

2211 ià(
dev
->
ù¾
.
hmmaxd
 && dev->ù¾.hmmaxd < 
max_’Œ›s
)

2212 
max_’Œ›s
 = 
dev
->
ù¾
.
hmmaxd
;

2214 
descs
 = 
	`dma_z®loc_coh”’t
(
dev
->dev, 
max_’Œ›s
 * (*descs),

2215 &
descs_dma
, 
GFP_KERNEL
);

2216 ià(!
descs
)

2217 
out
;

2219 
bufs
 = 
	`kÿÎoc
(
max_’Œ›s
, (*bufs), 
GFP_KERNEL
);

2220 ià(!
bufs
)

2221 
out_ä“_descs
;

2223 
size
 = 0; siz< 
´eã¼ed
 && 
i
 < 
max_’Œ›s
; siz+ð
Ën
) {

2224 
dma_addr_t
 
dma_addr
;

2225 #iâdeà
HAVE_DMA_SET_ATTR_TAKES_UNSIGNED_LONG_ATTRS


2226 
	`DEFINE_DMA_ATTRS
(
©Œs
);

2227 #ifdeà
HAVE_DMA_ATTR_NO_WARN


2228 
	`dma_£t_©Œ
(
DMA_ATTR_NO_KERNEL_MAPPING
 | 
DMA_ATTR_NO_WARN
, &
©Œs
);

2230 
	`dma_£t_©Œ
(
DMA_ATTR_NO_KERNEL_MAPPING
, &
©Œs
);

2234 
Ën
 = 
	`mš_t
(
u64
, 
chunk_size
, 
´eã¼ed
 - 
size
);

2235 
bufs
[
i
] = 
	`dma_®loc_©Œs
(
dev
->dev, 
Ën
, &
dma_addr
, 
GFP_KERNEL
,

2236 #ifdeà
HAVE_DMA_SET_ATTR_TAKES_UNSIGNED_LONG_ATTRS


2237 #ifdeà
HAVE_DMA_ATTR_NO_WARN


2238 
DMA_ATTR_NO_KERNEL_MAPPING
 | 
DMA_ATTR_NO_WARN
);

2240 
DMA_ATTR_NO_KERNEL_MAPPING
);

2243 &
©Œs
);

2245 ià(!
bufs
[
i
])

2248 
descs
[
i
].
addr
 = 
	`ýu_to_Ë64
(
dma_addr
);

2249 
descs
[
i
].
size
 = 
	`ýu_to_Ë32
(
Ën
 / 
dev
->
ù¾
.
·ge_size
);

2250 
i
++;

2253 ià(!
size
)

2254 
out_ä“_bufs
;

2256 
dev
->
Ä_ho¡_mem_descs
 = 
i
;

2257 
dev
->
ho¡_mem_size
 = 
size
;

2258 
dev
->
ho¡_mem_descs
 = 
descs
;

2259 
dev
->
ho¡_mem_descs_dma
 = 
descs_dma
;

2260 
dev
->
ho¡_mem_desc_bufs
 = 
bufs
;

2263 
out_ä“_bufs
:

2264 --
i
 >= 0) {

2265 
size_t
 
size
 = 
	`Ë32_to_ýu
(
descs
[
i
].sizeè* 
dev
->
ù¾
.
·ge_size
;

2267 
	`dma_ä“_coh”’t
(
dev
->dev, 
size
, 
bufs
[
i
],

2268 
	`Ë64_to_ýu
(
descs
[
i
].
addr
));

2271 
	`kä“
(
bufs
);

2272 
out_ä“_descs
:

2273 
	`dma_ä“_coh”’t
(
dev
->dev, 
max_’Œ›s
 * (*
descs
), descs,

2274 
descs_dma
);

2275 
out
:

2276 
dev
->
ho¡_mem_descs
 = 
NULL
;

2277  -
ENOMEM
;

2278 
	}
}

2280 
	$nvme_®loc_ho¡_mem
(
nvme_dev
 *
dev
, 
u64
 
mš
, u64 
´eã¼ed
)

2282 
u32
 
chunk_size
;

2285 
chunk_size
 = 
	`mš_t
(
u64
, 
´eã¼ed
, 
PAGE_SIZE
 * 
MAX_ORDER_NR_PAGES
);

2286 
chunk_size
 >ð
	`max_t
(
u32
, 
dev
->
ù¾
.
hmmšds
 * 4096, 
PAGE_SIZE
 * 2);

2287 
chunk_size
 /= 2) {

2288 ià(!
	`__nvme_®loc_ho¡_mem
(
dev
, 
´eã¼ed
, 
chunk_size
)) {

2289 ià(!
mš
 || 
dev
->
ho¡_mem_size
 >= min)

2291 
	`nvme_ä“_ho¡_mem
(
dev
);

2295  -
ENOMEM
;

2296 
	}
}

2298 
	$nvme_£tup_ho¡_mem
(
nvme_dev
 *
dev
)

2300 
u64
 
max
 = (u64)
max_ho¡_mem_size_mb
 * 
SZ_1M
;

2301 
u64
 
´eã¼ed
 = (u64)
dev
->
ù¾
.
hm´e
 * 4096;

2302 
u64
 
mš
 = (u64)
dev
->
ù¾
.
hmmš
 * 4096;

2303 
u32
 
’abË_b™s
 = 
NVME_HOST_MEM_ENABLE
;

2304 
»t
;

2306 
´eã¼ed
 = 
	`mš
Õ»ã¼ed, 
max
);

2307 ià(
mš
 > 
max
) {

2308 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

2310 
mš
 >> 
	`žog2
(
SZ_1M
), 
max_ho¡_mem_size_mb
);

2311 
	`nvme_ä“_ho¡_mem
(
dev
);

2318 ià(
dev
->
ho¡_mem_descs
) {

2319 ià(
dev
->
ho¡_mem_size
 >ð
mš
)

2320 
’abË_b™s
 |ð
NVME_HOST_MEM_RETURN
;

2322 
	`nvme_ä“_ho¡_mem
(
dev
);

2325 ià(!
dev
->
ho¡_mem_descs
) {

2326 ià(
	`nvme_®loc_ho¡_mem
(
dev
, 
mš
, 
´eã¼ed
)) {

2327 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

2332 
	`dev_šfo
(
dev
->
ù¾
.
deviû
,

2334 
dev
->
ho¡_mem_size
 >> 
	`žog2
(
SZ_1M
));

2337 
»t
 = 
	`nvme_£t_ho¡_mem
(
dev
, 
’abË_b™s
);

2338 ià(
»t
)

2339 
	`nvme_ä“_ho¡_mem
(
dev
);

2340  
»t
;

2341 
	}
}

2343 
	$nvme_£tup_io_queues
(
nvme_dev
 *
dev
)

2345 
nvme_queue
 *
admšq
 = &
dev
->
queues
[0];

2346 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

2347 #ifdeà
HAVE_PCI_IRQ_API


2348 
»suÉ
, 
Ä_io_queues
;

2350 
»suÉ
, 
i
, 
vecs
, 
Ä_io_queues
;

2352 
size
;

2354 #ià
	`defšed
(
HAVE_PCI_IRQ_API
è&& defšed(
HAVE_IRQ_CALC_AFFINITY_VECTORS_3_ARGS
)

2355 
œq_affš™y
 
affd
 = {

2356 .
´e_veùÜs
 = 1

2360 
Ä_io_queues
 = 
	`num_possibË_ýus
(è+ 
dev
->
num_p2p_queues
;

2361 
»suÉ
 = 
	`nvme_£t_queue_couÁ
(&
dev
->
ù¾
, &
Ä_io_queues
);

2362 ià(
»suÉ
 < 0)

2363  
»suÉ
;

2365 ià(
Ä_io_queues
 == 0)

2368 ià(
dev
->
cmb
 && (dev->
cmbsz
 & 
NVME_CMBSZ_SQS
)) {

2369 
»suÉ
 = 
	`nvme_cmb_qd•th
(
dev
, 
Ä_io_queues
,

2370 (
nvme_commªd
));

2371 ià(
»suÉ
 > 0)

2372 
dev
->
q_d•th
 = 
»suÉ
;

2374 
	`nvme_»Ëa£_cmb
(
dev
);

2377 ià(
dev
->
num_p2p_queues
) {

2378 ià(
Ä_io_queues
 <ð
dev
->
num_p2p_queues
) {

2379 ià(
Ä_io_queues
 > 1)

2380 
dev
->
num_p2p_queues
 = 
Ä_io_queues
 - 1;

2382 
dev
->
num_p2p_queues
 = 0;

2387 
size
 = 
	`db_b¬_size
(
dev
, 
Ä_io_queues
);

2388 
»suÉ
 = 
	`nvme_»m­_b¬
(
dev
, 
size
);

2389 ià(!
»suÉ
)

2391 ià(
dev
->
num_p2p_queues
)

2392 
dev
->
num_p2p_queues
--;

2393 ià(!--
Ä_io_queues
)

2394  -
ENOMEM
;

2396 
admšq
->
q_db
 = 
dev
->
dbs
;

2399 #ifdeà
HAVE_PCI_FREE_IRQ


2400 
	`pci_ä“_œq
(
pdev
, 0, 
admšq
);

2401 #–ià
	`defšed
(
HAVE_PCI_IRQ_API
)

2402 
	`ä“_œq
(
	`pci_œq_veùÜ
(
pdev
, 0), 
admšq
);

2404 
	`ä“_œq
(
dev
->
’Œy
[0].
veùÜ
, 
admšq
);

2411 #ifdeà
HAVE_PCI_IRQ_API


2412 
	`pci_ä“_œq_veùÜs
(
pdev
);

2413 #ifdeà
HAVE_IRQ_CALC_AFFINITY_VECTORS_3_ARGS


2414 
»suÉ
 = 
	`pci_®loc_œq_veùÜs_affš™y
(
pdev
, 1, 
Ä_io_queues
 + 1 - 
dev
->
num_p2p_queues
,

2415 
PCI_IRQ_ALL_TYPES
 | 
PCI_IRQ_AFFINITY
, &
affd
);

2416 ià(
»suÉ
 <= 0)

2417  -
EIO
;

2418 
dev
->
num_vecs
 = 
»suÉ
;

2419 
dev
->
max_qid
 = 
	`max
(
»suÉ
 - 1 + dev->
num_p2p_queues
, 1u);

2421 
Ä_io_queues
 = 
	`pci_®loc_œq_veùÜs
(
pdev
, 1,‚r_io_queue - 
dev
->
num_p2p_queues
,

2422 
PCI_IRQ_ALL_TYPES
 | 
PCI_IRQ_AFFINITY
);

2423 ià(
Ä_io_queues
 <= 0)

2424  -
EIO
;

2425 
dev
->
max_qid
 = 
Ä_io_queues
 + dev->
num_p2p_queues
;

2428 ià(
pdev
->
msi_’abËd
)

2429 
	`pci_di§bË_msi
(
pdev
);

2430 ià(
pdev
->
msix_’abËd
)

2431 
	`pci_di§bË_msix
(
pdev
);

2433 
i
 = 0; i < 
Ä_io_queues
 - 
dev
->
num_p2p_queues
; i++)

2434 
dev
->
’Œy
[
i
].entry = i;

2435 
vecs
 = 
	`pci_’abË_msix_¿nge
(
pdev
, 
dev
->
’Œy
, 1, 
Ä_io_queues
 - dev->
num_p2p_queues
);

2436 ià(
vecs
 < 0) {

2437 
vecs
 = 
	`pci_’abË_msi_¿nge
(
pdev
, 1, 
	`mš
((
Ä_io_queues
 - 
dev
->
num_p2p_queues
), 32u));

2438 ià(
vecs
 < 0) {

2439 
vecs
 = 1;

2441 
i
 = 0; i < 
vecs
; i++)

2442 
dev
->
’Œy
[
i
].
veùÜ
 = i + 
pdev
->
œq
;

2445 
Ä_io_queues
 = 
vecs
;

2446 
dev
->
max_qid
 = 
Ä_io_queues
 + dev->
num_p2p_queues
;

2456 
»suÉ
 = 
	`queue_»que¡_œq
(
admšq
);

2457 ià(
»suÉ
) {

2458 
admšq
->
cq_veùÜ
 = -1;

2459  
»suÉ
;

2461  
	`nvme_ü—‹_io_queues
(
dev
);

2462 
	}
}

2464 
	$nvme_d–_queue_’d
(
»que¡
 *
»q
, 
blk_¡©us_t
 
”rÜ
)

2466 
nvme_queue
 *
nvmeq
 = 
»q
->
’d_io_d©a
;

2468 
	`blk_mq_ä“_»que¡
(
»q
);

2469 
	`com¶‘e
(&
nvmeq
->
dev
->
ioq_wa™
);

2470 
	}
}

2472 
	$nvme_d–_cq_’d
(
»que¡
 *
»q
, 
blk_¡©us_t
 
”rÜ
)

2474 
nvme_queue
 *
nvmeq
 = 
»q
->
’d_io_d©a
;

2475 
u16
 
¡¬t
, 
’d
;

2477 ià(!
”rÜ
 && !
nvmeq
->
p2p
) {

2478 
æags
;

2485 
	`¥š_lock_œq§ve_Ã¡ed
(&
nvmeq
->
cq_lock
, 
æags
,

2486 
SINGLE_DEPTH_NESTING
);

2487 
	`nvme_´oûss_cq
(
nvmeq
, &
¡¬t
, &
’d
, -1);

2488 
	`¥š_uÆock_œq»¡Üe
(&
nvmeq
->
cq_lock
, 
æags
);

2490 
	`nvme_com¶‘e_cqes
(
nvmeq
, 
¡¬t
, 
’d
);

2493 
	`nvme_d–_queue_’d
(
»q
, 
”rÜ
);

2494 
	}
}

2496 
	$nvme_d–‘e_queue
(
nvme_queue
 *
nvmeq
, 
u8
 
Ýcode
)

2498 
»que¡_queue
 *
q
 = 
nvmeq
->
dev
->
ù¾
.
admš_q
;

2499 
»que¡
 *
»q
;

2500 
nvme_commªd
 
cmd
;

2502 
	`mem£t
(&
cmd
, 0, (cmd));

2503 
cmd
.
d–‘e_queue
.
Ýcode
 = opcode;

2504 
cmd
.
d–‘e_queue
.
qid
 = 
	`ýu_to_Ë16
(
nvmeq
->qid);

2506 #ifdeà
HAVE_BLK_MQ_ALLOC_REQUEST_HAS_3_PARAMS


2507 
»q
 = 
	`nvme_®loc_»que¡
(
q
, &
cmd
, 
BLK_MQ_REQ_NOWAIT
, 
NVME_QID_ANY
);

2509 
»q
 = 
	`nvme_®loc_»que¡
(
q
, &
cmd
, 
GFP_KERNEL
, 
çl£
, 
NVME_QID_ANY
);

2511 ià(
	`IS_ERR
(
»q
))

2512  
	`PTR_ERR
(
»q
);

2514 
»q
->
timeout
 = 
ADMIN_TIMEOUT
;

2515 
»q
->
’d_io_d©a
 = 
nvmeq
;

2517 
	`blk_execu‹_rq_nowa™
(
q
, 
NULL
, 
»q
, 
çl£
,

2518 
Ýcode
 =ð
nvme_admš_d–‘e_cq
 ?

2519 
nvme_d–_cq_’d
 : 
nvme_d–_queue_’d
);

2521 
	}
}

2523 
	$nvme_di§bË_io_queues
(
nvme_dev
 *
dev
)

2525 
·ss
, 
queues
 = 
dev
->
Úlše_queues
 - 1;

2526 
timeout
;

2527 
u8
 
Ýcode
 = 
nvme_admš_d–‘e_sq
;

2529 
·ss
 = 0;…ass < 2;…ass++) {

2530 
£Á
 = 0, 
i
 = 
queues
;

2532 
	`»š™_com¶‘iÚ
(&
dev
->
ioq_wa™
);

2533 
»Œy
:

2534 
timeout
 = 
ADMIN_TIMEOUT
;

2535 ; 
i
 > 0; i--, 
£Á
++)

2536 ià(
	`nvme_d–‘e_queue
(&
dev
->
queues
[
i
], 
Ýcode
))

2539 
£Á
--) {

2540 
timeout
 = 
	`wa™_fÜ_com¶‘iÚ_io_timeout
(&
dev
->
ioq_wa™
,imeout);

2541 ià(
timeout
 == 0)

2543 ià(
i
)

2544 
»Œy
;

2546 
Ýcode
 = 
nvme_admš_d–‘e_cq
;

2548 
	}
}

2553 
	$nvme_dev_add
(
nvme_dev
 *
dev
)

2555 
Ä_hw_queues
 = 
dev
->
Úlše_queues
 - 1 - dev->
num_p2p_queues
;

2556 
»t
;

2558 ià(!
dev
->
ù¾
.
g£t
) {

2559 
dev
->
g£t
.
Ýs
 = &
nvme_mq_Ýs
;

2560 
dev
->
g£t
.
Ä_hw_queues
 =‚r_hw_queues;

2561 
dev
->
g£t
.
timeout
 = 
NVME_IO_TIMEOUT
;

2562 
dev
->
g£t
.
numa_node
 = 
	`dev_to_node
(dev->dev);

2563 
dev
->
g£t
.
queue_d•th
 =

2564 
	`mš_t
(, 
dev
->
q_d•th
, 
BLK_MQ_MAX_DEPTH
) - 1;

2565 
dev
->
g£t
.
cmd_size
 = 
	`nvme_pci_cmd_size
(dev, 
çl£
);

2566 ià((
dev
->
ù¾
.
sgls
 & ((1 << 0è| (1 << 1))è&& 
sgl_th»shÞd
) {

2567 
dev
->
g£t
.
cmd_size
 = 
	`max
(dev->tagset.cmd_size,

2568 
	`nvme_pci_cmd_size
(
dev
, 
Œue
));

2570 
dev
->
g£t
.
æags
 = 
BLK_MQ_F_SHOULD_MERGE
;

2571 
dev
->
g£t
.
driv”_d©a
 = dev;

2573 
»t
 = 
	`blk_mq_®loc_g_£t
(&
dev
->
g£t
);

2574 ià(
»t
) {

2575 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

2576 "IO queue g£ˆ®loÿtiÚ fažed %d\n", 
»t
);

2577  
»t
;

2579 
dev
->
ù¾
.
g£t
 = &dev->tagset;

2581 
	`nvme_dbbuf_£t
(
dev
);

2583 #ifdeà
HAVE_BLK_MQ_UPDATE_NR_HW_QUEUES


2584 
	`blk_mq_upd©e_Ä_hw_queues
(&
dev
->
g£t
, 
Ä_hw_queues
);

2588 
	`nvme_ä“_queues
(
dev
, dev->
Úlše_queues
);

2592 
	}
}

2594 
	$nvme_pci_’abË
(
nvme_dev
 *
dev
)

2596 
»suÉ
 = -
ENOMEM
;

2597 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

2599 ià(
	`pci_’abË_deviû_mem
(
pdev
))

2600  
»suÉ
;

2602 
	`pci_£t_ma¡”
(
pdev
);

2604 ià(
	`dma_£t_mask_ªd_coh”’t
(
dev
->dev, 
	`DMA_BIT_MASK
(64)) &&

2605 
	`dma_£t_mask_ªd_coh”’t
(
dev
->dev, 
	`DMA_BIT_MASK
(32)))

2606 
di§bË
;

2608 ià(
	`»adl
(
dev
->
b¬
 + 
NVME_REG_CSTS
) == -1) {

2609 
»suÉ
 = -
ENODEV
;

2610 
di§bË
;

2618 #ifdeà
HAVE_PCI_IRQ_API


2619 
»suÉ
 = 
	`pci_®loc_œq_veùÜs
(
pdev
, 1, 1, 
PCI_IRQ_ALL_TYPES
);

2620 ià(
»suÉ
 < 0)

2621  
»suÉ
;

2623 ià(
	`pci_’abË_msix
(
pdev
, 
dev
->
’Œy
, 1)) {

2624 
	`pci_’abË_msi
(
pdev
);

2625 
dev
->
’Œy
[0].
veùÜ
 = 
pdev
->
œq
;

2628 ià(!
dev
->
’Œy
[0].
veùÜ
) {

2629 
»suÉ
 = -
ENODEV
;

2630 
di§bË
;

2634 
dev
->
ù¾
.
ÿp
 = 
	`lo_hi_»adq
(dev->
b¬
 + 
NVME_REG_CAP
);

2636 
dev
->
q_d•th
 = 
	`mš_t
(, 
	`NVME_CAP_MQES
(dev->
ù¾
.
ÿp
) + 1,

2637 
io_queue_d•th
);

2638 
dev
->
db_¡ride
 = 1 << 
	`NVME_CAP_STRIDE
(dev->
ù¾
.
ÿp
);

2639 
dev
->
dbs
 = dev->
b¬
 + 4096;

2645 ià(
pdev
->
v’dÜ
 =ð
PCI_VENDOR_ID_APPLE
 &&…dev->
deviû
 == 0x2001) {

2646 
dev
->
q_d•th
 = 2;

2647 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
, "detected Apple NVMe controller, "

2649 
dev
->
q_d•th
);

2650 } ià(
pdev
->
v’dÜ
 =ð
PCI_VENDOR_ID_SAMSUNG
 &&

2651 (
pdev
->
deviû
 == 0xa821 ||…dev->device == 0xa822) &&

2652 
	`NVME_CAP_MQES
(
dev
->
ù¾
.
ÿp
) == 0) {

2653 
dev
->
q_d•th
 = 64;

2654 
	`dev_”r
(
dev
->
ù¾
.
deviû
, "detected PM1725 NVMe controller, "

2655 "£ˆqueud•th=%u\n", 
dev
->
q_d•th
);

2658 
	`nvme_m­_cmb
(
dev
);

2660 
	`pci_’abË_pc›_”rÜ_»pÜtšg
(
pdev
);

2661 
	`pci_§ve_¡©e
(
pdev
);

2664 
di§bË
:

2665 
	`pci_di§bË_deviû
(
pdev
);

2666  
»suÉ
;

2667 
	}
}

2669 
	$nvme_dev_unm­
(
nvme_dev
 *
dev
)

2671 ià(
dev
->
b¬
)

2672 
	`iounm­
(
dev
->
b¬
);

2673 
	`pci_»Ëa£_mem_»giÚs
(
	`to_pci_dev
(
dev
->dev));

2674 
	}
}

2676 
	$nvme_pci_di§bË
(
nvme_dev
 *
dev
)

2678 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

2680 
	`nvme_»Ëa£_cmb
(
dev
);

2681 #ifdeà
HAVE_PCI_IRQ_API


2682 
	`pci_ä“_œq_veùÜs
(
pdev
);

2684 ià(
pdev
->
msi_’abËd
)

2685 
	`pci_di§bË_msi
(
pdev
);

2686 ià(
pdev
->
msix_’abËd
)

2687 
	`pci_di§bË_msix
(
pdev
);

2690 ià(
	`pci_is_’abËd
(
pdev
)) {

2691 
	`pci_di§bË_pc›_”rÜ_»pÜtšg
(
pdev
);

2692 
	`pci_di§bË_deviû
(
pdev
);

2694 
	}
}

2696 
	$nvme_dev_di§bË
(
nvme_dev
 *
dev
, 
boÞ
 
shutdown
)

2698 
i
;

2699 
boÞ
 
d—d
 = 
Œue
;

2700 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

2702 
	`mu‹x_lock
(&
dev
->
shutdown_lock
);

2703 ià(
	`pci_is_’abËd
(
pdev
)) {

2704 
u32
 
c¡s
 = 
	`»adl
(
dev
->
b¬
 + 
NVME_REG_CSTS
);

2706 ià(
dev
->
ù¾
.
¡©e
 =ð
NVME_CTRL_LIVE
 ||

2707 
dev
->
ù¾
.
¡©e
 =ð
NVME_CTRL_RESETTING
)

2708 
	`nvme_¡¬t_ä“ze
(&
dev
->
ù¾
);

2709 
d—d
 = !!((
c¡s
 & 
NVME_CSTS_CFS
è|| !(c¡ & 
NVME_CSTS_RDY
) ||

2710 
pdev
->
”rÜ_¡©e
 !ð
pci_chªÃl_io_nÜm®
);

2717 ià(!
d—d
) {

2718 ià(
shutdown
)

2719 
	`nvme_wa™_ä“ze_timeout
(&
dev
->
ù¾
, 
NVME_IO_TIMEOUT
);

2722 
	`nvme_¡Ý_queues
(&
dev
->
ù¾
);

2724 ià(!
d—d
 && 
dev
->
ù¾
.
queue_couÁ
 > 0) {

2731 ià(
dev
->
ho¡_mem_descs
)

2732 
	`nvme_£t_ho¡_mem
(
dev
, 0);

2733 
	`nvme_di§bË_io_queues
(
dev
);

2734 
	`nvme_di§bË_admš_queue
(
dev
, 
shutdown
);

2736 
i
 = 
dev
->
ù¾
.
queue_couÁ
 - 1; i >= 0; i--)

2737 
	`nvme_su¥’d_queue
(&
dev
->
queues
[
i
]);

2739 
	`nvme_pci_di§bË
(
dev
);

2741 
	`blk_mq_g£t_busy_™”
(&
dev
->
g£t
, 
nvme_ÿnûl_»que¡
, &dev->
ù¾
);

2742 
	`blk_mq_g£t_busy_™”
(&
dev
->
admš_g£t
, 
nvme_ÿnûl_»que¡
, &dev->
ù¾
);

2749 ià(
shutdown
)

2750 
	`nvme_¡¬t_queues
(&
dev
->
ù¾
);

2751 
	`mu‹x_uÆock
(&
dev
->
shutdown_lock
);

2752 
	}
}

2754 
	$nvme_£tup_´p_poÞs
(
nvme_dev
 *
dev
)

2756 
dev
->
´p_·ge_poÞ
 = 
	`dma_poÞ_ü—‹
("prp†ist…age", dev->dev,

2757 
PAGE_SIZE
, PAGE_SIZE, 0);

2758 ià(!
dev
->
´p_·ge_poÞ
)

2759  -
ENOMEM
;

2762 
dev
->
´p_sm®l_poÞ
 = 
	`dma_poÞ_ü—‹
("prp†ist 256", dev->dev,

2764 ià(!
dev
->
´p_sm®l_poÞ
) {

2765 
	`dma_poÞ_de¡roy
(
dev
->
´p_·ge_poÞ
);

2766  -
ENOMEM
;

2769 
	}
}

2771 
	$nvme_»Ëa£_´p_poÞs
(
nvme_dev
 *
dev
)

2773 
	`dma_poÞ_de¡roy
(
dev
->
´p_·ge_poÞ
);

2774 
	`dma_poÞ_de¡roy
(
dev
->
´p_sm®l_poÞ
);

2775 
	}
}

2777 
	$nvme_pci_ä“_ù¾
(
nvme_ù¾
 *
ù¾
)

2779 
nvme_dev
 *
dev
 = 
	`to_nvme_dev
(
ù¾
);

2781 
	`nvme_dbbuf_dma_ä“
(
dev
);

2782 
	`put_deviû
(
dev
->dev);

2783 ià(
dev
->
g£t
.
gs
)

2784 
	`blk_mq_ä“_g_£t
(&
dev
->
g£t
);

2785 ià(
dev
->
ù¾
.
admš_q
)

2786 
	`blk_put_queue
(
dev
->
ù¾
.
admš_q
);

2787 
	`kä“
(
dev
->
queues
);

2788 #ifdeà
HAVE_LINUX_SED_OPAL_H


2789 
	`ä“_Ý®_dev
(
dev
->
ù¾
.
Ý®_dev
);

2791 #iâdeà
HAVE_PCI_IRQ_API


2792 
	`kä“
(
dev
->
’Œy
);

2794 
	`kä“
(
dev
);

2795 
	}
}

2797 
	$nvme_»move_d—d_ù¾
(
nvme_dev
 *
dev
, 
¡©us
)

2799 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
, "Removšg‡á”…robçžu» stus: %d\n", 
¡©us
);

2801 
	`nvme_g‘_ù¾
(&
dev
->
ù¾
);

2802 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

2803 ià(!
	`queue_wÜk
(
nvme_wq
, &
dev
->
»move_wÜk
))

2804 
	`nvme_put_ù¾
(&
dev
->
ù¾
);

2805 
	}
}

2807 
	$nvme_»£t_wÜk
(
wÜk_¡ruù
 *
wÜk
)

2809 
nvme_dev
 *
dev
 =

2810 
	`cÚš”_of
(
wÜk
, 
nvme_dev
, 
ù¾
.
»£t_wÜk
);

2811 #ifdeà
HAVE_LINUX_SED_OPAL_H


2812 
boÞ
 
was_su¥’d
 = !!(
dev
->
ù¾
.
ù¾_cÚfig
 & 
NVME_CC_SHN_NORMAL
);

2814 
»suÉ
 = -
ENODEV
;

2815 
nvme_ù¾_¡©e
 
Ãw_¡©e
 = 
NVME_CTRL_LIVE
;

2817 ià(
	`WARN_ON
(
dev
->
ù¾
.
¡©e
 !ð
NVME_CTRL_RESETTING
))

2818 
out
;

2824 ià(
dev
->
ù¾
.
ù¾_cÚfig
 & 
NVME_CC_ENABLE
)

2825 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

2831 ià(!
	`nvme_chªge_ù¾_¡©e
(&
dev
->
ù¾
, 
NVME_CTRL_CONNECTING
)) {

2832 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

2834 
out
;

2837 
»suÉ
 = 
	`nvme_pci_’abË
(
dev
);

2838 ià(
»suÉ
)

2839 
out
;

2841 
»suÉ
 = 
	`nvme_pci_cÚfigu»_admš_queue
(
dev
);

2842 ià(
»suÉ
)

2843 
out
;

2845 
»suÉ
 = 
	`nvme_®loc_admš_gs
(
dev
);

2846 ià(
»suÉ
)

2847 
out
;

2849 
»suÉ
 = 
	`nvme_š™_id’tify
(&
dev
->
ù¾
);

2850 ià(
»suÉ
)

2851 
out
;

2853 #ifdeà
HAVE_LINUX_SED_OPAL_H


2854 ià(
dev
->
ù¾
.
ßcs
 & 
NVME_CTRL_OACS_SEC_SUPP
) {

2855 ià(!
dev
->
ù¾
.
Ý®_dev
)

2856 
dev
->
ù¾
.
Ý®_dev
 =

2857 
	`š™_Ý®_dev
(&
dev
->
ù¾
, &
nvme_£c_subm™
);

2858 ià(
was_su¥’d
)

2859 
	`Ý®_uÆock_äom_su¥’d
(
dev
->
ù¾
.
Ý®_dev
);

2861 
	`ä“_Ý®_dev
(
dev
->
ù¾
.
Ý®_dev
);

2862 
dev
->
ù¾
.
Ý®_dev
 = 
NULL
;

2866 ià(
dev
->
ù¾
.
ßcs
 & 
NVME_CTRL_OACS_DBBUF_SUPP
) {

2867 
»suÉ
 = 
	`nvme_dbbuf_dma_®loc
(
dev
);

2868 ià(
»suÉ
)

2869 
	`dev_w¬n
(
dev
->dev,

2873 ià(
dev
->
ù¾
.
hm´e
) {

2874 
»suÉ
 = 
	`nvme_£tup_ho¡_mem
(
dev
);

2875 ià(
»suÉ
 < 0)

2876 
out
;

2879 
»suÉ
 = 
	`nvme_£tup_io_queues
(
dev
);

2880 ià(
»suÉ
)

2881 
out
;

2887 ià(
dev
->
Úlše_queues
 < 2) {

2888 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
, "IO queues‚ot created\n");

2889 
	`nvme_kžl_queues
(&
dev
->
ù¾
);

2890 
	`nvme_»move_Çme¥aûs
(&
dev
->
ù¾
);

2891 
Ãw_¡©e
 = 
NVME_CTRL_ADMIN_ONLY
;

2893 
	`nvme_¡¬t_queues
(&
dev
->
ù¾
);

2894 
	`nvme_wa™_ä“ze
(&
dev
->
ù¾
);

2896 ià(
	`nvme_dev_add
(
dev
))

2897 
Ãw_¡©e
 = 
NVME_CTRL_ADMIN_ONLY
;

2898 
	`nvme_unä“ze
(&
dev
->
ù¾
);

2905 ià(!
	`nvme_chªge_ù¾_¡©e
(&
dev
->
ù¾
, 
Ãw_¡©e
)) {

2906 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

2907 "çžedØm¬k cÚŒÞË¸¡©%d\n", 
Ãw_¡©e
);

2908 
out
;

2911 
	`nvme_¡¬t_ù¾
(&
dev
->
ù¾
);

2914 
out
:

2915 
	`nvme_»move_d—d_ù¾
(
dev
, 
»suÉ
);

2916 
	}
}

2918 
	$nvme_»move_d—d_ù¾_wÜk
(
wÜk_¡ruù
 *
wÜk
)

2920 
nvme_dev
 *
dev
 = 
	`cÚš”_of
(
wÜk
, nvme_dev, 
»move_wÜk
);

2921 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

2923 
	`nvme_kžl_queues
(&
dev
->
ù¾
);

2924 ià(
	`pci_g‘_drvd©a
(
pdev
))

2925 
	`deviû_»Ëa£_driv”
(&
pdev
->
dev
);

2926 
	`nvme_put_ù¾
(&
dev
->
ù¾
);

2927 
	}
}

2929 
	$nvme_pci_»g_»ad32
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, u32 *
v®
)

2931 *
v®
 = 
	`»adl
(
	`to_nvme_dev
(
ù¾
)->
b¬
 + 
off
);

2933 
	}
}

2935 
	$nvme_pci_»g_wr™e32
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, u32 
v®
)

2937 
	`wr™–
(
v®
, 
	`to_nvme_dev
(
ù¾
)->
b¬
 + 
off
);

2939 
	}
}

2941 
	$nvme_pci_»g_»ad64
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, 
u64
 *
v®
)

2943 *
v®
 = 
	`»adq
(
	`to_nvme_dev
(
ù¾
)->
b¬
 + 
off
);

2945 
	}
}

2947 
	$nvme_pci_g‘_add»ss
(
nvme_ù¾
 *
ù¾
, *
buf
, 
size
)

2949 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
	`to_nvme_dev
(
ù¾
)->
dev
);

2951  
	`¢´štf
(
buf
, 
size
, "%s", 
	`dev_Çme
(&
pdev
->
dev
));

2952 
	}
}

2954 cÚ¡ 
nvme_ù¾_Ýs
 
	gnvme_pci_ù¾_Ýs
 = {

2955 .
Çme
 = "pcie",

2956 .
	gmoduË
 = 
THIS_MODULE
,

2957 .
	gæags
 = 
NVME_F_METADATA_SUPPORTED
,

2958 .
	g»g_»ad32
 = 
nvme_pci_»g_»ad32
,

2959 .
	g»g_wr™e32
 = 
nvme_pci_»g_wr™e32
,

2960 .
	g»g_»ad64
 = 
nvme_pci_»g_»ad64
,

2961 .
	gä“_ù¾
 = 
nvme_pci_ä“_ù¾
,

2962 .
	gsubm™_async_ev’t
 = 
nvme_pci_subm™_async_ev’t
,

2963 .
	gg‘_add»ss
 = 
nvme_pci_g‘_add»ss
,

2966 
pci_dev
 *
	$nvme_fšd_pdev_äom_bdev
(
block_deviû
 *
bdev
)

2968 
nvme_ns
 *
ns
;

2970 ià(!
	`disk_is_nvme
(
bdev
->
bd_disk
))

2971  
NULL
;

2973 
ns
 = 
bdev
->
bd_disk
->
´iv©e_d©a
;

2975 ià(
ns
->
ù¾
->
Ýs
 !ð&
nvme_pci_ù¾_Ýs
)

2976  
NULL
;

2978  
	`to_pci_dev
(
	`to_nvme_dev
(
ns
->
ù¾
)->
dev
);

2979 
	}
}

2980 
EXPORT_SYMBOL_GPL
(
nvme_fšd_pdev_äom_bdev
);

2982 
	$nvme_fšd_ns_id_äom_bdev
(
block_deviû
 *
bdev
)

2984 
nvme_ns
 *
ns
;

2986 ià(!
	`disk_is_nvme
(
bdev
->
bd_disk
))

2989 
ns
 = 
bdev
->
bd_disk
->
´iv©e_d©a
;

2991  
ns
->
h—d
->
ns_id
;

2992 
	}
}

2993 
EXPORT_SYMBOL_GPL
(
nvme_fšd_ns_id_äom_bdev
);

2995 
	$nvme_dev_m­
(
nvme_dev
 *
dev
)

2997 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

2999 ià(
	`pci_»que¡_mem_»giÚs
(
pdev
, "nvme"))

3000  -
ENODEV
;

3002 ià(
	`nvme_»m­_b¬
(
dev
, 
NVME_REG_DBS
 + 4096))

3003 
»Ëa£
;

3006 
»Ëa£
:

3007 
	`pci_»Ëa£_mem_»giÚs
(
pdev
);

3008  -
ENODEV
;

3009 
	}
}

3011 
	$check_v’dÜ_combš©iÚ_bug
(
pci_dev
 *
pdev
)

3013 ià(
pdev
->
v’dÜ
 =ð0x144d &&…dev->
deviû
 == 0xa802) {

3022 ià(
	`dmi_m©ch
(
DMI_SYS_VENDOR
, "Dell Inc.") &&

3023 (
	`dmi_m©ch
(
DMI_PRODUCT_NAME
, "XPS 15 9550") ||

3024 
	`dmi_m©ch
(
DMI_PRODUCT_NAME
, "Precision 5510")))

3025  
NVME_QUIRK_NO_DEEPEST_PS
;

3026 } ià(
pdev
->
v’dÜ
 =ð0x144d &&…dev->
deviû
 == 0xa804) {

3033 ià(
	`dmi_m©ch
(
DMI_BOARD_VENDOR
, "ASUSTeK COMPUTER INC.") &&

3034 (
	`dmi_m©ch
(
DMI_BOARD_NAME
, "PRIME B350M-A") ||

3035 
	`dmi_m©ch
(
DMI_BOARD_NAME
, "PRIME Z370-A")))

3036  
NVME_QUIRK_NO_APST
;

3040 
	}
}

3042 
	$nvme_async_´obe
(*
d©a
, 
async_cook›_t
 
cook›
)

3044 
nvme_dev
 *
dev
 = 
d©a
;

3046 
	`nvme_»£t_ù¾_sync
(&
dev
->
ù¾
);

3047 
	`æush_wÜk
(&
dev
->
ù¾
.
sÿn_wÜk
);

3048 
	`nvme_put_ù¾
(&
dev
->
ù¾
);

3049 
	}
}

3051 
	$nvme_´obe
(
pci_dev
 *
pdev
, cÚ¡ 
pci_deviû_id
 *
id
)

3053 
node
, 
»suÉ
 = -
ENOMEM
;

3054 
nvme_dev
 *
dev
;

3055 
quœks
 = 
id
->
driv”_d©a
;

3057 
node
 = 
	`dev_to_node
(&
pdev
->
dev
);

3058 ià(
node
 =ð
NUMA_NO_NODE
)

3059 
	`£t_dev_node
(&
pdev
->
dev
, 
fœ¡_memÜy_node
);

3061 
dev
 = 
	`kz®loc_node
((*dev), 
GFP_KERNEL
, 
node
);

3062 ià(!
dev
)

3063  -
ENOMEM
;

3065 #iâdeà
HAVE_PCI_IRQ_API


3066 
dev
->
’Œy
 = 
	`kz®loc_node
(
	`num_possibË_ýus
() * (*dev->entry),

3067 
GFP_KERNEL
, 
node
);

3068 ià(!
dev
->
’Œy
)

3069 
ä“
;

3072 
dev
->
queues
 = 
	`kÿÎoc_node
(
	`num_possibË_ýus
(è+ 1 + 
num_p2p_queues
,

3073 (
nvme_queue
), 
GFP_KERNEL
, 
node
);

3074 ià(!
dev
->
queues
)

3075 
ä“
;

3077 
dev
->
num_p2p_queues
 =‚um_p2p_queues;

3078 
dev
->dev = 
	`g‘_deviû
(&
pdev
->dev);

3079 
	`pci_£t_drvd©a
(
pdev
, 
dev
);

3081 
»suÉ
 = 
	`nvme_dev_m­
(
dev
);

3082 ià(
»suÉ
)

3083 
put_pci
;

3085 
	`INIT_WORK
(&
dev
->
ù¾
.
»£t_wÜk
, 
nvme_»£t_wÜk
);

3086 
	`INIT_WORK
(&
dev
->
»move_wÜk
, 
nvme_»move_d—d_ù¾_wÜk
);

3087 
	`mu‹x_š™
(&
dev
->
shutdown_lock
);

3088 
	`š™_com¶‘iÚ
(&
dev
->
ioq_wa™
);

3090 
»suÉ
 = 
	`nvme_£tup_´p_poÞs
(
dev
);

3091 ià(
»suÉ
)

3092 
unm­
;

3094 
quœks
 |ð
	`check_v’dÜ_combš©iÚ_bug
(
pdev
);

3096 
»suÉ
 = 
	`nvme_š™_ù¾
(&
dev
->
ù¾
, &
pdev
->dev, &
nvme_pci_ù¾_Ýs
,

3097 
quœks
);

3098 ià(
»suÉ
)

3099 
»Ëa£_poÞs
;

3107 ià(
	`sysfs_add_fže_to_group
(&
dev
->
ù¾
.
deviû
->
kobj
,

3108 &
dev_©Œ_num_p2p_queues
.
©Œ
, 
NULL
))

3109 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

3112 
	`dev_šfo
(
dev
->
ù¾
.
deviû
, "pc˜funùiÚ %s\n", 
	`dev_Çme
(&
pdev
->dev));

3114 
	`nvme_g‘_ù¾
(&
dev
->
ù¾
);

3115 
	`async_scheduË
(
nvme_async_´obe
, 
dev
);

3119 
»Ëa£_poÞs
:

3120 
	`nvme_»Ëa£_´p_poÞs
(
dev
);

3121 
unm­
:

3122 
	`nvme_dev_unm­
(
dev
);

3123 
put_pci
:

3124 
	`put_deviû
(
dev
->dev);

3125 
ä“
:

3126 
	`kä“
(
dev
->
queues
);

3127 #iâdeà
HAVE_PCI_IRQ_API


3128 
	`kä“
(
dev
->
’Œy
);

3130 
	`kä“
(
dev
);

3131  
»suÉ
;

3132 
	}
}

3134 #ifdeà
HAVE_PCI_ERROR_HANDLERS_RESET_NOTIFY


3135 
	$nvme_»£t_nÙify
(
pci_dev
 *
pdev
, 
boÞ
 
´•¬e
)

3137 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

3139 ià(
´•¬e
)

3140 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

3142 
	`nvme_»£t_ù¾
(&
dev
->
ù¾
);

3143 
	}
}

3144 #–ià
defšed
(
HAVE_PCI_ERROR_HANDLERS_RESET_PREPARE
è&& defšed(
HAVE_PCI_ERROR_HANDLERS_RESET_DONE
)

3145 
	$nvme_»£t_´•¬e
(
pci_dev
 *
pdev
)

3147 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

3148 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

3149 
	}
}

3151 
	$nvme_»£t_dÚe
(
pci_dev
 *
pdev
)

3153 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

3154 
	`nvme_»£t_ù¾_sync
(&
dev
->
ù¾
);

3155 
	}
}

3158 
	$nvme_shutdown
(
pci_dev
 *
pdev
)

3160 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

3161 
	`nvme_dev_di§bË
(
dev
, 
Œue
);

3162 
	}
}

3169 
	$nvme_»move
(
pci_dev
 *
pdev
)

3171 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

3173 
	`nvme_chªge_ù¾_¡©e
(&
dev
->
ù¾
, 
NVME_CTRL_DELETING
);

3175 
	`ÿnûl_wÜk_sync
(&
dev
->
ù¾
.
»£t_wÜk
);

3176 
	`pci_£t_drvd©a
(
pdev
, 
NULL
);

3178 ià(!
	`pci_deviû_is_´e£Á
(
pdev
)) {

3179 
	`nvme_chªge_ù¾_¡©e
(&
dev
->
ù¾
, 
NVME_CTRL_DEAD
);

3180 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

3183 
	`æush_wÜk
(&
dev
->
ù¾
.
»£t_wÜk
);

3184 
	`nvme_¡Ý_ù¾
(&
dev
->
ù¾
);

3185 
	`nvme_»move_Çme¥aûs
(&
dev
->
ù¾
);

3186 
	`nvme_dev_di§bË
(
dev
, 
Œue
);

3187 
	`nvme_ä“_ho¡_mem
(
dev
);

3188 
	`nvme_dev_»move_admš
(
dev
);

3189 
	`nvme_ä“_queues
(
dev
, 0);

3190 
	`nvme_unš™_ù¾
(&
dev
->
ù¾
);

3191 
	`nvme_»Ëa£_´p_poÞs
(
dev
);

3192 
	`nvme_dev_unm­
(
dev
);

3193 
	`nvme_put_ù¾
(&
dev
->
ù¾
);

3194 
	}
}

3196 
	$nvme_pci_¤iov_cÚfigu»
(
pci_dev
 *
pdev
, 
numvfs
)

3198 
»t
 = 0;

3200 ià(
numvfs
 == 0) {

3201 ià(
	`pci_vfs_assigÃd
(
pdev
)) {

3202 
	`dev_w¬n
(&
pdev
->
dev
,

3204  -
EPERM
;

3206 
	`pci_di§bË_¤iov
(
pdev
);

3210 
»t
 = 
	`pci_’abË_¤iov
(
pdev
, 
numvfs
);

3211  
»t
 ?„‘ : 
numvfs
;

3212 
	}
}

3214 #ifdeà
CONFIG_PM_SLEEP


3215 
	$nvme_su¥’d
(
deviû
 *
dev
)

3217 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
);

3218 
nvme_dev
 *
ndev
 = 
	`pci_g‘_drvd©a
(
pdev
);

3220 
	`nvme_dev_di§bË
(
ndev
, 
Œue
);

3222 
	}
}

3224 
	$nvme_»sume
(
deviû
 *
dev
)

3226 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
);

3227 
nvme_dev
 *
ndev
 = 
	`pci_g‘_drvd©a
(
pdev
);

3229 
	`nvme_»£t_ù¾
(&
ndev
->
ù¾
);

3231 
	}
}

3234 
SIMPLE_DEV_PM_OPS
(
nvme_dev_pm_Ýs
, 
nvme_su¥’d
, 
nvme_»sume
);

3236 
pci_”s_»suÉ_t
 
	$nvme_”rÜ_d‘eùed
(
pci_dev
 *
pdev
,

3237 
pci_chªÃl_¡©e_t
 
¡©e
)

3239 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

3246 
¡©e
) {

3247 
pci_chªÃl_io_nÜm®
:

3248  
PCI_ERS_RESULT_CAN_RECOVER
;

3249 
pci_chªÃl_io_äoz’
:

3250 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

3252 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

3253  
PCI_ERS_RESULT_NEED_RESET
;

3254 
pci_chªÃl_io_³rm_çžu»
:

3255 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

3257  
PCI_ERS_RESULT_DISCONNECT
;

3259  
PCI_ERS_RESULT_NEED_RESET
;

3260 
	}
}

3262 
pci_”s_»suÉ_t
 
	$nvme_¦Ù_»£t
(
pci_dev
 *
pdev
)

3264 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

3266 
	`dev_šfo
(
dev
->
ù¾
.
deviû
, "restart‡fter slot„eset\n");

3267 
	`pci_»¡Üe_¡©e
(
pdev
);

3268 
	`nvme_»£t_ù¾
(&
dev
->
ù¾
);

3269  
PCI_ERS_RESULT_RECOVERED
;

3270 
	}
}

3272 
	$nvme_”rÜ_»sume
(
pci_dev
 *
pdev
)

3274 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

3276 
	`æush_wÜk
(&
dev
->
ù¾
.
»£t_wÜk
);

3277 
	`pci_þ—nup_«r_uncÜ»ù_”rÜ_¡©us
(
pdev
);

3278 
	}
}

3280 cÚ¡ 
pci_”rÜ_hªdËrs
 
	gnvme_”r_hªdËr
 = {

3281 .
”rÜ_d‘eùed
 = 
nvme_”rÜ_d‘eùed
,

3282 .
	g¦Ù_»£t
 = 
nvme_¦Ù_»£t
,

3283 .
	g»sume
 = 
nvme_”rÜ_»sume
,

3284 #ifdeà
HAVE_PCI_ERROR_HANDLERS_RESET_NOTIFY


3285 .
	g»£t_nÙify
 = 
nvme_»£t_nÙify
,

3286 #–ià
defšed
(
HAVE_PCI_ERROR_HANDLERS_RESET_PREPARE
è&& defšed(
HAVE_PCI_ERROR_HANDLERS_RESET_DONE
)

3287 .
	g»£t_´•¬e
 = 
nvme_»£t_´•¬e
,

3288 .
	g»£t_dÚe
 = 
nvme_»£t_dÚe
,

3292 #iâdeà
HAVE_PCI_CLASS_STORAGE_EXPRESS


3293 
	#PCI_CLASS_STORAGE_EXPRESS
 0x010802

	)

3296 cÚ¡ 
pci_deviû_id
 
	gnvme_id_bË
[] = {

3297 #ifdeà
HAVE_BLK_QUEUE_MAX_WRITE_ZEROES_SECTORS


3298 { 
PCI_VDEVICE
(
INTEL
, 0x0953),

3299 .
driv”_d©a
 = 
NVME_QUIRK_STRIPE_SIZE
 |

3300 
NVME_QUIRK_DEALLOCATE_ZEROES
, },

3301 { 
PCI_VDEVICE
(
INTEL
, 0x0a53),

3302 .
	gdriv”_d©a
 = 
NVME_QUIRK_STRIPE_SIZE
 |

3303 
NVME_QUIRK_DEALLOCATE_ZEROES
, },

3304 { 
PCI_VDEVICE
(
INTEL
, 0x0a54),

3305 .
	gdriv”_d©a
 = 
NVME_QUIRK_STRIPE_SIZE
 |

3306 
NVME_QUIRK_DEALLOCATE_ZEROES
, },

3307 { 
PCI_VDEVICE
(
INTEL
, 0x0a55),

3308 .
	gdriv”_d©a
 = 
NVME_QUIRK_STRIPE_SIZE
 |

3309 
NVME_QUIRK_DEALLOCATE_ZEROES
, },

3311 { 
PCI_VDEVICE
(
INTEL
, 0x0953),

3312 .
	gdriv”_d©a
 = 
NVME_QUIRK_STRIPE_SIZE
 |

3313 
NVME_QUIRK_DISCARD_ZEROES
, },

3314 { 
PCI_VDEVICE
(
INTEL
, 0x0a53),

3315 .
	gdriv”_d©a
 = 
NVME_QUIRK_STRIPE_SIZE
 |

3316 
NVME_QUIRK_DISCARD_ZEROES
, },

3317 { 
PCI_VDEVICE
(
INTEL
, 0x0a54),

3318 .
	gdriv”_d©a
 = 
NVME_QUIRK_STRIPE_SIZE
 |

3319 
NVME_QUIRK_DISCARD_ZEROES
, },

3321 { 
PCI_VDEVICE
(
INTEL
, 0xf1a5),

3322 .
	gdriv”_d©a
 = 
NVME_QUIRK_NO_DEEPEST_PS
 |

3323 
NVME_QUIRK_MEDIUM_PRIO_SQ
 },

3324 { 
PCI_VDEVICE
(
INTEL
, 0x5845),

3325 .
	gdriv”_d©a
 = 
NVME_QUIRK_IDENTIFY_CNS
, },

3326 { 
PCI_DEVICE
(0x1bb1, 0x0100),

3327 .
	gdriv”_d©a
 = 
NVME_QUIRK_DELAY_BEFORE_CHK_RDY
, },

3328 { 
PCI_DEVICE
(0x1c58, 0x0003),

3329 .
	gdriv”_d©a
 = 
NVME_QUIRK_DELAY_BEFORE_CHK_RDY
, },

3330 { 
PCI_DEVICE
(0x1c58, 0x0023),

3331 .
	gdriv”_d©a
 = 
NVME_QUIRK_DELAY_BEFORE_CHK_RDY
, },

3332 { 
PCI_DEVICE
(0x1c5f, 0x0540),

3333 .
	gdriv”_d©a
 = 
NVME_QUIRK_DELAY_BEFORE_CHK_RDY
, },

3334 { 
PCI_DEVICE
(0x144d, 0xa821),

3335 .
	gdriv”_d©a
 = 
NVME_QUIRK_DELAY_BEFORE_CHK_RDY
, },

3336 { 
PCI_DEVICE
(0x144d, 0xa822),

3337 .
	gdriv”_d©a
 = 
NVME_QUIRK_DELAY_BEFORE_CHK_RDY
, },

3338 { 
PCI_DEVICE
(0x1d1d, 0x1f1f),

3339 .
	gdriv”_d©a
 = 
NVME_QUIRK_LIGHTNVM
, },

3340 { 
PCI_DEVICE
(0x1d1d, 0x2807),

3341 .
	gdriv”_d©a
 = 
NVME_QUIRK_LIGHTNVM
, },

3342 { 
PCI_DEVICE
(0x1d1d, 0x2601),

3343 .
	gdriv”_d©a
 = 
NVME_QUIRK_LIGHTNVM
, },

3344 { 
PCI_DEVICE_CLASS
(
PCI_CLASS_STORAGE_EXPRESS
, 0xffffff) },

3345 { 
PCI_DEVICE
(
PCI_VENDOR_ID_APPLE
, 0x2001) },

3346 { 
PCI_DEVICE
(
PCI_VENDOR_ID_APPLE
, 0x2003) },

3349 
MODULE_DEVICE_TABLE
(
pci
, 
nvme_id_bË
);

3351 
pci_driv”
 
	gnvme_driv”
 = {

3352 .
Çme
 = "nvme",

3353 .
	gid_bË
 = 
nvme_id_bË
,

3354 .
	g´obe
 = 
nvme_´obe
,

3355 .
	g»move
 = 
nvme_»move
,

3356 .
	gshutdown
 = 
nvme_shutdown
,

3357 .
	gdriv”
 = {

3358 .
pm
 = &
nvme_dev_pm_Ýs
,

3360 .
	g¤iov_cÚfigu»
 = 
nvme_pci_¤iov_cÚfigu»
,

3361 .
	g”r_hªdËr
 = &
nvme_”r_hªdËr
,

3364 
__š™
 
	$nvme_š™
()

3366  
	`pci_»gi¡”_driv”
(&
nvme_driv”
);

3367 
	}
}

3369 
__ex™
 
	$nvme_ex™
()

3371 
	`pci_uÄegi¡”_driv”
(&
nvme_driv”
);

3372 
	`æush_wÜkqueue
(
nvme_wq
);

3373 
	`_nvme_check_size
();

3374 
	}
}

3376 
MODULE_AUTHOR
("Matthew Wilcox <willy@linux.intel.com>");

3377 
MODULE_LICENSE
("GPL");

3378 #ifdeà
RETPOLINE_MLNX


3379 
MODULE_INFO
(
»Þše
, "Y");

3381 
MODULE_VERSION
("1.0");

3382 
moduË_š™
(
nvme_š™
);

3383 
moduË_ex™
(
nvme_ex™
);

	@rdma.c

14 #ifdeà
´_fmt


15 #undeà
´_fmt


17 
	#´_fmt
(
fmt
è
KBUILD_MODNAME
 ": " 
	)
fmt

18 
	~<lšux/moduË.h
>

19 
	~<lšux/š™.h
>

20 
	~<lšux/¦ab.h
>

21 
	~<rdma/mr_poÞ.h
>

22 
	~<lšux/”r.h
>

23 
	~<lšux/sizes.h
>

24 
	~<lšux/¡ršg.h
>

25 
	~<lšux/©omic.h
>

26 
	~<lšux/blk-mq.h
>

27 #ifdeà
HAVE_BLK_MQ_MAP_QUEUES


28 
	~<lšux/blk-mq-rdma.h
>

30 
	~<lšux/ty³s.h
>

31 
	~<lšux/li¡.h
>

32 
	~<lšux/mu‹x.h
>

33 
	~<lšux/sÿ‰”li¡.h
>

34 
	~<lšux/nvme.h
>

35 
	~<asm/uÇligÃd.h
>

36 #ifdeà
HAVE_SCSI_MAX_SG_SEGMENTS


37 
	~<scsi/scsi.h
>

39 
	~<lšux/»fcouÁ.h
>

41 
	~<rdma/ib_v”bs.h
>

42 
	~<rdma/rdma_cm.h
>

43 
	~<lšux/nvme-rdma.h
>

45 
	~"nvme.h
"

46 
	~"çbrics.h
"

49 
	#NVME_RDMA_CONNECT_TIMEOUT_MS
 3000

	)

51 
	#NVME_RDMA_MAX_SEGMENTS
 256

	)

53 
	#NVME_RDMA_MAX_INLINE_SEGMENTS
 1

	)

55 
	snvme_rdma_deviû
 {

56 
ib_deviû
 *
	mdev
;

57 
ib_pd
 *
	mpd
;

58 
k»f
 
	m»f
;

59 
li¡_h—d
 
	m’Œy
;

62 
	snvme_rdma_qe
 {

63 
ib_cqe
 
	mcqe
;

64 *
	md©a
;

65 
u64
 
	mdma
;

68 
	gnvme_rdma_queue
;

69 
	snvme_rdma_»que¡
 {

70 
nvme_»que¡
 
	m»q
;

71 
ib_mr
 *
	mmr
;

72 
nvme_rdma_qe
 
	msqe
;

73 
nvme_»suÉ
 
	m»suÉ
;

74 
__Ë16
 
	m¡©us
;

75 
»fcouÁ_t
 
	m»f
;

76 
ib_sge
 
	msge
[1 + 
NVME_RDMA_MAX_INLINE_SEGMENTS
];

77 
u32
 
	mnum_sge
;

78 
	mÃÁs
;

79 
ib_»g_wr
 
	m»g_wr
;

80 
ib_cqe
 
	m»g_cqe
;

81 
nvme_rdma_queue
 *
	mqueue
;

82 
sg_bË
 
	msg_bË
;

83 
sÿ‰”li¡
 
	mfœ¡_sgl
[];

86 
	envme_rdma_queue_æags
 {

87 
	mNVME_RDMA_Q_ALLOCATED
 = 0,

88 
	mNVME_RDMA_Q_LIVE
 = 1,

89 
	mNVME_RDMA_Q_TR_READY
 = 2,

92 
	snvme_rdma_queue
 {

93 
nvme_rdma_qe
 *
	mr¥_ršg
;

94 
	mqueue_size
;

95 
size_t
 
	mcmnd_ÿpsuË_Ën
;

96 
nvme_rdma_ù¾
 *
	mù¾
;

97 
nvme_rdma_deviû
 *
	mdeviû
;

98 
ib_cq
 *
	mib_cq
;

99 
ib_qp
 *
	mqp
;

101 
	mæags
;

102 
rdma_cm_id
 *
	mcm_id
;

103 
	mcm_”rÜ
;

104 
com¶‘iÚ
 
	mcm_dÚe
;

107 
	snvme_rdma_ù¾
 {

109 
nvme_rdma_queue
 *
	mqueues
;

112 
blk_mq_g_£t
 
	mg_£t
;

113 
wÜk_¡ruù
 
	m”r_wÜk
;

115 
nvme_rdma_qe
 
	masync_ev’t_sqe
;

117 
d–ayed_wÜk
 
	m»cÚÃù_wÜk
;

119 
li¡_h—d
 
	mli¡
;

121 
blk_mq_g_£t
 
	madmš_g_£t
;

122 
nvme_rdma_deviû
 *
	mdeviû
;

124 
u32
 
	mmax_ä_·ges
;

126 
sockaddr_¡Üage
 
	maddr
;

127 
sockaddr_¡Üage
 
	m¤c_addr
;

129 
nvme_ù¾
 
	mù¾
;

132 
šlše
 
nvme_rdma_ù¾
 *
	$to_rdma_ù¾
(
nvme_ù¾
 *
ù¾
)

134  
	`cÚš”_of
(
ù¾
, 
nvme_rdma_ù¾
, ctrl);

135 
	}
}

137 
LIST_HEAD
(
deviû_li¡
);

138 
DEFINE_MUTEX
(
deviû_li¡_mu‹x
);

140 
LIST_HEAD
(
nvme_rdma_ù¾_li¡
);

141 
DEFINE_MUTEX
(
nvme_rdma_ù¾_mu‹x
);

148 
boÞ
 
	g»gi¡”_®ways
 = 
Œue
;

149 
moduË_·¿m
(
»gi¡”_®ways
, 
boÞ
, 0444);

150 
MODULE_PARM_DESC
(
»gi¡”_®ways
,

153 
nvme_rdma_cm_hªdËr
(
rdma_cm_id
 *
cm_id
,

154 
rdma_cm_ev’t
 *
ev’t
);

155 
nvme_rdma_»cv_dÚe
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
);

157 #ifdeà
HAVE_BLK_MQ_TAG_SET_HAS_CONST_POS


158 cÚ¡ 
blk_mq_Ýs
 
	gnvme_rdma_mq_Ýs
;

159 cÚ¡ 
blk_mq_Ýs
 
	gnvme_rdma_admš_mq_Ýs
;

161 
blk_mq_Ýs
 
	gnvme_rdma_mq_Ýs
;

162 
blk_mq_Ýs
 
	gnvme_rdma_admš_mq_Ýs
;

166 
šlše
 
	$put_uÇligÃd_Ë24
(
u32
 
v®
, 
u8
 *
p
)

168 *
p
++ = 
v®
;

169 *
p
++ = 
v®
 >> 8;

170 *
p
++ = 
v®
 >> 16;

171 
	}
}

173 
šlše
 
	$nvme_rdma_queue_idx
(
nvme_rdma_queue
 *
queue
)

175  
queue
 - queue->
ù¾
->
queues
;

176 
	}
}

178 
šlše
 
size_t
 
	$nvme_rdma_šlše_d©a_size
(
nvme_rdma_queue
 *
queue
)

180  
queue
->
cmnd_ÿpsuË_Ën
 - (
nvme_commªd
);

181 
	}
}

183 
	$nvme_rdma_ä“_qe
(
ib_deviû
 *
ibdev
, 
nvme_rdma_qe
 *
qe
,

184 
size_t
 
ÿpsuË_size
, 
dma_d©a_dœeùiÚ
 
dœ
)

186 ià(
qe
->
d©a
) {

187 
	`ib_dma_unm­_sšgË
(
ibdev
, 
qe
->
dma
, 
ÿpsuË_size
, 
dœ
);

188 
	`kä“
(
qe
->
d©a
);

189 
qe
->
d©a
 = 
NULL
;

191 
	}
}

193 
	$nvme_rdma_®loc_qe
(
ib_deviû
 *
ibdev
, 
nvme_rdma_qe
 *
qe
,

194 
size_t
 
ÿpsuË_size
, 
dma_d©a_dœeùiÚ
 
dœ
)

196 
qe
->
d©a
 = 
	`kz®loc
(
ÿpsuË_size
, 
GFP_KERNEL
);

197 ià(!
qe
->
d©a
)

198  -
ENOMEM
;

200 
qe
->
dma
 = 
	`ib_dma_m­_sšgË
(
ibdev
, qe->
d©a
, 
ÿpsuË_size
, 
dœ
);

201 ià(
	`ib_dma_m­pšg_”rÜ
(
ibdev
, 
qe
->
dma
)) {

202 
	`kä“
(
qe
->
d©a
);

203  -
ENOMEM
;

207 
	}
}

209 
	$nvme_rdma_ä“_ršg
(
ib_deviû
 *
ibdev
,

210 
nvme_rdma_qe
 *
ršg
, 
size_t
 
ib_queue_size
,

211 
size_t
 
ÿpsuË_size
, 
dma_d©a_dœeùiÚ
 
dœ
)

213 
i
;

215 
i
 = 0; i < 
ib_queue_size
; i++)

216 
	`nvme_rdma_ä“_qe
(
ibdev
, &
ršg
[
i
], 
ÿpsuË_size
, 
dœ
);

217 
	`kä“
(
ršg
);

218 
	}
}

220 
nvme_rdma_qe
 *
	$nvme_rdma_®loc_ršg
(
ib_deviû
 *
ibdev
,

221 
size_t
 
ib_queue_size
, size_ˆ
ÿpsuË_size
,

222 
dma_d©a_dœeùiÚ
 
dœ
)

224 
nvme_rdma_qe
 *
ršg
;

225 
i
;

227 
ršg
 = 
	`kÿÎoc
(
ib_queue_size
, (
nvme_rdma_qe
), 
GFP_KERNEL
);

228 ià(!
ršg
)

229  
NULL
;

231 
i
 = 0; i < 
ib_queue_size
; i++) {

232 ià(
	`nvme_rdma_®loc_qe
(
ibdev
, &
ršg
[
i
], 
ÿpsuË_size
, 
dœ
))

233 
out_ä“_ršg
;

236  
ršg
;

238 
out_ä“_ršg
:

239 
	`nvme_rdma_ä“_ršg
(
ibdev
, 
ršg
, 
i
, 
ÿpsuË_size
, 
dœ
);

240  
NULL
;

241 
	}
}

243 
	$nvme_rdma_qp_ev’t
(
ib_ev’t
 *
ev’t
, *
cÚ‹xt
)

245 
	`´_debug
("QPƒvent %s (%d)\n",

246 
	`ib_ev’t_msg
(
ev’t
->event),ƒvent->event);

248 
	}
}

250 
	$nvme_rdma_wa™_fÜ_cm
(
nvme_rdma_queue
 *
queue
)

252 
	`wa™_fÜ_com¶‘iÚ_š‹¼u±ibË_timeout
(&
queue
->
cm_dÚe
,

253 
	`m£cs_to_jiff›s
(
NVME_RDMA_CONNECT_TIMEOUT_MS
) + 1);

254  
queue
->
cm_”rÜ
;

255 
	}
}

257 
	$nvme_rdma_ü—‹_qp
(
nvme_rdma_queue
 *
queue
, cÚ¡ 
çùÜ
)

259 
nvme_rdma_deviû
 *
dev
 = 
queue
->
deviû
;

260 
ib_qp_š™_©Œ
 
š™_©Œ
;

261 
»t
;

263 
	`mem£t
(&
š™_©Œ
, 0, (init_attr));

264 
š™_©Œ
.
ev’t_hªdËr
 = 
nvme_rdma_qp_ev’t
;

266 
š™_©Œ
.
ÿp
.
max_£nd_wr
 = 
çùÜ
 * 
queue
->
queue_size
 + 1;

268 
š™_©Œ
.
ÿp
.
max_»cv_wr
 = 
queue
->
queue_size
 + 1;

269 
š™_©Œ
.
ÿp
.
max_»cv_sge
 = 1;

270 
š™_©Œ
.
ÿp
.
max_£nd_sge
 = 1 + 
NVME_RDMA_MAX_INLINE_SEGMENTS
;

271 
š™_©Œ
.
sq_sig_ty³
 = 
IB_SIGNAL_REQ_WR
;

272 
š™_©Œ
.
qp_ty³
 = 
IB_QPT_RC
;

273 
š™_©Œ
.
£nd_cq
 = 
queue
->
ib_cq
;

274 
š™_©Œ
.
»cv_cq
 = 
queue
->
ib_cq
;

276 
»t
 = 
	`rdma_ü—‹_qp
(
queue
->
cm_id
, 
dev
->
pd
, &
š™_©Œ
);

278 
queue
->
qp
 = queue->
cm_id
->qp;

279  
»t
;

280 
	}
}

282 #ifdeà
HAVE_BLK_MQ_OPS_EXIT_REQUEST_HAS_3_PARAMS


283 
	$nvme_rdma_ex™_»que¡
(
blk_mq_g_£t
 *
£t
,

284 
»que¡
 *
rq
, 
hùx_idx
)

286 
	$__nvme_rdma_ex™_»que¡
(
nvme_rdma_ù¾
 *
ù¾
,

287 
»que¡
 *
rq
, 
queue_idx
)

290 #ifdeà
HAVE_BLK_MQ_OPS_EXIT_REQUEST_HAS_3_PARAMS


291 
nvme_rdma_ù¾
 *
ù¾
 = 
£t
->
driv”_d©a
;

293 
nvme_rdma_»que¡
 *
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

294 #ifdeà
HAVE_BLK_MQ_OPS_EXIT_REQUEST_HAS_3_PARAMS


295 
queue_idx
 = (
£t
 =ð&
ù¾
->
g_£t
è? 
hùx_idx
 + 1 : 0;

297 
nvme_rdma_queue
 *
queue
 = &
ù¾
->
queues
[
queue_idx
];

298 
nvme_rdma_deviû
 *
dev
 = 
queue
->
deviû
;

300 
	`nvme_rdma_ä“_qe
(
dev
->dev, &
»q
->
sqe
, (
nvme_commªd
),

301 
DMA_TO_DEVICE
);

302 
	}
}

303 #iâdeà
HAVE_BLK_MQ_OPS_EXIT_REQUEST_HAS_3_PARAMS


304 
	$nvme_rdma_ex™_»que¡
(*
d©a
, 
»que¡
 *
rq
,

305 
hùx_idx
, 
rq_idx
)

307 
	`__nvme_rdma_ex™_»que¡
(
d©a
, 
rq
, 
hùx_idx
 + 1);

308 
	}
}

310 
	$nvme_rdma_ex™_admš_»que¡
(*
d©a
, 
»que¡
 *
rq
,

311 
hùx_idx
, 
rq_idx
)

313 
	`__nvme_rdma_ex™_»que¡
(
d©a
, 
rq
, 0);

314 
	}
}

317 #ifdeà
HAVE_BLK_MQ_OPS_INIT_REQUEST_HAS_4_PARAMS


318 
	$nvme_rdma_š™_»que¡
(
blk_mq_g_£t
 *
£t
,

319 
»que¡
 *
rq
, 
hùx_idx
,

320 
numa_node
)

322 
	$__nvme_rdma_š™_»que¡
(
nvme_rdma_ù¾
 *
ù¾
,

323 
»que¡
 *
rq
, 
queue_idx
)

326 #ifdeà
HAVE_BLK_MQ_OPS_INIT_REQUEST_HAS_4_PARAMS


327 
nvme_rdma_ù¾
 *
ù¾
 = 
£t
->
driv”_d©a
;

329 
nvme_rdma_»que¡
 *
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

330 #ifdeà
HAVE_BLK_MQ_OPS_INIT_REQUEST_HAS_4_PARAMS


331 
queue_idx
 = (
£t
 =ð&
ù¾
->
g_£t
è? 
hùx_idx
 + 1 : 0;

333 
nvme_rdma_queue
 *
queue
 = &
ù¾
->
queues
[
queue_idx
];

334 
nvme_rdma_deviû
 *
dev
 = 
queue
->
deviû
;

335 
ib_deviû
 *
ibdev
 = 
dev
->dev;

336 
»t
;

338 
»t
 = 
	`nvme_rdma_®loc_qe
(
ibdev
, &
»q
->
sqe
, (
nvme_commªd
),

339 
DMA_TO_DEVICE
);

340 ià(
»t
)

341  
»t
;

343 
»q
->
queue
 = queue;

346 
	}
}

347 #iâdeà
HAVE_BLK_MQ_OPS_INIT_REQUEST_HAS_4_PARAMS


348 
	$nvme_rdma_š™_»que¡
(*
d©a
, 
»que¡
 *
rq
,

349 
hùx_idx
, 
rq_idx
,

350 
numa_node
)

352  
	`__nvme_rdma_š™_»que¡
(
d©a
, 
rq
, 
hùx_idx
 + 1);

353 
	}
}

355 
	$nvme_rdma_š™_admš_»que¡
(*
d©a
, 
»que¡
 *
rq
,

356 
hùx_idx
, 
rq_idx
,

357 
numa_node
)

359  
	`__nvme_rdma_š™_»que¡
(
d©a
, 
rq
, 0);

360 
	}
}

363 
	$nvme_rdma_š™_hùx
(
blk_mq_hw_ùx
 *
hùx
, *
d©a
,

364 
hùx_idx
)

366 
nvme_rdma_ù¾
 *
ù¾
 = 
d©a
;

367 
nvme_rdma_queue
 *
queue
 = &
ù¾
->
queues
[
hùx_idx
 + 1];

369 
	`BUG_ON
(
hùx_idx
 >ð
ù¾
->ù¾.
queue_couÁ
);

371 
hùx
->
driv”_d©a
 = 
queue
;

373 
	}
}

375 
	$nvme_rdma_š™_admš_hùx
(
blk_mq_hw_ùx
 *
hùx
, *
d©a
,

376 
hùx_idx
)

378 
nvme_rdma_ù¾
 *
ù¾
 = 
d©a
;

379 
nvme_rdma_queue
 *
queue
 = &
ù¾
->
queues
[0];

381 
	`BUG_ON
(
hùx_idx
 != 0);

383 
hùx
->
driv”_d©a
 = 
queue
;

385 
	}
}

387 
	$nvme_rdma_ä“_dev
(
k»f
 *
»f
)

389 
nvme_rdma_deviû
 *
ndev
 =

390 
	`cÚš”_of
(
»f
, 
nvme_rdma_deviû
,„ef);

392 
	`mu‹x_lock
(&
deviû_li¡_mu‹x
);

393 
	`li¡_d–
(&
ndev
->
’Œy
);

394 
	`mu‹x_uÆock
(&
deviû_li¡_mu‹x
);

396 
	`ib_d—Îoc_pd
(
ndev
->
pd
);

397 
	`kä“
(
ndev
);

398 
	}
}

400 
	$nvme_rdma_dev_put
(
nvme_rdma_deviû
 *
dev
)

402 
	`k»f_put
(&
dev
->
»f
, 
nvme_rdma_ä“_dev
);

403 
	}
}

405 
	$nvme_rdma_dev_g‘
(
nvme_rdma_deviû
 *
dev
)

407  
	`k»f_g‘_uÆess_z”o
(&
dev
->
»f
);

408 
	}
}

410 
nvme_rdma_deviû
 *

411 
	$nvme_rdma_fšd_g‘_deviû
(
rdma_cm_id
 *
cm_id
)

413 
nvme_rdma_deviû
 *
ndev
;

415 
	`mu‹x_lock
(&
deviû_li¡_mu‹x
);

416 
	`li¡_fÜ_—ch_’Œy
(
ndev
, &
deviû_li¡
, 
’Œy
) {

417 ià(
ndev
->
dev
->
node_guid
 =ð
cm_id
->
deviû
->node_guid &&

418 
	`nvme_rdma_dev_g‘
(
ndev
))

419 
out_uÆock
;

422 
ndev
 = 
	`kz®loc
((*ndev), 
GFP_KERNEL
);

423 ià(!
ndev
)

424 
out_”r
;

426 
ndev
->
dev
 = 
cm_id
->
deviû
;

427 
	`k»f_š™
(&
ndev
->
»f
);

429 
ndev
->
pd
 = 
	`ib_®loc_pd
Òdev->
dev
,

430 
»gi¡”_®ways
 ? 0 : 
IB_PD_UNSAFE_GLOBAL_RKEY
);

431 ià(
	`IS_ERR
(
ndev
->
pd
))

432 
out_ä“_dev
;

434 ià(!(
ndev
->
dev
->
©Œs
.
deviû_ÿp_æags
 &

435 
IB_DEVICE_MEM_MGT_EXTENSIONS
)) {

436 
	`dev_”r
(&
ndev
->
dev
->dev,

438 
out_ä“_pd
;

441 
	`li¡_add
(&
ndev
->
’Œy
, &
deviû_li¡
);

442 
out_uÆock
:

443 
	`mu‹x_uÆock
(&
deviû_li¡_mu‹x
);

444  
ndev
;

446 
out_ä“_pd
:

447 
	`ib_d—Îoc_pd
(
ndev
->
pd
);

448 
out_ä“_dev
:

449 
	`kä“
(
ndev
);

450 
out_”r
:

451 
	`mu‹x_uÆock
(&
deviû_li¡_mu‹x
);

452  
NULL
;

453 
	}
}

455 
	$nvme_rdma_de¡roy_queue_ib
(
nvme_rdma_queue
 *
queue
)

457 
nvme_rdma_deviû
 *
dev
;

458 
ib_deviû
 *
ibdev
;

460 ià(!
	`‹¡_ªd_þ—r_b™
(
NVME_RDMA_Q_TR_READY
, &
queue
->
æags
))

463 
dev
 = 
queue
->
deviû
;

464 
ibdev
 = 
dev
->dev;

466 
	`ib_mr_poÞ_de¡roy
(
queue
->
qp
, &queue->qp->
rdma_mrs
);

473 
	`ib_de¡roy_qp
(
queue
->
qp
);

474 
	`ib_ä“_cq
(
queue
->
ib_cq
);

476 
	`nvme_rdma_ä“_ršg
(
ibdev
, 
queue
->
r¥_ršg
, queue->
queue_size
,

477 (
nvme_com¶‘iÚ
), 
DMA_FROM_DEVICE
);

479 
	`nvme_rdma_dev_put
(
dev
);

480 
	}
}

482 
	$nvme_rdma_g‘_max_ä_·ges
(
ib_deviû
 *
ibdev
)

484  
	`mš_t
(
u32
, 
NVME_RDMA_MAX_SEGMENTS
,

485 
ibdev
->
©Œs
.
max_ç¡_»g_·ge_li¡_Ën
);

486 
	}
}

488 
	$nvme_rdma_ü—‹_queue_ib
(
nvme_rdma_queue
 *
queue
)

490 
ib_deviû
 *
ibdev
;

491 cÚ¡ 
£nd_wr_çùÜ
 = 3;

492 cÚ¡ 
cq_çùÜ
 = 
£nd_wr_çùÜ
 + 1;

493 
comp_veùÜ
, 
idx
 = 
	`nvme_rdma_queue_idx
(
queue
);

494 
»t
;

495 #iâdeà
HAVE_BLK_QUEUE_VIRT_BOUNDARY


496 
ib_mr_ty³
 
mr_ty³
;

499 
queue
->
deviû
 = 
	`nvme_rdma_fšd_g‘_deviû
(queue->
cm_id
);

500 ià(!
queue
->
deviû
) {

501 
	`dev_”r
(
queue
->
cm_id
->
deviû
->
dev
.
·»Á
,

503  -
ECONNREFUSED
;

505 
ibdev
 = 
queue
->
deviû
->
dev
;

507 #ifdeà
HAVE_BLK_MQ_ALLOC_REQUEST_HCTX


512 
comp_veùÜ
 = 
idx
 == 0 ? idx : idx - 1;

514 
comp_veùÜ
 = 
queue
->
ù¾
->ù¾.
š¡ªû
 % 
ibdev
->
num_comp_veùÜs
;

518 
queue
->
ib_cq
 = 
	`ib_®loc_cq
(
ibdev
, queue,

519 
cq_çùÜ
 * 
queue
->
queue_size
 + 1,

520 
comp_veùÜ
, 
IB_POLL_SOFTIRQ
);

521 ià(
	`IS_ERR
(
queue
->
ib_cq
)) {

522 
»t
 = 
	`PTR_ERR
(
queue
->
ib_cq
);

523 
out_put_dev
;

526 
»t
 = 
	`nvme_rdma_ü—‹_qp
(
queue
, 
£nd_wr_çùÜ
);

527 ià(
»t
)

528 
out_de¡roy_ib_cq
;

530 
queue
->
r¥_ršg
 = 
	`nvme_rdma_®loc_ršg
(
ibdev
, queue->
queue_size
,

531 (
nvme_com¶‘iÚ
), 
DMA_FROM_DEVICE
);

532 ià(!
queue
->
r¥_ršg
) {

533 
»t
 = -
ENOMEM
;

534 
out_de¡roy_qp
;

537 #iâdeà
HAVE_BLK_QUEUE_VIRT_BOUNDARY


538 ià(
ibdev
->
©Œs
.
deviû_ÿp_æags
 & 
IB_DEVICE_SG_GAPS_REG
)

539 
mr_ty³
 = 
IB_MR_TYPE_SG_GAPS
;

541 
mr_ty³
 = 
IB_MR_TYPE_MEM_REG
;

544 
»t
 = 
	`ib_mr_poÞ_š™
(
queue
->
qp
, &queue->qp->
rdma_mrs
,

545 
queue
->
queue_size
,

546 #ifdeà
HAVE_BLK_QUEUE_VIRT_BOUNDARY


547 
IB_MR_TYPE_MEM_REG
,

549 
mr_ty³
,

551 
	`nvme_rdma_g‘_max_ä_·ges
(
ibdev
));

552 ià(
»t
) {

553 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

555 
queue
->
queue_size
, 
idx
);

556 
out_de¡roy_ršg
;

559 
	`£t_b™
(
NVME_RDMA_Q_TR_READY
, &
queue
->
æags
);

563 
out_de¡roy_ršg
:

564 
	`nvme_rdma_ä“_ršg
(
ibdev
, 
queue
->
r¥_ršg
, queue->
queue_size
,

565 (
nvme_com¶‘iÚ
), 
DMA_FROM_DEVICE
);

566 
out_de¡roy_qp
:

567 
	`rdma_de¡roy_qp
(
queue
->
cm_id
);

568 
out_de¡roy_ib_cq
:

569 
	`ib_ä“_cq
(
queue
->
ib_cq
);

570 
out_put_dev
:

571 
	`nvme_rdma_dev_put
(
queue
->
deviû
);

572  
»t
;

573 
	}
}

575 
	$nvme_rdma_®loc_queue
(
nvme_rdma_ù¾
 *
ù¾
,

576 
idx
, 
size_t
 
queue_size
)

578 
nvme_rdma_queue
 *
queue
;

579 
sockaddr
 *
¤c_addr
 = 
NULL
;

580 
»t
;

582 
queue
 = &
ù¾
->
queues
[
idx
];

583 
queue
->
ù¾
 = ctrl;

584 
	`š™_com¶‘iÚ
(&
queue
->
cm_dÚe
);

586 ià(
idx
 > 0)

587 
queue
->
cmnd_ÿpsuË_Ën
 = 
ù¾
->ù¾.
ioccsz
 * 16;

589 
queue
->
cmnd_ÿpsuË_Ën
 = (
nvme_commªd
);

591 
queue
->
queue_size
 = queue_size;

593 
queue
->
cm_id
 = 
	`rdma_ü—‹_id
(&
š™_Ãt
, 
nvme_rdma_cm_hªdËr
, queue,

594 
RDMA_PS_TCP
, 
IB_QPT_RC
);

595 ià(
	`IS_ERR
(
queue
->
cm_id
)) {

596 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

597 "çžedØü—‹ CM ID: %ld\n", 
	`PTR_ERR
(
queue
->
cm_id
));

598  
	`PTR_ERR
(
queue
->
cm_id
);

601 ià(
ù¾
->ù¾.
Ýts
->
mask
 & 
NVMF_OPT_HOST_TRADDR
)

602 
¤c_addr
 = (
sockaddr
 *)&
ù¾
->src_addr;

604 
queue
->
cm_”rÜ
 = -
ETIMEDOUT
;

605 
»t
 = 
	`rdma_»sÞve_addr
(
queue
->
cm_id
, 
¤c_addr
,

606 (
sockaddr
 *)&
ù¾
->
addr
,

607 
NVME_RDMA_CONNECT_TIMEOUT_MS
);

608 ià(
»t
) {

609 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

610 "rdma_»sÞve_add¸çžed (%d).\n", 
»t
);

611 
out_de¡roy_cm_id
;

614 
»t
 = 
	`nvme_rdma_wa™_fÜ_cm
(
queue
);

615 ià(
»t
) {

616 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

617 "rdm¨cÚÃùiÚƒ¡ablishm’ˆçžed (%d)\n", 
»t
);

618 
out_de¡roy_cm_id
;

621 
	`£t_b™
(
NVME_RDMA_Q_ALLOCATED
, &
queue
->
æags
);

625 
out_de¡roy_cm_id
:

626 
	`rdma_de¡roy_id
(
queue
->
cm_id
);

627 
	`nvme_rdma_de¡roy_queue_ib
(
queue
);

628  
»t
;

629 
	}
}

631 
	$nvme_rdma_¡Ý_queue
(
nvme_rdma_queue
 *
queue
)

633 ià(!
	`‹¡_ªd_þ—r_b™
(
NVME_RDMA_Q_LIVE
, &
queue
->
æags
))

636 
	`rdma_discÚÃù
(
queue
->
cm_id
);

637 
	`ib_d¿š_qp
(
queue
->
qp
);

638 
	}
}

640 
	$nvme_rdma_ä“_queue
(
nvme_rdma_queue
 *
queue
)

642 ià(!
	`‹¡_ªd_þ—r_b™
(
NVME_RDMA_Q_ALLOCATED
, &
queue
->
æags
))

645 
	`nvme_rdma_de¡roy_queue_ib
(
queue
);

646 
	`rdma_de¡roy_id
(
queue
->
cm_id
);

647 
	}
}

649 
	$nvme_rdma_ä“_io_queues
(
nvme_rdma_ù¾
 *
ù¾
)

651 
i
;

653 
i
 = 1; i < 
ù¾
->ù¾.
queue_couÁ
; i++)

654 
	`nvme_rdma_ä“_queue
(&
ù¾
->
queues
[
i
]);

655 
	}
}

657 
	$nvme_rdma_¡Ý_io_queues
(
nvme_rdma_ù¾
 *
ù¾
)

659 
i
;

661 
i
 = 1; i < 
ù¾
->ù¾.
queue_couÁ
; i++)

662 
	`nvme_rdma_¡Ý_queue
(&
ù¾
->
queues
[
i
]);

663 
	}
}

665 
	$nvme_rdma_¡¬t_queue
(
nvme_rdma_ù¾
 *
ù¾
, 
idx
)

667 
»t
;

669 ià(
idx
)

670 
»t
 = 
	`nvmf_cÚÃù_io_queue
(&
ù¾
->ù¾, 
idx
);

672 
»t
 = 
	`nvmf_cÚÃù_admš_queue
(&
ù¾
->ctrl);

674 ià(!
»t
)

675 
	`£t_b™
(
NVME_RDMA_Q_LIVE
, &
ù¾
->
queues
[
idx
].
æags
);

677 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

678 "çžedØcÚÃù queue: %d„‘=%d\n", 
idx
, 
»t
);

679  
»t
;

680 
	}
}

682 
	$nvme_rdma_¡¬t_io_queues
(
nvme_rdma_ù¾
 *
ù¾
)

684 
i
, 
»t
 = 0;

686 
i
 = 1; i < 
ù¾
->ù¾.
queue_couÁ
; i++) {

687 
»t
 = 
	`nvme_rdma_¡¬t_queue
(
ù¾
, 
i
);

688 ià(
»t
)

689 
out_¡Ý_queues
;

694 
out_¡Ý_queues
:

695 
i
--; i >= 1; i--)

696 
	`nvme_rdma_¡Ý_queue
(&
ù¾
->
queues
[
i
]);

697  
»t
;

698 
	}
}

700 
	$nvme_rdma_®loc_io_queues
(
nvme_rdma_ù¾
 *
ù¾
)

702 
nvmf_ù¾_ÝtiÚs
 *
Ýts
 = 
ù¾
->ctrl.opts;

703 
ib_deviû
 *
ibdev
 = 
ù¾
->
deviû
->
dev
;

704 
Ä_io_queues
;

705 
i
, 
»t
;

707 
Ä_io_queues
 = 
	`mš
(
Ýts
->Ä_io_queues, 
	`num_Úlše_ýus
());

714 
Ä_io_queues
 = 
	`mš_t
(,‚r_io_queues,

715 
ibdev
->
num_comp_veùÜs
);

717 
»t
 = 
	`nvme_£t_queue_couÁ
(&
ù¾
->ù¾, &
Ä_io_queues
);

718 ià(
»t
)

719  
»t
;

721 
ù¾
->ù¾.
queue_couÁ
 = 
Ä_io_queues
 + 1;

722 ià(
ù¾
->ù¾.
queue_couÁ
 < 2)

725 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

726 "ü—tšg %d I/O queues.\n", 
Ä_io_queues
);

728 
i
 = 1; i < 
ù¾
->ù¾.
queue_couÁ
; i++) {

729 
»t
 = 
	`nvme_rdma_®loc_queue
(
ù¾
, 
i
,

730 
ù¾
->ù¾.
sqsize
 + 1);

731 ià(
»t
)

732 
out_ä“_queues
;

737 
out_ä“_queues
:

738 
i
--; i >= 1; i--)

739 
	`nvme_rdma_ä“_queue
(&
ù¾
->
queues
[
i
]);

741  
»t
;

742 
	}
}

744 
	$nvme_rdma_ä“_g£t
(
nvme_ù¾
 *
nù¾
,

745 
blk_mq_g_£t
 *
£t
)

747 
nvme_rdma_ù¾
 *
ù¾
 = 
	`to_rdma_ù¾
(
nù¾
);

749 
	`blk_mq_ä“_g_£t
(
£t
);

750 
	`nvme_rdma_dev_put
(
ù¾
->
deviû
);

751 
	}
}

753 
blk_mq_g_£t
 *
	$nvme_rdma_®loc_g£t
(
nvme_ù¾
 *
nù¾
,

754 
boÞ
 
admš
)

756 
nvme_rdma_ù¾
 *
ù¾
 = 
	`to_rdma_ù¾
(
nù¾
);

757 
blk_mq_g_£t
 *
£t
;

758 
»t
;

760 ià(
admš
) {

761 
£t
 = &
ù¾
->
admš_g_£t
;

762 
	`mem£t
(
£t
, 0, (*set));

763 
£t
->
Ýs
 = &
nvme_rdma_admš_mq_Ýs
;

764 
£t
->
queue_d•th
 = 
NVME_AQ_MQ_TAG_DEPTH
;

765 
£t
->
»£rved_gs
 = 2;

766 
£t
->
numa_node
 = 
NUMA_NO_NODE
;

767 #ifdeà
HAVE_SCSI_MAX_SG_SEGMENTS


768 
£t
->
cmd_size
 = (
nvme_rdma_»que¡
) +

769 
SCSI_MAX_SG_SEGMENTS
 * (
sÿ‰”li¡
);

771 
£t
->
cmd_size
 = (
nvme_rdma_»que¡
) +

772 
SG_CHUNK_SIZE
 * (
sÿ‰”li¡
);

774 
£t
->
driv”_d©a
 = 
ù¾
;

775 
£t
->
Ä_hw_queues
 = 1;

776 
£t
->
timeout
 = 
ADMIN_TIMEOUT
;

777 #ifdeà
HAVE_BLK_MQ_F_NO_SCHED


778 
£t
->
æags
 = 
BLK_MQ_F_NO_SCHED
;

781 
£t
 = &
ù¾
->
g_£t
;

782 
	`mem£t
(
£t
, 0, (*set));

783 
£t
->
Ýs
 = &
nvme_rdma_mq_Ýs
;

784 
£t
->
queue_d•th
 = 
nù¾
->
Ýts
->
queue_size
;

785 
£t
->
»£rved_gs
 = 1;

786 
£t
->
numa_node
 = 
NUMA_NO_NODE
;

787 
£t
->
æags
 = 
BLK_MQ_F_SHOULD_MERGE
;

788 #ifdeà
HAVE_SCSI_MAX_SG_SEGMENTS


789 
£t
->
cmd_size
 = (
nvme_rdma_»que¡
) +

790 
SCSI_MAX_SG_SEGMENTS
 * (
sÿ‰”li¡
);

792 
£t
->
cmd_size
 = (
nvme_rdma_»que¡
) +

793 
SG_CHUNK_SIZE
 * (
sÿ‰”li¡
);

795 
£t
->
driv”_d©a
 = 
ù¾
;

796 
£t
->
Ä_hw_queues
 = 
nù¾
->
queue_couÁ
 - 1;

797 
£t
->
timeout
 = 
NVME_IO_TIMEOUT
;

800 
»t
 = 
	`blk_mq_®loc_g_£t
(
£t
);

801 ià(
»t
)

802 
out
;

808 
»t
 = 
	`nvme_rdma_dev_g‘
(
ù¾
->
deviû
);

809 ià(!
»t
) {

810 
»t
 = -
EINVAL
;

811 
out_ä“_g£t
;

814  
£t
;

816 
out_ä“_g£t
:

817 
	`blk_mq_ä“_g_£t
(
£t
);

818 
out
:

819  
	`ERR_PTR
(
»t
);

820 
	}
}

822 
	$nvme_rdma_de¡roy_admš_queue
(
nvme_rdma_ù¾
 *
ù¾
,

823 
boÞ
 
»move
)

825 ià(
»move
) {

826 
	`blk_þ—nup_queue
(
ù¾
->ù¾.
admš_q
);

827 
	`nvme_rdma_ä“_g£t
(&
ù¾
->ù¾, cŒl->ù¾.
admš_g£t
);

829 
	`nvme_rdma_ä“_qe
(
ù¾
->
deviû
->
dev
, &ù¾->
async_ev’t_sqe
,

830 (
nvme_commªd
), 
DMA_TO_DEVICE
);

831 
	`nvme_rdma_ä“_queue
(&
ù¾
->
queues
[0]);

832 
	}
}

834 
	$nvme_rdma_cÚfigu»_admš_queue
(
nvme_rdma_ù¾
 *
ù¾
,

835 
boÞ
 
Ãw
)

837 
”rÜ
;

839 
”rÜ
 = 
	`nvme_rdma_®loc_queue
(
ù¾
, 0, 
NVME_AQ_DEPTH
);

840 ià(
”rÜ
)

841  
”rÜ
;

843 
ù¾
->
deviû
 = cŒl->
queues
[0].device;

845 
ù¾
->
max_ä_·ges
 = 
	`nvme_rdma_g‘_max_ä_·ges
(ù¾->
deviû
->
dev
);

847 
”rÜ
 = 
	`nvme_rdma_®loc_qe
(
ù¾
->
deviû
->
dev
, &ù¾->
async_ev’t_sqe
,

848 (
nvme_commªd
), 
DMA_TO_DEVICE
);

849 ià(
”rÜ
)

850 
out_ä“_queue
;

852 ià(
Ãw
) {

853 
ù¾
->ù¾.
admš_g£t
 = 
	`nvme_rdma_®loc_g£t
(&ù¾->ù¾, 
Œue
);

854 ià(
	`IS_ERR
(
ù¾
->ù¾.
admš_g£t
)) {

855 
”rÜ
 = 
	`PTR_ERR
(
ù¾
->ù¾.
admš_g£t
);

856 
out_ä“_async_qe
;

859 
ù¾
->ù¾.
admš_q
 = 
	`blk_mq_š™_queue
(&ù¾->
admš_g_£t
);

860 ià(
	`IS_ERR
(
ù¾
->ù¾.
admš_q
)) {

861 
”rÜ
 = 
	`PTR_ERR
(
ù¾
->ù¾.
admš_q
);

862 
out_ä“_g£t
;

866 
”rÜ
 = 
	`nvme_rdma_¡¬t_queue
(
ù¾
, 0);

867 ià(
”rÜ
)

868 
out_þ—nup_queue
;

870 
”rÜ
 = 
ù¾
->ù¾.
Ýs
->
	`»g_»ad64
(&ù¾->ù¾, 
NVME_REG_CAP
,

871 &
ù¾
->ù¾.
ÿp
);

872 ià(
”rÜ
) {

873 
	`dev_”r
(
ù¾
->ù¾.
deviû
,

875 
out_¡Ý_queue
;

878 
ù¾
->ù¾.
sqsize
 =

879 
	`mš_t
(, 
	`NVME_CAP_MQES
(
ù¾
->ù¾.
ÿp
), cŒl->ù¾.
sqsize
);

881 #iâdeà
HAVE_BLK_QUEUE_VIRT_BOUNDARY


882 ià(
ù¾
->
deviû
->
dev
->
©Œs
.
deviû_ÿp_æags
 & 
IB_DEVICE_SG_GAPS_REG
)

883 
ù¾
->ù¾.
sg_g­s_suµÜt
 = 
Œue
;

885 
”rÜ
 = 
	`nvme_’abË_ù¾
(&
ù¾
->ù¾, cŒl->ù¾.
ÿp
);

886 ià(
”rÜ
)

887 
out_¡Ý_queue
;

889 
ù¾
->ù¾.
max_hw_£ùÜs
 =

890 (
ù¾
->
max_ä_·ges
 - 1è<< (
	`žog2
(
SZ_4K
) - 9);

892 
”rÜ
 = 
	`nvme_š™_id’tify
(&
ù¾
->ctrl);

893 ià(
”rÜ
)

894 
out_¡Ý_queue
;

898 
out_¡Ý_queue
:

899 
	`nvme_rdma_¡Ý_queue
(&
ù¾
->
queues
[0]);

900 
out_þ—nup_queue
:

901 ià(
Ãw
)

902 
	`blk_þ—nup_queue
(
ù¾
->ù¾.
admš_q
);

903 
out_ä“_g£t
:

904 ià(
Ãw
)

905 
	`nvme_rdma_ä“_g£t
(&
ù¾
->ù¾, cŒl->ù¾.
admš_g£t
);

906 
out_ä“_async_qe
:

907 
	`nvme_rdma_ä“_qe
(
ù¾
->
deviû
->
dev
, &ù¾->
async_ev’t_sqe
,

908 (
nvme_commªd
), 
DMA_TO_DEVICE
);

909 
out_ä“_queue
:

910 
	`nvme_rdma_ä“_queue
(&
ù¾
->
queues
[0]);

911  
”rÜ
;

912 
	}
}

914 
	$nvme_rdma_de¡roy_io_queues
(
nvme_rdma_ù¾
 *
ù¾
,

915 
boÞ
 
»move
)

917 ià(
»move
) {

918 
	`blk_þ—nup_queue
(
ù¾
->ù¾.
cÚÃù_q
);

919 
	`nvme_rdma_ä“_g£t
(&
ù¾
->ù¾, cŒl->ù¾.
g£t
);

921 
	`nvme_rdma_ä“_io_queues
(
ù¾
);

922 
	}
}

924 
	$nvme_rdma_cÚfigu»_io_queues
(
nvme_rdma_ù¾
 *
ù¾
, 
boÞ
 
Ãw
)

926 
»t
;

928 
»t
 = 
	`nvme_rdma_®loc_io_queues
(
ù¾
);

929 ià(
»t
)

930  
»t
;

932 ià(
Ãw
) {

933 
ù¾
->ù¾.
g£t
 = 
	`nvme_rdma_®loc_g£t
(&ù¾->ù¾, 
çl£
);

934 ià(
	`IS_ERR
(
ù¾
->ù¾.
g£t
)) {

935 
»t
 = 
	`PTR_ERR
(
ù¾
->ù¾.
g£t
);

936 
out_ä“_io_queues
;

939 
ù¾
->ù¾.
cÚÃù_q
 = 
	`blk_mq_š™_queue
(&ù¾->
g_£t
);

940 ià(
	`IS_ERR
(
ù¾
->ù¾.
cÚÃù_q
)) {

941 
»t
 = 
	`PTR_ERR
(
ù¾
->ù¾.
cÚÃù_q
);

942 
out_ä“_g_£t
;

945 #ifdeà
HAVE_BLK_MQ_UPDATE_NR_HW_QUEUES


946 
	`blk_mq_upd©e_Ä_hw_queues
(&
ù¾
->
g_£t
,

947 
ù¾
->ù¾.
queue_couÁ
 - 1);

951 
»t
 = 
	`nvme_rdma_¡¬t_io_queues
(
ù¾
);

952 ià(
»t
)

953 
out_þ—nup_cÚÃù_q
;

957 
out_þ—nup_cÚÃù_q
:

958 ià(
Ãw
)

959 
	`blk_þ—nup_queue
(
ù¾
->ù¾.
cÚÃù_q
);

960 
out_ä“_g_£t
:

961 ià(
Ãw
)

962 
	`nvme_rdma_ä“_g£t
(&
ù¾
->ù¾, cŒl->ù¾.
g£t
);

963 
out_ä“_io_queues
:

964 
	`nvme_rdma_ä“_io_queues
(
ù¾
);

965  
»t
;

966 
	}
}

968 
	$nvme_rdma_¡Ý_ù¾
(
nvme_ù¾
 *
nù¾
)

970 
nvme_rdma_ù¾
 *
ù¾
 = 
	`to_rdma_ù¾
(
nù¾
);

972 
	`ÿnûl_wÜk_sync
(&
ù¾
->
”r_wÜk
);

973 
	`ÿnûl_d–ayed_wÜk_sync
(&
ù¾
->
»cÚÃù_wÜk
);

974 
	}
}

976 
	$nvme_rdma_ä“_ù¾
(
nvme_ù¾
 *
nù¾
)

978 
nvme_rdma_ù¾
 *
ù¾
 = 
	`to_rdma_ù¾
(
nù¾
);

980 ià(
	`li¡_em±y
(&
ù¾
->
li¡
))

981 
ä“_ù¾
;

983 
	`mu‹x_lock
(&
nvme_rdma_ù¾_mu‹x
);

984 
	`li¡_d–
(&
ù¾
->
li¡
);

985 
	`mu‹x_uÆock
(&
nvme_rdma_ù¾_mu‹x
);

987 
	`nvmf_ä“_ÝtiÚs
(
nù¾
->
Ýts
);

988 
ä“_ù¾
:

989 
	`kä“
(
ù¾
->
queues
);

990 
	`kä“
(
ù¾
);

991 
	}
}

993 
	$nvme_rdma_»cÚÃù_Ü_»move
(
nvme_rdma_ù¾
 *
ù¾
)

996 ià(
ù¾
->ù¾.
¡©e
 !ð
NVME_CTRL_CONNECTING
) {

997 
	`WARN_ON_ONCE
(
ù¾
->ù¾.
¡©e
 =ð
NVME_CTRL_NEW
 ||

998 
ù¾
->ù¾.
¡©e
 =ð
NVME_CTRL_LIVE
);

1002 ià(
	`nvmf_should_»cÚÃù
(&
ù¾
->ctrl)) {

1003 
	`dev_šfo
(
ù¾
->ù¾.
deviû
, "Reconnecting in %d seconds...\n",

1004 
ù¾
->ù¾.
Ýts
->
»cÚÃù_d–ay
);

1005 
	`queue_d–ayed_wÜk
(
nvme_wq
, &
ù¾
->
»cÚÃù_wÜk
,

1006 
ù¾
->ù¾.
Ýts
->
»cÚÃù_d–ay
 * 
HZ
);

1008 
	`nvme_d–‘e_ù¾
(&
ù¾
->ctrl);

1010 
	}
}

1012 
	$nvme_rdma_»cÚÃù_ù¾_wÜk
(
wÜk_¡ruù
 *
wÜk
)

1014 
nvme_rdma_ù¾
 *
ù¾
 = 
	`cÚš”_of
(
	`to_d–ayed_wÜk
(
wÜk
),

1015 
nvme_rdma_ù¾
, 
»cÚÃù_wÜk
);

1016 
boÞ
 
chªged
;

1017 
»t
;

1019 ++
ù¾
->ù¾.
Ä_»cÚÃùs
;

1021 
»t
 = 
	`nvme_rdma_cÚfigu»_admš_queue
(
ù¾
, 
çl£
);

1022 ià(
»t
)

1023 
»queue
;

1025 ià(
ù¾
->ù¾.
queue_couÁ
 > 1) {

1026 
»t
 = 
	`nvme_rdma_cÚfigu»_io_queues
(
ù¾
, 
çl£
);

1027 ià(
»t
)

1028 
de¡roy_admš
;

1031 
chªged
 = 
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_LIVE
);

1032 ià(!
chªged
) {

1034 
	`WARN_ON_ONCE
(
ù¾
->ù¾.
¡©e
 !ð
NVME_CTRL_DELETING
);

1038 
	`nvme_¡¬t_ù¾
(&
ù¾
->ctrl);

1040 
	`dev_šfo
(
ù¾
->ù¾.
deviû
, "Successfully„econnected (%d‡ttempts)\n",

1041 
ù¾
->ù¾.
Ä_»cÚÃùs
);

1043 
ù¾
->ù¾.
Ä_»cÚÃùs
 = 0;

1047 
de¡roy_admš
:

1048 
	`nvme_rdma_¡Ý_queue
(&
ù¾
->
queues
[0]);

1049 
	`nvme_rdma_de¡roy_admš_queue
(
ù¾
, 
çl£
);

1050 
»queue
:

1051 
	`dev_šfo
(
ù¾
->ù¾.
deviû
, "Failed„econnect‡ttempt %d\n",

1052 
ù¾
->ù¾.
Ä_»cÚÃùs
);

1053 
	`nvme_rdma_»cÚÃù_Ü_»move
(
ù¾
);

1054 
	}
}

1056 
	$nvme_rdma_”rÜ_»cov”y_wÜk
(
wÜk_¡ruù
 *
wÜk
)

1058 
nvme_rdma_ù¾
 *
ù¾
 = 
	`cÚš”_of
(
wÜk
,

1059 
nvme_rdma_ù¾
, 
”r_wÜk
);

1061 
	`nvme_¡Ý_k“p_®ive
(&
ù¾
->ctrl);

1063 ià(
ù¾
->ù¾.
queue_couÁ
 > 1) {

1064 
	`nvme_¡Ý_queues
(&
ù¾
->ctrl);

1065 
	`nvme_rdma_¡Ý_io_queues
(
ù¾
);

1066 
	`blk_mq_g£t_busy_™”
(&
ù¾
->
g_£t
,

1067 
nvme_ÿnûl_»que¡
, &
ù¾
->ctrl);

1068 
	`nvme_rdma_de¡roy_io_queues
(
ù¾
, 
çl£
);

1071 #ifdeà
HAVE_BLK_MQ_UNQUIESCE_QUEUE


1072 
	`blk_mq_qu›sû_queue
(
ù¾
->ù¾.
admš_q
);

1074 
	`blk_mq_¡Ý_hw_queues
(
ù¾
->ù¾.
admš_q
);

1076 
	`nvme_rdma_¡Ý_queue
(&
ù¾
->
queues
[0]);

1077 
	`blk_mq_g£t_busy_™”
(&
ù¾
->
admš_g_£t
,

1078 
nvme_ÿnûl_»que¡
, &
ù¾
->ctrl);

1079 
	`nvme_rdma_de¡roy_admš_queue
(
ù¾
, 
çl£
);

1085 #ifdeà
HAVE_BLK_MQ_UNQUIESCE_QUEUE


1086 
	`blk_mq_unqu›sû_queue
(
ù¾
->ù¾.
admš_q
);

1088 
	`blk_mq_¡¬t_¡Ý³d_hw_queues
(
ù¾
->ù¾.
admš_q
, 
Œue
);

1090 
	`nvme_¡¬t_queues
(&
ù¾
->ctrl);

1092 ià(!
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_CONNECTING
)) {

1094 
	`WARN_ON_ONCE
(
ù¾
->ù¾.
¡©e
 !ð
NVME_CTRL_DELETING
);

1098 
	`nvme_rdma_»cÚÃù_Ü_»move
(
ù¾
);

1099 
	}
}

1101 
	$nvme_rdma_”rÜ_»cov”y
(
nvme_rdma_ù¾
 *
ù¾
)

1103 ià(!
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_RESETTING
))

1106 
	`queue_wÜk
(
nvme_wq
, &
ù¾
->
”r_wÜk
);

1107 
	}
}

1109 
	$nvme_rdma_wr_”rÜ
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
,

1110 cÚ¡ *
Ý
)

1112 
nvme_rdma_queue
 *
queue
 = 
cq
->
cq_cÚ‹xt
;

1113 
nvme_rdma_ù¾
 *
ù¾
 = 
queue
->ctrl;

1115 ià(
ù¾
->ù¾.
¡©e
 =ð
NVME_CTRL_LIVE
)

1116 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

1118 
Ý
, 
wc
->
wr_cqe
,

1119 
	`ib_wc_¡©us_msg
(
wc
->
¡©us
), wc->status);

1120 
	`nvme_rdma_”rÜ_»cov”y
(
ù¾
);

1121 
	}
}

1123 
	$nvme_rdma_mem»g_dÚe
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
)

1125 ià(
	`uÆik–y
(
wc
->
¡©us
 !ð
IB_WC_SUCCESS
))

1126 
	`nvme_rdma_wr_”rÜ
(
cq
, 
wc
, "MEMREG");

1127 
	}
}

1129 
	$nvme_rdma_šv_rkey_dÚe
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
)

1131 
nvme_rdma_»que¡
 *
»q
 =

1132 
	`cÚš”_of
(
wc
->
wr_cqe
, 
nvme_rdma_»que¡
, 
»g_cqe
);

1133 
»que¡
 *
rq
 = 
	`blk_mq_rq_äom_pdu
(
»q
);

1135 ià(
	`uÆik–y
(
wc
->
¡©us
 !ð
IB_WC_SUCCESS
)) {

1136 
	`nvme_rdma_wr_”rÜ
(
cq
, 
wc
, "LOCAL_INV");

1140 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
»q
->
»f
))

1141 
	`nvme_’d_»que¡
(
rq
, 
»q
->
¡©us
,„eq->
»suÉ
);

1143 
	}
}

1145 
	$nvme_rdma_šv_rkey
(
nvme_rdma_queue
 *
queue
,

1146 
nvme_rdma_»que¡
 *
»q
)

1148 
ib_£nd_wr
 *
bad_wr
;

1149 
ib_£nd_wr
 
wr
 = {

1150 .
Ýcode
 = 
IB_WR_LOCAL_INV
,

1151 .
Ãxt
 = 
NULL
,

1152 .
num_sge
 = 0,

1153 .
£nd_æags
 = 
IB_SEND_SIGNALED
,

1154 .
ex
.
šv®id©e_rkey
 = 
»q
->
mr
->
rkey
,

1157 
»q
->
»g_cqe
.
dÚe
 = 
nvme_rdma_šv_rkey_dÚe
;

1158 
wr
.
wr_cqe
 = &
»q
->
»g_cqe
;

1160  
	`ib_po¡_£nd
(
queue
->
qp
, &
wr
, &
bad_wr
);

1161 
	}
}

1163 
	$nvme_rdma_unm­_d©a
(
nvme_rdma_queue
 *
queue
,

1164 
»que¡
 *
rq
)

1166 
nvme_rdma_»que¡
 *
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1167 
nvme_rdma_deviû
 *
dev
 = 
queue
->
deviû
;

1168 
ib_deviû
 *
ibdev
 = 
dev
->dev;

1170 #ifdeà
HAVE_BLK_RQ_NR_PAYLOAD_BYTES


1171 ià(!
	`blk_rq_·ylßd_by‹s
(
rq
))

1173 ià(!
	`nvme_m­_Ën
(
rq
))

1177 ià(
»q
->
mr
) {

1178 
	`ib_mr_poÞ_put
(
queue
->
qp
, &queue->qp->
rdma_mrs
, 
»q
->
mr
);

1179 
»q
->
mr
 = 
NULL
;

1182 
	`ib_dma_unm­_sg
(
ibdev
, 
»q
->
sg_bË
.
sgl
,

1183 
»q
->
ÃÁs
, 
	`rq_d©a_dœ
(
rq
) ==

1184 
WRITE
 ? 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
);

1186 
	`nvme_þ—nup_cmd
(
rq
);

1187 
	`sg_ä“_bË_chašed
(&
»q
->
sg_bË
, 
Œue
);

1188 
	}
}

1190 
	$nvme_rdma_£t_sg_nuÎ
(
nvme_commªd
 *
c
)

1192 
nvme_keyed_sgl_desc
 *
sg
 = &
c
->
commÚ
.
d±r
.
ksgl
;

1194 
sg
->
addr
 = 0;

1195 
	`put_uÇligÃd_Ë24
(0, 
sg
->
Ëngth
);

1196 
	`put_uÇligÃd_Ë32
(0, 
sg
->
key
);

1197 
sg
->
ty³
 = 
NVME_KEY_SGL_FMT_DATA_DESC
 << 4;

1199 
	}
}

1201 
	$nvme_rdma_m­_sg_šlše
(
nvme_rdma_queue
 *
queue
,

1202 
nvme_rdma_»que¡
 *
»q
, 
nvme_commªd
 *
c
)

1204 
nvme_sgl_desc
 *
sg
 = &
c
->
commÚ
.
d±r
.
sgl
;

1206 
»q
->
sge
[1].
addr
 = 
	`sg_dma_add»ss
Ôeq->
sg_bË
.
sgl
);

1207 
»q
->
sge
[1].
Ëngth
 = 
	`sg_dma_Ën
Ôeq->
sg_bË
.
sgl
);

1208 
»q
->
sge
[1].
lkey
 = 
queue
->
deviû
->
pd
->
loÿl_dma_lkey
;

1210 
sg
->
addr
 = 
	`ýu_to_Ë64
(
queue
->
ù¾
->ù¾.
icdoff
);

1211 
sg
->
Ëngth
 = 
	`ýu_to_Ë32
(
	`sg_dma_Ën
(
»q
->
sg_bË
.
sgl
));

1212 
sg
->
ty³
 = (
NVME_SGL_FMT_DATA_DESC
 << 4è| 
NVME_SGL_FMT_OFFSET
;

1214 
»q
->
num_sge
++;

1216 
	}
}

1218 
	$nvme_rdma_m­_sg_sšgË
(
nvme_rdma_queue
 *
queue
,

1219 
nvme_rdma_»que¡
 *
»q
, 
nvme_commªd
 *
c
)

1221 
nvme_keyed_sgl_desc
 *
sg
 = &
c
->
commÚ
.
d±r
.
ksgl
;

1223 
sg
->
addr
 = 
	`ýu_to_Ë64
(
	`sg_dma_add»ss
(
»q
->
sg_bË
.
sgl
));

1224 
	`put_uÇligÃd_Ë24
(
	`sg_dma_Ën
(
»q
->
sg_bË
.
sgl
), 
sg
->
Ëngth
);

1225 
	`put_uÇligÃd_Ë32
(
queue
->
deviû
->
pd
->
un§ã_glob®_rkey
, 
sg
->
key
);

1226 
sg
->
ty³
 = 
NVME_KEY_SGL_FMT_DATA_DESC
 << 4;

1228 
	}
}

1230 
	$nvme_rdma_m­_sg_ä
(
nvme_rdma_queue
 *
queue
,

1231 
nvme_rdma_»que¡
 *
»q
, 
nvme_commªd
 *
c
,

1232 
couÁ
)

1234 
nvme_keyed_sgl_desc
 *
sg
 = &
c
->
commÚ
.
d±r
.
ksgl
;

1235 
Ä
;

1237 
»q
->
mr
 = 
	`ib_mr_poÞ_g‘
(
queue
->
qp
, &queue->qp->
rdma_mrs
);

1238 ià(
	`WARN_ON_ONCE
(!
»q
->
mr
))

1239  -
EAGAIN
;

1245 
Ä
 = 
	`ib_m­_mr_sg
(
»q
->
mr
,„eq->
sg_bË
.
sgl
, 
couÁ
, 
NULL
, 
SZ_4K
);

1246 ià(
	`uÆik–y
(
Ä
 < 
couÁ
)) {

1247 
	`ib_mr_poÞ_put
(
queue
->
qp
, &queue->qp->
rdma_mrs
, 
»q
->
mr
);

1248 
»q
->
mr
 = 
NULL
;

1249 ià(
Ä
 < 0)

1250  
Ä
;

1251  -
EINVAL
;

1254 
	`ib_upd©e_ç¡_»g_key
(
»q
->
mr
, 
	`ib_šc_rkey
Ôeq->mr->
rkey
));

1256 
»q
->
»g_cqe
.
dÚe
 = 
nvme_rdma_mem»g_dÚe
;

1257 
	`mem£t
(&
»q
->
»g_wr
, 0, (req->reg_wr));

1258 
»q
->
»g_wr
.
wr
.
Ýcode
 = 
IB_WR_REG_MR
;

1259 
»q
->
»g_wr
.
wr
.
wr_cqe
 = &»q->
»g_cqe
;

1260 
»q
->
»g_wr
.
wr
.
num_sge
 = 0;

1261 
»q
->
»g_wr
.
mr
 =„eq->mr;

1262 
»q
->
»g_wr
.
key
 =„eq->
mr
->
rkey
;

1263 
»q
->
»g_wr
.
acûss
 = 
IB_ACCESS_LOCAL_WRITE
 |

1264 
IB_ACCESS_REMOTE_READ
 |

1265 
IB_ACCESS_REMOTE_WRITE
;

1267 
sg
->
addr
 = 
	`ýu_to_Ë64
(
»q
->
mr
->
iova
);

1268 
	`put_uÇligÃd_Ë24
(
»q
->
mr
->
Ëngth
, 
sg
->length);

1269 
	`put_uÇligÃd_Ë32
(
»q
->
mr
->
rkey
, 
sg
->
key
);

1270 
sg
->
ty³
 = (
NVME_KEY_SGL_FMT_DATA_DESC
 << 4) |

1271 
NVME_SGL_FMT_INVALIDATE
;

1274 
	}
}

1276 
	$nvme_rdma_m­_d©a
(
nvme_rdma_queue
 *
queue
,

1277 
»que¡
 *
rq
, 
nvme_commªd
 *
c
)

1279 
nvme_rdma_»que¡
 *
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1280 
nvme_rdma_deviû
 *
dev
 = 
queue
->
deviû
;

1281 
ib_deviû
 *
ibdev
 = 
dev
->dev;

1282 
couÁ
, 
»t
;

1284 
»q
->
num_sge
 = 1;

1285 
	`»fcouÁ_£t
(&
»q
->
»f
, 2);

1287 
c
->
commÚ
.
æags
 |ð
NVME_CMD_SGL_METABUF
;

1289 #ifdeà
HAVE_BLK_RQ_NR_PAYLOAD_BYTES


1290 ià(!
	`blk_rq_·ylßd_by‹s
(
rq
))

1292 ià(!
	`nvme_m­_Ën
(
rq
))

1294  
	`nvme_rdma_£t_sg_nuÎ
(
c
);

1296 
»q
->
sg_bË
.
sgl
 =„eq->
fœ¡_sgl
;

1297 #ifdeà
HAVE_SG_ALLOC_TABLE_CHAINED_4_PARAMS


1298 
»t
 = 
	`sg_®loc_bË_chašed
(&
»q
->
sg_bË
,

1299 
	`blk_rq_Ä_phys_£gm’ts
(
rq
),

1300 
GFP_ATOMIC
,

1301 
»q
->
sg_bË
.
sgl
);

1303 
»t
 = 
	`sg_®loc_bË_chašed
(&
»q
->
sg_bË
,

1304 
	`blk_rq_Ä_phys_£gm’ts
(
rq
), 
»q
->
sg_bË
.
sgl
);

1306 ià(
»t
)

1307  -
ENOMEM
;

1309 
»q
->
ÃÁs
 = 
	`blk_rq_m­_sg
(
rq
->
q
,„q,„eq->
sg_bË
.
sgl
);

1311 
couÁ
 = 
	`ib_dma_m­_sg
(
ibdev
, 
»q
->
sg_bË
.
sgl
,„eq->
ÃÁs
,

1312 
	`rq_d©a_dœ
(
rq
è=ð
WRITE
 ? 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
);

1313 ià(
	`uÆik–y
(
couÁ
 <= 0)) {

1314 
»t
 = -
EIO
;

1315 
out_ä“_bË
;

1318 ià(
couÁ
 == 1) {

1319 ià(
	`rq_d©a_dœ
(
rq
è=ð
WRITE
 && 
	`nvme_rdma_queue_idx
(
queue
) &&

1320 #ifdeà
HAVE_BLK_RQ_NR_PAYLOAD_BYTES


1321 
	`blk_rq_·ylßd_by‹s
(
rq
) <=

1323 
	`nvme_m­_Ën
(
rq
) <=

1325 
	`nvme_rdma_šlše_d©a_size
(
queue
)) {

1326 
»t
 = 
	`nvme_rdma_m­_sg_šlše
(
queue
, 
»q
, 
c
);

1327 
out
;

1330 ià(
dev
->
pd
->
æags
 & 
IB_PD_UNSAFE_GLOBAL_RKEY
) {

1331 
»t
 = 
	`nvme_rdma_m­_sg_sšgË
(
queue
, 
»q
, 
c
);

1332 
out
;

1336 
»t
 = 
	`nvme_rdma_m­_sg_ä
(
queue
, 
»q
, 
c
, 
couÁ
);

1337 
out
:

1338 ià(
	`uÆik–y
(
»t
))

1339 
out_unm­_sg
;

1343 
out_unm­_sg
:

1344 
	`ib_dma_unm­_sg
(
ibdev
, 
»q
->
sg_bË
.
sgl
,

1345 
»q
->
ÃÁs
, 
	`rq_d©a_dœ
(
rq
) ==

1346 
WRITE
 ? 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
);

1347 
out_ä“_bË
:

1348 
	`sg_ä“_bË_chašed
(&
»q
->
sg_bË
, 
Œue
);

1349  
»t
;

1350 
	}
}

1352 
	$nvme_rdma_£nd_dÚe
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
)

1354 
nvme_rdma_qe
 *
qe
 =

1355 
	`cÚš”_of
(
wc
->
wr_cqe
, 
nvme_rdma_qe
, 
cqe
);

1356 
nvme_rdma_»que¡
 *
»q
 =

1357 
	`cÚš”_of
(
qe
, 
nvme_rdma_»que¡
, 
sqe
);

1358 
»que¡
 *
rq
 = 
	`blk_mq_rq_äom_pdu
(
»q
);

1360 ià(
	`uÆik–y
(
wc
->
¡©us
 !ð
IB_WC_SUCCESS
)) {

1361 
	`nvme_rdma_wr_”rÜ
(
cq
, 
wc
, "SEND");

1365 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
»q
->
»f
))

1366 
	`nvme_’d_»que¡
(
rq
, 
»q
->
¡©us
,„eq->
»suÉ
);

1367 
	}
}

1369 
	$nvme_rdma_po¡_£nd
(
nvme_rdma_queue
 *
queue
,

1370 
nvme_rdma_qe
 *
qe
, 
ib_sge
 *
sge
, 
u32
 
num_sge
,

1371 
ib_£nd_wr
 *
fœ¡
)

1373 
ib_£nd_wr
 
wr
, *
bad_wr
;

1374 
»t
;

1376 
sge
->
addr
 = 
qe
->
dma
;

1377 
sge
->
Ëngth
 = (
nvme_commªd
),

1378 
sge
->
lkey
 = 
queue
->
deviû
->
pd
->
loÿl_dma_lkey
;

1380 
wr
.
Ãxt
 = 
NULL
;

1381 
wr
.
wr_cqe
 = &
qe
->
cqe
;

1382 
wr
.
sg_li¡
 = 
sge
;

1383 
wr
.
num_sge
 =‚um_sge;

1384 
wr
.
Ýcode
 = 
IB_WR_SEND
;

1385 
wr
.
£nd_æags
 = 
IB_SEND_SIGNALED
;

1387 ià(
fœ¡
)

1388 
fœ¡
->
Ãxt
 = &
wr
;

1390 
fœ¡
 = &
wr
;

1392 
»t
 = 
	`ib_po¡_£nd
(
queue
->
qp
, 
fœ¡
, &
bad_wr
);

1393 ià(
	`uÆik–y
(
»t
)) {

1394 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1395 "% çžed w™hƒ¼Ü cod%d\n", 
__func__
, 
»t
);

1397  
»t
;

1398 
	}
}

1400 
	$nvme_rdma_po¡_»cv
(
nvme_rdma_queue
 *
queue
,

1401 
nvme_rdma_qe
 *
qe
)

1403 
ib_»cv_wr
 
wr
, *
bad_wr
;

1404 
ib_sge
 
li¡
;

1405 
»t
;

1407 
li¡
.
addr
 = 
qe
->
dma
;

1408 
li¡
.
Ëngth
 = (
nvme_com¶‘iÚ
);

1409 
li¡
.
lkey
 = 
queue
->
deviû
->
pd
->
loÿl_dma_lkey
;

1411 
qe
->
cqe
.
dÚe
 = 
nvme_rdma_»cv_dÚe
;

1413 
wr
.
Ãxt
 = 
NULL
;

1414 
wr
.
wr_cqe
 = &
qe
->
cqe
;

1415 
wr
.
sg_li¡
 = &
li¡
;

1416 
wr
.
num_sge
 = 1;

1418 
»t
 = 
	`ib_po¡_»cv
(
queue
->
qp
, &
wr
, &
bad_wr
);

1419 ià(
	`uÆik–y
(
»t
)) {

1420 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1421 "% çžed w™hƒ¼Ü cod%d\n", 
__func__
, 
»t
);

1423  
»t
;

1424 
	}
}

1426 
blk_mq_gs
 *
	$nvme_rdma_g£t
(
nvme_rdma_queue
 *
queue
)

1428 
u32
 
queue_idx
 = 
	`nvme_rdma_queue_idx
(
queue
);

1430 ià(
queue_idx
 == 0)

1431  
queue
->
ù¾
->
admš_g_£t
.
gs
[
queue_idx
];

1432  
queue
->
ù¾
->
g_£t
.
gs
[
queue_idx
 - 1];

1433 
	}
}

1435 
	$nvme_rdma_async_dÚe
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
)

1437 ià(
	`uÆik–y
(
wc
->
¡©us
 !ð
IB_WC_SUCCESS
))

1438 
	`nvme_rdma_wr_”rÜ
(
cq
, 
wc
, "ASYNC");

1439 
	}
}

1441 
	$nvme_rdma_subm™_async_ev’t
(
nvme_ù¾
 *
¬g
)

1443 
nvme_rdma_ù¾
 *
ù¾
 = 
	`to_rdma_ù¾
(
¬g
);

1444 
nvme_rdma_queue
 *
queue
 = &
ù¾
->
queues
[0];

1445 
ib_deviû
 *
dev
 = 
queue
->
deviû
->dev;

1446 
nvme_rdma_qe
 *
sqe
 = &
ù¾
->
async_ev’t_sqe
;

1447 
nvme_commªd
 *
cmd
 = 
sqe
->
d©a
;

1448 
ib_sge
 
sge
;

1449 
»t
;

1451 
	`ib_dma_sync_sšgË_fÜ_ýu
(
dev
, 
sqe
->
dma
, (*
cmd
), 
DMA_TO_DEVICE
);

1453 
	`mem£t
(
cmd
, 0, (*cmd));

1454 
cmd
->
commÚ
.
Ýcode
 = 
nvme_admš_async_ev’t
;

1455 
cmd
->
commÚ
.
commªd_id
 = 
NVME_AQ_BLK_MQ_DEPTH
;

1456 
cmd
->
commÚ
.
æags
 |ð
NVME_CMD_SGL_METABUF
;

1457 
	`nvme_rdma_£t_sg_nuÎ
(
cmd
);

1459 
sqe
->
cqe
.
dÚe
 = 
nvme_rdma_async_dÚe
;

1461 
	`ib_dma_sync_sšgË_fÜ_deviû
(
dev
, 
sqe
->
dma
, (*
cmd
),

1462 
DMA_TO_DEVICE
);

1464 
»t
 = 
	`nvme_rdma_po¡_£nd
(
queue
, 
sqe
, &
sge
, 1, 
NULL
);

1465 
	`WARN_ON_ONCE
(
»t
);

1466 
	}
}

1468 
	$nvme_rdma_´oûss_nvme_r¥
(
nvme_rdma_queue
 *
queue
,

1469 
nvme_com¶‘iÚ
 *
cqe
, 
ib_wc
 *
wc
, 
g
)

1471 
»que¡
 *
rq
;

1472 
nvme_rdma_»que¡
 *
»q
;

1473 
»t
 = 0;

1475 
rq
 = 
	`blk_mq_g_to_rq
(
	`nvme_rdma_g£t
(
queue
), 
cqe
->
commªd_id
);

1476 ià(!
rq
) {

1477 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1479 
cqe
->
commªd_id
, 
queue
->
qp
->
qp_num
);

1480 
	`nvme_rdma_”rÜ_»cov”y
(
queue
->
ù¾
);

1481  
»t
;

1483 
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1485 
»q
->
¡©us
 = 
cqe
->status;

1486 
»q
->
»suÉ
 = 
cqe
->result;

1488 ià(
wc
->
wc_æags
 & 
IB_WC_WITH_INVALIDATE
) {

1489 ià(
	`uÆik–y
(
wc
->
ex
.
šv®id©e_rkey
 !ð
»q
->
mr
->
rkey
)) {

1490 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1492 
»q
->
mr
->
rkey
);

1493 
	`nvme_rdma_”rÜ_»cov”y
(
queue
->
ù¾
);

1495 } ià(
»q
->
mr
) {

1496 
»t
 = 
	`nvme_rdma_šv_rkey
(
queue
, 
»q
);

1497 ià(
	`uÆik–y
(
»t
 < 0)) {

1498 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1500 
»q
->
mr
->
rkey
, 
»t
);

1501 
	`nvme_rdma_”rÜ_»cov”y
(
queue
->
ù¾
);

1507 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
»q
->
»f
)) {

1508 ià(
rq
->
g
 ==ag)

1509 
»t
 = 1;

1510 
	`nvme_’d_»que¡
(
rq
, 
»q
->
¡©us
,„eq->
»suÉ
);

1513  
»t
;

1514 
	}
}

1516 
	$__nvme_rdma_»cv_dÚe
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
, 
g
)

1518 
nvme_rdma_qe
 *
qe
 =

1519 
	`cÚš”_of
(
wc
->
wr_cqe
, 
nvme_rdma_qe
, 
cqe
);

1520 
nvme_rdma_queue
 *
queue
 = 
cq
->
cq_cÚ‹xt
;

1521 
ib_deviû
 *
ibdev
 = 
queue
->
deviû
->
dev
;

1522 
nvme_com¶‘iÚ
 *
cqe
 = 
qe
->
d©a
;

1523 cÚ¡ 
size_t
 
Ën
 = (
nvme_com¶‘iÚ
);

1524 
»t
 = 0;

1526 ià(
	`uÆik–y
(
wc
->
¡©us
 !ð
IB_WC_SUCCESS
)) {

1527 
	`nvme_rdma_wr_”rÜ
(
cq
, 
wc
, "RECV");

1531 
	`ib_dma_sync_sšgË_fÜ_ýu
(
ibdev
, 
qe
->
dma
, 
Ën
, 
DMA_FROM_DEVICE
);

1538 ià(
	`uÆik–y
(
	`nvme_rdma_queue_idx
(
queue
) == 0 &&

1539 
cqe
->
commªd_id
 >ð
NVME_AQ_BLK_MQ_DEPTH
))

1540 
	`nvme_com¶‘e_async_ev’t
(&
queue
->
ù¾
->ù¾, 
cqe
->
¡©us
,

1541 &
cqe
->
»suÉ
);

1543 
»t
 = 
	`nvme_rdma_´oûss_nvme_r¥
(
queue
, 
cqe
, 
wc
, 
g
);

1544 
	`ib_dma_sync_sšgË_fÜ_deviû
(
ibdev
, 
qe
->
dma
, 
Ën
, 
DMA_FROM_DEVICE
);

1546 
	`nvme_rdma_po¡_»cv
(
queue
, 
qe
);

1547  
»t
;

1548 
	}
}

1550 
	$nvme_rdma_»cv_dÚe
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
)

1552 
	`__nvme_rdma_»cv_dÚe
(
cq
, 
wc
, -1);

1553 
	}
}

1555 
	$nvme_rdma_cÚn_e¡ablished
(
nvme_rdma_queue
 *
queue
)

1557 
»t
, 
i
;

1559 
i
 = 0; i < 
queue
->
queue_size
; i++) {

1560 
»t
 = 
	`nvme_rdma_po¡_»cv
(
queue
, &queue->
r¥_ršg
[
i
]);

1561 ià(
»t
)

1562 
out_de¡roy_queue_ib
;

1567 
out_de¡roy_queue_ib
:

1568 
	`nvme_rdma_de¡roy_queue_ib
(
queue
);

1569  
»t
;

1570 
	}
}

1572 
	$nvme_rdma_cÚn_»jeùed
(
nvme_rdma_queue
 *
queue
,

1573 
rdma_cm_ev’t
 *
ev
)

1575 
rdma_cm_id
 *
cm_id
 = 
queue
->cm_id;

1576 
¡©us
 = 
ev
->status;

1577 cÚ¡ *
»j_msg
;

1578 cÚ¡ 
nvme_rdma_cm_»j
 *
»j_d©a
;

1579 
u8
 
»j_d©a_Ën
;

1581 
»j_msg
 = 
	`rdma_»jeù_msg
(
cm_id
, 
¡©us
);

1582 
»j_d©a
 = 
	`rdma_cÚsum”_»jeù_d©a
(
cm_id
, 
ev
, &
»j_d©a_Ën
);

1584 ià(
»j_d©a
 && 
»j_d©a_Ën
 >ð(
u16
)) {

1585 
u16
 
¡s
 = 
	`Ë16_to_ýu
(
»j_d©a
->sts);

1587 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1589 
¡©us
, 
»j_msg
, 
¡s
, 
	`nvme_rdma_cm_msg
(sts));

1591 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1592 "CÚÃù„ejeùed: stu %d (%s).\n", 
¡©us
, 
»j_msg
);

1595  -
ECONNRESET
;

1596 
	}
}

1598 
	$nvme_rdma_addr_»sÞved
(
nvme_rdma_queue
 *
queue
)

1600 
»t
;

1602 
»t
 = 
	`nvme_rdma_ü—‹_queue_ib
(
queue
);

1603 ià(
»t
)

1604  
»t
;

1606 
»t
 = 
	`rdma_»sÞve_rou‹
(
queue
->
cm_id
, 
NVME_RDMA_CONNECT_TIMEOUT_MS
);

1607 ià(
»t
) {

1608 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1610 
queue
->
cm_”rÜ
);

1611 
out_de¡roy_queue
;

1616 
out_de¡roy_queue
:

1617 
	`nvme_rdma_de¡roy_queue_ib
(
queue
);

1618  
»t
;

1619 
	}
}

1621 
	$nvme_rdma_rou‹_»sÞved
(
nvme_rdma_queue
 *
queue
)

1623 
nvme_rdma_ù¾
 *
ù¾
 = 
queue
->ctrl;

1624 
rdma_cÚn_·¿m
 
·¿m
 = { };

1625 
nvme_rdma_cm_»q
 
´iv
 = { };

1626 
»t
;

1628 
·¿m
.
qp_num
 = 
queue
->
qp
->qp_num;

1629 
·¿m
.
æow_cÚŒÞ
 = 1;

1631 
·¿m
.
»¥Úd”_»sourûs
 = 
queue
->
deviû
->
dev
->
©Œs
.
max_qp_rd_©om
;

1633 
·¿m
.
»Œy_couÁ
 = 7;

1634 
·¿m
.
ºr_»Œy_couÁ
 = 7;

1635 
·¿m
.
´iv©e_d©a
 = &
´iv
;

1636 
·¿m
.
´iv©e_d©a_Ën
 = (
´iv
);

1638 
´iv
.
»cfmt
 = 
	`ýu_to_Ë16
(
NVME_RDMA_CM_FMT_1_0
);

1639 
´iv
.
qid
 = 
	`ýu_to_Ë16
(
	`nvme_rdma_queue_idx
(
queue
));

1644 ià(
´iv
.
qid
 == 0) {

1645 
´iv
.
hrqsize
 = 
	`ýu_to_Ë16
(
NVME_AQ_DEPTH
);

1646 
´iv
.
hsqsize
 = 
	`ýu_to_Ë16
(
NVME_AQ_DEPTH
 - 1);

1653 
´iv
.
hrqsize
 = 
	`ýu_to_Ë16
(
queue
->
queue_size
);

1654 
´iv
.
hsqsize
 = 
	`ýu_to_Ë16
(
queue
->
ù¾
->ù¾.
sqsize
);

1657 
»t
 = 
	`rdma_cÚÃù
(
queue
->
cm_id
, &
·¿m
);

1658 ià(
»t
) {

1659 
	`dev_”r
(
ù¾
->ù¾.
deviû
,

1660 "rdma_cÚÃù fažed (%d).\n", 
»t
);

1661 
out_de¡roy_queue_ib
;

1666 
out_de¡roy_queue_ib
:

1667 
	`nvme_rdma_de¡roy_queue_ib
(
queue
);

1668  
»t
;

1669 
	}
}

1671 
	$nvme_rdma_cm_hªdËr
(
rdma_cm_id
 *
cm_id
,

1672 
rdma_cm_ev’t
 *
ev
)

1674 
nvme_rdma_queue
 *
queue
 = 
cm_id
->
cÚ‹xt
;

1675 
cm_”rÜ
 = 0;

1677 
	`dev_dbg
(
queue
->
ù¾
->ù¾.
deviû
, "%s (%d): status %d id %p\n",

1678 
	`rdma_ev’t_msg
(
ev
->
ev’t
),ƒv->event,

1679 
ev
->
¡©us
, 
cm_id
);

1681 
ev
->
ev’t
) {

1682 
RDMA_CM_EVENT_ADDR_RESOLVED
:

1683 
cm_”rÜ
 = 
	`nvme_rdma_addr_»sÞved
(
queue
);

1685 
RDMA_CM_EVENT_ROUTE_RESOLVED
:

1686 
cm_”rÜ
 = 
	`nvme_rdma_rou‹_»sÞved
(
queue
);

1688 
RDMA_CM_EVENT_ESTABLISHED
:

1689 
queue
->
cm_”rÜ
 = 
	`nvme_rdma_cÚn_e¡ablished
(queue);

1691 
	`com¶‘e
(&
queue
->
cm_dÚe
);

1693 
RDMA_CM_EVENT_REJECTED
:

1694 
	`nvme_rdma_de¡roy_queue_ib
(
queue
);

1695 
cm_”rÜ
 = 
	`nvme_rdma_cÚn_»jeùed
(
queue
, 
ev
);

1697 
RDMA_CM_EVENT_ROUTE_ERROR
:

1698 
RDMA_CM_EVENT_CONNECT_ERROR
:

1699 
RDMA_CM_EVENT_UNREACHABLE
:

1700 
	`nvme_rdma_de¡roy_queue_ib
(
queue
);

1701 
RDMA_CM_EVENT_ADDR_ERROR
:

1702 
	`dev_dbg
(
queue
->
ù¾
->ù¾.
deviû
,

1703 "CMƒ¼Üƒv’ˆ%d\n", 
ev
->
ev’t
);

1704 
cm_”rÜ
 = -
ECONNRESET
;

1706 
RDMA_CM_EVENT_DISCONNECTED
:

1707 
RDMA_CM_EVENT_ADDR_CHANGE
:

1708 
RDMA_CM_EVENT_TIMEWAIT_EXIT
:

1709 
	`dev_dbg
(
queue
->
ù¾
->ù¾.
deviû
,

1711 
	`nvme_rdma_”rÜ_»cov”y
(
queue
->
ù¾
);

1713 
RDMA_CM_EVENT_DEVICE_REMOVAL
:

1717 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1718 "UÃx³ùed RDMA CMƒv’ˆ(%d)\n", 
ev
->
ev’t
);

1719 
	`nvme_rdma_”rÜ_»cov”y
(
queue
->
ù¾
);

1723 ià(
cm_”rÜ
) {

1724 
queue
->
cm_”rÜ
 = cm_error;

1725 
	`com¶‘e
(&
queue
->
cm_dÚe
);

1729 
	}
}

1731 
blk_eh_tim”_»tuº


1732 
	$nvme_rdma_timeout
(
»que¡
 *
rq
, 
boÞ
 
»£rved
)

1734 
nvme_rdma_»que¡
 *
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1736 
	`dev_w¬n
(
»q
->
queue
->
ù¾
->ù¾.
deviû
,

1738 
rq
->
g
, 
	`nvme_rdma_queue_idx
(
»q
->
queue
));

1741 
	`nvme_rdma_”rÜ_»cov”y
(
»q
->
queue
->
ù¾
);

1743 #ifdef 
HAVE_BLK_EH_DONE


1744  
BLK_EH_DONE
;

1746  
BLK_EH_RESET_TIMER
;

1748 
	}
}

1750 
blk_¡©us_t
 
	$nvme_rdma_queue_rq
(
blk_mq_hw_ùx
 *
hùx
,

1751 cÚ¡ 
blk_mq_queue_d©a
 *
bd
)

1753 
nvme_ns
 *
ns
 = 
hùx
->
queue
->
queued©a
;

1754 
nvme_rdma_queue
 *
queue
 = 
hùx
->
driv”_d©a
;

1755 
»que¡
 *
rq
 = 
bd
->rq;

1756 
nvme_rdma_»que¡
 *
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1757 
nvme_rdma_qe
 *
sqe
 = &
»q
->sqe;

1758 
nvme_commªd
 *
c
 = 
sqe
->
d©a
;

1759 
ib_deviû
 *
dev
;

1760 
blk_¡©us_t
 
»t
;

1761 
”r
;

1763 
	`WARN_ON_ONCE
(
rq
->
g
 < 0);

1765 
»t
 = 
	`nvmf_check_if_»ady
(&
queue
->
ù¾
->ù¾, 
rq
,

1766 
	`‹¡_b™
(
NVME_RDMA_Q_LIVE
, &
queue
->
æags
), 
Œue
);

1767 ià(
	`uÆik–y
(
»t
))

1768  
»t
;

1770 
dev
 = 
queue
->
deviû
->dev;

1771 
	`ib_dma_sync_sšgË_fÜ_ýu
(
dev
, 
sqe
->
dma
,

1772 (
nvme_commªd
), 
DMA_TO_DEVICE
);

1774 
»t
 = 
	`nvme_£tup_cmd
(
ns
, 
rq
, 
c
);

1775 ià(
»t
)

1776  
»t
;

1778 
	`blk_mq_¡¬t_»que¡
(
rq
);

1780 
”r
 = 
	`nvme_rdma_m­_d©a
(
queue
, 
rq
, 
c
);

1781 ià(
	`uÆik–y
(
”r
 < 0)) {

1782 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1783 "FažedØm­ d©¨(%d)\n", 
”r
);

1784 
	`nvme_þ—nup_cmd
(
rq
);

1785 
”r
;

1788 
sqe
->
cqe
.
dÚe
 = 
nvme_rdma_£nd_dÚe
;

1790 
	`ib_dma_sync_sšgË_fÜ_deviû
(
dev
, 
sqe
->
dma
,

1791 (
nvme_commªd
), 
DMA_TO_DEVICE
);

1793 
”r
 = 
	`nvme_rdma_po¡_£nd
(
queue
, 
sqe
, 
»q
->
sge
,„eq->
num_sge
,

1794 
»q
->
mr
 ? &»q->
»g_wr
.
wr
 : 
NULL
);

1795 ià(
	`uÆik–y
(
”r
)) {

1796 
	`nvme_rdma_unm­_d©a
(
queue
, 
rq
);

1797 
”r
;

1800  
BLK_STS_OK
;

1801 
”r
:

1802 ià(
”r
 =ð-
ENOMEM
 ||ƒ¼ =ð-
EAGAIN
)

1803  
BLK_STS_RESOURCE
;

1804  
BLK_STS_IOERR
;

1805 
	}
}

1807 #ifdeà
HAVE_BLK_MQ_POLL


1808 
	$nvme_rdma_pÞl
(
blk_mq_hw_ùx
 *
hùx
, 
g
)

1810 
nvme_rdma_queue
 *
queue
 = 
hùx
->
driv”_d©a
;

1811 
ib_cq
 *
cq
 = 
queue
->ib_cq;

1812 
ib_wc
 
wc
;

1813 
found
 = 0;

1815 
	`ib_pÞl_cq
(
cq
, 1, &
wc
) > 0) {

1816 
ib_cqe
 *
cqe
 = 
wc
.
wr_cqe
;

1818 ià(
cqe
) {

1819 ià(
cqe
->
dÚe
 =ð
nvme_rdma_»cv_dÚe
)

1820 
found
 |ð
	`__nvme_rdma_»cv_dÚe
(
cq
, &
wc
, 
g
);

1822 
cqe
->
	`dÚe
(
cq
, &
wc
);

1826  
found
;

1827 
	}
}

1830 
	$nvme_rdma_com¶‘e_rq
(
»que¡
 *
rq
)

1832 
nvme_rdma_»que¡
 *
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1834 
	`nvme_rdma_unm­_d©a
(
»q
->
queue
, 
rq
);

1835 
	`nvme_com¶‘e_rq
(
rq
);

1836 
	}
}

1838 #ifdeà
HAVE_BLK_MQ_MAP_QUEUES


1839 
	$nvme_rdma_m­_queues
(
blk_mq_g_£t
 *
£t
)

1842 
nvme_rdma_ù¾
 *
ù¾
 = 
£t
->
driv”_d©a
;

1844  
	`blk_mq_rdma_m­_queues
(
£t
, 
ù¾
->
deviû
->
dev
, 0);

1846  
	`blk_mq_m­_queues
(
£t
);

1848 
	}
}

1851 #ifdeà
HAVE_BLK_MQ_TAG_SET_HAS_CONST_POS


1852 cÚ¡ 
blk_mq_Ýs
 
	gnvme_rdma_mq_Ýs
 = {

1854 
blk_mq_Ýs
 
nvme_rdma_mq_Ýs
 = {

1856 .
queue_rq
 = 
nvme_rdma_queue_rq
,

1857 .
	gcom¶‘e
 = 
nvme_rdma_com¶‘e_rq
,

1858 #ifdeà
HAVE_BLK_MQ_OPS_MAP_QUEUE


1859 .
	gm­_queue
 = 
blk_mq_m­_queue
,

1861 .
	gš™_»que¡
 = 
nvme_rdma_š™_»que¡
,

1862 .
	gex™_»que¡
 = 
nvme_rdma_ex™_»que¡
,

1863 .
	gš™_hùx
 = 
nvme_rdma_š™_hùx
,

1864 #ifdeà
HAVE_BLK_MQ_POLL


1865 .
	gpÞl
 = 
nvme_rdma_pÞl
,

1867 .
	gtimeout
 = 
nvme_rdma_timeout
,

1868 #ifdeà
HAVE_BLK_MQ_MAP_QUEUES


1869 .
	gm­_queues
 = 
nvme_rdma_m­_queues
,

1873 #ifdeà
HAVE_BLK_MQ_TAG_SET_HAS_CONST_POS


1874 cÚ¡ 
blk_mq_Ýs
 
	gnvme_rdma_admš_mq_Ýs
 = {

1876 
blk_mq_Ýs
 
nvme_rdma_admš_mq_Ýs
 = {

1878 .
queue_rq
 = 
nvme_rdma_queue_rq
,

1879 .
	gcom¶‘e
 = 
nvme_rdma_com¶‘e_rq
,

1880 #ifdeà
HAVE_BLK_MQ_OPS_MAP_QUEUE


1881 .
	gm­_queue
 = 
blk_mq_m­_queue
,

1883 #ifdeà
HAVE_BLK_MQ_OPS_INIT_REQUEST_HAS_4_PARAMS


1884 .
	gš™_»que¡
 = 
nvme_rdma_š™_»que¡
,

1886 .
	gš™_»que¡
 = 
nvme_rdma_š™_admš_»que¡
,

1888 #ifdeà
HAVE_BLK_MQ_OPS_EXIT_REQUEST_HAS_3_PARAMS


1889 .
	gex™_»que¡
 = 
nvme_rdma_ex™_»que¡
,

1891 .
	gex™_»que¡
 = 
nvme_rdma_ex™_admš_»que¡
,

1893 .
	gš™_hùx
 = 
nvme_rdma_š™_admš_hùx
,

1894 .
	gtimeout
 = 
nvme_rdma_timeout
,

1897 
	$nvme_rdma_shutdown_ù¾
(
nvme_rdma_ù¾
 *
ù¾
, 
boÞ
 
shutdown
)

1899 ià(
ù¾
->ù¾.
queue_couÁ
 > 1) {

1900 
	`nvme_¡Ý_queues
(&
ù¾
->ctrl);

1901 
	`nvme_rdma_¡Ý_io_queues
(
ù¾
);

1902 
	`blk_mq_g£t_busy_™”
(&
ù¾
->
g_£t
,

1903 
nvme_ÿnûl_»que¡
, &
ù¾
->ctrl);

1904 
	`nvme_rdma_de¡roy_io_queues
(
ù¾
, 
shutdown
);

1907 ià(
shutdown
)

1908 
	`nvme_shutdown_ù¾
(&
ù¾
->ctrl);

1910 
	`nvme_di§bË_ù¾
(&
ù¾
->ù¾, cŒl->ù¾.
ÿp
);

1912 #ifdeà
HAVE_BLK_MQ_UNQUIESCE_QUEUE


1913 
	`blk_mq_qu›sû_queue
(
ù¾
->ù¾.
admš_q
);

1915 
	`blk_mq_¡Ý_hw_queues
(
ù¾
->ù¾.
admš_q
);

1917 
	`nvme_rdma_¡Ý_queue
(&
ù¾
->
queues
[0]);

1918 
	`blk_mq_g£t_busy_™”
(&
ù¾
->
admš_g_£t
,

1919 
nvme_ÿnûl_»que¡
, &
ù¾
->ctrl);

1920 #ifdeà
HAVE_BLK_MQ_UNQUIESCE_QUEUE


1921 
	`blk_mq_unqu›sû_queue
(
ù¾
->ù¾.
admš_q
);

1923 
	`blk_mq_¡¬t_¡Ý³d_hw_queues
(
ù¾
->ù¾.
admš_q
, 
Œue
);

1925 
	`nvme_rdma_de¡roy_admš_queue
(
ù¾
, 
shutdown
);

1926 
	}
}

1928 
	$nvme_rdma_d–‘e_ù¾
(
nvme_ù¾
 *
ù¾
)

1930 
	`nvme_rdma_shutdown_ù¾
(
	`to_rdma_ù¾
(
ù¾
), 
Œue
);

1931 
	}
}

1933 
	$nvme_rdma_»£t_ù¾_wÜk
(
wÜk_¡ruù
 *
wÜk
)

1935 
nvme_rdma_ù¾
 *
ù¾
 =

1936 
	`cÚš”_of
(
wÜk
, 
nvme_rdma_ù¾
, 
ù¾
.
»£t_wÜk
);

1937 
»t
;

1938 
boÞ
 
chªged
;

1940 
	`nvme_¡Ý_ù¾
(&
ù¾
->ctrl);

1941 
	`nvme_rdma_shutdown_ù¾
(
ù¾
, 
çl£
);

1943 ià(!
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_CONNECTING
)) {

1945 
	`WARN_ON_ONCE
(1);

1949 
»t
 = 
	`nvme_rdma_cÚfigu»_admš_queue
(
ù¾
, 
çl£
);

1950 ià(
»t
)

1951 
out_çž
;

1953 ià(
ù¾
->ù¾.
queue_couÁ
 > 1) {

1954 
»t
 = 
	`nvme_rdma_cÚfigu»_io_queues
(
ù¾
, 
çl£
);

1955 ià(
»t
)

1956 
out_çž
;

1959 
chªged
 = 
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_LIVE
);

1960 ià(!
chªged
) {

1962 
	`WARN_ON_ONCE
(
ù¾
->ù¾.
¡©e
 !ð
NVME_CTRL_DELETING
);

1966 
	`nvme_¡¬t_ù¾
(&
ù¾
->ctrl);

1970 
out_çž
:

1971 ++
ù¾
->ù¾.
Ä_»cÚÃùs
;

1972 
	`nvme_rdma_»cÚÃù_Ü_»move
(
ù¾
);

1973 
	}
}

1975 cÚ¡ 
nvme_ù¾_Ýs
 
	gnvme_rdma_ù¾_Ýs
 = {

1976 .
Çme
 = "rdma",

1977 .
	gmoduË
 = 
THIS_MODULE
,

1978 .
	gæags
 = 
NVME_F_FABRICS
,

1979 .
	g»g_»ad32
 = 
nvmf_»g_»ad32
,

1980 .
	g»g_»ad64
 = 
nvmf_»g_»ad64
,

1981 .
	g»g_wr™e32
 = 
nvmf_»g_wr™e32
,

1982 .
	gä“_ù¾
 = 
nvme_rdma_ä“_ù¾
,

1983 .
	gsubm™_async_ev’t
 = 
nvme_rdma_subm™_async_ev’t
,

1984 .
	gd–‘e_ù¾
 = 
nvme_rdma_d–‘e_ù¾
,

1985 .
	gg‘_add»ss
 = 
nvmf_g‘_add»ss
,

1986 .
	g¡Ý_ù¾
 = 
nvme_rdma_¡Ý_ù¾
,

1989 
šlše
 
boÞ


1990 
	$__nvme_rdma_ÝtiÚs_m©ch
(
nvme_rdma_ù¾
 *
ù¾
,

1991 
nvmf_ù¾_ÝtiÚs
 *
Ýts
)

1993 *
¡dpÜt
 = 
	`__¡ršgify
(
NVME_RDMA_IP_PORT
);

1996 ià(!
	`nvmf_ùÌ_m©ches_ba£Ýts
(&
ù¾
->ù¾, 
Ýts
) ||

1997 
	`¡rcmp
(
Ýts
->
Œaddr
, 
ù¾
->ctrl.opts->traddr))

1998  
çl£
;

2000 ià(
Ýts
->
mask
 & 
NVMF_OPT_TRSVCID
 &&

2001 
ù¾
->ù¾.
Ýts
->
mask
 & 
NVMF_OPT_TRSVCID
) {

2002 ià(
	`¡rcmp
(
Ýts
->
Œsvcid
, 
ù¾
->ctrl.opts->trsvcid))

2003  
çl£
;

2004 } ià(
Ýts
->
mask
 & 
NVMF_OPT_TRSVCID
) {

2005 ià(
	`¡rcmp
(
Ýts
->
Œsvcid
, 
¡dpÜt
))

2006  
çl£
;

2007 } ià(
ù¾
->ù¾.
Ýts
->
mask
 & 
NVMF_OPT_TRSVCID
) {

2008 ià(
	`¡rcmp
(
¡dpÜt
, 
ù¾
->ù¾.
Ýts
->
Œsvcid
))

2009  
çl£
;

2022 ià(
Ýts
->
mask
 & 
NVMF_OPT_HOST_TRADDR
 &&

2023 
ù¾
->ù¾.
Ýts
->
mask
 & 
NVMF_OPT_HOST_TRADDR
) {

2024 ià(
	`¡rcmp
(
Ýts
->
ho¡_Œaddr
, 
ù¾
->ctrl.opts->host_traddr))

2025  
çl£
;

2026 } ià(
Ýts
->
mask
 & 
NVMF_OPT_HOST_TRADDR
 ||

2027 
ù¾
->ù¾.
Ýts
->
mask
 & 
NVMF_OPT_HOST_TRADDR
)

2028  
çl£
;

2034  
Œue
;

2035 
	}
}

2049 
boÞ


2050 
	$nvme_rdma_exi¡šg_cÚŒÞËr
(
nvmf_ù¾_ÝtiÚs
 *
Ýts
)

2052 
nvme_rdma_ù¾
 *
ù¾
;

2053 
boÞ
 
found
 = 
çl£
;

2055 
	`mu‹x_lock
(&
nvme_rdma_ù¾_mu‹x
);

2056 
	`li¡_fÜ_—ch_’Œy
(
ù¾
, &
nvme_rdma_ù¾_li¡
, 
li¡
) {

2057 
found
 = 
	`__nvme_rdma_ÝtiÚs_m©ch
(
ù¾
, 
Ýts
);

2058 ià(
found
)

2061 
	`mu‹x_uÆock
(&
nvme_rdma_ù¾_mu‹x
);

2063  
found
;

2064 
	}
}

2066 
nvme_ù¾
 *
	$nvme_rdma_ü—‹_ù¾
(
deviû
 *
dev
,

2067 
nvmf_ù¾_ÝtiÚs
 *
Ýts
)

2069 
nvme_rdma_ù¾
 *
ù¾
;

2070 
»t
;

2071 
boÞ
 
chªged
;

2072 *
pÜt
;

2074 
ù¾
 = 
	`kz®loc
((*ù¾), 
GFP_KERNEL
);

2075 ià(!
ù¾
)

2076  
	`ERR_PTR
(-
ENOMEM
);

2077 
ù¾
->ù¾.
Ýts
 = opts;

2078 
	`INIT_LIST_HEAD
(&
ù¾
->
li¡
);

2080 ià(
Ýts
->
mask
 & 
NVMF_OPT_TRSVCID
)

2081 
pÜt
 = 
Ýts
->
Œsvcid
;

2083 
pÜt
 = 
	`__¡ršgify
(
NVME_RDMA_IP_PORT
);

2085 
»t
 = 
	`š‘_±Ú_w™h_scÝe
(&
š™_Ãt
, 
AF_UNSPEC
,

2086 
Ýts
->
Œaddr
, 
pÜt
, &
ù¾
->
addr
);

2087 ià(
»t
) {

2088 
	`´_”r
("m®fÜmed‡dd»s ·s£d: %s:%s\n", 
Ýts
->
Œaddr
, 
pÜt
);

2089 
out_ä“_ù¾
;

2092 ià(
Ýts
->
mask
 & 
NVMF_OPT_HOST_TRADDR
) {

2093 
»t
 = 
	`š‘_±Ú_w™h_scÝe
(&
š™_Ãt
, 
AF_UNSPEC
,

2094 
Ýts
->
ho¡_Œaddr
, 
NULL
, &
ù¾
->
¤c_addr
);

2095 ià(
»t
) {

2096 
	`´_”r
("malformed src‡ddress…assed: %s\n",

2097 
Ýts
->
ho¡_Œaddr
);

2098 
out_ä“_ù¾
;

2102 ià(!
Ýts
->
du¶iÿ‹_cÚÃù
 && 
	`nvme_rdma_exi¡šg_cÚŒÞËr
(opts)) {

2103 
»t
 = -
EALREADY
;

2104 
out_ä“_ù¾
;

2107 
	`INIT_DELAYED_WORK
(&
ù¾
->
»cÚÃù_wÜk
,

2108 
nvme_rdma_»cÚÃù_ù¾_wÜk
);

2109 
	`INIT_WORK
(&
ù¾
->
”r_wÜk
, 
nvme_rdma_”rÜ_»cov”y_wÜk
);

2110 
	`INIT_WORK
(&
ù¾
->ù¾.
»£t_wÜk
, 
nvme_rdma_»£t_ù¾_wÜk
);

2112 
ù¾
->ù¾.
queue_couÁ
 = 
Ýts
->
Ä_io_queues
 + 1;

2113 
ù¾
->ù¾.
sqsize
 = 
Ýts
->
queue_size
 - 1;

2114 
ù¾
->ù¾.
k©o
 = 
Ýts
->kato;

2116 
»t
 = -
ENOMEM
;

2117 
ù¾
->
queues
 = 
	`kÿÎoc
(ù¾->ù¾.
queue_couÁ
, (*ctrl->queues),

2118 
GFP_KERNEL
);

2119 ià(!
ù¾
->
queues
)

2120 
out_ä“_ù¾
;

2122 
»t
 = 
	`nvme_š™_ù¾
(&
ù¾
->ù¾, 
dev
, &
nvme_rdma_ù¾_Ýs
,

2124 ià(
»t
)

2125 
out_kä“_queues
;

2127 
chªged
 = 
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_CONNECTING
);

2128 
	`WARN_ON_ONCE
(!
chªged
);

2130 
»t
 = 
	`nvme_rdma_cÚfigu»_admš_queue
(
ù¾
, 
Œue
);

2131 ià(
»t
)

2132 
out_unš™_ù¾
;

2135 ià(
ù¾
->ù¾.
icdoff
) {

2136 
	`dev_”r
(
ù¾
->ù¾.
deviû
, "icdoff is‚ot supported!\n");

2137 
»t
 = -
EINVAL
;

2138 
out_»move_admš_queue
;

2142 ià(!(
ù¾
->ù¾.
sgls
 & (1 << 20))) {

2143 
	`dev_”r
(
ù¾
->ù¾.
deviû
, "Mandatory keyed sgls‡re‚ot support\n");

2144 
»t
 = -
EINVAL
;

2145 
out_»move_admš_queue
;

2148 ià(
Ýts
->
queue_size
 > 
ù¾
->ù¾.
maxcmd
) {

2150 
	`dev_w¬n
(
ù¾
->ù¾.
deviû
,

2152 
Ýts
->
queue_size
, 
ù¾
->ù¾.
maxcmd
);

2153 
Ýts
->
queue_size
 = 
ù¾
->ù¾.
maxcmd
;

2156 ià(
Ýts
->
queue_size
 > 
ù¾
->ù¾.
sqsize
 + 1) {

2158 
	`dev_w¬n
(
ù¾
->ù¾.
deviû
,

2160 
Ýts
->
queue_size
, 
ù¾
->ù¾.
sqsize
 + 1);

2161 
Ýts
->
queue_size
 = 
ù¾
->ù¾.
sqsize
 + 1;

2164 ià(
Ýts
->
Ä_io_queues
) {

2165 
»t
 = 
	`nvme_rdma_cÚfigu»_io_queues
(
ù¾
, 
Œue
);

2166 ià(
»t
)

2167 
out_»move_admš_queue
;

2170 
chªged
 = 
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_LIVE
);

2171 
	`WARN_ON_ONCE
(!
chªged
);

2173 
	`dev_šfo
(
ù¾
->ù¾.
deviû
, "new ctrl: NQN \"%s\",‡ddr %pISpcs\n",

2174 
ù¾
->ù¾.
Ýts
->
subsy¢qn
, &ù¾->
addr
);

2176 
	`nvme_g‘_ù¾
(&
ù¾
->ctrl);

2178 
	`mu‹x_lock
(&
nvme_rdma_ù¾_mu‹x
);

2179 
	`li¡_add_ž
(&
ù¾
->
li¡
, &
nvme_rdma_ù¾_li¡
);

2180 
	`mu‹x_uÆock
(&
nvme_rdma_ù¾_mu‹x
);

2182 
	`nvme_¡¬t_ù¾
(&
ù¾
->ctrl);

2184  &
ù¾
->ctrl;

2186 
out_»move_admš_queue
:

2187 
	`nvme_rdma_¡Ý_queue
(&
ù¾
->
queues
[0]);

2188 
	`nvme_rdma_de¡roy_admš_queue
(
ù¾
, 
Œue
);

2189 
out_unš™_ù¾
:

2190 
	`nvme_unš™_ù¾
(&
ù¾
->ctrl);

2191 
	`nvme_put_ù¾
(&
ù¾
->ctrl);

2192 ià(
»t
 > 0)

2193 
»t
 = -
EIO
;

2194  
	`ERR_PTR
(
»t
);

2195 
out_kä“_queues
:

2196 
	`kä“
(
ù¾
->
queues
);

2197 
out_ä“_ù¾
:

2198 
	`kä“
(
ù¾
);

2199  
	`ERR_PTR
(
»t
);

2200 
	}
}

2202 
nvmf_Œª¥Üt_Ýs
 
	gnvme_rdma_Œª¥Üt
 = {

2203 .
Çme
 = "rdma",

2204 .
	gmoduË
 = 
THIS_MODULE
,

2205 .
	g»quœed_Ýts
 = 
NVMF_OPT_TRADDR
,

2206 .
	g®lowed_Ýts
 = 
NVMF_OPT_TRSVCID
 | 
NVMF_OPT_RECONNECT_DELAY
 |

2207 
NVMF_OPT_HOST_TRADDR
 | 
NVMF_OPT_CTRL_LOSS_TMO
,

2208 .
	gü—‹_ù¾
 = 
nvme_rdma_ü—‹_ù¾
,

2211 
	$nvme_rdma_»move_Úe
(
ib_deviû
 *ib_deviû, *
þ›Á_d©a
)

2213 
nvme_rdma_ù¾
 *
ù¾
;

2214 
nvme_rdma_deviû
 *
ndev
;

2215 
boÞ
 
found
 = 
çl£
;

2217 
	`mu‹x_lock
(&
deviû_li¡_mu‹x
);

2218 
	`li¡_fÜ_—ch_’Œy
(
ndev
, &
deviû_li¡
, 
’Œy
) {

2219 ià(
ndev
->
dev
 =ð
ib_deviû
) {

2220 
found
 = 
Œue
;

2224 
	`mu‹x_uÆock
(&
deviû_li¡_mu‹x
);

2226 ià(!
found
)

2230 
	`mu‹x_lock
(&
nvme_rdma_ù¾_mu‹x
);

2231 
	`li¡_fÜ_—ch_’Œy
(
ù¾
, &
nvme_rdma_ù¾_li¡
, 
li¡
) {

2232 ià(
ù¾
->
deviû
->
dev
 !ð
ib_deviû
)

2234 
	`nvme_d–‘e_ù¾
(&
ù¾
->ctrl);

2236 
	`mu‹x_uÆock
(&
nvme_rdma_ù¾_mu‹x
);

2238 
	`æush_wÜkqueue
(
nvme_d–‘e_wq
);

2239 
	}
}

2241 
ib_þ›Á
 
	gnvme_rdma_ib_þ›Á
 = {

2242 .
Çme
 = "nvme_rdma",

2243 .
	g»move
 = 
nvme_rdma_»move_Úe


2246 
__š™
 
	$nvme_rdma_š™_moduË
()

2248 
»t
;

2250 
»t
 = 
	`ib_»gi¡”_þ›Á
(&
nvme_rdma_ib_þ›Á
);

2251 ià(
»t
)

2252  
»t
;

2254 
»t
 = 
	`nvmf_»gi¡”_Œª¥Üt
(&
nvme_rdma_Œª¥Üt
);

2255 ià(
»t
)

2256 
”r_uÄeg_þ›Á
;

2260 
”r_uÄeg_þ›Á
:

2261 
	`ib_uÄegi¡”_þ›Á
(&
nvme_rdma_ib_þ›Á
);

2262  
»t
;

2263 
	}
}

2265 
__ex™
 
	$nvme_rdma_þ—nup_moduË
()

2267 
	`nvmf_uÄegi¡”_Œª¥Üt
(&
nvme_rdma_Œª¥Üt
);

2268 
	`ib_uÄegi¡”_þ›Á
(&
nvme_rdma_ib_þ›Á
);

2269 
	}
}

2271 
moduË_š™
(
nvme_rdma_š™_moduË
);

2272 
moduË_ex™
(
nvme_rdma_þ—nup_moduË
);

2274 
MODULE_LICENSE
("GPL v2");

2275 #ifdeà
RETPOLINE_MLNX


2276 
MODULE_INFO
(
»Þše
, "Y");

	@trace.c

15 
	~<asm/uÇligÃd.h
>

16 
	~"Œaû.h
"

18 cÚ¡ *
	$nvme_Œaû_ü—‹_sq
(
Œaû_£q
 *
p
, 
u8
 *
cdw10
)

20 cÚ¡ *
»t
 = 
	`Œaû_£q_bufãr_±r
(
p
);

21 
u16
 
sqid
 = 
	`g‘_uÇligÃd_Ë16
(
cdw10
);

22 
u16
 
qsize
 = 
	`g‘_uÇligÃd_Ë16
(
cdw10
 + 2);

23 
u16
 
sq_æags
 = 
	`g‘_uÇligÃd_Ë16
(
cdw10
 + 4);

24 
u16
 
cqid
 = 
	`g‘_uÇligÃd_Ë16
(
cdw10
 + 6);

27 
	`Œaû_£q_´štf
(
p
, "sqid=%u, qsize=%u, sq_flags=0x%x, cqid=%u",

28 
sqid
, 
qsize
, 
sq_æags
, 
cqid
);

29 
	`Œaû_£q_putc
(
p
, 0);

31  
»t
;

32 
	}
}

34 cÚ¡ *
	$nvme_Œaû_ü—‹_cq
(
Œaû_£q
 *
p
, 
u8
 *
cdw10
)

36 cÚ¡ *
»t
 = 
	`Œaû_£q_bufãr_±r
(
p
);

37 
u16
 
cqid
 = 
	`g‘_uÇligÃd_Ë16
(
cdw10
);

38 
u16
 
qsize
 = 
	`g‘_uÇligÃd_Ë16
(
cdw10
 + 2);

39 
u16
 
cq_æags
 = 
	`g‘_uÇligÃd_Ë16
(
cdw10
 + 4);

40 
u16
 
œq_veùÜ
 = 
	`g‘_uÇligÃd_Ë16
(
cdw10
 + 6);

42 
	`Œaû_£q_´štf
(
p
, "cqid=%u, qsize=%u, cq_flags=0x%x, irq_vector=%u",

43 
cqid
, 
qsize
, 
cq_æags
, 
œq_veùÜ
);

44 
	`Œaû_£q_putc
(
p
, 0);

46  
»t
;

47 
	}
}

49 cÚ¡ *
	$nvme_Œaû_admš_id’tify
(
Œaû_£q
 *
p
, 
u8
 *
cdw10
)

51 cÚ¡ *
»t
 = 
	`Œaû_£q_bufãr_±r
(
p
);

52 
u8
 
ús
 = 
cdw10
[0];

53 
u16
 
ù¾id
 = 
	`g‘_uÇligÃd_Ë16
(
cdw10
 + 2);

55 
	`Œaû_£q_´štf
(
p
, "ús=%u, cŒlid=%u", 
ús
, 
ù¾id
);

56 
	`Œaû_£q_putc
(
p
, 0);

58  
»t
;

59 
	}
}

63 cÚ¡ *
	$nvme_Œaû_»ad_wr™e
(
Œaû_£q
 *
p
, 
u8
 *
cdw10
)

65 cÚ¡ *
»t
 = 
	`Œaû_£q_bufãr_±r
(
p
);

66 
u64
 
¦ba
 = 
	`g‘_uÇligÃd_Ë64
(
cdw10
);

67 
u16
 
Ëngth
 = 
	`g‘_uÇligÃd_Ë16
(
cdw10
 + 8);

68 
u16
 
cÚŒÞ
 = 
	`g‘_uÇligÃd_Ë16
(
cdw10
 + 10);

69 
u32
 
dsmgmt
 = 
	`g‘_uÇligÃd_Ë32
(
cdw10
 + 12);

70 
u32
 
»áag
 = 
	`g‘_uÇligÃd_Ë32
(
cdw10
 + 16);

72 
	`Œaû_£q_´štf
(
p
,

74 
¦ba
, 
Ëngth
, 
cÚŒÞ
, 
dsmgmt
, 
»áag
);

75 
	`Œaû_£q_putc
(
p
, 0);

77  
»t
;

78 
	}
}

80 cÚ¡ *
	$nvme_Œaû_dsm
(
Œaû_£q
 *
p
, 
u8
 *
cdw10
)

82 cÚ¡ *
»t
 = 
	`Œaû_£q_bufãr_±r
(
p
);

84 
	`Œaû_£q_´štf
(
p
, "nr=%u,‡ttributes=%u",

85 
	`g‘_uÇligÃd_Ë32
(
cdw10
),

86 
	`g‘_uÇligÃd_Ë32
(
cdw10
 + 4));

87 
	`Œaû_£q_putc
(
p
, 0);

89  
»t
;

90 
	}
}

92 cÚ¡ *
	$nvme_Œaû_commÚ
(
Œaû_£q
 *
p
, 
u8
 *
cdw10
)

94 cÚ¡ *
»t
 = 
	`Œaû_£q_bufãr_±r
(
p
);

96 
	`Œaû_£q_´štf
(
p
, "cdw10=%*ph", 24, 
cdw10
);

97 
	`Œaû_£q_putc
(
p
, 0);

99  
»t
;

100 
	}
}

102 cÚ¡ *
	$nvme_Œaû_·r£_admš_cmd
(
Œaû_£q
 *
p
,

103 
u8
 
Ýcode
, u8 *
cdw10
)

105 
Ýcode
) {

106 
nvme_admš_ü—‹_sq
:

107  
	`nvme_Œaû_ü—‹_sq
(
p
, 
cdw10
);

108 
nvme_admš_ü—‹_cq
:

109  
	`nvme_Œaû_ü—‹_cq
(
p
, 
cdw10
);

110 
nvme_admš_id’tify
:

111  
	`nvme_Œaû_admš_id’tify
(
p
, 
cdw10
);

113  
	`nvme_Œaû_commÚ
(
p
, 
cdw10
);

115 
	}
}

117 cÚ¡ *
	$nvme_Œaû_·r£_nvm_cmd
(
Œaû_£q
 *
p
,

118 
u8
 
Ýcode
, u8 *
cdw10
)

120 
Ýcode
) {

121 
nvme_cmd_»ad
:

122 
nvme_cmd_wr™e
:

123 
nvme_cmd_wr™e_z”Ûs
:

124  
	`nvme_Œaû_»ad_wr™e
(
p
, 
cdw10
);

125 
nvme_cmd_dsm
:

126  
	`nvme_Œaû_dsm
(
p
, 
cdw10
);

128  
	`nvme_Œaû_commÚ
(
p
, 
cdw10
);

130 
	}
}

	@trace.h

15 #undeà
TRACE_SYSTEM


16 
	#TRACE_SYSTEM
 
nvme


	)

18 #ià!
defšed
(
_TRACE_NVME_H
è|| defšed(
TRACE_HEADER_MULTI_READ
)

19 
	#_TRACE_NVME_H


	)

21 
	~<lšux/nvme.h
>

22 
	~<lšux/Œaûpošt.h
>

23 
	~<lšux/Œaû_£q.h
>

25 
	~"nvme.h
"

27 
	#nvme_admš_Ýcode_Çme
(
Ýcode
è{ opcode, #Ýcod}

	)

28 #ifdeà
HAVE_BLK_MAX_WRITE_HINTS


29 
	#show_admš_Ýcode_Çme
(
v®
) \

30 
	`__´št_symbÞic
(
v®
, \

31 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_d–‘e_sq
), \

32 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_ü—‹_sq
), \

33 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_g‘_log_·ge
), \

34 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_d–‘e_cq
), \

35 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_ü—‹_cq
), \

36 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_id’tify
), \

37 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_abÜt_cmd
), \

38 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_£t_ã©u»s
), \

39 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_g‘_ã©u»s
), \

40 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_async_ev’t
), \

41 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_ns_mgmt
), \

42 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_aùiv©e_fw
), \

43 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_dowÆßd_fw
), \

44 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_ns_©ch
), \

45 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_k“p_®ive
), \

46 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_dœeùive_£nd
), \

47 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_dœeùive_»cv
), \

48 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_dbbuf
), \

49 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_fÜm©_nvm
), \

50 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_£cur™y_£nd
), \

51 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_£cur™y_»cv
), \

52 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_§n™ize_nvm
))

	)

54 
	#show_admš_Ýcode_Çme
(
v®
) \

55 
	`__´št_symbÞic
(
v®
, \

56 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_d–‘e_sq
), \

57 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_ü—‹_sq
), \

58 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_g‘_log_·ge
), \

59 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_d–‘e_cq
), \

60 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_ü—‹_cq
), \

61 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_id’tify
), \

62 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_abÜt_cmd
), \

63 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_£t_ã©u»s
), \

64 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_g‘_ã©u»s
), \

65 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_async_ev’t
), \

66 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_ns_mgmt
), \

67 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_aùiv©e_fw
), \

68 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_dowÆßd_fw
), \

69 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_ns_©ch
), \

70 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_k“p_®ive
), \

71 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_dbbuf
), \

72 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_fÜm©_nvm
), \

73 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_£cur™y_£nd
), \

74 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_£cur™y_»cv
), \

75 
	`nvme_admš_Ýcode_Çme
(
nvme_admš_§n™ize_nvm
))

	)

78 cÚ¡ *
nvme_Œaû_·r£_admš_cmd
(
Œaû_£q
 *
p
, 
u8
 
Ýcode
,

79 
u8
 *
cdw10
);

80 
	#__·r£_nvme_admš_cmd
(
Ýcode
, 
cdw10
) \

81 
	`nvme_Œaû_·r£_admš_cmd
(
p
, 
Ýcode
, 
cdw10
)

	)

83 
	#nvme_Ýcode_Çme
(
Ýcode
è{ opcode, #Ýcod}

	)

84 
	#show_Ýcode_Çme
(
v®
) \

85 
	`__´št_symbÞic
(
v®
, \

86 
	`nvme_Ýcode_Çme
(
nvme_cmd_æush
), \

87 
	`nvme_Ýcode_Çme
(
nvme_cmd_wr™e
), \

88 
	`nvme_Ýcode_Çme
(
nvme_cmd_»ad
), \

89 
	`nvme_Ýcode_Çme
(
nvme_cmd_wr™e_uncÜ
), \

90 
	`nvme_Ýcode_Çme
(
nvme_cmd_com·»
), \

91 
	`nvme_Ýcode_Çme
(
nvme_cmd_wr™e_z”Ûs
), \

92 
	`nvme_Ýcode_Çme
(
nvme_cmd_dsm
), \

93 
	`nvme_Ýcode_Çme
(
nvme_cmd_»sv_»gi¡”
), \

94 
	`nvme_Ýcode_Çme
(
nvme_cmd_»sv_»pÜt
), \

95 
	`nvme_Ýcode_Çme
(
nvme_cmd_»sv_acquœe
), \

96 
	`nvme_Ýcode_Çme
(
nvme_cmd_»sv_»Ëa£
))

	)

98 cÚ¡ *
nvme_Œaû_·r£_nvm_cmd
(
Œaû_£q
 *
p
, 
u8
 
Ýcode
,

99 
u8
 *
cdw10
);

100 
	#__·r£_nvme_cmd
(
Ýcode
, 
cdw10
) \

101 
	`nvme_Œaû_·r£_nvm_cmd
(
p
, 
Ýcode
, 
cdw10
)

	)

103 
TRACE_EVENT
(
nvme_£tup_admš_cmd
,

104 
TP_PROTO
(
nvme_commªd
 *
cmd
),

105 
TP_ARGS
(
cmd
),

106 
TP_STRUCT__’Œy
(

107 
	$__f›ld
(
u8
, 
Ýcode
)

108 
	$__f›ld
(
u8
, 
æags
)

109 
	$__f›ld
(
u16
, 
cid
)

110 
	$__f›ld
(
u64
, 
m‘ad©a
)

111 
	`__¬¿y
(
u8
, 
cdw10
, 24)

113 
	`TP_ç¡_assign
(

114 
__’Œy
->
Ýcode
 = 
cmd
->
commÚ
.opcode;

115 
__’Œy
->
æags
 = 
cmd
->
commÚ
.flags;

116 
__’Œy
->
cid
 = 
cmd
->
commÚ
.
commªd_id
;

117 
__’Œy
->
m‘ad©a
 = 
	`Ë64_to_ýu
(
cmd
->
commÚ
.metadata);

118 
	`memýy
(
__’Œy
->
cdw10
, 
cmd
->
commÚ
.cdw10,

119 (
__’Œy
->
cdw10
));

121 
	`TP_´štk
(" cmdid=%u, flags=0x%x, meta=0x%llx, cmd=(%s %s)",

122 
__’Œy
->
cid
, __’Œy->
æags
, __’Œy->
m‘ad©a
,

123 
	`show_admš_Ýcode_Çme
(
__’Œy
->
Ýcode
),

124 
	`__·r£_nvme_admš_cmd
(
__’Œy
->
Ýcode
, __’Œy->
cdw10
))

128 
	`TRACE_EVENT
(
nvme_£tup_nvm_cmd
,

129 
	`TP_PROTO
(
qid
, 
nvme_commªd
 *
cmd
),

130 
	`TP_ARGS
(
qid
, 
cmd
),

131 
	`TP_STRUCT__’Œy
(

132 
	$__f›ld
(, 
qid
)

133 
	$__f›ld
(
u8
, 
Ýcode
)

134 
	$__f›ld
(
u8
, 
æags
)

135 
	$__f›ld
(
u16
, 
cid
)

136 
	$__f›ld
(
u32
, 
nsid
)

137 
	$__f›ld
(
u64
, 
m‘ad©a
)

138 
	`__¬¿y
(
u8
, 
cdw10
, 24)

140 
	`TP_ç¡_assign
(

141 
__’Œy
->
qid
 = qid;

142 
__’Œy
->
Ýcode
 = 
cmd
->
commÚ
.opcode;

143 
__’Œy
->
æags
 = 
cmd
->
commÚ
.flags;

144 
__’Œy
->
cid
 = 
cmd
->
commÚ
.
commªd_id
;

145 
__’Œy
->
nsid
 = 
	`Ë32_to_ýu
(
cmd
->
commÚ
.nsid);

146 
__’Œy
->
m‘ad©a
 = 
	`Ë64_to_ýu
(
cmd
->
commÚ
.metadata);

147 
	`memýy
(
__’Œy
->
cdw10
, 
cmd
->
commÚ
.cdw10,

148 (
__’Œy
->
cdw10
));

150 
	`TP_´štk
("qid=%d,‚sid=%u, cmdid=%u, flags=0x%x, meta=0x%llx, cmd=(%s %s)",

151 
__’Œy
->
qid
, __’Œy->
nsid
, __’Œy->
cid
,

152 
__’Œy
->
æags
, __’Œy->
m‘ad©a
,

153 
	`show_Ýcode_Çme
(
__’Œy
->
Ýcode
),

154 
	`__·r£_nvme_cmd
(
__’Œy
->
Ýcode
, __’Œy->
cdw10
))

157 
	`TRACE_EVENT
(
nvme_com¶‘e_rq
,

158 
	`TP_PROTO
(
»que¡
 *
»q
),

159 
	`TP_ARGS
(
»q
),

160 
	`TP_STRUCT__’Œy
(

161 
	$__f›ld
(, 
qid
)

162 
	$__f›ld
(, 
cid
)

163 
	$__f›ld
(
u64
, 
»suÉ
)

164 
	$__f›ld
(
u8
, 
»Œ›s
)

165 
	$__f›ld
(
u8
, 
æags
)

166 
	`__f›ld
(
u16
, 
¡©us
)

168 
	`TP_ç¡_assign
(

169 
__’Œy
->
qid
 = 
»q
->
q
->
id
;

170 
__’Œy
->
cid
 = 
»q
->
g
;

171 
__’Œy
->
»suÉ
 = 
	`Ë64_to_ýu
(
	`nvme_»q
(
»q
)->»suÉ.
u64
);

172 
__’Œy
->
»Œ›s
 = 
	`nvme_»q
(
»q
)->retries;

173 
__’Œy
->
æags
 = 
	`nvme_»q
(
»q
)->flags;

174 
__’Œy
->
¡©us
 = 
	`nvme_»q
(
»q
)->status;

176 
	`TP_´štk
("qid=%d, cmdid=%u,„es=%llu,„etries=%u, flags=0x%x, status=%u",

177 
__’Œy
->
qid
, __’Œy->
cid
, __’Œy->
»suÉ
,

178 
__’Œy
->
»Œ›s
, __’Œy->
æags
, __’Œy->
¡©us
)

184 #undeà
TRACE_INCLUDE_PATH


185 
	#TRACE_INCLUDE_PATH
 .

	)

186 #undeà
TRACE_INCLUDE_FILE


187 
	#TRACE_INCLUDE_FILE
 
Œaû


	)

190 
	~<Œaû/defše_Œaû.h
>

	@
1
.
0
17
192
core.c
fabrics.c
fabrics.h
fault_inject.c
fc.c
lightnvm.c
multipath.c
nvme-core_dummy.c
nvme-fabrics_dummy.c
nvme-fc_dummy.c
nvme-rdma_dummy.c
nvme.h
nvme_dummy.c
pci.c
rdma.c
trace.c
trace.h
